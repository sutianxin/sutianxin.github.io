<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><script class="meting-secondary-script-marker" src="\assets\js\Meting.min.js"></script>"use strict";var _createClass=function(){function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}}();function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var JustAddMusic=function(){function e(t){_classCallCheck(this,e),this.gain=(t=!t||"string"==typeof t?{src:t}:t).gain||1,this.onstart=t.onstart,this.ontick=t.ontick,this.ondecode=t.ondecode,this.onended=t.onended,this.onprogress=t.onprogress,this.label=t.label||"",this.loop=!!t.loop,this._paused=!!t.paused,this._keyControl=!1,this._tickInterval=0,this._tickIntervalID=0,this._request=null,this._playT=0,this._pausedT=0,this._ui=!1,this._uiDiv=null,this._audioData=null,this._deltaT=t.deltaT||50,this._avgT=t.avgT||150,this._maxT=Math.max(this._deltaT,this._avgT),this._allAdj=.1,this._bandAdj=.1,this._fftData=null,this._fftBins=Math.max(0,Math.min(128,t.spectrumBins||0)),this._fftThreshold=.65,this._hitThresholds={low:2,mid:2,high:2,all:2},this._context=null,this._gainNode=null,this._sourceNode=null,this._buffer=null,this._muteNode=null,this._nullNode=null,this._analyserNode=null,this._bound_handleKeyDown=this._handleKeyDown.bind(this),this._initAudio(),this._initUI(),this._initDropTarget(t.dropTarget),this.tickInterval=t.tickInterval,this.loadAudio(t.src),this.ui=void 0===t.ui||t.ui,this.keyControl=void 0===t.keyControl||t.keyControl,this.volume=void 0===t.volume?1:t.volume}return _createClass(e,[{key:"loadAudio",value:function(t){var e;this.abort(),this.disconnect(),t&&(this._updateLoadUI(0),(e=this._request=new XMLHttpRequest).open("GET",t,!0),e.responseType="arraybuffer",e.addEventListener("load",this._handleURILoad.bind(this)),e.addEventListener("progress",this._handleURIProgress.bind(this)),e.send())}},{key:"abort",value:function(){this._request&&this._request.abort(),this._request=null}},{key:"disconnect",value:function(){this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.disconnect(),this._sourceNode=null)}},{key:"play",value:function(){var e=this,t=(this._sourceNode&&this._sourceNode.buffer)!==this._buffer,i=this._pausedT;this.pause();var n=this._sourceNode=this._context.createBufferSource();n.buffer=this._buffer,n.connect(this._nullNode),n.start(0,i),n.addEventListener("ended",function(t){return e._handleEnded(t)}),this._playT=this._context.currentTime-i,this._paused=!1,t&&this.onstart&&this.onstart()}},{key:"pause",value:function(){this._sourceNode&&!this._paused&&(this.disconnect(),this._pausedT=this._context.currentTime-this._playT,this._paused=!0)}},{key:"stop",value:function(){this.abort(),this.pause(),this._pausedT=this._playT=0}},{key:"seek",value:function(t){this._buffer&&(this.playT=0,this._pausedT=Math.min(this._buffer.duration-.001,Math.max(0,t)),this._paused||this.play())}},{key:"skip",value:function(t){this.seek(this._context.currentTime-this._playT+t)}},{key:"tick",value:function(){if(this._sourceNode&&(this._updateTimeUI(),this.ontick||!this._tickIntervalID)){this._allAnalyser||this._initAnalyser();var t=this._oldObj||{low:{},mid:{},high:{},all:{}},e=this._audioData;this._oldObj=null,e.unshift(t);e=t.t=1e3*this._context.currentTime;return this._getVal(t.all,this._allAnalyser,e,!0),this._getVal(t.low,this._lowAnalyser,e),this._getVal(t.mid,this._midAnalyser,e),this._getVal(t.high,this._highAnalyser,e),this._calculate(),this._calculateSpectrum(t),this.ontick&&this.ontick(t),t}}},{key:"toString",value:function(){return"[JustAddMusic]"}},{key:"_initAudio",value:function(){var t=this._context=new(window.AudioContext||window.webkitAudioContext);this._gainNode=t.createGain(),this._gainNode.connect(t.destination),this._nullNode=t.createGain(),this._nullNode.connect(this._gainNode)}},{key:"_initAnalyser",value:function(){var t,e;this._muteNode||(this._audioData=[],e=this._context,(t=this._muteNode=e.createGain()).gain.value=0,t.connect(e.destination),this._lowAnalyser=this._createBandAnalyser(40,250),this._midAnalyser=this._createBandAnalyser(250,2e3),this._highAnalyser=this._createBandAnalyser(2e3,6e3),this._allAnalyser=this._createBandAnalyser(),this._fftBins&&((e=this._analyserNode=e.createAnalyser()).fftSize=512,e.maxDecibels=-15,this._fftData=new Uint8Array(e.frequencyBinCount),this._nullNode.connect(e)))}},{key:"_createBandAnalyser",value:function(t,e){var i,n=void 0,a=this._context,s=a.createDynamicsCompressor();return s.threshold.value=-36,s.knee.value=35,s.ratio.value=10,s.release.value=0,s.connect(this._muteNode),s.attack.value=1,s.attack.linearRampToValueAtTime(0,a.currentTime+.1),(t||e)&&(t=(i=Math.sqrt(t*e))/(e-t),(n=a.createBiquadFilter()).type="bandpass",n.Q.value=t,n.frequency.value=i,n.connect(s)),this._nullNode.connect(n||s),s}},{key:"_getVal",value:function(t,e,i,n){var a=e.reduction.value,s=n?this._allAdj:this._bandAdj;return 1<(a=(void 0===a?e.reduction:a)*-s)&&(s/=a,a=1,n?this._allAdj=s:this._bandAdj=s),t.val=a*this.gain}},{key:"_calculate",value:function(){for(var s=this._audioData,o=s[0],r=o.t,h=this._hitThresholds,u=s[1],d=u,l=0,t=1,e=s.length;t<e;t++){var i=s[t],n=i.t;n>=r-this._avgT&&(l=t),n>=r-this._deltaT&&(d=i),n<r-this._maxT&&(this._oldObj=s.pop(),e--)}for(var a in o)(function(n){var t=o[n],e=t.val;if(void 0===e)return;t.avg=l?s.reduce(function(t,e,i){return l<i?t:t+e[n].val},0)/l:0,t.delta=d?e-d[n].val:0,t.trend=d?t.avg-s[l][n].avg:0;var i=h[n],a=u?(r-u.t)/16:1;t.hit=!1,u&&!u[n].hit&&Math.pow(e,1.3)>1.3*i&&(t.hit=!0),h[n]=Math.max(.1,e,i-.15*(i-e)*a)})(a)}},{key:"_calculateSpectrum",value:function(t){if(this._fftBins){var e=this._fftBins,i=[],n=0,a=this._fftData,s=this._fftThreshold,o=this._analyserNode,r=o.frequencyBinCount;o.getByteFrequencyData(a);for(var h=0;h<e;h++){for(var u=0,d=(h+1)/e*r*s,l=n;n<d;)u+=a[n++];i[h]=u/255/(n-l)}t.spectrum=i}}},{key:"_initDropTarget",value:function(t){(t="string"==typeof(t=void 0===t?window:t)?document.querySelector(t):t)&&(t.addEventListener("drop",this._handleDrop.bind(this)),t.addEventListener("dragenter",this._handleDragEnter.bind(this)),t.addEventListener("dragleave",this._handleDragLeave.bind(this)),t.addEventListener("dragover",this._handleDragOver.bind(this)),this._updateUI("drop an MP3 to play"))}},{key:"_decode",value:function(t){this._context.decodeAudioData(t,this._handleBufferDecode.bind(this)),this._updateUI("可视化加载中...")}},{key:"_initUI",value:function(){(this._uiDiv=document.createElement("div")).className="jam-ui";var t=document.createElement("style");t.innerHTML=".jam-ui{padding:0.75em;font-size:10pt;font-family:arial,sans-serif;background:#000;color:#FFF;z-index:100;position:absolute;bottom:0;left:0;}",document.head.insertBefore(t,document.head.firstChild)}},{key:"_updateLoadUI",value:function(t){this._updateUI(Math.round(100*t)+"%")}},{key:"_updateTimeUI",value:function(){var t;this._buffer&&(t=this._formatTime(Math.min(this._buffer.duration,this._context.currentTime-this._playT)),t+=" / "+this._formatTime(this._buffer.duration),this._updateUI(t))}},{key:"_formatTime",value:function(t){var e=t/60|0,t=t-60*e|0;return e+":"+(t<10?"0":"")+t}},{key:"_updateUI",value:function(t){var e=this._uiDiv;e.style.display=t?"inline-block":"none",e.innerHTML=this.label+t}},{key:"_handleKeyDown",value:function(t){var e=t.key||t.keyIdentifier;" "===(e=e.replace("Arrow",""))||"U+0020"===e?this.paused=!this.paused:"Enter"===e?(this._pausedT=0,this.play()):"Up"===e||"Down"===e?this.volume+=.1*("Up"===e?1:-1):"Left"!==e&&"Right"!==e||(t=("Left"===e?-1:1)*(t.shiftKey?15:5)*(t.altKey?12:1),this.skip(t))}},{key:"_handleEnded",value:function(t){this.loop?this.seek(0):this.onended&&this.onended()}},{key:"_handleDragEnter",value:function(t){this._handleDragLeave(t);t=t.currentTarget;(t===window?document.body:t).className+=" jam-drop"}},{key:"_handleDragLeave",value:function(t){t.preventDefault();t=t.currentTarget,t=t===window?document.body:t;t.className=t.className.replace(/\b\s?jam-drop\b/,"")}},{key:"_handleDragOver",value:function(t){this._handleDragEnter(t)}},{key:"_handleDrop",value:function(t){this._handleDragLeave(t),this.abort();var e=new FileReader;e.addEventListener("load",this._handleDropLoad.bind(this)),e.readAsArrayBuffer(t.dataTransfer.files[0])}},{key:"_handleDropLoad",value:function(t){this._decode(t.target.result)}},{key:"_handleURILoad",value:function(t){this._decode(t.target.response),this._request=null}},{key:"_handleURIProgress",value:function(t){t=t.loaded/t.total;this.onprogress&&this.onprogress(t),this._updateLoadUI(t)}},{key:"_handleBufferDecode",value:function(t){this._buffer=t,this._pausedT=0,this._playT=this._context.currentTime,this.ondecode&&this.ondecode(t),this._updateTimeUI(),this._paused||this.play()}},{key:"paused",get:function(){return this._paused},set:function(t){!t===this._paused&&(t?this.pause():this.play())}},{key:"keyControl",get:function(){return this._keyControl},set:function(t){this._keyControl!==(t=!!t)&&((this._keyControl=t)?document.addEventListener("keydown",this._bound_handleKeyDown):document.removeEventListener("keydown",this._bound_handleKeyDown))}},{key:"tickInterval",get:function(){return this._tickInterval},set:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:16;clearInterval(this._tickIntervalID),this._tickIntervalID=0<t?setInterval(this.tick.bind(this),t):0}},{key:"volume",get:function(){return this._gainNode.gain.value},set:function(t){this._gainNode.gain.value=Math.max(0,Math.min(2,t))}},{key:"ui",get:function(){return this._ui},set:function(t){var e;this._ui!==(t=!!t)&&(this._ui=t,e=this._uiDiv,t?document.body.appendChild(e):e.parentNode.removeChild(e))}},{key:"audioData",get:function(){return this._audioData&&this._audioData[0]||e.DEFAULT_AUDIO_DATA}}]),e}();JustAddMusic.DEFAULT_FREQUENCY_RANGE={val:0,avg:0,delta:0,trend:0,hit:!1},JustAddMusic.DEFAULT_AUDIO_DATA={t:0,spectrum:[],low:JustAddMusic.DEFAULT_FREQUENCY_RANGE,mid:JustAddMusic.DEFAULT_FREQUENCY_RANGE,high:JustAddMusic.DEFAULT_FREQUENCY_RANGE,all:JustAddMusic.DEFAULT_FREQUENCY_RANGE};