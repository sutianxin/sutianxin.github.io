<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>数据结构与算法学习（六）-HashMap源码解读</title>
      <link href="posts/717860798.html"/>
      <url>posts/717860798.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1、集合容器"><a href="#1、集合容器" class="headerlink" title="1、集合容器"></a>1、集合容器</h2><h3 id="1-1、概述"><a href="#1-1、概述" class="headerlink" title="1.1、概述"></a>1.1、概述</h3><blockquote><p>Java集合容器主要包含了三个接口，分别为<strong>List</strong>，<strong>Set</strong>和<strong>Map</strong>，以及实现了这些接口的诸多子类。</p><p>其中List和Set继承了Collection接口，而Map是单独的接口。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210217221746.png" alt="image-20210217221746006"></p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210217221735.png" alt="image-20210217221733459"></p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210217221829.png" alt="image-20210217221829486"></p><h3 id="1-2、对比"><a href="#1-2、对比" class="headerlink" title="1.2、对比"></a>1.2、对比</h3><blockquote><p>List是有序的，有序指插入元素的顺序，其中可以存放重复值和null值</p><p>Set是无序的，且元素具有唯一性，所以只能存放一个null值</p><p>Map存放的是Entry键值对，键必须是唯一的，所以只能存放一个key为null的entry，但可以存放多个值为null的entry</p></blockquote><h3 id="1-3、HashMap的基本概念"><a href="#1-3、HashMap的基本概念" class="headerlink" title="1.3、HashMap的基本概念"></a>1.3、HashMap的基本概念</h3><blockquote><p>HashMap基于哈希表的Map接口实现，是以key-value存储形式存在，即主要用于存放键值对。HashMap的实现不是同步的，这意味着它不是线程安全的。它的key-value都可以为null（只能有一个key为null，可以有多个值为null），此外，HashMap中的映射不是有序的（不保证存取顺序）。</p><p>JDK1.8之前HashMap由数组+链表组成的，数组是HashMap的主体，链表则是主要为了解决哈希冲突（两个对象调用的hashCode方法计算的哈希码值一致导致计算的数组系引值相同）而存在的（“拉链法“解决冲突）JDK1.8以后在解决哈希冲突时有了较大的变化，<strong>当链表长度大于阀值（或者红黑树的边界值，默认为8）并且当前数组的长度大于64时</strong>，此时此案引位置上的所有数据改为使用<strong>红黑树</strong>存储。</p><p>补充：将链表转换成红黑树前会判断，即便阈值大于8，但是数组长度小于64，此时并不会将链表变为红黑树。而是选择进行数组扩容。</p><p>这样做的目的是因为效组比较小，尽量避开红黑树结构，这种情况下变为红黑树结构，反而会降低效率，因为红黑树需要进行左旋，右旋，变色这些操作来保持平衡。同时数组长度小于64时，搜索时间相对要快些。所以综上所述为了提高性能和减少搜索时间，底层在调值大于8并且数组长度大于64时，链表才转换为红黑树。吴体可以参考treeifyBin方法。</p><p>当然虽然增了红黑树作为底层数据结构，结构变得复杂了，但是阈值大于8并且数组长度大于64时，链表转换为红黑树时，效率也变的更高效。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210218113025.png" alt="image-20210218113018160"></p><blockquote><p>特点总结：</p></blockquote><ul><li>存取是无序的</li><li>键和值位置都可以是null，但是键位置只能有一个null</li><li>键位置是唯一的</li><li>1.8之前数据结构是数组+链表；1.8之后数据结构是数组+链表+红黑树</li><li>阈值（边界值）》8且数组长度大于64，才将链表转换为红黑树，变为红黑树的目的是为了更高效的查询。</li></ul><h3 id="1-4、Hash和Hash算法"><a href="#1-4、Hash和Hash算法" class="headerlink" title="1.4、Hash和Hash算法"></a>1.4、Hash和Hash算法</h3><blockquote><p>Hash也称散列、哈希，基本原理就是把任意长度的输入，通过Hash算法变为固定长度的输出，这个映射的规则就是对应的Hash算法，而原始数据映射后的二进制串就是哈希值。</p><p>Hash的特点：</p></blockquote><ul><li>从Hash值不能反向推导出原始的数据</li><li>输入数据的微小变化会得到完全不同的Hash值，相同的数据会得到相同的值。</li><li>Hash算法的执行效率要高效，长的文本也能快速计算出Hash值</li><li>Hash算法的冲突概率要小</li></ul><blockquote><p>由于Hash算法的原理是将输入空间的值映射成Hash空间内，而hash值的空间远小于输入的空间，根据抽屉原理，一定会存在不同的输入被映射为相同输出的情况。</p><p>抽屉原理：10个苹果放到9个抽屉中，无论怎么放，我们会发现至少会有一个抽屉里面放不少于两个苹果。</p></blockquote><h2 id="2、HashMap原理"><a href="#2、HashMap原理" class="headerlink" title="2、HashMap原理"></a>2、HashMap原理</h2><h3 id="2-1、HashMap的继承体系"><a href="#2-1、HashMap的继承体系" class="headerlink" title="2.1、HashMap的继承体系"></a>2.1、HashMap的继承体系</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210218123331.png" alt="image-20210218123330894"></p><h3 id="2-3、底层数据结构介绍"><a href="#2-3、底层数据结构介绍" class="headerlink" title="2.3、底层数据结构介绍"></a>2.3、底层数据结构介绍</h3><ul><li>JDK1.7及之前</li></ul><blockquote><p>HashMap底层使用数组 + 链表的形式来实现HashMap，当创建HashMap集合对象时，构造方法中会<strong>创建一个长度为16的Entry[] table</strong>来存储键值对数据。</p></blockquote><ul><li>JDK1.8之后</li></ul><blockquote><p>HashMap底层使用数组 + 链表 + 红黑树来实现HashMap，在JDK8之后不再使用HashMap的构造方法底层创建数组了，而是在第一次使用put存储时才创建数组，使用Node[] table来存储键值对数据。</p></blockquote><h3 id="2-4、Hash表使用什么算法计算hash值？"><a href="#2-4、Hash表使用什么算法计算hash值？" class="headerlink" title="2.4、Hash表使用什么算法计算hash值？"></a>2.4、Hash表使用什么算法计算hash值？</h3><ul><li>底层采用的是key的hashCode方法的值结合数组长度进行无符号右移(&gt;&gt;&gt;),按位异或(^),按位与(&amp;)计算出索引</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>还可以使用平方取中法、取余数、伪随机数法计算hash值</p></li><li><p>为什么底层采用的无符号右移、按位异或、按位与而不是采用取余呢？</p></li></ul><blockquote><p>其他计算方式效率比较低，而上述位运算效率较高。</p></blockquote><h3 id="2-5、put数据原理分析"><a href="#2-5、put数据原理分析" class="headerlink" title="2.5、put数据原理分析"></a>2.5、put数据原理分析</h3><ul><li>map.put(“芜湖”,”起飞”);</li><li>获取键”芜湖”字符串的Hash值</li><li>经过hash值扰动函数，使此hash值更散列</li><li>构造出Node对象</li><li>通过路由算法，找出Node应当存放在数组中的位置</li></ul><blockquote><p>路由寻址公式：(table.length - 1) &amp; node.hash</p><p>这里要注意，table数组的大小为2^n</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210218220841.png" alt="2021-02-18_220529"></p><h3 id="2-6、什么是Hash碰撞"><a href="#2-6、什么是Hash碰撞" class="headerlink" title="2.6、什么是Hash碰撞"></a>2.6、什么是Hash碰撞</h3><blockquote><p>如果两个输入串的hash函数的值一样，则称这两个串是一个碰撞(Collision)。既然是把任意长度的字符串变成固定长度的字符串，所以必有一个输出串对应无穷多个输入串，碰撞是必然存在的。</p><p>即元素的key不同，但得出的hash值相同</p></blockquote><h3 id="2-7、什么引入红黑树？"><a href="#2-7、什么引入红黑树？" class="headerlink" title="2.7、什么引入红黑树？"></a>2.7、什么引入红黑树？</h3><blockquote><p>在jdk8之前HashMap的实现是数组＋链表，即使哈希函数取得再好，也很难达到元素百分百均匀分布。当HashMap中有大量的元素都存放在同一个桶中时，这个桶下有一条长长的链表，这个时候HashMap就相当于一个单链表，假如单链表有n个元素，遍历的时间复杂度就是O(n)，完全失去了它的优势。针对这种情况，JDK1.8中引入了红黑树（查找时间复杂度为O(logn)）来优化这个问题。当链表长度很小的时候，即使遍历，速度也非常快，但是当链表长度不断变长，肯定会对查询性能有一定的影响，所以才需要转成树。</p></blockquote><h2 id="3、HashMap源码分析"><a href="#3、HashMap源码分析" class="headerlink" title="3、HashMap源码分析"></a>3、HashMap源码分析</h2><h3 id="3-1、核心属性分析"><a href="#3-1、核心属性分析" class="headerlink" title="3.1、核心属性分析"></a>3.1、核心属性分析</h3><blockquote><p>DEFAULT_INITIAL_CAPACITY</p></blockquote><ul><li>table数组的默认大小，当使用无参函数构造HashMap时，HashMap对象的大小默认为16</li></ul><blockquote><p>TREEIFY_THRESHOLD</p></blockquote><ul><li>树化阈值之一，默认为8</li></ul><blockquote><p>UNTREEIFY_THRESHOLD</p></blockquote><ul><li>树降级为链表的阈值，默认为6</li></ul><blockquote><p>MIN_TREEIFY_CAPACITY</p></blockquote><ul><li>树化阈值之一，只有当table数组中元素大小超过这个值时，数组中长度大于TREEIFY_THRESHOLD的链表才能转换为红黑树。</li></ul><blockquote><p>transient Node&lt;K,V&gt;[] table</p></blockquote><ul><li>ashmap中维护的散列表结构，是一个Node数组</li><li>JDK1.8后，HashMap对象在被构造出来时不初始化散列表，而是等到第一次往该对象中put键值对时才初始化散列表。</li></ul><blockquote><p>transient int size</p></blockquote><ul><li>当前哈希表中的元素个数，即HashMap对象中键值对个数。</li></ul><blockquote><p>transient int modCount</p></blockquote><ul><li>当前hash表结构的修改次数,往hashMap中放入一个键值对，删除一个键值对时，modCount+1，但使用相同key，不同value的Node覆盖旧值时，modCount不会+1</li></ul><blockquote><p>threshold</p></blockquote><ul><li>扩容阈值，当Hash表中的元素超过此值时触发扩容</li><li>threshold = capacity * loadFactory，其中capacity表示当前hash表的数组长度</li></ul><blockquote><p>loadFactory</p></blockquote><ul><li>负载因子，默认负载因子大小为0.75</li></ul><h3 id="3-2、构造方法分析"><a href="#3-2、构造方法分析" class="headerlink" title="3.2、构造方法分析"></a>3.2、构造方法分析</h3><ul><li>构造方法一，自定义初始化大小和负载因子</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Illegal initial capacity: &quot;</span> +</span><br><span class="line">                                           initialCapacity);</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                           loadFactor);</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">    <span class="keyword">this</span>.threshold = tableSizeFor(initialCapacity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>tableSizeFor(initialCapacity)方法，<strong>就是返回一个大于等于当前capacity的一个数字，这个数字一定是2的次方数。</strong></p><p>假设传入的cap为10</p><p>那么n = cap - 1 = 9</p><p>将n转换为二进制，n变为1001</p><p>n &gt;&gt;&gt; 1 = 0100，右移就是在1001的最前面补上一个0，使其变为01001，然后截去最后一位，变为0100，而1001 | 0100 = 1101，此时n = 1101</p><p>同理可得1101 &gt;&gt;&gt; 2 = 0011，1101 | 0011 = 1111</p><p>同理可得1111  &gt;&gt;&gt;&gt; 4 = 0000，1111 | 0000 = 1111</p><p>此时n&gt;&gt;&gt;8、n&gt;&gt;&gt;16的结果和上面一致，故n = 1111(2) = 15(10)</p><p>最后执行return语句，此时返回15 + 1 = 16，为2^ 4</p><p>如果不减一，那么会得到一个比预期结果大一倍的数字</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> cap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = cap - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>构造方法二：自定义初始化大小，调用了上面的构造方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(initialCapacity, DEFAULT_LOAD_FACTOR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>构造方法三：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR; <span class="comment">// all other fields defaulted</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>构造方法四：根据传入的Map构造HashMap</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;</span><br><span class="line">    putMapEntries(m, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3、put方法分析"><a href="#3-3、put方法分析" class="headerlink" title="3.3、put方法分析"></a>3.3、put方法分析</h3><blockquote><p>分析源码可知，put方法内部调用了putVal方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>hash(key)方法，扰动函数，作用是让key的hash值的高16位也参与运算，增加散列性，减少hash冲突的概率。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>核心putVal方法</p><p>注意：这里HashMap实现了延迟初始化，即new HashMap的时候不创建散列表，等到第一次往hashMap中put键值对时才初始化，节省了内存空间。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">boolean</span> evict)</span> </span>&#123;</span><br><span class="line">      <span class="comment">//tab：引用当前hashMap的散列表</span></span><br><span class="line"><span class="comment">//p：表示当前散列表的元素</span></span><br><span class="line"><span class="comment">//n：表示散列表数组的长度</span></span><br><span class="line"><span class="comment">//i：表示路由寻址结果的下标</span></span><br><span class="line">      Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, i;</span><br><span class="line">      <span class="comment">//如果当前hashmap中的散列表为null，或者散列表长度为0</span></span><br><span class="line">      <span class="comment">//n = (tab = resize()).length;创建散列表</span></span><br><span class="line">      <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">          n = (tab = resize()).length;</span><br><span class="line">      <span class="comment">//i = (n - 1) &amp; hash，使用路由寻址算法计算出要当前键值对要存放的位置</span></span><br><span class="line">      <span class="comment">//如果散列表中该下标对应元素为null，那么就new 一个Node节点</span></span><br><span class="line">      <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)</span><br><span class="line">          tab[i] = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">//e：node临时元素</span></span><br><span class="line"><span class="comment">//k：表示临时的一个key</span></span><br><span class="line">          Node&lt;K,V&gt; e; K k;</span><br><span class="line">          <span class="comment">//表示桶位中的该元素，与你当前插入的元素的key完全一致，表示后续需要进行替换操作。</span></span><br><span class="line">          <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">              ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">              e = p;</span><br><span class="line">          <span class="comment">//如果要插入的桶位对应的元素已经树化，即要插入的位置不是一根链表而是一棵红黑树</span></span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">              e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="keyword">this</span>, tab, hash, key, value);</span><br><span class="line">          <span class="comment">//如果不是树也不相等，那么只能是链表了</span></span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">//循环遍历找到的链表，如果链表中有key与待插入键值对相同的元素，那么用新的值替换旧的值</span></span><br><span class="line">              <span class="comment">//否则将待插入元素加入到该链表中</span></span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> binCount = <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                  <span class="keyword">if</span> ((e = p.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                      p.next = newNode(hash, key, value, <span class="keyword">null</span>);</span><br><span class="line">                      <span class="comment">//表示当前链表中的元素大于临界值，此时可能需要树化</span></span><br><span class="line">                      <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                          treeifyBin(tab, hash);</span><br><span class="line">                      <span class="keyword">break</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="comment">//找到了含有相同key的元素，需要进行替换操作</span></span><br><span class="line">                  <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                      ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                      <span class="keyword">break</span>;</span><br><span class="line">                  p = e;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//如果e不为null，说明找到了一个与你插入元素key完全一致的元素，需要替换</span></span><br><span class="line">          <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123; <span class="comment">// existing mapping for key</span></span><br><span class="line">              V oldValue = e.value;</span><br><span class="line">              <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="keyword">null</span>)</span><br><span class="line">                  e.value = value;</span><br><span class="line">              afterNodeAccess(e);</span><br><span class="line">              <span class="keyword">return</span> oldValue;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//让散列表被修改的次数+1</span></span><br><span class="line">      ++modCount;</span><br><span class="line">      <span class="comment">//如果size自增后值大于扩容阈值，则触发扩容。</span></span><br><span class="line">      <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">          resize();</span><br><span class="line">      afterNodeInsertion(evict);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><blockquote><p>总结如下：</p></blockquote><ul><li>先通过hash值计算出key映射到哪个桶</li><li>如果桶上没有Hash冲突，则直接插入</li><li>如果出现hash冲突，则需要处理冲突<ul><li>如果该桶采用红黑树处理冲突，则调用红黑树的方法插入数据。</li><li>否则采用传统的链式方法插入，如果链表长度达到临界值且桶个数达到64个，则把链变为红黑树。</li></ul></li><li>如果桶中存在重复的值，则为该键替换新值value</li><li>如果size大于阈值threshold，则进行扩容</li></ul><blockquote><p>具体方法如下：</p><p>hash(key)，获取key的hash值</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object key)</span></span>&#123;</span><br><span class="line"><span class="keyword">int</span> h;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1)如果key等于null;</span></span><br><span class="line"><span class="comment">可以看到当key等于null的时候也是有哈希值的，返回的是0.</span></span><br><span class="line"><span class="comment">2)如果key不等于null;</span></span><br><span class="line"><span class="comment">首先计算出key的hashCode赋值给h,然后与h无符号右移16位后的二进制进行按位异或得到最后的hash值</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">return</span> (key == <span class="keyword">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在putVal函数中使用了上述hash函数计算出的hash值，根据公式(n - 1) &amp; hash来决定要放入哪个桶中，其中n为HashMap对象中的桶个数（数组长度）。</p><ul><li>&amp;（按位与运算）：运算规则：相同二进制位上，都是1的时候，结果为1，否则为0。</li><li>^（按位异或运算）：运算规则：相同的二进制数位上，数字相同，结果为0，不同则为1。</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">boolean</span> onlyIfAbsent, <span class="keyword">boolean</span> evict)</span></span>&#123;</span><br><span class="line">......</span><br><span class="line"><span class="keyword">if</span>((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="keyword">null</span>)<span class="comment">//这里的n表示数组的长度16</span></span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-4、resize扩容方法分析"><a href="#3-4、resize扩容方法分析" class="headerlink" title="3.4、resize扩容方法分析"></a>3.4、resize扩容方法分析</h3><blockquote><p>为什么需要扩容？</p><p>为了解决因哈希冲突而导致的链化影响查询效率的问题，扩容可以缓解这个问题。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] resize() &#123;</span><br><span class="line">    <span class="comment">//odTab引用未扩容的哈希表</span></span><br><span class="line">    Node&lt;K,V&gt;[] oldTab = table;</span><br><span class="line">    <span class="comment">//oldCap：表示扩容前的table数组长度</span></span><br><span class="line">    <span class="comment">//如果扩容前的table为空，则oldCap = 0</span></span><br><span class="line">    <span class="keyword">int</span> oldCap = (oldTab == <span class="keyword">null</span>) ? <span class="number">0</span> : oldTab.length;</span><br><span class="line">    <span class="comment">//表示扩容前的扩容阈值，触发本词扩容的阈值</span></span><br><span class="line">    <span class="keyword">int</span> oldThr = threshold;</span><br><span class="line">    <span class="comment">//newCap：扩容之后想要达到的大小</span></span><br><span class="line">    <span class="comment">//newThr：扩容后再次触发扩容的条件</span></span><br><span class="line">    <span class="keyword">int</span> newCap, newThr = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//如果oldCap&gt;0，那么证明哈希表中的散列表已经被初始化过了</span></span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//如果扩容前数组长度已经达到HashMap定义的最大值，此时无法扩容</span></span><br><span class="line">        <span class="comment">//将扩容阈值赋值为Integer类型的最大值后返回旧的散列表</span></span><br><span class="line">        <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            threshold = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span> oldTab;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//令newCap = 2 * oldCap，如果扩容后的newCap小于HashMap规定的最小值且原来的oldCap大于等于默认初始化大小，让新的扩容阈值 = 2 * 原来的扩容阈值</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp;</span><br><span class="line">                 oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">            newThr = oldThr &lt;&lt; <span class="number">1</span>; <span class="comment">// double threshold</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//这里和下面两种情况均说明oldCap == 0</span></span><br><span class="line">    <span class="comment">//会执行这一步的情况如下：</span></span><br><span class="line">    <span class="comment">//1 new HashMap(initCap,loadFactory)</span></span><br><span class="line">    <span class="comment">//2 new HashMap(initCap)</span></span><br><span class="line">    <span class="comment">//3 new HashMap(map)，并且这个map有数据</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// initial capacity was placed in threshold</span></span><br><span class="line">        newCap = oldThr;</span><br><span class="line">    <span class="comment">//oldCap == 0</span></span><br><span class="line">    <span class="comment">//执行这一步的情况如下</span></span><br><span class="line">    <span class="comment">//new HashMap()</span></span><br><span class="line">    <span class="keyword">else</span> &#123;               <span class="comment">// zero initial threshold signifies using defaults</span></span><br><span class="line">        newCap = DEFAULT_INITIAL_CAPACITY;<span class="comment">//16</span></span><br><span class="line">        <span class="comment">//12</span></span><br><span class="line">        newThr = (<span class="keyword">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//newThr为0时，通过负载因子和扩容后的容量计算得到结果</span></span><br><span class="line">    <span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">float</span> ft = (<span class="keyword">float</span>)newCap * loadFactor;</span><br><span class="line">        newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="keyword">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">                  (<span class="keyword">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//将扩容阈值设置为newThr</span></span><br><span class="line">    threshold = newThr;</span><br><span class="line">    <span class="comment">//根据newCap创建一个新的Node数组</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span></span><br><span class="line">    Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node[newCap];</span><br><span class="line">    table = newTab;</span><br><span class="line">    <span class="comment">//此条件说明Hashmap在本次扩容之前不为null，里面可能有数据</span></span><br><span class="line">    <span class="keyword">if</span> (oldTab != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">            Node&lt;K,V&gt; e;</span><br><span class="line">            <span class="comment">//说明当前桶位有数据，但具体是单个数据、链表还是树尚未得知</span></span><br><span class="line">            <span class="keyword">if</span> ((e = oldTab[j]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//方便jvm回收内存</span></span><br><span class="line">                oldTab[j] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">//表示该桶位中只有一个元素，从未发生过Hash碰撞</span></span><br><span class="line">                <span class="keyword">if</span> (e.next == <span class="keyword">null</span>)</span><br><span class="line">                    <span class="comment">//直接计算出当前元素应该存放在新数组中的位置，然后放进去</span></span><br><span class="line">                    newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">                <span class="comment">//当前的桶位存放了一个树</span></span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                    ((TreeNode&lt;K,V&gt;)e).split(<span class="keyword">this</span>, newTab, j, oldCap);</span><br><span class="line">                <span class="comment">//桶位已经形成链表</span></span><br><span class="line">                <span class="keyword">else</span> &#123; <span class="comment">// preserve order</span></span><br><span class="line">                    <span class="comment">//低位链表：存放在扩容之后的数组的下标位置，与当前数组的下标位置一致</span></span><br><span class="line">                    Node&lt;K,V&gt; loHead = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="comment">//高位链表：存放再扩容之后的数组的下标位置为当前数组下标位置+扩容之前数组的长度</span></span><br><span class="line">                    Node&lt;K,V&gt; hiHead = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                    Node&lt;K,V&gt; next;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        next = e.next;</span><br><span class="line">                        <span class="comment">//如果等于0，那么证明放在低位桶</span></span><br><span class="line">                        <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (loTail == <span class="keyword">null</span>)</span><br><span class="line">                                loHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                loTail.next = e;</span><br><span class="line">                            loTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">//不为0则放在高位桶</span></span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (hiTail == <span class="keyword">null</span>)</span><br><span class="line">                                hiHead = e;</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hiTail.next = e;</span><br><span class="line">                            hiTail = e;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">while</span> ((e = next) != <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">if</span> (loTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        loTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j] = loHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (hiTail != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        hiTail.next = <span class="keyword">null</span>;</span><br><span class="line">                        newTab[j + oldCap] = hiHead;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>HashMap的扩容是什么?</p></blockquote><ul><li><p><strong>进行扩容，会伴随着一次重新hash分配，并且会遍历hash表中所有的元素，是非常耗时的。在编写程序中，要尽可能避免resize。</strong></p></li><li><p><strong>HashMap在进行扩容时，使用的rehash方式非常巧妙，因为每次扩容都是翻倍，与原来计算的（n-1）&amp;hash的结果相比，只是多了一个bit位，所以节点要么就在原来的位置，要么就被分配到”原位置+旧容量”这个位置。</strong></p></li><li><p><strong>怎么理解呢？例如我们从16扩展为32时，具体的变化如下所示：</strong></p></li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210218232608.png" alt="image-20210218232607701"></p><blockquote><p><strong>扩容之后的索引位要么是原来索引，要么是原来索引+旧数组容量<br>因此元素在重新计算hash之后，因为n变为2倍，那么n-1的标记范围在高位多1bit（红色），因此新的index就会发生这样的变化：</strong></p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210218232714.png" alt="image-20210218232713970"></p><blockquote><p>*说明：5是假设计算出来的原来的索引。这样就验证了上述描述的：扩容之后所以节点要么放在原来的位置，要么被分配到<strong>“原位置+旧容量”**这个位置。<br>因此，我们在扩容HashMap的时候，不需要重新计算hash，只需要看看原来的hash值新增的那个bit是1还是0就可以了，是0的话索引就不变，是1的话索引变成</strong>“原索引+oldCap(原位置+旧容量)”**。可以看看下图为16扩容为32的resize示意图：</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210218232749.png" alt="image-20210218232749785"></p><blockquote><p>正是因为这样巧妙的rehash方式，既省去了重新计算hash值的时间，而且同时，由于新增的1bit是0还是1可以认为是随机的，在resize的过程中保证了rehash之后每个桶上的节点数一定小于等于原来桶上的节点数，保证了rehash之后不会出现更严重的hash冲突，均匀的把之前hash冲突的节点分散到新的桶中了。</p></blockquote><h3 id="3-5、get方法分析"><a href="#3-5、get方法分析" class="headerlink" title="3.5、get方法分析"></a>3.5、get方法分析</h3><blockquote><p>实现思路</p></blockquote><ul><li>计算传入key的hash值</li><li>通过hash值获取该key映射到的桶</li><li>桶上的key正好是要删除的key，则直接找到并返回</li><li>桶商的key不是要找的key，则查看后续节点<ul><li>如果后续节点是红黑树节点，则通过调用红黑树方法根据key获取value</li><li>如果后续节点是链表节点，则通过循环遍历链表根据key获取value</li></ul></li></ul><blockquote><p>get方法中调用了getNode方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = getNode(hash(key), key)) == <span class="keyword">null</span> ? <span class="keyword">null</span> : e.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>getNode方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">getNode</span><span class="params">(<span class="keyword">int</span> hash, Object key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//tab：引用当前HashMap的散列表</span></span><br><span class="line">    <span class="comment">//first：桶位中的头元素</span></span><br><span class="line">    <span class="comment">//e：临时Node元素</span></span><br><span class="line">    <span class="comment">//n：table数组长度</span></span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="keyword">int</span> n; K k;</span><br><span class="line">    <span class="comment">//散列表不为空且table数组中hash对应的桶不为空时才进行取元素</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//说明路由寻址出来的桶的头元素就是要寻找的值</span></span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp; <span class="comment">// always check first node</span></span><br><span class="line">            ((k = first.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="comment">//寻找出来的桶位不是单个元素，且头元素不是我们要找的，此时桶位元素可能是一条链表或一棵红黑树</span></span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//桶位元素升级成了红黑树</span></span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">            <span class="comment">//桶位元素是一条链表</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="comment">//遍历整个链表，找到就返回，否则跳出循环返回null</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-6、remove方法分析"><a href="#3-6、remove方法分析" class="headerlink" title="3.6、remove方法分析"></a>3.6、remove方法分析</h3><blockquote><p>remove方法底层调用了removeNode方法</p><p>思路</p></blockquote><ul><li>根据传入的key计算出key的hash值</li><li>再根据路由寻址公式(n - 1) &amp; hash找到桶的位置<ul><li>如果找到的桶是链表，则遍历链表使用equals方法找到元素后删除，</li><li>如果是红黑树就需要遍历树然后删除元素，桶元素小于6后转为链表。</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">return</span> (e = removeNode(hash(key), key, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>)) == <span class="keyword">null</span> ?</span><br><span class="line">        <span class="keyword">null</span> : e.value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>removeNode方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title">removeNode</span><span class="params">(<span class="keyword">int</span> hash, Object key, Object value,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">boolean</span> matchValue, <span class="keyword">boolean</span> movable)</span> </span>&#123;</span><br><span class="line">       <span class="comment">//tab：引用当前hashMap的散列表</span></span><br><span class="line">       <span class="comment">//p：当前node元素</span></span><br><span class="line">       <span class="comment">//n：表示散列表数组长度</span></span><br><span class="line">       <span class="comment">//index：表示寻址结果</span></span><br><span class="line">       Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="keyword">int</span> n, index;</span><br><span class="line">       <span class="comment">//只有当散列表不为空且table数组中寻址结果对应的桶不为空时，才继续删除</span></span><br><span class="line">       <span class="keyword">if</span> ((tab = table) != <span class="keyword">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">           (p = tab[index = (n - <span class="number">1</span>) &amp; hash]) != <span class="keyword">null</span>) &#123;</span><br><span class="line">           Node&lt;K,V&gt; node = <span class="keyword">null</span>, e; K k; V v;</span><br><span class="line">           <span class="comment">//如果寻址结果对应的桶元素就是要删除的Node，此时将p赋值给node</span></span><br><span class="line">           <span class="keyword">if</span> (p.hash == hash &amp;&amp;</span><br><span class="line">               ((k = p.key) == key || (key != <span class="keyword">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">               node = p;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> ((e = p.next) != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">//表示桶位中的元素是一棵红黑树</span></span><br><span class="line">               <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                   node = ((TreeNode&lt;K,V&gt;)p).getTreeNode(hash, key);</span><br><span class="line">               <span class="comment">//表示桶位中的元素是一条链表</span></span><br><span class="line">               <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">do</span> &#123;</span><br><span class="line">                       <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                           ((k = e.key) == key ||</span><br><span class="line">                            (key != <span class="keyword">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">                           node = e;</span><br><span class="line">                           <span class="keyword">break</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                       p = e;</span><br><span class="line">                   &#125; <span class="keyword">while</span> ((e = e.next) != <span class="keyword">null</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">//上面的代码是为了找到要删除的元素，然后将其赋给node引用</span></span><br><span class="line">           <span class="comment">//当node不为空时进行删除</span></span><br><span class="line">           <span class="keyword">if</span> (node != <span class="keyword">null</span> &amp;&amp; (!matchValue || (v = node.value) == value ||</span><br><span class="line">                                (value != <span class="keyword">null</span> &amp;&amp; value.equals(v)))) &#123;</span><br><span class="line">               <span class="comment">//根据node的类型删除</span></span><br><span class="line">               <span class="comment">//node是一个树节点</span></span><br><span class="line">               <span class="keyword">if</span> (node <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                   ((TreeNode&lt;K,V&gt;)node).removeTreeNode(<span class="keyword">this</span>, tab, movable);</span><br><span class="line">               <span class="comment">//让table[寻址结果]指向node的下一个节点，这个节点可能为空，可能为一个Node</span></span><br><span class="line">               <span class="keyword">else</span> <span class="keyword">if</span> (node == p)</span><br><span class="line">                   tab[index] = node.next;</span><br><span class="line">               <span class="keyword">else</span></span><br><span class="line">                   <span class="comment">//如果node在一条链表中，就按照链表的删除方式删除此node</span></span><br><span class="line">                   p.next = node.next;</span><br><span class="line">               <span class="comment">//modCount++</span></span><br><span class="line">               ++modCount;</span><br><span class="line">               <span class="comment">//散列表中元素个数-1</span></span><br><span class="line">               --size;</span><br><span class="line">               </span><br><span class="line">               afterNodeRemoval(node);</span><br><span class="line">               <span class="keyword">return</span> node;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="3-7、replace方法分析"><a href="#3-7、replace方法分析" class="headerlink" title="3.7、replace方法分析"></a>3.7、replace方法分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">replace</span><span class="params">(K key, V oldValue, V newValue)</span> </span>&#123;</span><br><span class="line">    Node&lt;K,V&gt; e; V v;</span><br><span class="line">    <span class="keyword">if</span> ((e = getNode(hash(key), key)) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        ((v = e.value) == oldValue || (v != <span class="keyword">null</span> &amp;&amp; v.equals(oldValue)))) &#123;</span><br><span class="line">        e.value = newValue;</span><br><span class="line">        afterNodeAccess(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这个replace传入三个参数，只有当key匹配且oldValue等于HashMap中键值对的值时，才使用newValue进行替换。</p></blockquote><p>本文参考自：</p><ul><li><p>[1]  <a href="https://www.bilibili.com/video/BV1LJ411W7dP">小刘讲源码</a></p></li><li><p>[2]  <a href="https://blog.csdn.net/qq_38616503/article/details/111218480">Java进阶之HashMap</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据结构与算法学习（五）-雪花算法生成唯一ID</title>
      <link href="posts/3410178450.html"/>
      <url>posts/3410178450.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>面试题: 集群高并发情况下如何保证分布式唯一全局ID生成?</p></blockquote><h2 id="1、问题"><a href="#1、问题" class="headerlink" title="1、问题"></a>1、问题</h2><h3 id="1-1、为什么需要分布式全局唯一ID以及分布式ID的业务需求"><a href="#1-1、为什么需要分布式全局唯一ID以及分布式ID的业务需求" class="headerlink" title="1.1、为什么需要分布式全局唯一ID以及分布式ID的业务需求"></a>1.1、为什么需要分布式全局唯一ID以及分布式ID的业务需求</h3><blockquote><p>在复杂分布式系统中，往往需要对大量的数据和消息进行唯一标识。</p><p>如在美团点评的金融、支付、餐饮、酒店；</p><p>猫眼电影等产品的系统中数据日渐增长，对数据分库分表后需要有一个唯一ID来表示一条数据或者消息。</p><p>特别一点的如订单、骑手、优惠劵也都需要一个唯一ID做为标识。</p><p>此时一个能<strong>生成唯一ID的系统是非常必要的</strong>。</p></blockquote><h3 id="1-2、ID生成规则部分硬性要求"><a href="#1-2、ID生成规则部分硬性要求" class="headerlink" title="1.2、ID生成规则部分硬性要求"></a>1.2、ID生成规则部分硬性要求</h3><ul><li>全局唯一</li></ul><blockquote><p>既然是唯一标识，那么<strong>全局唯一是最基本的要求</strong>。</p></blockquote><ul><li>趋势递增</li></ul><blockquote><p>在MySQL的InnoDB引擎中使用的是聚集索引，由于多数RDBMS使用Btree的数据结构来存储索引数据，在主键的选择上面我们应该尽量使用有序的主键来保证写入性能。</p></blockquote><ul><li>单调递增</li></ul><blockquote><p>保证下一个ID一定大于上一个ID，例如事务版本号、IM增量消息、排序等特殊需求。</p></blockquote><ul><li>信息安全</li></ul><blockquote><p>如果ID是连续的，那么恶意用户的扒取工作就非常容易做了，直接按照顺序下载指定URL即可；</p><p>如果是订单号那么更加危险，竞争对手可以知道我们一天的单量。</p><p>所以在一些应用场景下，需要ID无规则不规则，让竞争对手不好猜。</p></blockquote><ul><li>含时间戳</li></ul><blockquote><p>这样就能在开发中快速了解这个分布式ID的生成时间。</p></blockquote><h3 id="1-3、ID生成系统的可用性要求"><a href="#1-3、ID生成系统的可用性要求" class="headerlink" title="1.3、ID生成系统的可用性要求"></a>1.3、ID生成系统的可用性要求</h3><ul><li>高可用</li></ul><blockquote><p>发一个获取分布式ID的请求，服务器就要保证99.999%的情况下给我创建一个唯一分布式ID</p></blockquote><ul><li>低延迟</li></ul><blockquote><p>发一个获取分布式ID的请求，服务器就要快，极速</p></blockquote><ul><li>高QPS</li></ul><blockquote><p>假如并发一口气10万个创建分布式ID请求同时过来，服务器需要顶得住且成功创建10万个分布式ID</p></blockquote><h2 id="2、一般通用方案"><a href="#2、一般通用方案" class="headerlink" title="2、一般通用方案"></a>2、一般通用方案</h2><h3 id="2-1、UUID"><a href="#2-1、UUID" class="headerlink" title="2.1、UUID"></a>2.1、UUID</h3><ul><li>是什么？</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    String uuid = UUID.randomUUID().toString();</span><br><span class="line">    System.out.println(uuid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210217110837.png" alt="image-20210217110837065"></p><blockquote><p>如果只是考虑唯一性，那么UUID基本可以满足需求。</p></blockquote><ul><li>缺点：入数据库性能差，原因如下</li></ul><blockquote><p>1 无序，无法预测他的生成顺序，不能生成递增有序的数字</p><p>2 主键，ID作为主键时在特定的环境下会存在一些问题，比如做DB主键的场景下，UUID非常不适用，MySQL官方有明确的建议主键要尽量越短越好，36位的UUID不合要求。</p><p>3 索引，会导致B+树索引的分裂。</p></blockquote><h3 id="2-2、数据库自增主键"><a href="#2-2、数据库自增主键" class="headerlink" title="2.2、数据库自增主键"></a>2.2、数据库自增主键</h3><blockquote><p>在高并发集群上此策略不可用。</p></blockquote><h3 id="2-3、基于Redis生成全局ID策略"><a href="#2-3、基于Redis生成全局ID策略" class="headerlink" title="2.3、基于Redis生成全局ID策略"></a>2.3、基于Redis生成全局ID策略</h3><ul><li>因为Redis是单线程，天生保证原子性，所以可以使用INCR和INCRBY来实现。</li><li>集群分布式</li></ul><blockquote><p>在Redis集群下，同样和MySQL一样需要<strong>设置不同的增长步数</strong>，同时key需要设置有效期。</p><p>可以使用Redis集群来获取更高的吞吐量。</p><p>假如一个集群中有五个Redis，那么初始化每台Redis步长分别是1，2，3，4，5，然后步长都是5。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210217113313.png" alt="image-20210217113312811"></p><h2 id="3、snowflake"><a href="#3、snowflake" class="headerlink" title="3、snowflake"></a>3、snowflake</h2><h3 id="3-1、概述"><a href="#3-1、概述" class="headerlink" title="3.1、概述"></a>3.1、概述</h3><ul><li><p>雪花算法是推特的分布式唯一ID生成算法。</p></li><li><p>经测试雪花算法每秒钟可以生产26万个自增可排序的ID</p></li></ul><blockquote><p>1 推特的雪花算法生成ID能够按照时间有序生成。</p><p>2 雪花算法生成ID的结果是一个64bit大小的整数，为一个Long型（转换为字符串后长度最多19）</p><p>3 分布式系统内不会产生ID碰撞（由datecenter和workerId作区分），并且效率较高。</p></blockquote><ul><li>分布式系统中，有一些需要使用全局唯一ID的场景，生成ID的基本需求</li></ul><blockquote><p>1 分布式环境下必须全局且唯一。</p><p>2 一般都需要单调递增，因为一般唯一ID都会存到数据库，而lnnodb的特性就是将内容存储在主键索引树上的叶子节点，而且是从左往右，递增的，所以考虑到数据库性能，一般生成的id也最好是单调递增。为了防止ID冲突可以使用36位的UUID，但是UUID有一些缺点，首先他相对比较长，另外UUID般是无序的。</p><p>3 可能还会需要无规则，因为如果使用唯一lD作为订单号这种，为了不然别人知道一天的订单量是多少，就需要这个规则。</p></blockquote><h3 id="3-2、结构"><a href="#3-2、结构" class="headerlink" title="3.2、结构"></a>3.2、结构</h3><blockquote><p>雪花算法的几个核心组成部分</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210217114752.png" alt="image-20210217114752319"></p><blockquote><p>号段解析</p></blockquote><ul><li><p>1bit符号位：不用，因为二进制最高位是符号位，1表示负数，0表示正数，生成的id一般都是用正数，所以最高位固定位0</p></li><li><p>41bit时间戳，用于记录时间戳，毫秒级</p><ul><li>41位可以表示2^41 - 1个数字</li><li>如果只用来表示正整数（计算机正数包含0），可以表示的数值范围是0-2^41 - 1，<strong>减一是因为可表示的数值范围是从0开始算的，而不是1</strong></li><li>也就是说41位可以表示2^41 - 1个毫秒的值，转换为单位年则是69年。</li></ul></li><li><p>10bit工作进程位，用于记录工作机器id</p><ul><li>可以部署在2^10 = 1024个节点，包括五位datacenterId和五位workerId</li><li>五位可以表示的最大整数位2^5 - 1 = 31，即可以使用0，1，2…31这32个数字来表示不同的datacenterId和workerId</li></ul></li><li><p>12bit序列号，序列号，用来记录同<strong>毫秒内</strong> 产生的不同的ID</p><ul><li>12bit可以表示的最大正整数位2^12 - 1 = 4095，即可以表示0，1….4094这4095个数字</li><li>表示同一机器同一时间戳（毫秒）中产生的4095个ID序号</li></ul></li></ul><blockquote><p>雪花算法可以保证</p></blockquote><ul><li>所有生成的id按时间趋势递增</li><li>整个分布式内不会产生重复id，因为有datacenterId和workerId来做区分。</li></ul><h3 id="3-3、源码"><a href="#3-3、源码" class="headerlink" title="3.3、源码"></a>3.3、源码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * twitter的snowflake算法 -- java实现</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> beyond</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2016/11/26</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SnowFlake</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 起始的时间戳</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> START_STMP = <span class="number">1480166465631L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每一部分占用的位数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> SEQUENCE_BIT = <span class="number">12</span>; <span class="comment">//序列号占用的位数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MACHINE_BIT = <span class="number">5</span>;   <span class="comment">//机器标识占用的位数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> DATACENTER_BIT = <span class="number">5</span>;<span class="comment">//数据中心占用的位数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每一部分的最大值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MAX_DATACENTER_NUM = -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; DATACENTER_BIT);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MAX_MACHINE_NUM = -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; MACHINE_BIT);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MAX_SEQUENCE = -<span class="number">1L</span> ^ (-<span class="number">1L</span> &lt;&lt; SEQUENCE_BIT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每一部分向左的位移</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> MACHINE_LEFT = SEQUENCE_BIT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> DATACENTER_LEFT = SEQUENCE_BIT + MACHINE_BIT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">long</span> TIMESTMP_LEFT = DATACENTER_LEFT + DATACENTER_BIT;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> datacenterId;  <span class="comment">//数据中心</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> machineId;     <span class="comment">//机器标识</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> sequence = <span class="number">0L</span>; <span class="comment">//序列号</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> lastStmp = -<span class="number">1L</span>;<span class="comment">//上一次时间戳</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SnowFlake</span><span class="params">(<span class="keyword">long</span> datacenterId, <span class="keyword">long</span> machineId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (datacenterId &gt; MAX_DATACENTER_NUM || datacenterId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;datacenterId can&#x27;t be greater than MAX_DATACENTER_NUM or less than 0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (machineId &gt; MAX_MACHINE_NUM || machineId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;machineId can&#x27;t be greater than MAX_MACHINE_NUM or less than 0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.datacenterId = datacenterId;</span><br><span class="line">        <span class="keyword">this</span>.machineId = machineId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 产生下一个ID</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> <span class="title">nextId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> currStmp = getNewstmp();</span><br><span class="line">        <span class="keyword">if</span> (currStmp &lt; lastStmp) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Clock moved backwards.  Refusing to generate id&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currStmp == lastStmp) &#123;</span><br><span class="line">            <span class="comment">//相同毫秒内，序列号自增</span></span><br><span class="line">            sequence = (sequence + <span class="number">1</span>) &amp; MAX_SEQUENCE;</span><br><span class="line">            <span class="comment">//同一毫秒的序列数已经达到最大</span></span><br><span class="line">            <span class="keyword">if</span> (sequence == <span class="number">0L</span>) &#123;</span><br><span class="line">                currStmp = getNextMill();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//不同毫秒内，序列号置为0</span></span><br><span class="line">            sequence = <span class="number">0L</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastStmp = currStmp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (currStmp - START_STMP) &lt;&lt; TIMESTMP_LEFT <span class="comment">//时间戳部分</span></span><br><span class="line">                | datacenterId &lt;&lt; DATACENTER_LEFT       <span class="comment">//数据中心部分</span></span><br><span class="line">                | machineId &lt;&lt; MACHINE_LEFT             <span class="comment">//机器标识部分</span></span><br><span class="line">                | sequence;                             <span class="comment">//序列号部分</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getNextMill</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> mill = getNewstmp();</span><br><span class="line">        <span class="keyword">while</span> (mill &lt;= lastStmp) &#123;</span><br><span class="line">            mill = getNewstmp();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mill;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getNewstmp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SnowFlake snowFlake = <span class="keyword">new</span> SnowFlake(<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (<span class="number">1</span> &lt;&lt; <span class="number">12</span>); i++) &#123;</span><br><span class="line">            System.out.println(snowFlake.nextId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>测试，使用雪花算法生成id</p></blockquote><ul><li>构造SnowFlake对象，构造方法中传入一个datacenterId和workerId</li><li>使用SnowFlake对象的nextId方法生成唯一Id</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//测试使用雪花算法生成ID</span></span><br><span class="line"><span class="comment">//构造函数中传入datacenterId和workerId</span></span><br><span class="line">SnowFlake snowFlake = <span class="keyword">new</span> SnowFlake(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">long</span> id = snowFlake.nextId();</span><br><span class="line">    System.out.println(<span class="string">&quot;id：&quot;</span> + id + <span class="string">&quot;\t&quot;</span> + String.valueOf(id).length() + <span class="string">&quot;位&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;------------------------------------------&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210217143342.png" alt="image-20210217143341390"></p><h3 id="3-4、Spring-Boot整合雪花算法"><a href="#3-4、Spring-Boot整合雪花算法" class="headerlink" title="3.4、Spring Boot整合雪花算法"></a>3.4、Spring Boot整合雪花算法</h3><blockquote><p>引入<strong>hutool-all</strong>，maven依赖引入如下</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.hutool<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hutool-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>使用SnowFlake对象的nextId方法即可生成唯一ID</p></blockquote><ul><li>创建一个SnowFlake配置类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SnowFlakeConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;application.datacenterId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long datacenterId;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;application.workerId&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long workerId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 注入一个生成雪花ID的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Snowflake <span class="title">snowflake</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Snowflake(workerId,datacenterId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>yml配置文件</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">application:</span></span><br><span class="line">  <span class="attr">datacenterId:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">workerId:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7777</span></span><br></pre></td></tr></table></figure><ul><li>Service层</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Snowflake snowflake;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getIdBySnowFlake</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.valueOf(snowflake.nextId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Controller层</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/snowflake&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderService.getIdBySnowFlake();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>启动主启动类，访问<a href="http://localhost:7777/snowflake">http://localhost:7777/snowflake</a></li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210217151414.png" alt="image-20210217151414112"></p><h3 id="3-4、优点"><a href="#3-4、优点" class="headerlink" title="3.4、优点"></a>3.4、优点</h3><blockquote><ul><li>毫秒数在高位，自增序列在低位，整个ID都是趋势递增的</li><li>不依赖数据库、redis等第三方系统，以服务的方式部署，稳定性更高，生成ID的性能也是非常高的。</li><li>可以根据自身业务分配bit位，非常灵活。</li></ul></blockquote><h3 id="3-5、缺点"><a href="#3-5、缺点" class="headerlink" title="3.5、缺点"></a>3.5、缺点</h3><blockquote><ul><li><strong>依赖机器时钟，如果机器时钟回退，会导致重复ID生成</strong></li><li>在单机上是递增的，但是由于设计到分布式环境，每台机器上的时钟不可能完全同步，有时候会出现不是全局递增的情况。（此缺点可以认为芜锁胃，一般分布式ID只要求趋势递增，并不会严格要求递增，90%的需求都只需要趋势递增）</li></ul></blockquote><h2 id="4、其他补充"><a href="#4、其他补充" class="headerlink" title="4、其他补充"></a>4、其他补充</h2><blockquote><p>雪花算法的改进方案：</p></blockquote><ul><li>百度开源的分布式唯一ID生成器UidGenerator</li><li>Leaf–美团点评分布式ID生成系统</li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
            <tag> ❄雪花算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Cloud学习（五）-Nacos服务注册与配置中心</title>
      <link href="posts/87309235.html"/>
      <url>posts/87309235.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、Nacos简介"><a href="#一、Nacos简介" class="headerlink" title="一、Nacos简介"></a>一、Nacos简介</h1><h2 id="1-1、为什么叫Nacos？"><a href="#1-1、为什么叫Nacos？" class="headerlink" title="1.1、为什么叫Nacos？"></a>1.1、为什么叫Nacos？</h2><blockquote><p>前四个字母分别为Naming和Configuration的前两个字母，最后的s为Service。</p></blockquote><h2 id="1-2、是什么？"><a href="#1-2、是什么？" class="headerlink" title="1.2、是什么？"></a>1.2、是什么？</h2><blockquote><p>一个更易于构建云原生应用的动态服务发现，配置管理和服务管理中心</p><p><strong>Nacos</strong>就是<strong>注册中心</strong>+<strong>配置中心</strong>的组合</p></blockquote><h2 id="1-3、能干嘛？"><a href="#1-3、能干嘛？" class="headerlink" title="1.3、能干嘛？"></a>1.3、能干嘛？</h2><blockquote><p>替代Eureka做服务注册中心</p><p>替代Config做微服务配置中心</p></blockquote><h1 id="二、安装并运行Nacos"><a href="#二、安装并运行Nacos" class="headerlink" title="二、安装并运行Nacos"></a>二、安装并运行Nacos</h1><blockquote><p>进入Nacos的官网下载，地址：<a href="http://nacos.io/">http://nacos.io</a></p></blockquote><ul><li>启动，打开nacos/bin，windows环境下点击startup.cmd启动nacos</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215154748.png" alt="image-20210215154741130"></p><ul><li>启动后访问localhost:8848/nacos启动nacos</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215154854.png" alt="image-20210215154854073"></p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215154937.png" alt="image-20210215154937350"></p><ul><li>登录后页面如下</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215155000.png" alt="image-20210215155000197"></p><h1 id="三、Nacos作为服务注册中心演示"><a href="#三、Nacos作为服务注册中心演示" class="headerlink" title="三、Nacos作为服务注册中心演示"></a>三、Nacos作为服务注册中心演示</h1><h2 id="3-1、创建基于Nacos的服务提供者"><a href="#3-1、创建基于Nacos的服务提供者" class="headerlink" title="3.1、创建基于Nacos的服务提供者"></a>3.1、创建基于Nacos的服务提供者</h2><h3 id="1、新建Module"><a href="#1、新建Module" class="headerlink" title="1、新建Module"></a>1、新建Module</h3><blockquote><p>新建cloudalibaba-provider-payment9001</p></blockquote><h3 id="2、引入依赖"><a href="#2、引入依赖" class="headerlink" title="2、引入依赖"></a>2、引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.62<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3、编写yml配置文件"><a href="#3、编写yml配置文件" class="headerlink" title="3、编写yml配置文件"></a>3、编写yml配置文件</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-provider</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span> <span class="comment">#配置Nacos地址</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="4、主启动类"><a href="#4、主启动类" class="headerlink" title="4、主启动类"></a>4、主启动类</h3><blockquote><p>在需要注册入注册中心的模块主启动类上添加@EnableDiscoveryClient注解</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentMain9001</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentMain9001.class,args);</span><br><span class="line">        System.out.println(<span class="string">&quot;http://localhost:8848/nacos&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5、业务类"><a href="#5、业务类" class="headerlink" title="5、业务类"></a>5、业务类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/payment/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPayment</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;nacos registry, serverPort: &quot;</span>+ serverPort+<span class="string">&quot;\t id&quot;</span>+id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6、启动9001微服务，查看nacos控制台"><a href="#6、启动9001微服务，查看nacos控制台" class="headerlink" title="6、启动9001微服务，查看nacos控制台"></a>6、启动9001微服务，查看nacos控制台</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215161607.png" alt="image-20210215161605817"></p><h3 id="7、仿照9001创建9002微服务，启动查看结果"><a href="#7、仿照9001创建9002微服务，启动查看结果" class="headerlink" title="7、仿照9001创建9002微服务，启动查看结果"></a>7、仿照9001创建9002微服务，启动查看结果</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215162714.png" alt="image-20210215162714116"></p><h2 id="3-2、创建基于Nacos的服务消费者"><a href="#3-2、创建基于Nacos的服务消费者" class="headerlink" title="3.2、创建基于Nacos的服务消费者"></a>3.2、创建基于Nacos的服务消费者</h2><h3 id="1、新建Module-1"><a href="#1、新建Module-1" class="headerlink" title="1、新建Module"></a>1、新建Module</h3><blockquote><p>新建cloudalibaba-consumer-nacos-order83</p></blockquote><h3 id="2、引入依赖-1"><a href="#2、引入依赖-1" class="headerlink" title="2、引入依赖"></a>2、引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--SpringCloud ailibaba nacos --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cloudstudy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>为什么Nacos支持负载均衡?</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215164039.png" alt="image-20210215164039536"></p><h3 id="3、编写yml配置文件-1"><a href="#3、编写yml配置文件-1" class="headerlink" title="3、编写yml配置文件"></a>3、编写yml配置文件</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">83</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-consumer</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line"><span class="comment"># 消费者要访问的服务提供者。</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">nacos-user-service:</span> <span class="string">http://nacos-payment-provider</span></span><br></pre></td></tr></table></figure><h3 id="4、主启动类-1"><a href="#4、主启动类-1" class="headerlink" title="4、主启动类"></a>4、主启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderNacosMain83</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderNacosMain83.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5、业务类-1"><a href="#5、业务类-1" class="headerlink" title="5、业务类"></a>5、业务类</h3><blockquote><p>OrderNacosController</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderNacosController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;service-url.nacos-user-service&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverURL;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/consumer/payment/nacos/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(serverURL+<span class="string">&quot;/payment/nacos/&quot;</span>+id,String.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ApplicationContextConfig</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContextConfig</span></span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6、启动83微服务，查看nacos控制台"><a href="#6、启动83微服务，查看nacos控制台" class="headerlink" title="6、启动83微服务，查看nacos控制台"></a>6、启动83微服务，查看nacos控制台</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215165717.png" alt="image-20210215165716365"></p><h3 id="7、使用83消费者调用服务提供方"><a href="#7、使用83消费者调用服务提供方" class="headerlink" title="7、使用83消费者调用服务提供方"></a>7、使用83消费者调用服务提供方</h3><blockquote><p>访问<a href="http://localhost:83/consumer/payment/nacos/13">http://localhost:83/consumer/payment/nacos/13</a></p></blockquote><ul><li>第一次</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215165922.png" alt="image-20210215165922630"></p><ul><li>第二次</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215165950.png" alt="image-20210215165950241"></p><blockquote><p>这样就实现了负载均衡和远程调用</p></blockquote><h2 id="3-3、各种服务注册中心对比"><a href="#3-3、各种服务注册中心对比" class="headerlink" title="3.3、各种服务注册中心对比"></a>3.3、各种服务注册中心对比</h2><h3 id="1、Nacos全景图"><a href="#1、Nacos全景图" class="headerlink" title="1、Nacos全景图"></a>1、Nacos全景图</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215171620.png" alt="img"></p><h3 id="2、Nacos和CAP"><a href="#2、Nacos和CAP" class="headerlink" title="2、Nacos和CAP"></a>2、Nacos和CAP</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215171729.png" alt="image-20210215171729262"></p><h1 id="四、Nacos作为服务配置中心演示"><a href="#四、Nacos作为服务配置中心演示" class="headerlink" title="四、Nacos作为服务配置中心演示"></a>四、Nacos作为服务配置中心演示</h1><h2 id="4-1、Nacos作为配置中心–基础配置"><a href="#4-1、Nacos作为配置中心–基础配置" class="headerlink" title="4.1、Nacos作为配置中心–基础配置"></a>4.1、Nacos作为配置中心–基础配置</h2><h3 id="1、新建Module-2"><a href="#1、新建Module-2" class="headerlink" title="1、新建Module"></a>1、新建Module</h3><blockquote><p>创建微服务模块：cloudalibaba-config-nacos-client3377</p></blockquote><h3 id="2、引入依赖-2"><a href="#2、引入依赖-2" class="headerlink" title="2、引入依赖"></a>2、引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-devtools --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.projectlombok/lombok --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-test --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3、编写yml配置文件-2"><a href="#3、编写yml配置文件-2" class="headerlink" title="3、编写yml配置文件"></a>3、编写yml配置文件</h3><blockquote><p>bootstrap.yml</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nacos配置</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-client</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="comment"># Nacos服务注册中心地址</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="comment"># 指定Nacos配置中心的地址</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">localhost:8848</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span> <span class="comment"># 指定yaml格式的配置</span></span><br></pre></td></tr></table></figure><blockquote><p>application.yml</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="comment"># 表示开发环境</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure><blockquote><p>为何编写两个配置文件？</p><p>Nacos同Spring Cloud Config一致，在项目初始化时，要保证先从配置中心进行配置拉取，拉取配置后，才能保证项目的正常启动。</p><p>Spring Boot中配置文件的加载是存在优先级顺序的，<strong>bootstrap（全局）优先级高于application（自定义）</strong></p></blockquote><h3 id="4、主启动类-2"><a href="#4、主启动类-2" class="headerlink" title="4、主启动类"></a>4、主启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosConfigClientMain3377</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(NacosConfigClientMain3377.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5、业务类-2"><a href="#5、业务类-2" class="headerlink" title="5、业务类"></a>5、业务类</h3><blockquote><p>@RefreshScope注解用于动态刷新，作用在Controller层</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.context.config.annotation.RefreshScope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigClientController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="meta">@Value(&quot;$&#123;config.info&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/config/info&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getConfigInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6、Nacos的配置规则"><a href="#6、Nacos的配置规则" class="headerlink" title="6、Nacos的配置规则"></a>6、Nacos的配置规则</h3><ul><li>理论：Nacos中的dataid的组成格式与SpringBoot配置文件中的匹配规则</li></ul><blockquote><p>说明：之所以要配置<em>spring.application.name</em> ，示音为它是构成Nacos配置管理<em>dataId</em>字段的一部分。</p><p>在Nacos Spring Cloud中，dataId的完整格式如下</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;prefix&#125;-$&#123;spring.profile.active&#125;.$&#123;file-extension&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>prefix</strong> 默认为 <strong>spring.application.name</strong> 的值，也可以通过配置项 <strong>spring.cloud.nacos.config.prefix</strong> 来配置。</li><li><strong>spring.profile.active</strong> 即为当前环境对于的profile，详情可以参考 <a href="https://www.docs4dev.com/docs/zh/spring-boot/2.1.1.RELEASE/reference">Spring Boot文档</a> 注意：当<strong>spring.profile.active</strong> 为空时，对应的 <strong>-</strong> 也将不存在，此时dataId的拼接格式变为 <strong>${prefix}-${file-extension}</strong> ，<strong>file-extension</strong> 为配置内容的数据格式，可以通过配置项 <strong>spring.cloud.nacos.config.file-extension</strong> 来配置，目前只支持<strong>properties</strong>  和 <strong>yaml</strong> 类型。</li><li>通过Spring Cloud原生注解 <strong>@RefreshScope</strong> 实现配置自动更新。</li></ul><blockquote><p>最后公式为：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;spring.application.name&#125;-$&#123;spring.profile.active&#125;.$&#123;file-extension&#125;</span><br></pre></td></tr></table></figure><blockquote><p>根据上面的公式，我们可以得到cloudalibaba-config-nacos-client3377微服务配置的dataId为：<strong>nacos-config-client-dev.yaml</strong></p></blockquote><h3 id="7、实操"><a href="#7、实操" class="headerlink" title="7、实操"></a>7、实操</h3><blockquote><p>在nacos控制台中选择<strong>配置管理</strong>-<strong>配置列表</strong>，点击“+”号添加配置</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215203233.png" alt="image-20210215203231682"></p><blockquote><p>添加的配置如下：</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215203636.png" alt="image-20210215203636355"></p><h3 id="8、测试"><a href="#8、测试" class="headerlink" title="8、测试"></a>8、测试</h3><blockquote><p>运行cloudalibaba-config-nacos-client3377微服务，调用接口查看配置信息，接口地址为：<a href="http://localhost:3377/config/info">http://localhost:3377/config/info</a></p></blockquote><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215205027.png" alt="image-20210215205027075"></p><h3 id="9、配置的动态刷新"><a href="#9、配置的动态刷新" class="headerlink" title="9、配置的动态刷新"></a>9、配置的动态刷新</h3><blockquote><p>修改下Nacos中的yaml配置文件，再次调用查看配置的端口，就会发现配置已经刷新。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215210048.png" alt="image-20210215210048752"></p><blockquote><p>重新调用查看配置的接口，查看配置</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215210140.png" alt="image-20210215210140349"></p><h2 id="4-2、Nacos作为配置中心–分类配置"><a href="#4-2、Nacos作为配置中心–分类配置" class="headerlink" title="4.2、Nacos作为配置中心–分类配置"></a>4.2、Nacos作为配置中心–分类配置</h2><h3 id="1、问题一"><a href="#1、问题一" class="headerlink" title="1、问题一"></a>1、问题一</h3><blockquote><p>实际开发中，通常一个系统会准备</p><ul><li>dev开发环境</li><li>test测试环境</li><li>prod生产环境</li></ul><p>如何保证指定环境启动时服务能正确读取到Nacos上相应环境的配置文件呢？</p></blockquote><h3 id="2、问题二"><a href="#2、问题二" class="headerlink" title="2、问题二"></a>2、问题二</h3><blockquote><p>一个大型分布式微服务系统会有很多个微服务子项目</p><p>每个微服务又有对应的开发环境、预发环境、测试环境、正式环境…</p><p>那么又怎么对这些配置进行处理呢？</p></blockquote><h3 id="3、什么是分类配置？"><a href="#3、什么是分类配置？" class="headerlink" title="3、什么是分类配置？"></a>3、什么是分类配置？</h3><blockquote><p>类似Java中的package + 类名</p><p>最外层的namespace用于区别部署环境，Group和DataId从逻辑上区分两个对象</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215212745.png" alt="image-20210215212745121"></p><blockquote><p>默认情况下</p></blockquote><ul><li>Namespace=public</li><li>Group=DEFAULT_GROUP</li></ul><blockquote><p>Nacos默认的命名空间为public，Namespace主要用来隔离，比如说我们有三个（生产、开发、测试）环境，那么我们就可以创建三个Namespace，不同的Namespace之间是隔离的。</p><p>Group默认是DEFAULT_GROUP，Group可以把不同微服务划分到一个分组中。</p><p>Service就是微服务，一个Service可以包括多个Cluster（集群），Nacos默认Cluster是Default，Cluster是对指定微服务的一个虚拟划分。</p><p>比如说为了容灾，将Service微服务分别部署在了杭州机房和广州机房，这个时候给杭州机房的Service微服务起一个集群名称（HZ），给广州计方的Service微服务起一个集群名称（GZ），还可以尽量让同一个机房中的微服务相互调用，提升性能。</p><p>Instance：微服务实例</p></blockquote><h3 id="4、通过DataId读取不同配置"><a href="#4、通过DataId读取不同配置" class="headerlink" title="4、通过DataId读取不同配置"></a>4、通过DataId读取不同配置</h3><blockquote><p>默认空间+默认分组+新建dev和test两个DataId</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215233720.png" alt="image-20210215233719100"></p><ul><li>修改3377微服务的application.yml配置文件，指定记载环境</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="comment"># 配置什么环境就加载什么配置</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">test</span></span><br><span class="line">  <span class="comment"># 表示开发环境</span></span><br><span class="line">    <span class="comment"># active: dev</span></span><br></pre></td></tr></table></figure><blockquote><p>此时读取的配置的DataId为 <strong>nacos-config-client-test.yaml</strong> ，配置为</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215234528.png" alt="image-20210215234528455"></p><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215234506.png" alt="image-20210215234506773"></p><h3 id="5、通过Group读取不同配置"><a href="#5、通过Group读取不同配置" class="headerlink" title="5、通过Group读取不同配置"></a>5、通过Group读取不同配置</h3><blockquote><p>新建一个开发组DEV_GROUP</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210215235657.png" alt="image-20210215235657328"></p><blockquote><p>新建一个测试组TEST_GROUP</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210216000114.png" alt="image-20210216000114864"></p><blockquote><p>此时配置列表如下，两个不同组有相同DataId的配置</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210216000529.png" alt="image-20210216000529294"></p><blockquote><p>在bootstrap.yml配置文件中添加一条配置，指定要加载的配置组</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="comment"># 配置哪个组就加载哪个组</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">TEST_GROUP</span></span><br></pre></td></tr></table></figure><blockquote><p>同时修改application.yml配置文件中启动的环境</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="comment"># 配置什么环境就加载什么配置</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">info</span></span><br><span class="line">  <span class="comment"># 表示开发环境</span></span><br><span class="line">    <span class="comment"># active: dev</span></span><br></pre></td></tr></table></figure><blockquote><p>重启3377，访问<a href="http://localhost:3377/config/info">http://localhost:3377/config/info</a> ，结果如下</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210216001128.png" alt="image-20210216001128542"></p><blockquote><p>修改bootstrap.yml配置文件，重启</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="comment"># 配置哪个组就加载哪个组</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEV_GROUP</span></span><br></pre></td></tr></table></figure><blockquote><p>结果为：</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210216001326.png" alt="image-20210216001326298"></p><h3 id="6、通过Namespace读取不同配置"><a href="#6、通过Namespace读取不同配置" class="headerlink" title="6、通过Namespace读取不同配置"></a>6、通过Namespace读取不同配置</h3><blockquote><p>默认的namespace不能删除，新建DEV/TEST命名空间</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210216001648.png" alt="image-20210216001648259"></p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210216001734.png" alt="image-20210216001734240"></p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210216002033.png" alt="image-20210216002033214"></p><blockquote><p>切换到dev namespace，新建三个分组，分组中配置DataId一致。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210216002615.png" alt="image-20210216002615825"></p><blockquote><p>切换namespace，在bootstrap.yml配置文件中添加如下配置，同时修改application.yml中配置环境为dev：</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">namespace:</span> <span class="string">a9ec0b1e-e254-4b99-84ec-fa4ca62bf5a6</span></span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210216003211.png" alt="image-20210216003211534"></p><h1 id="五、Nacos集群和持久化配置（重要）"><a href="#五、Nacos集群和持久化配置（重要）" class="headerlink" title="五、Nacos集群和持久化配置（重要）"></a>五、Nacos集群和持久化配置（重要）</h1><h2 id="5-1、官网说明"><a href="#5-1、官网说明" class="headerlink" title="5.1、官网说明"></a>5.1、官网说明</h2><h3 id="1、官网文档"><a href="#1、官网文档" class="headerlink" title="1、官网文档"></a>1、官网文档</h3><blockquote><p><a href="https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html">https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html</a></p></blockquote><h3 id="2、官网架构图"><a href="#2、官网架构图" class="headerlink" title="2、官网架构图"></a>2、官网架构图</h3><blockquote><p>VIP：virtual IP，虚拟IP，也就是nginx</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210216111649.png" alt="img"></p><h3 id="3、根据官网翻译，我们可得以下架构图"><a href="#3、根据官网翻译，我们可得以下架构图" class="headerlink" title="3、根据官网翻译，我们可得以下架构图"></a>3、根据官网翻译，我们可得以下架构图</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210216112702.jpg" alt="未命名文件 (1)"></p><h3 id="4、说明"><a href="#4、说明" class="headerlink" title="4、说明"></a>4、说明</h3><blockquote><p>按照上面的架构图，我们需要Mysql数据库；</p><p>默认Nacos使用嵌入式数据库实现了数据的存储。所以，如果启动多个默认配置的Nacos节点，数据存储是存在一致性问题的。为了解决这个问题，Nacos采用了<strong>集中式存储的方式支持集群体部署，目前只支持MySQL的存储。</strong></p></blockquote><h2 id="5-2、Nacos持久化配置解释"><a href="#5-2、Nacos持久化配置解释" class="headerlink" title="5.2、Nacos持久化配置解释"></a>5.2、Nacos持久化配置解释</h2><h3 id="1、Nacos自带了嵌入式数据库"><a href="#1、Nacos自带了嵌入式数据库" class="headerlink" title="1、Nacos自带了嵌入式数据库"></a>1、Nacos自带了嵌入式数据库</h3><blockquote><p>Nacos默认自带<strong>嵌入式数据库derby</strong>，打开Nacos的依赖坐标：<a href="https://github.com/alibaba/nacos/blob/develop/config/pom.xml">https://github.com/alibaba/nacos/blob/develop/config/pom.xml</a></p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210216114401.png" alt="image-20210216114401758"></p><blockquote><p>但当我们做Nacos集群时，每个Nacos都各自带着一个derby嵌入式数据库，此时会出现持久化数据不一致的问题，此时我们引入外部的MySQL数据库，将配置数据持久化到MySQL中。 </p></blockquote><h3 id="2、derby到MySQL切换配置步骤"><a href="#2、derby到MySQL切换配置步骤" class="headerlink" title="2、derby到MySQL切换配置步骤"></a>2、derby到MySQL切换配置步骤</h3><blockquote><p>在<strong>nacos-server-1.1.4\nacos\conf</strong>目录下找到并执行 <strong>nacos-mysql.sql</strong> 脚本</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210216115406.png" alt="image-20210216115406872"></p><blockquote><p>在<strong>nacos-server-1.1.4\nacos\conf</strong>目录下找到<strong>application.properties</strong>，增加支持mysql数据源配置，添加mysql数据库的url、用户名和密码</p><p>注：nacos默认不支持mysql8.0，如需支持8.0，需要下载mysql8.0驱动进行更换。</p></blockquote><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将持久化配置从derby迁移到mysql配置</span></span><br><span class="line"><span class="meta">spring.datasource.platform</span>=<span class="string">mysql</span></span><br><span class="line"></span><br><span class="line"><span class="meta">db.num</span>=<span class="string">1</span></span><br><span class="line"><span class="meta">db.url.0</span>=<span class="string">jdbc:mysql://localhost:3306/nacos_config?&amp;connectTimeout=10000&amp;socketTimeout=30000&amp;serverTimezone=GMT%2B8</span></span><br><span class="line"><span class="meta">db.user</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">db.password</span>=<span class="string">tianxin1230.</span></span><br></pre></td></tr></table></figure><blockquote><p>重启Nacos，可以看到是个全新的空记录页面</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Spring Cloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Cloud学习（四）-Eureka服务注册中心</title>
      <link href="posts/995752607.html"/>
      <url>posts/995752607.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、Eureka基础知识"><a href="#一、Eureka基础知识" class="headerlink" title="一、Eureka基础知识"></a>一、Eureka基础知识</h1><h2 id="1-1、什么是服务治理"><a href="#1-1、什么是服务治理" class="headerlink" title="1.1、什么是服务治理"></a>1.1、什么是服务治理</h2><blockquote><p>Spring Cloud 封装了Netflix公司开发的Eureka模块来实现服务治理</p><p>在传统的rpc远程调用框架中，管理每个服务与服务之间依赖关系比较复杂，管理比较复杂，所以需要使用服务治理，管理服务于服务之间依赖关系，可以实现服务调用、负载均衡、容错等，实现服务发现与注册。</p></blockquote><h2 id="1-2、什么是服务注册"><a href="#1-2、什么是服务注册" class="headerlink" title="1.2、什么是服务注册"></a>1.2、什么是服务注册</h2><blockquote><p>​        Eureka采用了CS的设计架构，Eureka Server作为服务注册功能的服务器，它是服务注册中心。而系统中的其他微服务，使用Eureka的客户端连接到Eureka Server并维持心跳连接。这样系统的维护人员就可以通过Eureka Server来监控系统中各个微服务是否正常运行。</p><p>​        在服务注册与发现中，有一个注册中心。当服务器启动的时候，会把当前自己服务器的信息比如服务地址通讯地址等以别名方式注册到注册中心上。另一方（消费者服务提供者），以该别名的方式去注册中心上获取到实际的服务通讯地址，然后再实现本地RPC调用RPC远程调用框架核心设计思想：在于注册中心，因为使用注册中心管理每个服务与服务之间的一个依赖关系（服务治理概念）。在任何rpc远程框架中，都会有一个注册中心（存放服务地址相关信息（接口地址））</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214161851.png" alt="img"></p><h2 id="1-3、Eureka两组件"><a href="#1-3、Eureka两组件" class="headerlink" title="1.3、Eureka两组件"></a>1.3、Eureka两组件</h2><blockquote><p>Eureka包括两个组件：Eureka Server和Eureka Client，其中</p></blockquote><ul><li><strong>Eureka Server提供服务注册服务</strong>，各个微服务节点通过配置启动后，会在Eureka Server中进行注册，这样Eureka Server中的服务注册表将会存储所有可用服务节点的信息，服务节点的信息可以在界面中直观看到。</li><li><strong>Eureka Client通过服务注册中心访问</strong>，是一个Java客户端，用于简化Eureka Server的交互，客户端同时也具备一个内置的、使用轮询（Round-robin）负载算法的负载均衡器。在应用启动后，将会向Eureka Server发送心跳（默认时间周期为30s）。如果Eureka Server在多个心跳周期内没有接收到某个节点的心跳，Eureka Server将会从注册服务表中把这个服务节点移除（默认为90s）。</li></ul><h1 id="二、单击Eureka构建步骤"><a href="#二、单击Eureka构建步骤" class="headerlink" title="二、单击Eureka构建步骤"></a>二、单击Eureka构建步骤</h1><h2 id="2-1、创建cloud-eureka-server-7001"><a href="#2-1、创建cloud-eureka-server-7001" class="headerlink" title="2.1、创建cloud-eureka-server-7001"></a>2.1、创建cloud-eureka-server-7001</h2><blockquote><p>这个微服务就是eureka Server服务注册中心，为其他微服务提供服务注册。</p></blockquote><h2 id="2-2、引入依赖"><a href="#2-2、引入依赖" class="headerlink" title="2.2、引入依赖"></a>2.2、引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-eureka-server --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cloudstudy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-web  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-devtools --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-test --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>Eureka 1.x和Eureka 2.x的区别</p></blockquote><ul><li>Eureka 1.x 老版本，依赖中不分服务端和客户端</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-eureka<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>Eureka 2.x 新版本</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2-3、编写yml配置文件"><a href="#2-3、编写yml配置文件" class="headerlink" title="2.3、编写yml配置文件"></a>2.3、编写yml配置文件</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">erver:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">  <span class="comment"># 表示不向服务注册中心注册自己</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 表示自己就是服务注册中心，职责是维护服务实例，并不需要去检索服务</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br></pre></td></tr></table></figure><h2 id="2-4、主启动类"><a href="#2-4、主启动类" class="headerlink" title="2.4、主启动类"></a>2.4、主启动类</h2><blockquote><p>在主启动类上添加@EnableEurekaServer注解，表示这个微服务为服务注册中心。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServer7001</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaServer7001.class,args);</span><br><span class="line">        System.out.println(<span class="string">&quot;http://localhost:7001&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-5、启动eureka7001"><a href="#2-5、启动eureka7001" class="headerlink" title="2.5、启动eureka7001"></a>2.5、启动eureka7001</h2><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214171752.png" alt="image-20210214171751846"></p><h2 id="2-6、修改payment8001和order80"><a href="#2-6、修改payment8001和order80" class="headerlink" title="2.6、修改payment8001和order80"></a>2.6、修改payment8001和order80</h2><blockquote><p>引入eureka Client依赖</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>在yml配置文件中添加配置</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka</span></span><br></pre></td></tr></table></figure><blockquote><p>在payment8001、order80主启动类上添加注解</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br></pre></td></tr></table></figure><blockquote><p>启动payment8001、order80</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214173444.png" alt="image-20210214173444635"></p><blockquote><p>Eureka Server列表中会显示已经注册入注册中心的微服务的spring.application.name</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214173637.png" alt="image-20210214173637695"></p><h1 id="三、集群Eureka构建步骤"><a href="#三、集群Eureka构建步骤" class="headerlink" title="三、集群Eureka构建步骤"></a>三、集群Eureka构建步骤</h1><h2 id="3-1、单机eureka存在的问题"><a href="#3-1、单机eureka存在的问题" class="headerlink" title="3.1、单机eureka存在的问题"></a>3.1、单机eureka存在的问题</h2><blockquote><p><strong>微服务RPC远程服务调用最核心的是什么？</strong></p><ul><li>高可用，如果注册中心为单机，那么一旦它出现故障，就会导致整个系统不可用。</li></ul><p><strong>解决方法</strong></p><ul><li>搭建Eureka注册中心集群，实现负载均衡+故障容错</li></ul></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214181019.png" alt="img"></p><h2 id="3-2、eureka集群的实质"><a href="#3-2、eureka集群的实质" class="headerlink" title="3.2、eureka集群的实质"></a>3.2、eureka集群的实质</h2><blockquote><p>互相注册，相互守望。</p><p>集群中的每一台eureka Server要有<strong>除自己之外的所有eureka server</strong>的信息。</p></blockquote><h2 id="3-3、新建Eureka-7002微服务"><a href="#3-3、新建Eureka-7002微服务" class="headerlink" title="3.3、新建Eureka 7002微服务"></a>3.3、新建Eureka 7002微服务</h2><blockquote><p>修改本地hosts文件，添加域名和ip映射</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># My hosts</span><br><span class="line">127.0.0.1 eureka7001.com</span><br><span class="line">127.0.0.1 eureka7002.com</span><br></pre></td></tr></table></figure><blockquote><p>由于依赖、主启动类与7001类似，所以这里只给出yml配置文件</p><p>此时需要修改一下7001的配置文件</p></blockquote><ul><li>7001</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="comment">#集群时7001需要注册到7002</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002/eureka/</span></span><br></pre></td></tr></table></figure><ul><li>7002</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7002</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7002.com</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span>     <span class="comment">#设置与eureka server交互的地址查询服务和注册服务都需要依赖这个地址</span></span><br></pre></td></tr></table></figure><h2 id="3-4、启动7001和7002，测试"><a href="#3-4、启动7001和7002，测试" class="headerlink" title="3.4、启动7001和7002，测试"></a>3.4、启动7001和7002，测试</h2><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214201207.png" alt="image-20210214201206201"></p><h2 id="3-5、将payment8001和order80注册到eureka集群"><a href="#3-5、将payment8001和order80注册到eureka集群" class="headerlink" title="3.5、将payment8001和order80注册到eureka集群"></a>3.5、将payment8001和order80注册到eureka集群</h2><blockquote><p>修改payment8001和order80的yml文件</p></blockquote><ul><li>payment8001</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span>    <span class="comment">#表识不向注册中心注册自己</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span>   <span class="comment">#表示自己就是注册中心，职责是维护服务实例，并不需要去检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span>    <span class="comment">#设置与eureka server交互的地址查询服务和注册服务都需要依赖这个地址</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-provider-hystrix-payment</span></span><br></pre></td></tr></table></figure><ul><li>order80</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-order-service</span></span><br></pre></td></tr></table></figure><blockquote><p>测试</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214210220.png" alt="image-20210214210219113"></p><h1 id="四、actuator微服务信息完善"><a href="#四、actuator微服务信息完善" class="headerlink" title="四、actuator微服务信息完善"></a>四、actuator微服务信息完善</h1><h2 id="4-1、主机名，服务名称修改"><a href="#4-1、主机名，服务名称修改" class="headerlink" title="4.1、主机名，服务名称修改"></a>4.1、主机名，服务名称修改</h2><h3 id="1、当前问题"><a href="#1、当前问题" class="headerlink" title="1、当前问题"></a>1、当前问题</h3><blockquote><p>eureka注册表中含有主机名称</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214211411.png" alt="image-20210214211411127"></p><h3 id="2、修改payment8001"><a href="#2、修改payment8001" class="headerlink" title="2、修改payment8001"></a>2、修改payment8001</h3><blockquote><p>修改payment8001微服务的yml配置文件，添加配置如下</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8001</span></span><br></pre></td></tr></table></figure><blockquote><p>重启，查看结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214212223.png" alt="image-20210214212222852"></p><h2 id="4-2、访问信息有IP信息提示"><a href="#4-2、访问信息有IP信息提示" class="headerlink" title="4.2、访问信息有IP信息提示"></a>4.2、访问信息有IP信息提示</h2><h3 id="1、遇到的问题"><a href="#1、遇到的问题" class="headerlink" title="1、遇到的问题"></a>1、遇到的问题</h3><blockquote><p>在eureka点击微服务时没有ip提示</p></blockquote><h3 id="2、添加配置"><a href="#2、添加配置" class="headerlink" title="2、添加配置"></a>2、添加配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="3、测试"><a href="#3、测试" class="headerlink" title="3、测试"></a>3、测试</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214212622.png" alt="image-20210214212622010"></p><h2 id="4-3、总结"><a href="#4-3、总结" class="headerlink" title="4.3、总结"></a>4.3、总结</h2><blockquote><p>修改主机名、添加IP信息提示的步骤如下：</p></blockquote><h3 id="1、引入依赖"><a href="#1、引入依赖" class="headerlink" title="1、引入依赖"></a>1、引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2、yml文件添加配置"><a href="#2、yml文件添加配置" class="headerlink" title="2、yml文件添加配置"></a>2、yml文件添加配置</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">服务名称</span></span><br><span class="line">    <span class="comment"># 开启IP信息提示</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><h1 id="五、服务发现Discovery"><a href="#五、服务发现Discovery" class="headerlink" title="五、服务发现Discovery"></a>五、服务发现Discovery</h1><h2 id="5-1、概述"><a href="#5-1、概述" class="headerlink" title="5.1、概述"></a>5.1、概述</h2><blockquote><p>对于注册入Eureka中的微服务，可以通过服务发现来获得该服务的信息。</p></blockquote><h2 id="5-2、使用"><a href="#5-2、使用" class="headerlink" title="5.2、使用"></a>5.2、使用</h2><blockquote><p>这里以payment8001为例</p></blockquote><h3 id="1、修改payment8001的Controller"><a href="#1、修改payment8001的Controller" class="headerlink" title="1、修改payment8001的Controller"></a>1、修改payment8001的Controller</h3><blockquote><p>注入一个DiscoveryClient对象</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br></pre></td></tr></table></figure><blockquote><p>在Controller中添加一个方法，这个方法用户获取微服务的信息</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/payment/discovery&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">discovery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; services = discoveryClient.getServices();</span><br><span class="line">    services.stream().forEach(service -&gt; &#123;</span><br><span class="line">        log.info(<span class="string">&quot;-----------element:&quot;</span> + service);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//在getInstances方法中输入注册到eureka中的微服务名称</span></span><br><span class="line">    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">&quot;CLOUD-PAYMENT-SERVICE&quot;</span>);</span><br><span class="line">    instances.stream().forEach(instance -&gt; &#123;</span><br><span class="line">        log.info(instance.getServiceId() + <span class="string">&quot;\t&quot;</span> + instance.getHost() + <span class="string">&quot;\t&quot;</span> + instance.getPort() + <span class="string">&quot;\t&quot;</span> + instance.getUri());</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.discoveryClient;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、在payment8001主启动类上添加注解"><a href="#2、在payment8001主启动类上添加注解" class="headerlink" title="2、在payment8001主启动类上添加注解"></a>2、在payment8001主启动类上添加注解</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br></pre></td></tr></table></figure><h3 id="3、重启payment8001"><a href="#3、重启payment8001" class="headerlink" title="3、重启payment8001"></a>3、重启payment8001</h3><blockquote><p>访问 <a href="http://localhost:8001/payment/discovery">http://localhost:8001/payment/discovery</a></p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214214947.png" alt="image-20210214214946293"></p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214215325.png" alt="image-20210214215324991"></p><h1 id="六、Eureka自我保护"><a href="#六、Eureka自我保护" class="headerlink" title="六、Eureka自我保护"></a>六、Eureka自我保护</h1><h2 id="6-1、概述"><a href="#6-1、概述" class="headerlink" title="6.1、概述"></a>6.1、概述</h2><blockquote><p>保护模式主要用于一组客户端和Eureka Server之间存在网络分区场景。一旦进入保护模式，<strong>Eureka Server将会尝试保护其服务注册表中的信息，不再删除服务注册表中的数据，也就是不会注销任何服务</strong>。</p><p>即：某时刻某一个微服务不可用了，Eureka不会立即清理，依旧会对该微服务的信息进行保存。</p></blockquote><ul><li>如果在Eureka Server首页中看到以下这段提示，则说明Eureka进入了保护模式</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214220119.png" alt="image-20210214220118806"></p><h2 id="6-2、导致原因"><a href="#6-2、导致原因" class="headerlink" title="6.2、导致原因"></a>6.2、导致原因</h2><h3 id="1、为什么会产生Eureka自我保护机制？"><a href="#1、为什么会产生Eureka自我保护机制？" class="headerlink" title="1、为什么会产生Eureka自我保护机制？"></a>1、为什么会产生Eureka自我保护机制？</h3><blockquote><p>为了防止EurekaClient可以正常运行，但是与EurekaServer网络不通情况下，Eurekaserver不会立刻将EurekaClient服务剔除</p></blockquote><h3 id="2、什么是自我保护模式"><a href="#2、什么是自我保护模式" class="headerlink" title="2、什么是自我保护模式"></a>2、什么是自我保护模式</h3><blockquote><p>​    默认情况下，如果EurekaServer在一定时间内没有接收到某个微服务实例的心跳，EurekaServer将会注销该实例（默认90秒）。但当网络分区故障发生（延时、卡顿、拥挤）时，微服务与EurekaServer之间无法正常通信，以上行为可能变得非常危险了——因为微务本身其实是健康的，此时本不应该注销这个微服务。Eureka通过“自我保护模式”来解决这个问题——当EurekaServer节点在短时间内丢失过多客户端时（可能发生了网络分区故障），那么这个节点就会进入自我保护模式。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214221434.png" alt="img"></p><h2 id="6-3、禁止自我保护"><a href="#6-3、禁止自我保护" class="headerlink" title="6.3、禁止自我保护"></a>6.3、禁止自我保护</h2><blockquote><p>以eureka7001和payment8001举例说明</p></blockquote><h3 id="1、修改eureka7001的配置文件"><a href="#1、修改eureka7001的配置文件" class="headerlink" title="1、修改eureka7001的配置文件"></a>1、修改eureka7001的配置文件</h3><blockquote><p>禁用自我保护模式</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="comment"># 关闭自我保护机制</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">enable-self-preservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure><blockquote><p>重启7001，查看结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214222939.png" alt="image-20210214222939563"></p><h3 id="2、修改payment8001的配置文件"><a href="#2、修改payment8001的配置文件" class="headerlink" title="2、修改payment8001的配置文件"></a>2、修改payment8001的配置文件</h3><blockquote><p>设置eureka客户端向服务端发送心跳的时间间隔</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment">#Eureka客户端向服务端发送心跳的时间间隔，单位为秒（默认为10s）</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment">#Eureka服务端在收到最后一次心跳后等待时间上限，单位为s，超时直接剔除服务</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure><blockquote><p>重启payment8001，查看结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214223337.png" alt="image-20210214223337465"></p><blockquote><p>关闭payment8001，查看结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214223531.png" alt="image-20210214223531487"></p><blockquote><p>可以看到，在禁用自我保护模式的情况下，关闭payment8001后服务被剔除</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Spring Cloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Cloud学习（三）-Hystrix的使用</title>
      <link href="posts/4157920692.html"/>
      <url>posts/4157920692.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><h2 id="1-1、分布式系统面临的问题"><a href="#1-1、分布式系统面临的问题" class="headerlink" title="1.1、分布式系统面临的问题"></a>1.1、分布式系统面临的问题</h2><blockquote><p><strong>复杂分布式体系结构中的应用程序有数十个依赖关系，每个依赖关系在某些时候将不可避免的失败。</strong></p><p>微服务之间调用关系错综复杂，一个请求，可能需要调用多个微服务接口才能实现，会形成非常复杂的调用链路：</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212114450.png" alt="img"></p><h2 id="1-2、服务雪崩"><a href="#1-2、服务雪崩" class="headerlink" title="1.2、服务雪崩"></a>1.2、服务雪崩</h2><blockquote><p>多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其它的微服务，这就是所谓的**“扇出”**。如果扇出的链路上某个微服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，所谓的“雪崩效应”。</p><p>对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源都在几秒钟内饱和。比失败更糟糕的是，这些应用程序还可能导致服务之间的延迟增加，备份队列，线程和其他系统资源紧张，导致整个系统发生更多的级联故障。这些都表示需要对故障和延迟进行隔离和管理，以便单个依赖关系的失败，不能取消整个应用程序或系统。</p><p>所以，通常当你发现一个模块下的某个实例失败后，这时候这个模块依然还会接收流量，然后这个有问题的模块还调用了其他的模块，这样就会发生<strong>级联故障</strong>，或者叫<strong>雪崩</strong>。</p></blockquote><p>如图，一次业务请求，需要调用A、P、H、I四个服务，这四个服务又可能调用其它服务。</p><p>如果此时，某个服务出现异常：</p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212115722.png" alt="image-20210212115722168"></p><p>例如微服务I发生异常，请求阻塞，用户不会得到响应，则tomcat的这个线程不会释放，于是越来越多的用户请求到来，越来越多的线程会阻塞：</p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212115754.png" alt="image-20210212115754001"></p><p><strong>服务器支持的线程和并发数有限，请求一直阻塞，会导致服务器资源耗尽，从而导致所有其它服务都不可用，形成雪崩效应。</strong></p><p>这就好比，一个汽车生产线，生产不同的汽车，需要使用不同的零件，如果某个零件因为种种原因无法使用，那么就会造成整台车无法装配，陷入等待零件的状态，直到零件到位，才能继续组装。  此时如果有很多个车型都需要这个零件，那么整个工厂都将陷入等待的状态，导致所有生产都陷入瘫痪。一个零件的波及范围不断扩大。 </p><blockquote><p>Hystix解决雪崩问题的手段有两个：</p></blockquote><ul><li>线程隔离</li><li>服务熔断</li></ul><h2 id="1-3、Hystrix是什么？"><a href="#1-3、Hystrix是什么？" class="headerlink" title="1.3、Hystrix是什么？"></a>1.3、Hystrix是什么？</h2><blockquote><p>​    Hystrix是一个用于处理分布式系统的<strong>延迟</strong>和<strong>容错</strong>的开源库，在分布式系统里，许多依赖不可避免的会调用失败，比如超时、异常等，Hystrix能够保证在一个依赖出问题的情况下，<strong>不会导致整体服务失败，避免级联故障，以提高分布式系统的弹性。</strong><br>​    “断路器”本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控（类似熔断保险丝），<strong>向调用方返回一个符合预期的、可处理的备选响应（FallBack)**，而</strong>不是长时间的等待或者抛出调用方无法处理的异常**，这样就保证了服务调用方的线程不会被长时间、不必要地占用，从而避免了故障在分布式系统中的蔓延，乃至雪崩。</p></blockquote><h1 id="二、Hystrix重要概念"><a href="#二、Hystrix重要概念" class="headerlink" title="二、Hystrix重要概念"></a>二、Hystrix重要概念</h1><h2 id="2-1、服务降级（fallback）"><a href="#2-1、服务降级（fallback）" class="headerlink" title="2.1、服务降级（fallback）"></a>2.1、服务降级（fallback）</h2><h3 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h3><blockquote><p>假设要调用的微服务/系统<strong>出现故障不可用</strong>了，此时不让客户端<strong>等待</strong>并<strong>立刻返回一个友好提示</strong>，fallback</p></blockquote><h3 id="2、会触发服务降级的情况"><a href="#2、会触发服务降级的情况" class="headerlink" title="2、会触发服务降级的情况"></a>2、会触发服务降级的情况</h3><ul><li>程序运行异常</li><li>超时</li><li>服务熔断触发服务降级</li><li>线程池/信号量打满也会触发服务降级。</li></ul><h2 id="2-2、服务熔断（break）"><a href="#2-2、服务熔断（break）" class="headerlink" title="2.2、服务熔断（break）"></a>2.2、服务熔断（break）</h2><h3 id="1、介绍-1"><a href="#1、介绍-1" class="headerlink" title="1、介绍"></a>1、介绍</h3><blockquote><p>类比保险丝，当电器总功率达到一定限度后直接熔断，不让电器继续工作。即<strong>服务达到最大访问量后直接拒绝访问</strong>，拉闸限电，然后<strong>调用服务降级的方法并返回友好提示</strong>，这样可以放置整个系统被拖垮。</p><p>故服务熔断会<strong>触发</strong>服务降级。</p></blockquote><p>服务熔断就是保险丝：<strong>服务的降级</strong>-&gt;<strong>进而熔断</strong>-&gt;<strong>恢复调用链路</strong></p><h3 id="2、Hystrix的弹性容错"><a href="#2、Hystrix的弹性容错" class="headerlink" title="2、Hystrix的弹性容错"></a>2、Hystrix的弹性容错</h3><blockquote><p>​    不同于电路熔断只能断不能自动重连，Hystrix可以实现弹性容错，当情况好转之后，可以自动重连。这就好比魔术师把鸽子变没了容易，但是真正考验技术的是如何把消失的鸽子再变回来。<br>​    通过断路的方式，可以将后续请求直接拒绝掉，一段时间之后允许部分请求通过，如果调用成功则回到电路闭合状态，否则继续断开。</p></blockquote><h3 id="3、Hystrix熔断状态机的三个状态"><a href="#3、Hystrix熔断状态机的三个状态" class="headerlink" title="3、Hystrix熔断状态机的三个状态"></a>3、Hystrix熔断状态机的三个状态</h3><ul><li>Closed：关闭状态，所有请求都正常访问。</li><li>Open：打开状态，所有请求都会被降级。Hystix会对请求情况计数，当一定时间内失败请求百分比达到阈值，则触发熔断，断路器会完全打开。默认失败比例的阈值是50%，请求次数最少不低于20次。</li><li>Half Open：半开状态，open状态不是永久的，打开后会进入休眠时间（默认是5S）。随后断路器会自动进入半开状态。此时会释放部分请求通过，若这些请求都是健康的，则会完全关闭断路器，否则继续保持打开，再次进行休眠计时</li></ul><h2 id="2-3、服务限流（float-limited）"><a href="#2-3、服务限流（float-limited）" class="headerlink" title="2.3、服务限流（float limited）"></a>2.3、服务限流（float limited）</h2><blockquote><p>秒杀高并发等操作中，严禁请求一窝蜂地过来拥挤，需要使请求排队，一秒钟N个，有序进行。</p></blockquote><h1 id="三、Hystrix案例"><a href="#三、Hystrix案例" class="headerlink" title="三、Hystrix案例"></a>三、Hystrix案例</h1><h2 id="3-1、构建基础项目"><a href="#3-1、构建基础项目" class="headerlink" title="3.1、构建基础项目"></a>3.1、构建基础项目</h2><blockquote><p>新建cloud-provider-hystrix-payment8001微服务</p></blockquote><h3 id="1、POM"><a href="#1、POM" class="headerlink" title="1、POM"></a>1、POM</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--新增hystrix--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cloudstudy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2、YML"><a href="#2、YML" class="headerlink" title="2、YML"></a>2、YML</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8001</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-provider-hystrix-payment</span>  </span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span>    <span class="comment">#表识不向注册中心注册自己</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span>   <span class="comment">#表示自己就是注册中心，职责是维护服务实例，并不需要去检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br></pre></td></tr></table></figure><h3 id="3、主启动类"><a href="#3、主启动类" class="headerlink" title="3、主启动类"></a>3、主启动类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentHystrixMain8001</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentHystrixMain8001.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4、业务类"><a href="#4、业务类" class="headerlink" title="4、业务类"></a>4、业务类</h3><blockquote><p>在service层中编写一个正常访问和一个超时的方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentServiceImpl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_OK</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;paymentInfo_OK,id:&quot;</span> + id + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;😄&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_TimeOut</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> timeOut = <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(timeOut);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException interruptedException) &#123;</span><br><span class="line">            interruptedException.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;paymentInfo_TimeOut,id:&quot;</span> + id + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;😢耗时(S):&quot;</span> + timeOut;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5、Controller层"><a href="#5、Controller层" class="headerlink" title="5、Controller层"></a>5、Controller层</h3><blockquote><p>编写一个正常访问接口和一个超时接口</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentServiceImpl paymentService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_Ok</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">        String result = paymentService.paymentInfo_OK(id);</span><br><span class="line">        log.info(<span class="string">&quot;*********result:&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_TimeOut</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">        String result = paymentService.paymentInfo_TimeOut(id);</span><br><span class="line">        log.info(<span class="string">&quot;*********result:&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6、测试"><a href="#6、测试" class="headerlink" title="6、测试"></a>6、测试</h3><blockquote><p>打开eureka7001、hystrix-payment8001，测试</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212132513.png" alt="image-20210212132512369"></p><blockquote><p>调用成功的方法：<a href="http://localhost:8001/payment/hystrix/ok/31">http://localhost:8001/payment/hystrix/ok/31</a></p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212132619.png" alt="image-20210212132619143"></p><blockquote><p>调用超时方法：<a href="http://localhost:8001/payment/hystrix/timeout/31">http://localhost:8001/payment/hystrix/timeout/31</a></p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212132704.png" alt="image-20210212132704481"></p><h2 id="3-2、高并发测试"><a href="#3-2、高并发测试" class="headerlink" title="3.2、高并发测试"></a>3.2、高并发测试</h2><blockquote><p>以上面的项目为根基</p></blockquote><h3 id="1、使用JMeter进行压力测试"><a href="#1、使用JMeter进行压力测试" class="headerlink" title="1、使用JMeter进行压力测试"></a>1、使用JMeter进行压力测试</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212133943.png" alt="image-20210212133943440"></p><blockquote><p>启动Jmeter后再次访问<a href="http://localhost:8001/payment/hystrix/ok/31%E6%8E%A5%E5%8F%A3%EF%BC%8C%E5%8F%91%E7%8E%B0%E5%93%8D%E5%BA%94%E6%98%8E%E6%98%BE%E5%8F%98%E6%85%A2%EF%BC%8C%E5%8D%B3http://localhost:8001/payment/hystrix/timeout/31%E6%8E%A5%E5%8F%A3%E8%A2%AB%E6%8C%A4%E7%88%86%E5%90%8E%EF%BC%8Chttp://localhost:8001/payment/hystrix/ok/31%E6%8E%A5%E5%8F%A3%E4%B9%9F%E4%BC%9A%E8%A2%AB%E6%8B%96%E7%B4%AF%E3%80%82">http://localhost:8001/payment/hystrix/ok/31接口，发现响应明显变慢，即http://localhost:8001/payment/hystrix/timeout/31接口被挤爆后，http://localhost:8001/payment/hystrix/ok/31接口也会被拖累。</a></p></blockquote><h3 id="2、使用消费者调用Payment8001"><a href="#2、使用消费者调用Payment8001" class="headerlink" title="2、使用消费者调用Payment8001"></a>2、使用消费者调用Payment8001</h3><blockquote><p>新建一个cloud-consumer-feign-hystrix-order80微服务</p></blockquote><blockquote><p>引入依赖</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--新增hystrix--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cloudstudy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>编写yml文件</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span>    <span class="comment">#表识不向注册中心注册自己</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span>   <span class="comment">#表示自己就是注册中心，职责是维护服务实例，并不需要去检索服务</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-provider-hystrix-order</span></span><br></pre></td></tr></table></figure><blockquote><p>主启动类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hzx.springcloud&quot;,&quot;com.hzx.common&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderHystrixMain80</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderHystrixMain80.class,args);</span><br><span class="line">        System.out.println(<span class="string">&quot;http://localhost/swagger-ui.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>业务类：service</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;cloud-provider-hystrix-payment&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentHystrixService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_OK</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_TimeOut</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>业务类：Controller</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderHystrixController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentHystrixService paymentHystrixService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/hystrix/ok/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_OK</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">        String result = paymentHystrixService.paymentInfo_OK(id);</span><br><span class="line">        log.info(<span class="string">&quot;结果为：&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_TIMEOUT</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">        String result = paymentHystrixService.paymentInfo_TimeOut(id);</span><br><span class="line">        log.info(<span class="string">&quot;结果为：&quot;</span> + result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>故障原因：</p><p>8001同一层次的其他接口服务被困死，因为tomcat线程里面的工作线程已经被挤占完毕</p><p>80此时调用8001，客户端访问响应缓慢，转圈圈</p></blockquote><h2 id="3-3、解决方案"><a href="#3-3、解决方案" class="headerlink" title="3.3、解决方案"></a>3.3、解决方案</h2><h3 id="1、问题1"><a href="#1、问题1" class="headerlink" title="1、问题1"></a>1、问题1</h3><blockquote><p>超时导致服务器变慢（转圈）</p></blockquote><p>超时不再等待</p><h3 id="2、问题2"><a href="#2、问题2" class="headerlink" title="2、问题2"></a>2、问题2</h3><blockquote><p>出错（服务器宕机或者程序运行错误）</p></blockquote><p>出错要有兜底方案</p><h3 id="3、解决"><a href="#3、解决" class="headerlink" title="3、解决"></a>3、解决</h3><blockquote><p>对方服务（8001）超时了，调用者（80）不能一直卡死等待，必须有服务降级</p><p>对方服务（8001）down机了，调用者（80）不能一直卡死等待，必须有服务降级</p><p>对方服务（8001）OK，调用者（80）自己出故障或有自我要求（自己的等待时间小于服务提供者），自己处理降级</p></blockquote><h2 id="3-4、服务降级（fallback）"><a href="#3-4、服务降级（fallback）" class="headerlink" title="3.4、服务降级（fallback）"></a>3.4、服务降级（fallback）</h2><h3 id="1、对自身进行降级配置"><a href="#1、对自身进行降级配置" class="headerlink" title="1、对自身进行降级配置"></a>1、对自身进行降级配置</h3><blockquote><p>先从8001自身找问题：需要设置自身调用超时时间的峰值，在峰值时间内可以正常运行，超过峰值后需要有兜底的方法处理，做降级处理。</p><p>使用步骤如下</p></blockquote><ul><li>在业务类中启用@HystrixCommand注解</li><li>使用@HystrixCommand注解的fallbackMethod属性指定兜底方法</li><li>使用@HystrixCommand注解的commandProperties属性指定自身调用超时时间的峰值。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentInfo_TimeOutHandler&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;3000&quot;)  //3秒钟以内就是正常的业务逻辑</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure><ul><li>若业务时间在超时时间峰值之内，那么走正常的业务逻辑，超过峰值后直接调用兜底方法。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentServiceImpl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_OK</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;paymentInfo_OK,id:&quot;</span> + id + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;😄&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentInfo_TimeOutHandler&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">            @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;3000&quot;)  //3秒钟以内就是正常的业务逻辑</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_TimeOut</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> timeOut = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TimeUnit.SECONDS.sleep(timeOut);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException interruptedException) &#123;</span><br><span class="line">            interruptedException.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;paymentInfo_TimeOut,id:&quot;</span> + id + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;😢耗时(S):&quot;</span> + timeOut;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_TimeOutHandler</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;线程池：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;paymentInfo_TimeOutHandler,id:&quot;</span> + id + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;😓&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在主启动类上添加@EnableCircuitBreaker注解激活服务降级</li><li>测试，由于我们设置了峰值时间为3s，而我们在业务中休眠了5s，所以会触发服务降级</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212153100.png" alt="image-20210212153058330"></p><blockquote><p>除超市外，系统出现异常时也会调用兜底方案</p></blockquote><h3 id="2、对消费端进行降级配置"><a href="#2、对消费端进行降级配置" class="headerlink" title="2、对消费端进行降级配置"></a>2、对消费端进行降级配置</h3><blockquote><p>对于需要<strong>远程调用payment8001的订单微服务80</strong>，它也可以更好地保护自己，<strong>对自己进行客户端降级保护</strong>。</p><p>hystrix的服务降级既可以做在消费（调用服务）端，也可以做在服务（提供服务）端，但服务降级一般做在消费端</p></blockquote><ul><li>在80订单微服务的yml文件中添加配置</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment">#如果处理自身的容错就开启。开启方式与生产端不一样。</span></span><br></pre></td></tr></table></figure><ul><li>在80订单微服务的主启动类上添加@EnableHystrix注解激活Hystrix</li><li>修改业务类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/consumer/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentTimeOutFallbackMethod&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;1500&quot;)</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_TIMEOUT</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">    String result = paymentHystrixService.paymentInfo_TimeOut(id);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentTimeOutFallbackMethod</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;我是消费者80，对付支付系统繁忙请10秒钟后再试或者自己运行出错请检查自己,(┬＿┬)&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>测试</p><ul><li>修改paymentHystrix8001中的业务类，确保8001中的方法可以正常运行</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentInfo_TimeOutHandler&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;execution.isolation.thread.timeoutInMilliseconds&quot;,value = &quot;5000&quot;)  //3秒钟以内就是正常的业务逻辑</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_TimeOut</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> timeOut = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(timeOut);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException interruptedException) &#123;</span><br><span class="line">        interruptedException.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;线程池：&quot;</span> + Thread.currentThread().getName() + <span class="string">&quot;paymentInfo_TimeOut,id:&quot;</span> + id + <span class="string">&quot;\t&quot;</span> + <span class="string">&quot;😢耗时(S):&quot;</span> + timeOut;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>启动微服务，此时由于80订单中微服务的超时时间峰值为1.5s，而8001休眠了3s，所以80会调用失败，此时会调用自身的兜底方法</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210213205233.png"></p></li></ul><blockquote><p>如果80微服务端发生运行时异常，那么也会直接执行兜底方案。</p></blockquote><h3 id="3、以上配置存在的问题"><a href="#3、以上配置存在的问题" class="headerlink" title="3、以上配置存在的问题"></a>3、以上配置存在的问题</h3><ul><li>每个业务方法对应一个兜底的方法，代码膨胀</li><li>业务逻辑和兜底方法混杂在一起，代码混乱。</li><li>全局兜底方法和自定义兜底方法分开</li></ul><blockquote><p>配置一个全局兜底方法，使用@DefaultProperties(defaultFallback = “全局兜底方法名”) 来指定全局兜底方法。</p><p>加入全局兜底方法后，代码结构可变为</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210213210443.png" alt="img"></p><blockquote><p>1对N，除了个别重要核心业务有专属兜底方法，其余普通的方法都可以通过全局兜底方法统一兜底。</p><p>修改80订单微服务的Controller层</p></blockquote><ul><li>添加一个全局兜底方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 下面是全局fallback方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">payment_Global_FallbackMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Global异常处理信息，请稍后再试...😓&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在控制器上添加注解</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DefaultProperties(defaultFallback = &quot;payment_Global_FallbackMethod&quot;)</span></span><br></pre></td></tr></table></figure><ul><li>修改业务类，使用全局兜底方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/consumer/payment/hystrix/timeout/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@HystrixCommand</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_TIMEOUT</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> </span>&#123;</span><br><span class="line">    String result = paymentHystrixService.paymentInfo_TimeOut(id);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4、为远程调用接口添加一个统一降级类"><a href="#4、为远程调用接口添加一个统一降级类" class="headerlink" title="4、为远程调用接口添加一个统一降级类"></a>4、为远程调用接口添加一个统一降级类</h3><blockquote><p>服务降级，客户端去调用服务端，碰上服务端宕机或关闭。</p><p>修改order80订单微服务，根据order80订单微服务已经有的PaymentHystrixService接口，重新新建一个类（PaymentFallbackService）实现该接口，统一为接口里面的方法进行异常处理。</p><p>编写一个类，实现PaymentHystrixService接口</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentFallbackService</span> <span class="keyword">implements</span> <span class="title">PaymentHystrixService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_OK</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;----PaymentFallbackService fall back-payment_OK，😂&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">paymentInfo_TimeOut</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;----PaymentFallbackService fall back-paymentInfo_TimeOut，😂&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>此时没有配置任何兜底方法的paymentInfo_OK方法由PaymentFallbackService类中的实现方法兜底</p><p>测试</p></blockquote><ul><li>正常测试，访问：<a href="http://localhost/consumer/payment/hystrix/ok/31">http://localhost/consumer/payment/hystrix/ok/31</a></li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210213214055.png" alt="image-20210213214054384"></p><ul><li>关闭payment8001，模拟服务端宕机，重新访问：<a href="http://localhost/consumer/payment/hystrix/ok/31">http://localhost/consumer/payment/hystrix/ok/31</a> ，此时可以看到调用了PaymentFallbackService类中的实现方法兜底。</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210213214153.png" alt="image-20210213214152979"></p><blockquote><p>此时服务端provider已经down了，但是我们做了服务降级处理，让客户端在服务端不可用时也会获得提示信息而不会挂起耗死服务器</p></blockquote><h2 id="3-5、服务熔断"><a href="#3-5、服务熔断" class="headerlink" title="3.5、服务熔断"></a>3.5、服务熔断</h2><h3 id="1、修改cloud-provider-hystrix-payment8001"><a href="#1、修改cloud-provider-hystrix-payment8001" class="headerlink" title="1、修改cloud-provider-hystrix-payment8001"></a>1、修改cloud-provider-hystrix-payment8001</h3><ul><li>修改PaymentService</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand(fallbackMethod = &quot;paymentCircuitBreaker_fallback&quot;,commandProperties = &#123;</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.enabled&quot;,value = &quot;true&quot;),  //是否开启断路器</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.requestVolumeThreshold&quot;,value = &quot;10&quot;),   //请求次数</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.sleepWindowInMilliseconds&quot;,value = &quot;10000&quot;),  //时间范围</span></span><br><span class="line"><span class="meta">        @HystrixProperty(name = &quot;circuitBreaker.errorThresholdPercentage&quot;,value = &quot;60&quot;), //失败率达到多少后跳闸</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentCircuitBreaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (id &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;*****id 不能负数&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    String serialNumber = IdUtil.simpleUUID();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Thread.currentThread().getName()+<span class="string">&quot;\t&quot;</span>+<span class="string">&quot;调用成功,流水号：&quot;</span>+serialNumber;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//兜底方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentCircuitBreaker_fallback</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;id 不能负数，请稍候再试,(┬＿┬)/~~     id: &quot;</span> +id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>@HystrixProperty(name = “circuitBreaker.enabled”,value = “true”)</td><td>是否开启断路器</td></tr><tr><td>@HystrixProperty(name = “circuitBreaker.requestVolumeThreshold”,value = “10”)</td><td>请求次数</td></tr><tr><td>@HystrixProperty(name = “circuitBreaker.sleepWindowInMilliseconds”,value = “10000”)</td><td>时间窗口期/时间范围</td></tr><tr><td>@HystrixProperty(name = “circuitBreaker.errorThresholdPercentage”,value = “60”)</td><td>失败率到达多少后跳闸</td></tr></tbody></table><blockquote><p>上面设置的意思时，如果10秒内10次请求中有60以上失败，就直接跳闸</p></blockquote><ul><li>Controller层</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//===服务熔断</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/payment/circuit/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentCircuitBreaker</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span></span>&#123;</span><br><span class="line">    String result = paymentService.paymentCircuitBreaker(id);</span><br><span class="line">    log.info(<span class="string">&quot;*******result:&quot;</span>+result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、测试符合条件的参数"><a href="#2、测试符合条件的参数" class="headerlink" title="2、测试符合条件的参数"></a>2、测试符合条件的参数</h3><ul><li>访问 <a href="http://localhost:8001/payment/circuit/31">http://localhost:8001/payment/circuit/31</a> ，由于id为正数，所以测试通过。</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210213220833.png" alt="image-20210213220832634"></p><h3 id="3、演示服务熔断"><a href="#3、演示服务熔断" class="headerlink" title="3、演示服务熔断"></a>3、演示服务熔断</h3><ul><li>演示服务熔断，在短时间内连续多次输入小于0的id号，然后再输入正确的id，查看结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210213221321.png" alt="image-20210213221321526"></p><blockquote><p>一段时间之后（默认是5秒），这个时候断路器是半开状态，会让其中一个请求进行转发。如果成功，断路器会关闭，若失败，继续开启。</p></blockquote><h3 id="4、结论"><a href="#4、结论" class="headerlink" title="4、结论"></a>4、结论</h3><blockquote><p>熔断类型</p><ul><li>熔断打开：请求不再进行调用当前服务，内部设置时钟一般为MTTR(平均故障处理时间)，当打开时长达到所设时钟则进入熔断状态</li><li>熔断关闭：熔断关闭不会对服务进行熔断</li><li>熔断半开：部分请求根据规则调用当前服务，如果请求成功且符合规则则认为当前服务恢复正常，关闭熔断</li></ul><p>熔断器开启、半开、关闭的转化关系大致如下</p><ul><li>当请求错误次数在一定时间内没达到峰值或者请求成功的情况下，熔断器关闭。</li><li>当请求错误次数在一定时间内达到峰值时，熔断器打开，此时进入服务熔断状态，通过服务降级对任何请求返回提示。</li><li>当熔断一定时间后，熔断器会进入半开状态，此时它会试着通过一些请求，如果请求通过，那么它会从半开状态转换为关闭状态，此时服务恢复，否则仍然进入打开状态，服务继续熔断。</li></ul></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210213222919.png" alt="image-20210213222918954"></p><h3 id="5、断路器的三个重要参数"><a href="#5、断路器的三个重要参数" class="headerlink" title="5、断路器的三个重要参数"></a>5、断路器的三个重要参数</h3><blockquote><p>分别是<strong>快照时间窗</strong>、<strong>请求总数阈值</strong>和<strong>错误百分比阈值</strong></p></blockquote><ul><li>快照时间窗：断路器确定是否打开需要统计一些请求和错误数据，而统计的时间范围就是快照时间窗，默认为最近的10秒。</li><li>请求总数阀值：在快照时间窗内，必须满足请求总数阀值才有资格熔断。默认为20，意味着在10秒内，如果该hystrix命令的调用次数不足20次，即使所有的请求都超时或其他原因失败，断路器都不会打开。</li><li>错误百分比阀值：当请求总数在快照时间窗内超过了阀值，比如发生了30次调用，如果在这30次调用中，有15次发生了超时异常，也就是超过50%的错误百分比，在默认设定50%阀值情况下，这时候就会将断路器打开。</li></ul><h3 id="6、Hystrix如何自动恢复？"><a href="#6、Hystrix如何自动恢复？" class="headerlink" title="6、Hystrix如何自动恢复？"></a>6、Hystrix如何自动恢复？</h3><blockquote><p>对于这一问题，hystrix也为我们实现了自动恢复功能。<br>当断路器打开，对主逻辑进行熔断之后，hystrix会启动一个<strong>休眠时间窗</strong>，在这个时间窗内，降级逻辑是临时的成为主逻辑，当休眠时间窗到期，断路器将进入半开状态，释放一次请求到原来的主逻辑上，如果此次请求正常返回，那么断路器将继续闭合，主逻辑恢复，如果这次请求依然有问题，断路器继续进入打开状态，休眠时间窗重新计时。</p></blockquote><h2 id="3-6、服务限流"><a href="#3-6、服务限流" class="headerlink" title="3.6、服务限流"></a>3.6、服务限流</h2><blockquote><p>暂时留空</p></blockquote><h1 id="四、Hystrix工作流程"><a href="#四、Hystrix工作流程" class="headerlink" title="四、Hystrix工作流程"></a>四、Hystrix工作流程</h1><h2 id="4-1、流程图"><a href="#4-1、流程图" class="headerlink" title="4.1、流程图"></a>4.1、流程图</h2><p><img src= "/img/loading.gif" data-lazy-src="https://github.com/Netflix/Hystrix/wiki/images/hystrix-command-flow-chart-640.png" alt="img"></p><h2 id="4-2、步骤说明"><a href="#4-2、步骤说明" class="headerlink" title="4.2、步骤说明"></a>4.2、步骤说明</h2><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210213225605.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> Spring Cloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
            <tag> 🐷Hystrix </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在线教育项目总结（五）-统一返回结果、分页条件查询、订单操作和定时任务</title>
      <link href="posts/1717741625.html"/>
      <url>posts/1717741625.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1、统一返回格式"><a href="#1、统一返回格式" class="headerlink" title="1、统一返回格式"></a>1、统一返回格式</h2><blockquote><p>在前后端接口交互中，前端按照约定请求URL路径，并传入相关参数，后端服务器接收请求，进行业务处理，返回数据给前端。在前后端分离的项目中，我们往往会将后端的结果<strong>封装为JSON数据</strong>返回，统一的数据格式会使前端对数据的操作更一致、轻松。</p><p>一般情况下，统一返回数据格式没有固定的格式，只要能描述清楚返回的数据状态以及要返回的具体数据就可以。但是一般会包含<strong>状态码</strong>、<strong>返回消息</strong>、<strong>数据</strong>这几部分内容</p></blockquote><p>例如，我们的系统要求返回的基本数据格式如下：</p><ul><li><strong>列表：</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;success&quot;</span>: <span class="keyword">true</span>,</span><br><span class="line">  <span class="string">&quot;code&quot;</span>: <span class="number">20000</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;items&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;刘德华&quot;</span>,</span><br><span class="line">        <span class="string">&quot;intro&quot;</span>: <span class="string">&quot;毕业于师范大学数学系，热爱教育事业，执教数学思维6年有余&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>分页：</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;success&quot;</span>: <span class="keyword">true</span>,</span><br><span class="line">  <span class="string">&quot;code&quot;</span>: <span class="number">20000</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: <span class="number">17</span>,</span><br><span class="line">    <span class="string">&quot;rows&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;刘德华&quot;</span>,</span><br><span class="line">        <span class="string">&quot;intro&quot;</span>: <span class="string">&quot;毕业于师范大学数学系，热爱教育事业，执教数学思维6年有余&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>没有返回数据：</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;success&quot;</span>: <span class="keyword">true</span>,</span><br><span class="line">  <span class="string">&quot;code&quot;</span>: <span class="number">20000</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>失败：</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;success&quot;</span>: <span class="keyword">false</span>,</span><br><span class="line">  <span class="string">&quot;code&quot;</span>: <span class="number">20001</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;失败&quot;</span>,</span><br><span class="line">  <span class="string">&quot;data&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>我们定义统一返回格式为：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;success&quot;</span>: 布尔, <span class="comment">//响应是否成功</span></span><br><span class="line">  <span class="string">&quot;code&quot;</span>: 数字, <span class="comment">//响应码</span></span><br><span class="line">  <span class="string">&quot;message&quot;</span>: 字符串, <span class="comment">//返回消息</span></span><br><span class="line">  <span class="string">&quot;data&quot;</span>: HashMap <span class="comment">//返回数据，放在键值对中</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2、定义统一返回结果"><a href="#2、定义统一返回结果" class="headerlink" title="2、定义统一返回结果"></a>2、定义统一返回结果</h2><h3 id="2-1、创建返回码定义枚举类"><a href="#2-1、创建返回码定义枚举类" class="headerlink" title="2.1、创建返回码定义枚举类"></a>2.1、创建返回码定义枚举类</h3><blockquote><p>状态码定义枚举类对于特殊响应情况做了定义。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">ResultCodeEnum</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    SUCCESS(<span class="keyword">true</span>, <span class="number">20000</span>,<span class="string">&quot;成功&quot;</span>),</span><br><span class="line">    UNKNOWN_REASON(<span class="keyword">false</span>, <span class="number">20001</span>, <span class="string">&quot;未知错误&quot;</span>),</span><br><span class="line"></span><br><span class="line">    BAD_SQL_GRAMMAR(<span class="keyword">false</span>, <span class="number">21001</span>, <span class="string">&quot;sql语法错误&quot;</span>),</span><br><span class="line">    JSON_PARSE_ERROR(<span class="keyword">false</span>, <span class="number">21002</span>, <span class="string">&quot;json解析异常&quot;</span>),</span><br><span class="line">    PARAM_ERROR(<span class="keyword">false</span>, <span class="number">21003</span>, <span class="string">&quot;参数不正确&quot;</span>),</span><br><span class="line"></span><br><span class="line">    FILE_UPLOAD_ERROR(<span class="keyword">false</span>, <span class="number">21004</span>, <span class="string">&quot;文件上传错误&quot;</span>),</span><br><span class="line">    FILE_DELETE_ERROR(<span class="keyword">false</span>, <span class="number">21005</span>, <span class="string">&quot;文件刪除错误&quot;</span>),</span><br><span class="line">    EXCEL_DATA_IMPORT_ERROR(<span class="keyword">false</span>, <span class="number">21006</span>, <span class="string">&quot;Excel数据导入错误&quot;</span>),</span><br><span class="line"></span><br><span class="line">    VIDEO_UPLOAD_ALIYUN_ERROR(<span class="keyword">false</span>, <span class="number">22001</span>, <span class="string">&quot;视频上传至阿里云失败&quot;</span>),</span><br><span class="line">    VIDEO_UPLOAD_TOMCAT_ERROR(<span class="keyword">false</span>, <span class="number">22002</span>, <span class="string">&quot;视频上传至业务服务器失败&quot;</span>),</span><br><span class="line">    VIDEO_DELETE_ALIYUN_ERROR(<span class="keyword">false</span>, <span class="number">22003</span>, <span class="string">&quot;阿里云视频文件删除失败&quot;</span>),</span><br><span class="line">    FETCH_VIDEO_UPLOADAUTH_ERROR(<span class="keyword">false</span>, <span class="number">22004</span>, <span class="string">&quot;获取上传地址和凭证失败&quot;</span>),</span><br><span class="line">    REFRESH_VIDEO_UPLOADAUTH_ERROR(<span class="keyword">false</span>, <span class="number">22005</span>, <span class="string">&quot;刷新上传地址和凭证失败&quot;</span>),</span><br><span class="line">    FETCH_PLAYAUTH_ERROR(<span class="keyword">false</span>, <span class="number">22006</span>, <span class="string">&quot;获取播放凭证失败&quot;</span>),</span><br><span class="line"></span><br><span class="line">    URL_ENCODE_ERROR(<span class="keyword">false</span>, <span class="number">23001</span>, <span class="string">&quot;URL编码失败&quot;</span>),</span><br><span class="line">    ILLEGAL_CALLBACK_REQUEST_ERROR(<span class="keyword">false</span>, <span class="number">23002</span>, <span class="string">&quot;非法回调请求&quot;</span>),</span><br><span class="line">    FETCH_ACCESSTOKEN_FAILD(<span class="keyword">false</span>, <span class="number">23003</span>, <span class="string">&quot;获取accessToken失败&quot;</span>),</span><br><span class="line">    FETCH_USERINFO_ERROR(<span class="keyword">false</span>, <span class="number">23004</span>, <span class="string">&quot;获取用户信息失败&quot;</span>),</span><br><span class="line">    LOGIN_ERROR(<span class="keyword">false</span>, <span class="number">23005</span>, <span class="string">&quot;登录失败&quot;</span>),</span><br><span class="line"></span><br><span class="line">    COMMENT_EMPTY(<span class="keyword">false</span>, <span class="number">24006</span>, <span class="string">&quot;评论内容必须填写&quot;</span>),</span><br><span class="line"></span><br><span class="line">    PAY_RUN(<span class="keyword">false</span>, <span class="number">25000</span>, <span class="string">&quot;支付中&quot;</span>),</span><br><span class="line">    PAY_UNIFIEDORDER_ERROR(<span class="keyword">false</span>, <span class="number">25001</span>, <span class="string">&quot;统一下单错误&quot;</span>),</span><br><span class="line">    PAY_ORDERQUERY_ERROR(<span class="keyword">false</span>, <span class="number">25002</span>, <span class="string">&quot;查询支付结果错误&quot;</span>),</span><br><span class="line"></span><br><span class="line">    ORDER_EXIST_ERROR(<span class="keyword">false</span>, <span class="number">25003</span>, <span class="string">&quot;课程已购买&quot;</span>),</span><br><span class="line"></span><br><span class="line">    GATEWAY_ERROR(<span class="keyword">false</span>, <span class="number">26000</span>, <span class="string">&quot;服务不能访问&quot;</span>),</span><br><span class="line"></span><br><span class="line">    CODE_ERROR(<span class="keyword">false</span>, <span class="number">28000</span>, <span class="string">&quot;验证码错误&quot;</span>),</span><br><span class="line"></span><br><span class="line">    LOGIN_PHONE_ERROR(<span class="keyword">false</span>, <span class="number">28009</span>, <span class="string">&quot;手机号码不正确&quot;</span>),</span><br><span class="line">    LOGIN_MOBILE_ERROR(<span class="keyword">false</span>, <span class="number">28001</span>, <span class="string">&quot;账号不正确&quot;</span>),</span><br><span class="line">    LOGIN_PASSWORD_ERROR(<span class="keyword">false</span>, <span class="number">28008</span>, <span class="string">&quot;密码不正确&quot;</span>),</span><br><span class="line">    LOGIN_DISABLED_ERROR(<span class="keyword">false</span>, <span class="number">28002</span>, <span class="string">&quot;该用户已被禁用&quot;</span>),</span><br><span class="line">    REGISTER_MOBLE_ERROR(<span class="keyword">false</span>, <span class="number">28003</span>, <span class="string">&quot;手机号已被注册&quot;</span>),</span><br><span class="line">    LOGIN_AUTH(<span class="keyword">false</span>, <span class="number">28004</span>, <span class="string">&quot;需要登录&quot;</span>),</span><br><span class="line">    LOGIN_ACL(<span class="keyword">false</span>, <span class="number">28005</span>, <span class="string">&quot;没有权限&quot;</span>),</span><br><span class="line">    SMS_SEND_ERROR(<span class="keyword">false</span>, <span class="number">28006</span>, <span class="string">&quot;短信发送失败&quot;</span>),</span><br><span class="line">    SMS_SEND_ERROR_BUSINESS_LIMIT_CONTROL(<span class="keyword">false</span>, <span class="number">28007</span>, <span class="string">&quot;短信发送过于频繁&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Boolean success;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    ResultCodeEnum(Boolean success, Integer code, String message) &#123;</span><br><span class="line">        <span class="keyword">this</span>.success = success;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2、创建结果类"><a href="#2-2、创建结果类" class="headerlink" title="2.2、创建结果类"></a>2.2、创建结果类</h3><blockquote><p>对于返回数据有两种赋值方法，一是传入一个Map对象，二是传入一个Key和一个Value。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel(value = &quot;全局统一返回结果&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">R</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;是否成功&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean success;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;返回码&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;返回消息&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;返回数据&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; data = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">R</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> R <span class="title">ok</span><span class="params">()</span></span>&#123;</span><br><span class="line">        R r = <span class="keyword">new</span> R();</span><br><span class="line">        r.setSuccess(ResultCodeEnum.SUCCESS.getSuccess());</span><br><span class="line">        r.setCode(ResultCodeEnum.SUCCESS.getCode());</span><br><span class="line">        r.setMessage(ResultCodeEnum.SUCCESS.getMessage());</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> R <span class="title">error</span><span class="params">()</span></span>&#123;</span><br><span class="line">        R r = <span class="keyword">new</span> R();</span><br><span class="line">        r.setSuccess(ResultCodeEnum.UNKNOWN_REASON.getSuccess());</span><br><span class="line">        r.setCode(ResultCodeEnum.UNKNOWN_REASON.getCode());</span><br><span class="line">        r.setMessage(ResultCodeEnum.UNKNOWN_REASON.getMessage());</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> R <span class="title">setResult</span><span class="params">(ResultCodeEnum resultCodeEnum)</span></span>&#123;</span><br><span class="line">        R r = <span class="keyword">new</span> R();</span><br><span class="line">        r.setSuccess(resultCodeEnum.getSuccess());</span><br><span class="line">        r.setCode(resultCodeEnum.getCode());</span><br><span class="line">        r.setMessage(resultCodeEnum.getMessage());</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">success</span><span class="params">(Boolean success)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setSuccess(success);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">message</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setMessage(message);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">code</span><span class="params">(Integer code)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setCode(code);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">data</span><span class="params">(String key, Object value)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">data</span><span class="params">(Map&lt;String, Object&gt; map)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setData(map);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3、分页条件查询"><a href="#3、分页条件查询" class="headerlink" title="3、分页条件查询"></a>3、分页条件查询</h2><h3 id="3-1、需求说明"><a href="#3-1、需求说明" class="headerlink" title="3.1、需求说明"></a>3.1、需求说明</h3><blockquote><p>在讲师分页列表中，我们需要根据讲师名进行模糊查询，根据讲师头衔、讲师入驻时间进行查询。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212210910.png" alt="image-20210212210909529"></p><h3 id="3-2、创建查询对象"><a href="#3-2、创建查询对象" class="headerlink" title="3.2、创建查询对象"></a>3.2、创建查询对象</h3><blockquote><p>创建讲师条件查询类TeacherQueryVo，该类定义了3.1中的四个条件属性。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TeacherQueryVo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer level;</span><br><span class="line">    <span class="keyword">private</span> String joinDateBegin;</span><br><span class="line">    <span class="keyword">private</span> String joinDateEnd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-3、在TeacherController中编写一个分页条件查询接口"><a href="#3-3、在TeacherController中编写一个分页条件查询接口" class="headerlink" title="3.3、在TeacherController中编写一个分页条件查询接口"></a>3.3、在TeacherController中编写一个分页条件查询接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 实现条件查询带分页查询的方法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> page 当前页</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> limit 每页记录数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> queryVo 条件封装成的查询对象</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 总记录数及讲师列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;list/&#123;page&#125;/&#123;limit&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;实现条件查询带分页&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">listPage</span><span class="params">(<span class="meta">@ApiParam(value = &quot;当前页&quot;,required = true)</span> <span class="meta">@PathVariable(&quot;page&quot;)</span> Long page,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="meta">@ApiParam(value = &quot;每页记录数&quot;,required = true)</span> <span class="meta">@PathVariable(&quot;limit&quot;)</span> Long limit,</span></span></span><br><span class="line"><span class="function"><span class="params">                  TeacherQueryVo queryVo)</span> </span>&#123;</span><br><span class="line">    Page&lt;Teacher&gt; pageParam = <span class="keyword">new</span> Page&lt;&gt;(page, limit);</span><br><span class="line">    IPage&lt;Teacher&gt; pageModel = teacherService.selectPage(pageParam, queryVo);</span><br><span class="line">    List&lt;Teacher&gt; records = pageModel.getRecords();</span><br><span class="line">    <span class="keyword">long</span> total = pageModel.getTotal();</span><br><span class="line">    <span class="keyword">return</span> R.ok().data(<span class="string">&quot;total&quot;</span>, total).data(<span class="string">&quot;rows&quot;</span>, records);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-4、在Service层实现selectPage方法"><a href="#3-4、在Service层实现selectPage方法" class="headerlink" title="3.4、在Service层实现selectPage方法"></a>3.4、在Service层实现selectPage方法</h3><blockquote><p>这个方法接收传入的分页对象和条件查询对象，首先对传入的条件对象进行判断，如果条件对象为空，那么直接进行一次普通的分页查询;</p><p>如果条件对象不为空，那么分别取出其中的四个属性，根据属性类型使用QueryWrapper拼接不为空的条件属性。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IPage&lt;Teacher&gt; <span class="title">selectPage</span><span class="params">(Page&lt;Teacher&gt; pageParam, TeacherQueryVo teacherQueryVo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//显示分页查询列表</span></span><br><span class="line"><span class="comment">//        1、排序：按照sort字段排序</span></span><br><span class="line">    QueryWrapper&lt;Teacher&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.orderByAsc(<span class="string">&quot;sort&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        2、分页查询</span></span><br><span class="line">    <span class="keyword">if</span>(teacherQueryVo == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> baseMapper.selectPage(pageParam, queryWrapper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        3、条件查询</span></span><br><span class="line">    String name = teacherQueryVo.getName();</span><br><span class="line">    Integer level = teacherQueryVo.getLevel();</span><br><span class="line">    String joinDateBegin = teacherQueryVo.getJoinDateBegin();</span><br><span class="line">    String joinDateEnd = teacherQueryVo.getJoinDateEnd();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(name))&#123;</span><br><span class="line">        queryWrapper.likeRight(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(level != <span class="keyword">null</span>)&#123;</span><br><span class="line">        queryWrapper.eq(<span class="string">&quot;level&quot;</span>, level);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(joinDateBegin))&#123;</span><br><span class="line">        queryWrapper.ge(<span class="string">&quot;join_date&quot;</span>, joinDateBegin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!StringUtils.isEmpty(joinDateEnd))&#123;</span><br><span class="line">        queryWrapper.le(<span class="string">&quot;join_date&quot;</span>, joinDateEnd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> baseMapper.selectPage(pageParam, queryWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-5、测试"><a href="#3-5、测试" class="headerlink" title="3.5、测试"></a>3.5、测试</h3><blockquote><p>打开swagger，进行测试</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212213414.png" alt="image-20210212213413862"></p><blockquote><p>结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212213429.png" alt="image-20210212213429863"></p><h2 id="4、订单操作"><a href="#4、订单操作" class="headerlink" title="4、订单操作"></a>4、订单操作</h2><blockquote><p>由于只有登录后的用户才可以下订单，而且订单除了必需的商品号外，还必须有用户号，在合法用户登录后，我们会下发给用户一个token，在之后的订单操作中，用户需要在发起请求的时候在请求头中带上这个token，服务器解析请求头中的token后即可获取用户id。</p></blockquote><h3 id="4-1、创建JWTUtils"><a href="#4-1、创建JWTUtils" class="headerlink" title="4.1、创建JWTUtils"></a>4.1、创建JWTUtils</h3><blockquote><p>这个工具类封装了一系列有关token的方法，包括根据密钥生成token，鉴定token是否合法，从请求中的token解析出用户信息等。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String APP_SECRET = <span class="string">&quot;ukc8BDbRigUDaY6pZFfWus2jZWLPHO&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Key <span class="title">getKeyInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = DatatypeConverter.parseBase64Binary(APP_SECRET);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SecretKeySpec(bytes,signatureAlgorithm.getJcaName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJwtToken</span><span class="params">(JwtInfo jwtInfo, <span class="keyword">int</span> expire)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        String JwtToken = Jwts.builder()</span><br><span class="line">                .setHeaderParam(<span class="string">&quot;typ&quot;</span>, <span class="string">&quot;JWT&quot;</span>)</span><br><span class="line">                .setHeaderParam(<span class="string">&quot;alg&quot;</span>, <span class="string">&quot;HS256&quot;</span>)</span><br><span class="line">                .setSubject(<span class="string">&quot;guli-user&quot;</span>)<span class="comment">//主题</span></span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> Date())<span class="comment">//颁发时间</span></span><br><span class="line">                .setExpiration(DateTime.now().plusSeconds(expire).toDate())<span class="comment">//过期时间</span></span><br><span class="line">                .claim(<span class="string">&quot;id&quot;</span>, jwtInfo.getId())<span class="comment">//用户id</span></span><br><span class="line">                .claim(<span class="string">&quot;nickname&quot;</span>, jwtInfo.getNickname())<span class="comment">//用户昵称</span></span><br><span class="line">                .claim(<span class="string">&quot;avatar&quot;</span>, jwtInfo.getAvatar())<span class="comment">//用户头像</span></span><br><span class="line">                .signWith(SignatureAlgorithm.HS256, getKeyInstance())</span><br><span class="line">                .compact();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JwtToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断token是否存在与有效</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwtToken</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkJwtTToken</span><span class="params">(String jwtToken)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(jwtToken)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Jwts.parser().setSigningKey(getKeyInstance()).parseClaimsJws(jwtToken);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断token是否存在与有效</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkJwtTToken</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String jwtToken = request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(StringUtils.isEmpty(jwtToken)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            Jwts.parser().setSigningKey(getKeyInstance()).parseClaimsJws(jwtToken);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据token获取会员id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JwtInfo <span class="title">getMemberIdByJwtToken</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String jwtToken = request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(jwtToken)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jws&lt;Claims&gt; claimsJws = Jwts.parser().setSigningKey(getKeyInstance()).parseClaimsJws(jwtToken);</span><br><span class="line">        Claims claims = claimsJws.getBody();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtInfo(claims.get(<span class="string">&quot;id&quot;</span>).toString(), claims.get(<span class="string">&quot;nickname&quot;</span>).toString(), claims.get(<span class="string">&quot;avatar&quot;</span>).toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-2、新增订单–Controller层"><a href="#4-2、新增订单–Controller层" class="headerlink" title="4.2、新增订单–Controller层"></a>4.2、新增订单–Controller层</h3><blockquote><p>这个方法除了接收课程Id外，还需要接收一个HttpServletRequest对象，我们需要从这个request对象中获取用户信息（用户id）</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(&quot;新增订单&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;auth/save/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">save</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@ApiParam(value = &quot;课程Id&quot;,required = true)</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@PathVariable</span> String courseId, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">    JwtInfo jwtInfo = JwtUtils.getMemberIdByJwtToken(request);</span><br><span class="line">    <span class="comment">// 调用service层添加订单的方法，需要传入课程id和用户id</span></span><br><span class="line">    <span class="comment">// 这个方法将返回新增的订单id</span></span><br><span class="line">    String orderId = orderService.saveOrder(courseId,jwtInfo.getId());</span><br><span class="line">    <span class="keyword">return</span> R.ok().data(<span class="string">&quot;orderId&quot;</span>,orderId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-3、新增订单–Service层"><a href="#4-3、新增订单–Service层" class="headerlink" title="4.3、新增订单–Service层"></a>4.3、新增订单–Service层</h3><blockquote><p>Service层中新增订单的流程如下：</p></blockquote><ul><li>根据传入的memberId和courseId作为条件，使用QueryWrapper查询该用户是否已经存在当前课程的订单<ul><li>如果已存在，直接返回已存在的订单号即可</li></ul></li><li>查询课程信息和用户信息是否存在</li><li>创建订单，使用一个工具类生成订单号，然后将上面根据课程号查询到的课程信息，根据用户id查询到的用户信息填入订单对象中。</li><li>向数据库中插入该对象，根据Mybatis-Plus的id自动回填功能将订单对象Id返回。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">saveOrder</span><span class="params">(String courseId, String memberId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1 查询当前用户是否已经存在当前课程的订单</span></span><br><span class="line">    QueryWrapper&lt;Order&gt; orderQueryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    orderQueryWrapper.eq(<span class="string">&quot;course_id&quot;</span>,courseId);</span><br><span class="line">    orderQueryWrapper.eq(<span class="string">&quot;member_id&quot;</span>,memberId);</span><br><span class="line">    Order orderExist = baseMapper.selectOne(orderQueryWrapper);</span><br><span class="line">    <span class="comment">//如果已经存在订单，直接返回查找到的订单id即可</span></span><br><span class="line">    <span class="keyword">if</span>(orderExist != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> orderExist.getId();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//2 查询课程信息</span></span><br><span class="line">    CourseDto courseDto = eduCourseService.getCourseDtoById(courseId);</span><br><span class="line">    <span class="keyword">if</span>(courseDto == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果查询courseDto为空，直接抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> GrainException(ResultCodeEnum.PARAM_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//3 查询用户信息</span></span><br><span class="line">    MemberDto memberDto = eduMemberService.getMemberDtoByMemberId(memberId);</span><br><span class="line">    <span class="keyword">if</span>(memberDto == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果查询memberDto为空，直接抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> GrainException(ResultCodeEnum.PARAM_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4 创建订单</span></span><br><span class="line">    Order order = <span class="keyword">new</span> Order();</span><br><span class="line">    order.setOrderNo(OrderNoUtils.getOrderNo());</span><br><span class="line">    order.setCourseId(courseId);</span><br><span class="line">    order.setCourseTitle(courseDto.getTitle());</span><br><span class="line">    order.setCourseCover(courseDto.getCover());</span><br><span class="line">    order.setTeacherName(courseDto.getTeacherName());</span><br><span class="line">    <span class="comment">//分</span></span><br><span class="line">    order.setTotalFee(courseDto.getPrice().multiply(<span class="keyword">new</span> BigDecimal(<span class="number">100</span>)));</span><br><span class="line">    order.setMemberId(memberId);</span><br><span class="line">    order.setMobile(memberDto.getMobile());</span><br><span class="line">    order.setNickname(memberDto.getNickname());</span><br><span class="line">    <span class="comment">//未支付</span></span><br><span class="line">    order.setStatus(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//微信支付</span></span><br><span class="line">    order.setPayType(<span class="number">1</span>);</span><br><span class="line">    baseMapper.insert(order);</span><br><span class="line">    <span class="keyword">return</span> order.getId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5、定时任务"><a href="#5、定时任务" class="headerlink" title="5、定时任务"></a>5、定时任务</h2><h3 id="5-1、定时任务实现方式"><a href="#5-1、定时任务实现方式" class="headerlink" title="5.1、定时任务实现方式"></a>5.1、定时任务实现方式</h3><blockquote><p>Timer</p></blockquote><p>使用jdk的Timer和TimerTask可以实现简单的间隔执行任务，无法实现按日历去调度执行任务</p><blockquote><p>ScheduledThreadPool线程池</p></blockquote><p>创建可以延迟或定时执行任务的线程，无法实现按日历去调度执行任务</p><blockquote><p>quartz</p></blockquote><p>使用Quartz实现 Quartz 是一个异步任务调度框架，功能丰富，可以实现按日历调度</p><blockquote><p>Spring Task</p></blockquote><p>Spring 3.0后提供Spring Task实现任务调度，支持按日历调度，相比Quartz功能稍简单，但是开发基本够用，支持注解编程方式</p><h3 id="5-2、集成Spring-Task"><a href="#5-2、集成Spring-Task" class="headerlink" title="5.2、集成Spring Task"></a>5.2、集成Spring Task</h3><blockquote><p>在启动类中添加注解@EnableScheduling</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ComponentScan(&#123;&quot;com.hzx.grain&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceStatisticsApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ServiceStatisticsApplication.class, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;http://localhost:8180/doc.html&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;http://localhost:8180/swagger-ui.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-3、创建定时任务类"><a href="#5-3、创建定时任务类" class="headerlink" title="5.3、创建定时任务类"></a>5.3、创建定时任务类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduledTask</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DailyService dailyService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Scheduled(cron=&quot;0/3 * * * * *&quot;)</span> <span class="comment">// 每隔3秒执行一次</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">task1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;task1 执行&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-4、测试"><a href="#5-4、测试" class="headerlink" title="5.4、测试"></a>5.4、测试</h3><blockquote><p>查看控制台，可以发现控制台定时输出日志</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212215219.png" alt="image-20210212215219245"></p><h3 id="5-5、在线生成cron表达式"><a href="#5-5、在线生成cron表达式" class="headerlink" title="5.5、在线生成cron表达式"></a>5.5、在线生成cron表达式</h3><blockquote><p><a href="http://cron.qqe2.com/">http://cron.qqe2.com/</a></p></blockquote><blockquote><p>参考教程如下：</p></blockquote><ul><li>[1]  <a href="https://www.bilibili.com/video/BV1fi4y1x7on">尚硅谷在线教育项目</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> 项目总结 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
            <tag> 🆔JWT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据结构与算法学习（四）-二分查找算法</title>
      <link href="posts/1801475703.html"/>
      <url>posts/1801475703.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1、二分查找算法"><a href="#1、二分查找算法" class="headerlink" title="1、二分查找算法"></a>1、二分查找算法</h2><blockquote><p>二分查找（Binary Search）也叫作折半查找。二分查找有两个要求，一个是数列有序，另一个是数列使用顺序存储结构（比如数组）。</p></blockquote><h2 id="2、二分查找算法的思路分析"><a href="#2、二分查找算法的思路分析" class="headerlink" title="2、二分查找算法的思路分析"></a>2、二分查找算法的思路分析</h2><blockquote><p>这里以数组[1,8,10,89,1000,1234]为例</p></blockquote><ul><li>首先确定该数组中间元素的下标mid</li></ul><blockquote><p>mid = [left+right] / 2</p></blockquote><ul><li>让需要查找的数findVal和arr[mid]比较，此时会出现以下几种情况<ul><li>findVal&gt;arr[mid]，说明要查找的数在mid的右边，因此我们需要递归向右查找</li><li>findVal&lt;arr[mid]，说明要查找的数在mid的左边，因此我们需要递归向左查找</li><li>findVal=arr[mid]，说明arr[mid]就是我们要寻找的值，直接返回mid</li></ul></li><li>结束递归的条件有<ul><li>找到目标值结束递归。</li><li>递归完整个数组仍然没有找到findVal，也需要结束递归。即当left&gt;right时结束递归。</li></ul></li></ul><h2 id="3、递归二分查找算法的代码实现"><a href="#3、递归二分查找算法的代码实现" class="headerlink" title="3、递归二分查找算法的代码实现"></a>3、递归二分查找算法的代码实现</h2><blockquote><p>递归退出条件1：寻找到目标值，此时返回mid</p><p>递归退出条件2：递归完整个数组没有找到目标值，此时left &gt; right，返回-1</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 二分查找算法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> arr 要查找的目标数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> left 本次查找的左边界</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> right 本次查找的右边界</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> findVal 要查找的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> findVal在arr中的下标，如果找不到返回-1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binarySearch</span><span class="params">(<span class="keyword">int</span>[] arr,<span class="keyword">int</span> left,<span class="keyword">int</span> right,<span class="keyword">int</span> findVal)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(left &gt; right) &#123;</span><br><span class="line">        <span class="comment">//如果发现left值大于right值，那么证明此时数组已经递归完毕且数组中没有要寻找的值</span></span><br><span class="line">        <span class="comment">//此时需要返回-1</span></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> mid = (left + right) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> midVal = arr[mid];</span><br><span class="line">    <span class="comment">//如果要寻找的值小于当前的midVal</span></span><br><span class="line">    <span class="keyword">if</span>(findVal &gt; midVal) &#123;</span><br><span class="line">        <span class="comment">//向右递归</span></span><br><span class="line">        <span class="keyword">return</span> binarySearch(arr,mid + <span class="number">1</span>,right,findVal);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(findVal &lt; midVal) &#123;</span><br><span class="line">        <span class="comment">//向左递归</span></span><br><span class="line">        <span class="keyword">return</span> binarySearch(arr,left,mid - <span class="number">1</span>,findVal);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4、测试"><a href="#4、测试" class="headerlink" title="4、测试"></a>4、测试</h2><blockquote><p>测试找不到的情况</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] arr = &#123;<span class="number">1</span>,<span class="number">8</span>,<span class="number">10</span>,<span class="number">89</span>,<span class="number">1000</span>,<span class="number">1234</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> resultIndex = binarySearch(arr,<span class="number">0</span>, arr.length - <span class="number">1</span>,<span class="number">10000</span>);</span><br><span class="line">    System.out.println(resultIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212170117.png" alt="image-20210212170116299"></p><blockquote><p>测试找得到的情况</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] arr = &#123;<span class="number">1</span>,<span class="number">8</span>,<span class="number">10</span>,<span class="number">89</span>,<span class="number">1000</span>,<span class="number">1234</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> resultIndex = binarySearch(arr,<span class="number">0</span>, arr.length - <span class="number">1</span>,<span class="number">8</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;resultIndex:&quot;</span> + resultIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212170225.png" alt="image-20210212170225794"></p><h2 id="5、改进二分查找算法"><a href="#5、改进二分查找算法" class="headerlink" title="5、改进二分查找算法"></a>5、改进二分查找算法</h2><blockquote><p>在一个数组中，如果有多个值与findVal值相同时，要求将这些值的下标都找到</p><p>思路分析如下:</p></blockquote><ul><li><p>在找到mid索引值时，不要马上返回</p></li><li><p>向mid索引值的左边扫描，将所有等于findVal的元素下标进入到一个集合中</p></li><li><p>向mid索引值的右边扫描，将所有等于findVal的元素下标进入到一个集合中</p></li><li><p>返回下标集合</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 二分查找算法</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> arr 要查找的目标数组</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> left 本次查找的左边界</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> right 本次查找的右边界</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> findVal 要查找的值</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> findVal在arr中的下标，如果找不到返回-1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Integer&gt; <span class="title">binarySearchAllElements</span><span class="params">(<span class="keyword">int</span>[] arr,<span class="keyword">int</span> left,<span class="keyword">int</span> right,<span class="keyword">int</span> findVal)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(left &gt; right) &#123;</span><br><span class="line">        <span class="comment">//如果发现left值大于right值，那么证明此时数组已经递归完毕且数组中没有要寻找的值</span></span><br><span class="line">        <span class="comment">//此时需要返回null</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> mid = (left + right) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> midVal = arr[mid];</span><br><span class="line">    <span class="comment">//如果要寻找的值小于当前的midVal</span></span><br><span class="line">    <span class="keyword">if</span>(findVal &gt; midVal) &#123;</span><br><span class="line">        <span class="comment">//向右递归</span></span><br><span class="line">        <span class="keyword">return</span> binarySearchAllElements(arr,mid + <span class="number">1</span>,right,findVal);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(findVal &lt; midVal) &#123;</span><br><span class="line">        <span class="comment">//向左递归</span></span><br><span class="line">        <span class="keyword">return</span> binarySearchAllElements(arr,left,mid - <span class="number">1</span>,findVal);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; resIndexList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">//实现向左边扫描</span></span><br><span class="line">        <span class="keyword">int</span> temp = mid - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//如果数组下标越界或者左边已经没有与findVal相等的值</span></span><br><span class="line">            <span class="keyword">if</span>(temp &lt; <span class="number">0</span> || arr[temp] != findVal) &#123;</span><br><span class="line">                <span class="comment">//退出</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            resIndexList.add(temp);</span><br><span class="line">            temp -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//将mid加入到集合中</span></span><br><span class="line">        resIndexList.add(mid);</span><br><span class="line">        <span class="comment">//向右边扫描</span></span><br><span class="line">        temp = mid + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(temp &gt; arr.length - <span class="number">1</span> || arr[temp] != findVal) &#123;</span><br><span class="line">                <span class="comment">//退出</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            resIndexList.add(temp);</span><br><span class="line">            temp += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> resIndexList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>测试</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] arr = &#123;<span class="number">1</span>,<span class="number">5</span>,<span class="number">1000</span>,<span class="number">1000</span>,<span class="number">1000</span>,<span class="number">1234</span>,<span class="number">1999</span>&#125;;</span><br><span class="line">    List&lt;Integer&gt; result = binarySearchAllElements(arr,<span class="number">0</span>, arr.length - <span class="number">1</span>,<span class="number">1000</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;结果下标为：&quot;</span> + result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212171648.png" alt="image-20210212171648097"></p><h2 id="6、非递归实现二分查找算法"><a href="#6、非递归实现二分查找算法" class="headerlink" title="6、非递归实现二分查找算法"></a>6、非递归实现二分查找算法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binarySearch</span><span class="params">(<span class="keyword">int</span>[] arr,<span class="keyword">int</span> findVal)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//如果数组为空直接return -1</span></span><br><span class="line">    <span class="keyword">if</span>(arr == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> left = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> right = arr.length - <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//在left小于right的情况下进行循环</span></span><br><span class="line">    <span class="keyword">while</span>(left &lt;= right) &#123;</span><br><span class="line">        <span class="keyword">int</span> mid = (left + right) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span>(findVal &lt; arr[mid]) &#123;</span><br><span class="line">            <span class="comment">//说明此时需要向左进行查找</span></span><br><span class="line">            right = mid - <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(findVal &gt; arr[mid]) &#123;</span><br><span class="line">            <span class="comment">//说明此时需要向右进行查找</span></span><br><span class="line">            left = mid + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果上面没有返回，证明数组中没有findVal，直接返回-1</span></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>测试：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span>[] arr = &#123;<span class="number">1</span>,<span class="number">5</span>,<span class="number">888</span>,<span class="number">1000</span>,<span class="number">1111</span>,<span class="number">1234</span>,<span class="number">1999</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> resIndex = binarySearch(arr,<span class="number">5</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;resIndex的值为:&quot;</span> + resIndex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210212172431.png" alt="image-20210212172431234"></p>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Cloud学习（二）-OpenFeign微服务调用</title>
      <link href="posts/2863462089.html"/>
      <url>posts/2863462089.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、OpenFeign"><a href="#一、OpenFeign" class="headerlink" title="一、OpenFeign"></a>一、OpenFeign</h1><blockquote><p>OpenFeign是Spring Cloud提供的一个声明式的伪Http客户端， 它使得调用远程服务就像调用本地服务一样简单， 只需要<strong>创建一个接口并添加一个注解</strong>即可。</p><p>Nacos很好的兼容了OpenFeign， OpenFeign默认<strong>集成了 Ribbon</strong>， 所以在Nacos下使用OpenFeign默认就实现了负载均衡的效果。</p><p>Feign是一个声明式的web服务客户端，让编写web服务客户端变得非常容易，只需创建一个接口并在接口上添加注解即可</p></blockquote><h2 id="1-1、作用"><a href="#1-1、作用" class="headerlink" title="1.1、作用"></a>1.1、作用</h2><ul><li>Feign使得编写Java Http客户端变得更加容易。</li><li>在Feign的实现下，我们只需创建一个接口并使用注解的方式来配置它（以前是Dao接口上面标注Mapper注解，现在是一个微服务接口上面标注一个Feign注解即可），即可完成对服务提供方的接口绑定，简化了使用Spring cloud Ribbon时，自动封装服务调用客户端的开发量。</li><li>Feign集成了Ribbon利用Ribbon维护了Payment的服务列表信息，并且通过轮询实现了客户端的负载均衡。而与Ribbon不同的是，通过feign只需要定义服务绑定接口目以声明式的方法，优雅而简单的实现了服务调用。</li></ul><h2 id="1-2、Feign和OpenFeign"><a href="#1-2、Feign和OpenFeign" class="headerlink" title="1.2、Feign和OpenFeign"></a>1.2、Feign和OpenFeign</h2><table><thead><tr><th>Feign</th><th>OpenFeign</th></tr></thead><tbody><tr><td>Feign是Spring Cloud组件中的一个轻量级RESTful的HTTP服务客户端Feign内置了Ribbon，用来做客户端负载均衡，去调用服务注册中心的服务。Feign的使用方式是：使用Feign的注解定义接口，调用这个接口，就可以调用服务注册中心的服务。</td><td>OpenFeign是Spring Cloud 在Feign的基础上支持了Spring MVC的注解，如@RequesMapping等等。OpenFeign的@FeignClient可以解析Spring MVC的@RequestMapping注解下的接口，并通过动态代理的方式产生实现类，实现类中做负载均衡并调用其他服务。</td></tr></tbody></table><h2 id="1-3、OpenFeign使用步骤"><a href="#1-3、OpenFeign使用步骤" class="headerlink" title="1.3、OpenFeign使用步骤"></a>1.3、OpenFeign使用步骤</h2><h3 id="1、创建微服务提供者集群"><a href="#1、创建微服务提供者集群" class="headerlink" title="1、创建微服务提供者集群"></a>1、创建微服务提供者集群</h3><blockquote><p>创建微服务模块cloud-provider-payment8001和cloud-provider-payment8002，payment微服务的控制器为：</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;支付功能控制器&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;server.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据id查询订单&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        Payment result = paymentService.getPaymentById(id);</span><br><span class="line">        <span class="keyword">if</span>(result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">404</span>,<span class="string">&quot;数据库中没有该订单！端口为：&quot;</span> + serverPort,<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">200</span>,<span class="string">&quot;成功！端口为：&quot;</span> + serverPort,result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、创建OpenFeign客户端"><a href="#2、创建OpenFeign客户端" class="headerlink" title="2、创建OpenFeign客户端"></a>2、创建OpenFeign客户端</h3><blockquote><p>创建微服务模块cloud-consumer-feign-order80，这个微服务需要调用payment微服务中的接口。</p><p>注：OpenFeign是在<strong>消费端（微服务调用者端）</strong>使用的。</p></blockquote><h3 id="3、引入依赖"><a href="#3、引入依赖" class="headerlink" title="3、引入依赖"></a>3、引入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--openfeign--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cloudstudy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>OpenFeign中自动集成了Ribbon，实现了负载均衡</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211214254.png" alt="image-20210211214254211"></p><h3 id="4、编写yml配置文件"><a href="#4、编写yml配置文件" class="headerlink" title="4、编写yml配置文件"></a>4、编写yml配置文件</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 不注册入eureka</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,</span> <span class="string">http://eureka7002.com:7002/eureka</span></span><br></pre></td></tr></table></figure><h3 id="5、编写启动类，添加-EnableFeignClients注解激活OpenFeign"><a href="#5、编写启动类，添加-EnableFeignClients注解激活OpenFeign" class="headerlink" title="5、编写启动类，添加@EnableFeignClients注解激活OpenFeign"></a>5、编写启动类，添加@EnableFeignClients注解激活OpenFeign</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//激活并开启OpenFeign</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderFeignMain80</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderFeignMain80.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6、编写一个Service接口，用于远程调用payment微服务"><a href="#6、编写一个Service接口，用于远程调用payment微服务" class="headerlink" title="6、编写一个Service接口，用于远程调用payment微服务"></a>6、编写一个Service接口，用于远程调用payment微服务</h3><blockquote><p>注意点：</p><ul><li>在Service接口上添加一个@FeignClient注解，value值为要调用的微服务在注册中心中注册的服务名；</li><li>需要完整添加远程调用接口的全路径</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;cloud-payment-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentFeignService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function">CommonResult&lt;Payment&gt; <span class="title">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7、在OpenFeign微服务中编写Controller"><a href="#7、在OpenFeign微服务中编写Controller" class="headerlink" title="7、在OpenFeign微服务中编写Controller"></a>7、在OpenFeign微服务中编写Controller</h3><blockquote><p>这个Controller调用上面写的OpenFeign服务接口</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderFeignController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentFeignService paymentFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentFeignService.getPaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8、测试"><a href="#8、测试" class="headerlink" title="8、测试"></a>8、测试</h3><blockquote><p>启动eureka7001、payment8001、payment8002集群和openfeign微服务。</p></blockquote><ul><li>由于openfeign微服务没有被我们注册入eureka，所以eureka注册中心显示如下</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211220835.png" alt="image-20210211220835349"></p><ul><li>使用openfeign微服务远程调用payment微服务中的方法</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211221340.png" alt="image-20210211221340700"></p><h2 id="1-4、OpenFeign超时控制"><a href="#1-4、OpenFeign超时控制" class="headerlink" title="1.4、OpenFeign超时控制"></a>1.4、OpenFeign超时控制</h2><h3 id="1、OpenFeign默认等待时间"><a href="#1、OpenFeign默认等待时间" class="headerlink" title="1、OpenFeign默认等待时间"></a>1、OpenFeign默认等待时间</h3><blockquote><p>OpenFeign默认等待时间为1秒钟，若服务提供方超过这个时间则直接报错。</p></blockquote><h3 id="2、演示超时出错情况"><a href="#2、演示超时出错情况" class="headerlink" title="2、演示超时出错情况"></a>2、演示超时出错情况</h3><blockquote><p>在服务提供方payment微服务中新添一个接口，在接口中模拟超时情况</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/payment/feign/timeout&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">paymentFeignTimeOut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//在被调用的服务提供方中休眠三秒</span></span><br><span class="line">    <span class="comment">//用于模拟长流程调用</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException interruptedException) &#123;</span><br><span class="line">        interruptedException.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> serverPort;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、在OpenFeign微服务中添加远程调用接口"><a href="#3、在OpenFeign微服务中添加远程调用接口" class="headerlink" title="3、在OpenFeign微服务中添加远程调用接口"></a>3、在OpenFeign微服务中添加远程调用接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/payment/feign/timeout&quot;)</span></span><br><span class="line">   <span class="function">String <span class="title">paymentFeignTimeOut</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><h3 id="4、在OpenFeign微服务控制器中添加接口"><a href="#4、在OpenFeign微服务控制器中添加接口" class="headerlink" title="4、在OpenFeign微服务控制器中添加接口"></a>4、在OpenFeign微服务控制器中添加接口</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(value = &quot;/consumer/feign/timeout&quot;)</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> String <span class="title">paymentFeignTimeOut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> paymentFeignService.paymentFeignTimeOut();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><h3 id="5、测试"><a href="#5、测试" class="headerlink" title="5、测试"></a>5、测试</h3><blockquote><p>先访问payment微服务中新增的接口</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211222304.png" alt="image-20210211222304721"></p><blockquote><p>测试远程调用payment微服务的超时接口</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211222545.png" alt="image-20210211222545603"></p><h3 id="6、设置OpenFeign的超时时间"><a href="#6、设置OpenFeign的超时时间" class="headerlink" title="6、设置OpenFeign的超时时间"></a>6、设置OpenFeign的超时时间</h3><blockquote><p>修改yml配置文件</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置Feign客户端的超时时间(OpenFeign默认支持Ribbon)</span></span><br><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="comment">#指的是建立连接后从服务器读取到可用资源所用的时间</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">5000</span></span><br><span class="line">  <span class="comment">#指的是建立连接所用的时间，适用于网络正常的情况下</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure><blockquote><p>重启OpenFeign微服务，测试</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211222811.png" alt="image-20210211222811217"></p><h2 id="1-5、OpenFeign的日志打印功能"><a href="#1-5、OpenFeign的日志打印功能" class="headerlink" title="1.5、OpenFeign的日志打印功能"></a>1.5、OpenFeign的日志打印功能</h2><h3 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h3><blockquote><p>Feign 提供了日志打印功能，我们可以通过配置来调整日志级别，从而了解 Feign中Http请求的细节。<br>说白了就是对Feign接口的调用情况进行监控和输出</p></blockquote><h3 id="2、级别说明"><a href="#2、级别说明" class="headerlink" title="2、级别说明"></a>2、级别说明</h3><ul><li>NONE:默认的，不显示任何日志；</li><li>BASIC：仅记录请求方法、URL、响应状态码及执行时间；</li><li>HEADERS:除了BASIC中定义的信息之外，还有请求和响应的头信息；</li><li>FULL:除了HEADERS中定义的信息之外，还有请求和响应的正文及元数据。</li></ul><h3 id="3、编写配置类，配置日志输出级别"><a href="#3、编写配置类，配置日志输出级别" class="headerlink" title="3、编写配置类，配置日志输出级别"></a>3、编写配置类，配置日志输出级别</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeignLogConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 开启详细日志</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.<span class="function">Level <span class="title">feignLoggerLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4、在yml文件中开启日志的Feign客户端"><a href="#4、在yml文件中开启日志的Feign客户端" class="headerlink" title="4、在yml文件中开启日志的Feign客户端"></a>4、在yml文件中开启日志的Feign客户端</h3><blockquote><p>指定Feign以什么级别监控哪个接口</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="comment"># feign日志以什么级别监控哪个接口</span></span><br><span class="line">    <span class="attr">com.hzx.springcloud.service.PaymentFeignService:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure><h3 id="5、再次测试，查看日志输出"><a href="#5、再次测试，查看日志输出" class="headerlink" title="5、再次测试，查看日志输出"></a>5、再次测试，查看日志输出</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211223406.png" alt="image-20210211223406662"></p><blockquote><p>日志输出情况</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211223450.png" alt="image-20210211223450652"></p><h1 id="二、在线教育项目整合OpenFeign"><a href="#二、在线教育项目整合OpenFeign" class="headerlink" title="二、在线教育项目整合OpenFeign"></a>二、在线教育项目整合OpenFeign</h1><blockquote><p>在线教育中，我们创建了两个用于与阿里云交互的微服务，分别为用于文件上传的oss微服务和用于视频点播的vod微服务，在其他微服务中，我们需要远程调用这两个微服务中的接口来完成业务需求。</p></blockquote><h2 id="2-1、远程调用OSS微服务"><a href="#2-1、远程调用OSS微服务" class="headerlink" title="2.1、远程调用OSS微服务"></a>2.1、远程调用OSS微服务</h2><blockquote><p>在删除讲师信息时，我们希望一同删除该讲师上传至阿里云中的头像文件，该过程中需要远程调用oss微服务中的文件删除接口</p></blockquote><h3 id="1、Oss微服务中的文件删除接口"><a href="#1、Oss微服务中的文件删除接口" class="headerlink" title="1、Oss微服务中的文件删除接口"></a>1、Oss微服务中的文件删除接口</h3><ul><li>Controller层</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping(&quot;remove&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;图片文件删除&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">removeFile</span><span class="params">(<span class="meta">@RequestBody</span> String url)</span> </span>&#123;</span><br><span class="line">    fileService.removeFile(url);</span><br><span class="line">    <span class="keyword">return</span> R.ok().message(<span class="string">&quot;文件删除成功！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Service实现类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeFile</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//读取配置信息</span></span><br><span class="line">    String endpoint = ossProperties.getEndpoint();</span><br><span class="line">    String keyid = ossProperties.getKeyid();</span><br><span class="line">    String keysecret = ossProperties.getKeysecret();</span><br><span class="line">    String bucketname = ossProperties.getBucketname();</span><br><span class="line">    <span class="comment">//创建OSSClient实例</span></span><br><span class="line">    OSS ossClient = <span class="keyword">new</span> OSSClientBuilder().build(endpoint,keyid,keysecret);</span><br><span class="line">    <span class="comment">//获取要删除的文件名，根据url获取</span></span><br><span class="line">    <span class="comment">//主机名</span></span><br><span class="line">    String host = <span class="string">&quot;https://&quot;</span> + bucketname + <span class="string">&quot;.&quot;</span> + endpoint + <span class="string">&quot;/&quot;</span>;</span><br><span class="line">    <span class="comment">//从主机名长度的下标开始截取，就可以获取文件名</span></span><br><span class="line">    String objectName = url.substring(host.length());</span><br><span class="line">    System.out.println(objectName);</span><br><span class="line">    ossClient.deleteObject(bucketname,objectName);</span><br><span class="line">    <span class="comment">//关闭OSSClient</span></span><br><span class="line">    ossClient.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、在edu微服务中远程调用Oss微服务"><a href="#2、在edu微服务中远程调用Oss微服务" class="headerlink" title="2、在edu微服务中远程调用Oss微服务"></a>2、在edu微服务中远程调用Oss微服务</h3><blockquote><p>在edu微服务中创建一个feign包，包下存放远程调用接口</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;service-oss&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OssFileService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 远程调用OSS微服务中的控制器方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/admin/oss/file/remove&quot;)</span></span><br><span class="line">    <span class="function">R <span class="title">removeFile</span><span class="params">(<span class="meta">@RequestBody</span> String url)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在edu微服务中调用feign接口删除讲师头像</p><p>teacherService.removeAvatarById(id);</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 根据id删除讲师</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id 要删除的讲师id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 删除结果及提示信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@DeleteMapping(&quot;remove/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(value = &quot;根据ID删除讲师&quot;, notes = &quot;根据ID删除讲师&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">removeById</span><span class="params">(<span class="meta">@ApiParam(value = &quot;讲师id&quot;,required = true)</span> <span class="meta">@PathVariable(&quot;id&quot;)</span> String id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//删除讲师前先删除讲师头像</span></span><br><span class="line">    teacherService.removeAvatarById(id);</span><br><span class="line">    <span class="keyword">boolean</span> flag = teacherService.removeById(id);</span><br><span class="line">    <span class="keyword">return</span> flag ? R.ok().message(<span class="string">&quot;删除成功！&quot;</span>) : R.error().message(<span class="string">&quot;删除失败！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>removeAvatarById(id)方法如下</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TeacherServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">TeacherMapper</span>, <span class="title">Teacher</span>&gt; <span class="keyword">implements</span> <span class="title">TeacherService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 注入远程调用接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OssFileService ossFileService;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeAvatarById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1 根据id获取讲师avatar的url</span></span><br><span class="line">        Teacher teacher = baseMapper.selectById(id);</span><br><span class="line">        <span class="keyword">if</span>(teacher != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String avatarUrl = teacher.getAvatar();</span><br><span class="line">            <span class="keyword">if</span>(StringUtils.isNotBlank(avatarUrl)) &#123;</span><br><span class="line">                <span class="comment">//头像不为空才进行远程调用</span></span><br><span class="line">                R r = ossFileService.removeFile(avatarUrl);</span><br><span class="line">                <span class="keyword">return</span> r.getSuccess();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spring Cloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
            <tag> 👥OpenFeign </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Cloud学习（一）-GateWay网关</title>
      <link href="posts/337037609.html"/>
      <url>posts/337037609.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、网关基本概念"><a href="#一、网关基本概念" class="headerlink" title="一、网关基本概念"></a>一、网关基本概念</h1><h2 id="1-1、API网关介绍"><a href="#1-1、API网关介绍" class="headerlink" title="1.1、API网关介绍"></a>1.1、API网关介绍</h2><blockquote><p>API 网关出现的原因是微服务架构的出现，不同的微服务一般会有不同的网络地址，而外部客户端可能需要调用多个服务的接口才能完成一个业务需求，如果让客户端直接与各个微服务通信，会有以下的问题：</p></blockquote><ul><li><p>客户端会多次请求不同的微服务，增加了客户端的复杂性。</p></li><li><p>存在跨域请求，在一定场景下处理相对复杂。</p></li><li><p>认证复杂，每个服务都需要独立认证。</p></li><li><p>难以重构，随着项目的迭代，可能需要重新划分微服务。例如，可能将多个服务合并成一个或者将一个服务拆分成多个。如果客户端直接与微服务通信，那么重构将会很难实施。</p></li></ul><p>以上这些问题可以借助 API 网关解决。API 网关是介于客户端和服务器端之间的中间层，所有的外部请求都会先经过 API 网关这一层。也就是说，API 的实现方面更多的考虑业务逻辑，而安全、性能、监控可以交由 API 网关来做，这样既提高业务灵活性又不缺安全性</p><blockquote><p>假设一个电商项目，购买一件商品需要调用多个微服务接口，才能完成下单操作，在没有使用网关之前，用户的操作流程图是这样的：</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211121506.png" alt="image-20210211121505821"></p><blockquote><p>在引入网关后，架构可以演变为下图</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211121759.png" alt="image-20210211121759523"></p><blockquote><p>微服务网关是程序的大门，封装了应用程序的内部结构，用户只需要跟网关交互，无需调用特定微服务接口。</p><p>这样，开发就可以得到简化。不仅如此，使用微服务网关还有以下优点：</p></blockquote><ul><li>易于监控。可在微服务网关收集监控数据并将其推送到外部系统进行分析。</li><li>易于认证。可在微服务网关上进行认证，然后再将请求转发到后端的微服务，而无须在每个微服务中进行认证。</li><li>减少了客户端与各个微服务之间的交互次数。</li></ul><h2 id="1-2、Spring-Cloud-GateWay"><a href="#1-2、Spring-Cloud-GateWay" class="headerlink" title="1.2、Spring Cloud GateWay"></a>1.2、Spring Cloud GateWay</h2><h3 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h3><blockquote><p><strong>Spring cloud gateway</strong>是spring官方基于Spring 5.0、Spring Boot2.0和Project Reactor等技术开发的网关，Spring Cloud Gateway旨在为微服务架构提供简单、有效和统一的API路由管理方式，Spring Cloud Gateway作为Spring Cloud生态系统中的网关，目标是替代Netflix Zuul，其不仅提供统一的路由方式，并且还基于Filer链的方式提供了网关基本的功能，例如：安全、监控/埋点、限流等。</p><p>Spring Cloud Gateway作为Spring Cloud生态系统中的网关，目的是为了替代Zuul，在Spring Cloud2.0以上版本中，没有对新版本的Zuul 2.0以上的新高版本进行集成，仍然还是使用Zuul 1.x非Reactor模式的老版本。Gateway是<strong>基于webFlux框架实现的</strong>，<strong>WebFlux框架底层</strong>使用了<strong>高性能</strong>的Reactor模式通信框架<strong>Netty</strong>。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211130506.png" alt="img"></p><blockquote><p>作用：</p></blockquote><ul><li>反向代理</li><li>统一鉴权</li><li>流量控制</li><li>熔断</li><li>日志监控</li></ul><blockquote><p>所处位置</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211130628.png" alt="img"></p><h3 id="2、核心概念"><a href="#2、核心概念" class="headerlink" title="2、核心概念"></a>2、核心概念</h3><ul><li><p><strong>路由</strong>：路由是网关最基础的部分，路由信息有一个ID、一个目的URL、一组断言和一组Filter组成。如果断言路由为真，则说明请求的URL和配置匹配</p><ul><li>id：路由id，没有起名规则，但要求唯一</li><li>uri：匹配路由的转发地址</li><li>predicates：配置该路由的断言，若符合该断言则会转发到匹配的地址</li><li>order：路由的优先级，数字越小优先级越高</li></ul></li><li><p><strong>断言</strong>：Java8中的断言函数。Spring Cloud Gateway中的断言函数允许开发者去定义匹配来自于http request中的任何信息，比如请求头和参数等。</p></li><li><p><strong>过滤器</strong>：一个标准的Spring webFilter。Spring cloud gateway中的filter分为两种类型的Filter，分别是Gateway Filter和Global Filter。过滤器Filter将会对请求和响应进行修改处理。</p></li></ul><h3 id="3、执行流程"><a href="#3、执行流程" class="headerlink" title="3、执行流程"></a>3、执行流程</h3><blockquote><p>如下图所示，Spring cloud Gateway发出请求。然后再由Gateway Handler Mapping中找到与请求相匹配的路由，将其发送到Gateway web handler。Handler再通过指定的过滤器链将请求发送到我们实际的服务执行业务逻辑，然后返回。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211130419.png" alt="image-20210211130417182"></p><ul><li>Filter中，”pre”类型的过滤器可以做参数校验、权限校验、流量控制、日志输出和协议转换等。”post”类型的过滤器可以做相应内容、响应头的修改、日志的输出、流量监控。</li><li>核心逻辑：路由转发+执行过滤器链。</li></ul><h3 id="4、特点"><a href="#4、特点" class="headerlink" title="4、特点"></a>4、特点</h3><p>优点：</p><ul><li>性能强劲：是第一代网关Zuul的1.6倍</li><li>功能强大：内置了很多实用的功能，例如转发、监控、限流等</li><li>设计优雅，容易扩展</li></ul><p>缺点：</p><ul><li>其实现依赖Netty与WebFlux，不是传统的Servlet编程模型，学习成本高</li><li>不能将其部署在Tomcat、Jetty等Servlet容器里，只能打成jar包执行</li><li>需要Spring Boot 2.0及以上的版本，才支持</li></ul><h1 id="二、网关使用"><a href="#二、网关使用" class="headerlink" title="二、网关使用"></a>二、网关使用</h1><h2 id="2-1、创建网关微服务cloud-gateway-9527"><a href="#2-1、创建网关微服务cloud-gateway-9527" class="headerlink" title="2.1、创建网关微服务cloud-gateway-9527"></a>2.1、创建网关微服务cloud-gateway-9527</h2><blockquote><p>pom.xml</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--新增gateway--&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.cloudstudy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>application.yml配置文件</p></blockquote><p>application.yml文件中添加路由配置</p><ul><li>-：表示数组元素，可以配置多个节点</li><li>id：配置的唯一标识，可以和微服务同名，也可以起别的名字，区别于其他 Route。</li><li>uri：路由指向的目的地 uri，即客户端请求最终被转发到的微服务。</li><li>predicates：断言的作用是进行条件判断，只有断言都返回真，才会真正的执行路由。</li><li>Path：路径形式的断言。当匹配这个路径时，断言条件成立</li><li>/**：一个或多个层次的路径</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span> <span class="comment">#注册到eureka中的应用名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh</span> <span class="comment">#路由id，没有命名规则但要求唯一，建议配合服务名</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:8001</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/get/**</span>  <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:8001</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>  <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure><blockquote><p>主启动类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayMain9527</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(GatewayMain9527.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-2、Payment8001"><a href="#2-2、Payment8001" class="headerlink" title="2.2、Payment8001"></a>2.2、Payment8001</h2><blockquote><p>在payment微服务中有两个重要接口</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/get/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;根据id查询订单&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">    Payment result = paymentService.getPaymentById(id);</span><br><span class="line">    <span class="keyword">if</span>(result == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">404</span>,<span class="string">&quot;数据库中没有该订单！端口为：&quot;</span> + serverPort,<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">200</span>,<span class="string">&quot;成功！端口为：&quot;</span> + serverPort,result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;/lb&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPaymentLB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> serverPort;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>我们希望通过网关在payment服务的8001端口外再包裹一层9527端口，让用户无法直接访问8001端口。</p></blockquote><h2 id="2-3、启动微服务，进行测试"><a href="#2-3、启动微服务，进行测试" class="headerlink" title="2.3、启动微服务，进行测试"></a>2.3、启动微服务，进行测试</h2><blockquote><p>启动eureka7001、payment8001和gateway9527</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211132551.png" alt="image-20210211132551232"></p><blockquote><p>通过localhost:8001/payment/lb访问payment微服务</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211132713.png" alt="image-20210211132713170"></p><blockquote><p>通过网关，即9527端口访问payment微服务</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211133144.png" alt="image-20210211133144911"></p><blockquote><p>访问说明</p></blockquote><ul><li>payment微服务控制器的访问路径</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211133943.png" alt="image-20210211133942958"></p><ul><li>如果访问路径匹配路由断言，则转发到指定uri</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211134300.png" alt="image-20210211134259898"></p><h2 id="2-4、配置路由的另一种方式"><a href="#2-4、配置路由的另一种方式" class="headerlink" title="2.4、配置路由的另一种方式"></a>2.4、配置路由的另一种方式</h2><blockquote><p>使用网关，让网关帮我们跳转到百度新闻页面</p></blockquote><ul><li>如果访问路径匹配路由断言/guoji，则帮我们跳转到<a href="http://news.baidu.com/guoji">http://news.baidu.com/guoji</a></li><li>如果访问路径匹配路由断言/guonei，则帮我们跳转到<a href="http://news.baidu.com/guonei">http://news.baidu.com/guonei</a></li></ul><h3 id="1、创建一个GateWayConfig配置类"><a href="#1、创建一个GateWayConfig配置类" class="headerlink" title="1、创建一个GateWayConfig配置类"></a>1、创建一个GateWayConfig配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder routeLocatorBuilder)</span> </span>&#123;</span><br><span class="line">        RouteLocatorBuilder.Builder routes = routeLocatorBuilder.routes();</span><br><span class="line">        routes.route(<span class="string">&quot;path_route_wuhu&quot;</span>,</span><br><span class="line">                r -&gt; r.path(<span class="string">&quot;/guonei&quot;</span>).uri(<span class="string">&quot;http://news.baidu.com/guonei&quot;</span>));</span><br><span class="line">        routes.route(<span class="string">&quot;path_route_qifei&quot;</span>,</span><br><span class="line">                r -&gt; r.path(<span class="string">&quot;/guoji&quot;</span>).uri(<span class="string">&quot;http://news.baidu.com/guoji&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> routes.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>使用routes对象的route方法来配置路由断言及要转发的uri</li><li>其中route接收两个参数，一个为路由id，另一个为jdk8新添加的Function接口对象</li><li>如果访问路径中有/guonei，那么网关会帮我们跳转到<a href="http://news.baidu.com/guonei%EF%BC%9B%E5%A6%82%E6%9E%9C%E8%AE%BF%E9%97%AE%E8%B7%AF%E5%BE%84%E4%B8%AD%E6%9C%89/guoji%EF%BC%8C%E9%82%A3%E4%B9%88%E7%BD%91%E5%85%B3%E4%BC%9A%E5%B8%AE%E6%88%91%E4%BB%AC%E8%B7%B3%E8%BD%AC%E5%88%B0http://news.baidu.com/guoji">http://news.baidu.com/guonei；如果访问路径中有/guoji，那么网关会帮我们跳转到http://news.baidu.com/guoji</a></li></ul><h3 id="2、测试"><a href="#2、测试" class="headerlink" title="2、测试"></a>2、测试</h3><blockquote><p>访问<a href="http://localhost:9527/guoji">http://localhost:9527/guoji</a></p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211135216.png" alt="image-20210211135215779"></p><blockquote><p>同理访问<a href="http://localhost:9527/guonei">http://localhost:9527/guonei</a></p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211135303.png" alt="image-20210211135303881"></p><h2 id="2-5、配合注册中心实现动态路由"><a href="#2-5、配合注册中心实现动态路由" class="headerlink" title="2.5、配合注册中心实现动态路由"></a>2.5、配合注册中心实现动态路由</h2><blockquote><p>默认情况下Gateway会根据注册中心的服务列表，以注册中心上微服务名为路径创建动态路由进行转发，从而实现动态路由的功能</p></blockquote><h3 id="1、启动"><a href="#1、启动" class="headerlink" title="1、启动"></a>1、启动</h3><blockquote><p>根据payment8001微服务复刻出另一个类似的payment微服务，端口号为8002</p><p>启动eureka7001+payment8001+payment8002</p></blockquote><h3 id="2、修改网关微服务配置文件"><a href="#2、修改网关微服务配置文件" class="headerlink" title="2、修改网关微服务配置文件"></a>2、修改网关微服务配置文件</h3><blockquote><p>在路由的uri中使用lb://微服务名称的方法来动态配置路由，并实现负载均衡，使用步骤如下</p></blockquote><ul><li>在配置文件中开启从注册中心动态创建路由的功能，使用微服务名进行路由</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="comment"># 开启从注册中心动态创建路由的功能，使用微服务名进行路由</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><ul><li>在配置文件中将路由uri修改为lb://微服务名来指定跳转地址，并实现负载均衡，需要注意的是uri的协议为lb，表示启用Gateway的负载均衡功能。</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh</span> <span class="comment">#路由id，没有命名规则但要求唯一，建议配合服务名</span></span><br><span class="line">    <span class="comment"># 使用注册中心中注册的微服务名实现动态路由</span></span><br><span class="line">    <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">    <span class="attr">predicates:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Path=/payment/get/**</span>  <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span></span><br><span class="line">    <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">    <span class="attr">predicates:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>  <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>网关微服务完整配置文件如下</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway</span> <span class="comment">#注册到eureka中的应用名</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="comment"># 开启从注册中心动态创建路由的功能，使用微服务名进行路由</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh</span> <span class="comment">#路由id，没有命名规则但要求唯一，建议配合服务名</span></span><br><span class="line">          <span class="comment"># 使用注册中心中注册的微服务名实现动态路由</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/get/**</span>  <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>  <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3、测试"><a href="#3、测试" class="headerlink" title="3、测试"></a>3、测试</h3><blockquote><p>启动网关微服务，查看eureka注册中心情况</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211144519.png" alt="image-20210211144518120"></p><blockquote><p>测试，访问payment微服务的lb方法，查看调用端口情况</p></blockquote><ul><li>第一次</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211144610.png" alt="image-20210211144610176"></p><ul><li>第二次</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211144625.png" alt="image-20210211144625837"></p><blockquote><p>这样就实现了动态路由和负载均衡功能。</p></blockquote><h2 id="2-6、Predicate的使用"><a href="#2-6、Predicate的使用" class="headerlink" title="2.6、Predicate的使用"></a>2.6、Predicate的使用</h2><blockquote><p>Spring Cloud Gateway内置断言工厂，用于进行条件判断，只有断言都返回真，才会真正执行路由。</p><p>内置的断言工厂具体如下</p></blockquote><h3 id="1、基于DateTime"><a href="#1、基于DateTime" class="headerlink" title="1、基于DateTime"></a>1、基于DateTime</h3><blockquote><p>此类型的断言根据时间做判断，主要有三个：</p></blockquote><ul><li>AfterRoutePredicateFactory： 接收一个日期参数，判断请求日期是否晚于指定日期</li><li>BeforeRoutePredicateFactory： 接收一个日期参数，判断请求日期是否早于指定日期</li><li>BetweenRoutePredicateFactory： 接收两个日期参数，判断请求日期是否在指定时间段内</li></ul><blockquote><p>这里的时间格式可以由JDK8自带的ZoneDateTime生成</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    ZonedDateTime dateTime = ZonedDateTime.now();</span><br><span class="line">    System.out.println(dateTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211153541.png" alt="image-20210211153541725"></p><blockquote><p>AfterRoutePredicateFactory</p></blockquote><ul><li>在yml配置文件中添加配置如下，这里将after后面的时间设置为我当前时间的一个笑是后</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>  <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">After=2021-02-11T16:37:54.926+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211153734.png" alt="image-20210211153734924"></p><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211153920.png" alt="image-20210211153920543"></p><ul><li>修改yml配置文件，将时间改为当前时间一个小时前，重启微服务</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">After=2021-02-11T14:37:54.926+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211154031.png" alt="image-20210211154031133"></p><blockquote><p>同理，Before断言和Between断言与After的使用方式类型，只是Between断言需要传入两个时间，如</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">Between=2020-03-08T10:59:34.102+08:00[Asia/Shanghai]</span> <span class="string">,</span>  <span class="number">2020-03-08T10:59:34.102+08:00</span>[<span class="string">Asia/Shanghai</span>]</span><br></pre></td></tr></table></figure><h3 id="2、基于远程地址"><a href="#2、基于远程地址" class="headerlink" title="2、基于远程地址"></a>2、基于远程地址</h3><blockquote><p>RemoteAddrRoutePredicateFactory：接收一个IP地址段，判断请求主机地址是否在地址段中</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">RemoteAddr=192.168.1.1/24</span></span><br></pre></td></tr></table></figure><blockquote><p>修改yml配置文件，进行测试</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>  <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line">    <span class="comment">#- After=2021-02-11T14:37:54.926+08:00[Asia/Shanghai]</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">RemoteAddr=192.168.1.1/24</span></span><br></pre></td></tr></table></figure><ul><li>结果：由于本机地址不在配置的地址内，所以报错</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211155533.png" alt="image-20210211155532617"></p><h3 id="3、基于Cookie"><a href="#3、基于Cookie" class="headerlink" title="3、基于Cookie"></a>3、基于Cookie</h3><blockquote><p>CookieRoutePredicateFactory：接收两个参数，cookie 名字和一个正则表达式。 判断请求cookie是否具有给定名称且值与正则表达式匹配。</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">Cookie=chocolate,</span> <span class="string">ch.</span></span><br></pre></td></tr></table></figure><blockquote><p>修改配置文件，设置访问时需要带上的Cookie</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>  <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Cookie=wuhu,qifei</span></span><br></pre></td></tr></table></figure><blockquote><p>打开命令行，使用curl进行访问</p></blockquote><ul><li>不带Cookie时：curl <a href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a></li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211155943.png" alt="image-20210211155943876"></p><ul><li>带上Cookie时：curl <a href="http://localhost:9527/payment/lb">http://localhost:9527/payment/lb</a> –cookie “wuhu=qifei”</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211160356.png" alt="image-20210211160356405"></p><h3 id="4、基于请求头Header"><a href="#4、基于请求头Header" class="headerlink" title="4、基于请求头Header"></a>4、基于请求头Header</h3><blockquote><p>HeaderRoutePredicateFactory：接收两个参数，标题名称和正则表达式。 判断请求Header是否具有给定名称且值与正则表达式匹配。</p></blockquote><ul><li>两个参数，一个属性名称和一个正则表达式，当属性值与正则表达式相匹配时执行</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span></span><br></pre></td></tr></table></figure><blockquote><p>修改yml文件</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>  <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line">    <span class="comment"># 请求头中需要含有X-Request-Id属性，且X-Request-Id属性值需要为正整数</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Header=X-Request-Id,</span> <span class="string">\d+</span></span><br></pre></td></tr></table></figure><ul><li>使用curl进行测试</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">curl</span> http://localhost:<span class="number">9527</span>/payment/lb <span class="literal">-H</span> <span class="string">&quot;X-Request-Id:123&quot;</span></span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211161019.png" alt="image-20210211161019074"></p><ul><li>使用curl进行错误示范</li></ul><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">curl</span> http://localhost:<span class="number">9527</span>/payment/lb <span class="literal">-H</span> <span class="string">&quot;X-Request-Id:-123&quot;</span></span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211161133.png" alt="image-20210211161133476"></p><h3 id="5、基于Method请求方法"><a href="#5、基于Method请求方法" class="headerlink" title="5、基于Method请求方法"></a>5、基于Method请求方法</h3><blockquote><p>MethodRoutePredicateFactory：接收一个参数，判断请求类型是否跟指定的类型匹配。</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">Method=GET</span></span><br></pre></td></tr></table></figure><h3 id="6、基于Path请求路径"><a href="#6、基于Path请求路径" class="headerlink" title="6、基于Path请求路径"></a>6、基于Path请求路径</h3><blockquote><p>PathRoutePredicateFactory：接收一个参数，判断请求的URI部分是否满足路径规则。</p><p>最常见的一种断言</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">Path=/foo/**</span></span><br></pre></td></tr></table></figure><h3 id="7、基于Query请求参数"><a href="#7、基于Query请求参数" class="headerlink" title="7、基于Query请求参数"></a>7、基于Query请求参数</h3><blockquote><p>QueryRoutePredicateFactory ：接收两个参数，请求param和正则表达式， 判断请求参数是否具有给定名称且值与正则表达式匹配。</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">Query=baz,</span> <span class="string">ba.</span></span><br></pre></td></tr></table></figure><blockquote><p>修改配置文件</p></blockquote><ul><li>Query=uname, wuhu断言要求请求中必须有uname参数，且参数值必须为wuhu</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_routh2</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Path=/payment/lb/**</span>  <span class="comment">#断言，路径相匹配的进行路由</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">Query=uname,</span> <span class="string">wuhu</span></span><br></pre></td></tr></table></figure><ul><li>进行测试，访问<a href="http://localhost:9527/payment/lb%EF%BC%8C%E6%9F%A5%E7%9C%8B%E7%BB%93%E6%9E%9C">http://localhost:9527/payment/lb，查看结果</a></li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211162140.png" alt="image-20210211162139906"></p><ul><li>打开浏览器，访问<a href="http://localhost:9527/payment/lb?uname=wuhu">http://localhost:9527/payment/lb?uname=wuhu</a></li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211162254.png" alt="image-20210211162254068"></p><h1 id="三、过滤器"><a href="#三、过滤器" class="headerlink" title="三、过滤器"></a>三、过滤器</h1><h2 id="3-1、过滤器基本概念"><a href="#3-1、过滤器基本概念" class="headerlink" title="3.1、过滤器基本概念"></a>3.1、过滤器基本概念</h2><h3 id="1、作用"><a href="#1、作用" class="headerlink" title="1、作用"></a>1、作用</h3><p>过滤器就是在请求的传递过程中，对请求和响应做一些修改</p><h3 id="2、生命周期"><a href="#2、生命周期" class="headerlink" title="2、生命周期"></a>2、生命周期</h3><p>客户端的请求先经过“pre”类型的filter，然后将请求转发到具体的业务服务，收到业务服务的响应之后，再经过“post”类型的filter处理，最后返回响应到客户端。</p><p>pre： 这种过滤器在请求被路由之前调用。我们可利用这种过滤器实现参数校验、权限校验、流量监控、日志输出、协议转换等；</p><p>post：这种过滤器在路由到达微服务以后执行。这种过滤器可用做响应内容、响应头的修改，日志的输出，流量监控等。</p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211162518.png" alt="image-20210211162518791"></p><h3 id="3、分类"><a href="#3、分类" class="headerlink" title="3、分类"></a>3、分类</h3><p>局部过滤器 GatewayFilter：作用在某一个路由上</p><p>全局过滤器 GlobalFilter：作用全部路由上</p><h2 id="3-2、局部过滤器"><a href="#3-2、局部过滤器" class="headerlink" title="3.2、局部过滤器"></a>3.2、局部过滤器</h2><h3 id="1、内置局部过滤器"><a href="#1、内置局部过滤器" class="headerlink" title="1、内置局部过滤器"></a>1、内置局部过滤器</h3><p>在SpringCloud Gateway中内置了很多不同类型的网关路由过滤器。具体如下</p><table><thead><tr><th>过滤器工厂</th><th>作用</th><th>参数</th></tr></thead><tbody><tr><td>AddRequestHeader</td><td>为原始请求添加Header</td><td>Header的名称及值</td></tr><tr><td>AddRequestParameter</td><td>为原始请求添加请求参数</td><td>参数名称及值</td></tr><tr><td>AddResponseHeader</td><td>为原始响应添加Header</td><td>Header的名称及值</td></tr><tr><td>DedupeResponseHeader</td><td>剔除响应头中重复的值</td><td>需要去重的Header名称及去重策略</td></tr><tr><td>Hystrix</td><td>为路由引入Hystrix的断路器保护</td><td>HystrixCommand 的名称</td></tr><tr><td>FallbackHeaders</td><td>为fallbackUri的请求头中添加具体的异常信息</td><td>Header的名称</td></tr><tr><td>PreﬁxPath</td><td>为原始请求路径添加前缀</td><td>前缀路径</td></tr><tr><td>PreserveHostHeader</td><td>为请求添加一个preserveHostHeader=true的属性，路由过滤器会检查该属性以决定是否要发送原始的Host</td><td>无</td></tr><tr><td>RequestRateLimiter</td><td>用于对请求限流，限流算法为令牌桶</td><td>keyResolver、rateLimiter、statusCode、denyEmptyKey、emptyKeyStatus</td></tr><tr><td>RedirectTo</td><td>将原始请求重定向到指定的URL</td><td>http状态码及重定向的url</td></tr><tr><td>RemoveHopByHopHeadersFilter</td><td>为原始请求删除IETF组织规定的一系列Header</td><td>默认就会启用，可以通过配置指定仅删除哪些Header</td></tr><tr><td>RemoveRequestHeader</td><td>为原始请求删除某个Header</td><td>Header名称</td></tr><tr><td>RemoveResponseHeader</td><td>为原始响应删除某个Header</td><td>Header名称</td></tr><tr><td>RewritePath</td><td>重写原始的请求路径</td><td>原始路径正则表达式以及重写后路径的正则表达式</td></tr><tr><td>RewriteResponseHeader</td><td>重写原始响应中的某个Header</td><td>Header名称，值的正则表达式，重写后的值</td></tr><tr><td>SaveSession</td><td>在转发请求之前，强制执行WebSession::save 操作</td><td>无</td></tr><tr><td>secureHeaders</td><td>为原始响应添加一系列起安全作用的响应头</td><td>无，支持修改这些安全响应头的值</td></tr><tr><td>SetPath</td><td>修改原始的请求路径</td><td>修改后的路径</td></tr><tr><td>SetResponseHeader</td><td>修改原始响应中某个Header的值</td><td>Header名称，修改后的值</td></tr><tr><td>SetStatus</td><td>修改原始响应的状态码</td><td>HTTP 状态码，可以是数字，也可以是字符串</td></tr><tr><td>StripPreﬁx</td><td>用于截断原始请求的路径</td><td>使用数字表示要截断的路径的数量</td></tr><tr><td>Retry</td><td>针对不同的响应进行重试</td><td>retries、statuses、methods、series</td></tr><tr><td>RequestSize</td><td>设置允许接收最大请求包的大 小。如果请求包大小超过设置的值，则返回 413 Payload TooLarge</td><td>请求包大小，单位为字节，默认值为5M</td></tr><tr><td>ModifyRequestBody</td><td>在转发请求之前修改原始请求体内容</td><td>修改后的请求体内容</td></tr><tr><td>ModifyResponseBody</td><td>修改原始响应体的内容</td><td>修改后的响应体内容</td></tr></tbody></table><h3 id="2、内置局部过滤器的使用"><a href="#2、内置局部过滤器的使用" class="headerlink" title="2、内置局部过滤器的使用"></a>2、内置局部过滤器的使用</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">id:</span> <span class="string">service-edu</span></span><br><span class="line">  <span class="attr">uri:</span> <span class="string">lb://service-edu</span></span><br><span class="line">  <span class="attr">predicates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Path=/user/**,</span> <span class="string">/*/edu/**</span></span><br><span class="line">  <span class="attr">filters:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">SetStatus=250</span> <span class="comment"># 修改返回状态码</span></span><br></pre></td></tr></table></figure><h2 id="3-3、全局过滤器"><a href="#3-3、全局过滤器" class="headerlink" title="3.3、全局过滤器"></a>3.3、全局过滤器</h2><h3 id="1、内置全局过滤器"><a href="#1、内置全局过滤器" class="headerlink" title="1、内置全局过滤器"></a>1、内置全局过滤器</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211162756.png" alt="image-20210211162756079"></p><p>内置全局过滤器的使用举例：负载均衡过滤器</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">lb://service-edu</span></span><br></pre></td></tr></table></figure><h2 id="3-4、自定义全局过滤器"><a href="#3-4、自定义全局过滤器" class="headerlink" title="3.4、自定义全局过滤器"></a>3.4、自定义全局过滤器</h2><blockquote><p>定义一个Filter实现 GlobalFilter 和 Ordered接口</p></blockquote><h3 id="1、作用-1"><a href="#1、作用-1" class="headerlink" title="1、作用"></a>1、作用</h3><ul><li>全局日志记录</li><li>统一网关鉴权</li><li>…</li></ul><h3 id="2、自定义全局过滤器"><a href="#2、自定义全局过滤器" class="headerlink" title="2、自定义全局过滤器"></a>2、自定义全局过滤器</h3><blockquote><p>编写一个过滤器类，这个过滤器用于记录日志已经鉴权</p></blockquote><ul><li>如果请求中uname参数值为空，则不放行，直接响应406</li><li>这个类需要实现GlobalFilter和Ordered接口，并重写两个方法</li><li>在getOrder方法中，定义过滤器的优先级，order越低，优先级越高</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> HIGHEST_PRECEDENCE = -<span class="number">2147483648</span>;</span><br><span class="line">    <span class="keyword">int</span> LOWEST_PRECEDENCE = <span class="number">2147483647</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在filter方法中进行日志记录和鉴权操作</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyLogGateWayFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;*************进入自定义全局过滤器，时间为：&quot;</span> + <span class="keyword">new</span> Date());</span><br><span class="line">        String uname = exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;uname&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(uname == <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;********用户名为null，非法用户！&quot;</span>);</span><br><span class="line">            <span class="comment">//给响应对象返回一个状态码：请求不被接受</span></span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.NOT_ACCEPTABLE);</span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//放行，进入到下一个过滤器</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 此方法用于定义这个过滤器在过滤器链中的位置</span></span><br><span class="line"><span class="comment">     * 返回的order越小优先级越高</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>测试</li></ul><blockquote><p>访问<a href="http://localhost:9257/payment/lb">http://localhost:9257/payment/lb</a></p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211164137.png" alt="image-20210211164137410"></p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211164206.png" alt="image-20210211164206315"></p><blockquote><p>访问<a href="http://localhost:9257/payment/lb%EF%BC%8C%E5%B8%A6%E4%B8%8A%E5%8F%82%E6%95%B0uname">http://localhost:9257/payment/lb，带上参数uname</a></p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211164402.png" alt="image-20210211164402908"></p><h1 id="四、在线教育项目整合GateWay"><a href="#四、在线教育项目整合GateWay" class="headerlink" title="四、在线教育项目整合GateWay"></a>四、在线教育项目整合GateWay</h1><blockquote><p><strong>注意</strong>：gateway底层使用的是webflux会与web冲突，所以在gateway中不要引入spring-boot-starter-web依赖</p></blockquote><h2 id="4-1、统一网关鉴权"><a href="#4-1、统一网关鉴权" class="headerlink" title="4.1、统一网关鉴权"></a>4.1、统一网关鉴权</h2><blockquote><p>我们需要在微服务网关中自定义一个全局过滤器，统一处理需要鉴权的服务</p></blockquote><h3 id="1、鉴权逻辑描述"><a href="#1、鉴权逻辑描述" class="headerlink" title="1、鉴权逻辑描述"></a>1、鉴权逻辑描述</h3><ul><li>当客户端第一次请求服务时，服务端对用户进行信息认证（登录）</li><li>认证通过，将用户信息进行加密形成token，返回给客户端</li><li>作为登录凭证以后每次请求，客户端都携带认证的token</li><li>服务端对token进行解密，判断是否有效</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211165219.png" alt="image-20210211165219298"></p><blockquote><p>对于验证用户是否已经登录鉴权的过程可以在网关统一检验。检验的标准就是请求中是否携带token凭证以及token的正确性。</p><p>下面的我们自定义一个GlobalFilter，去校验所有的请求参数中是否包含“token”，如果不包含请求参数“token”则不转发路由，否则执行正常的逻辑。</p></blockquote><h3 id="2、创建自定义过滤器"><a href="#2、创建自定义过滤器" class="headerlink" title="2、创建自定义过滤器"></a>2、创建自定义过滤器</h3><ul><li>如果token为空或者token不合法，则不放行。</li><li>这个过滤器的order为0</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthGlobalFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">        String path = request.getURI().getPath();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//谷粒学院api接口，校验用户必须登录</span></span><br><span class="line">        AntPathMatcher antPathMatcher = <span class="keyword">new</span> AntPathMatcher();</span><br><span class="line">        <span class="keyword">if</span>(antPathMatcher.match(<span class="string">&quot;/api/**/auth/**&quot;</span>, path)) &#123;</span><br><span class="line">            List&lt;String&gt; tokenList = request.getHeaders().get(<span class="string">&quot;token&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//没有token</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> == tokenList) &#123;</span><br><span class="line">                ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">                <span class="keyword">return</span> out(response);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//token校验失败</span></span><br><span class="line">            Boolean isCheck = JwtUtils.checkJwtTToken(tokenList.get(<span class="number">0</span>));</span><br><span class="line">            <span class="keyword">if</span>(!isCheck) &#123;</span><br><span class="line">                ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">                <span class="keyword">return</span> out(response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//放行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义当前过滤器的优先级，值越小，优先级越高</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Mono&lt;Void&gt; <span class="title">out</span><span class="params">(ServerHttpResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        JsonObject message = <span class="keyword">new</span> JsonObject();</span><br><span class="line">        message.addProperty(<span class="string">&quot;success&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        message.addProperty(<span class="string">&quot;code&quot;</span>, <span class="number">28004</span>);</span><br><span class="line">        message.addProperty(<span class="string">&quot;data&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        message.addProperty(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;鉴权失败&quot;</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = message.toString().getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        DataBuffer buffer = response.bufferFactory().wrap(bytes);</span><br><span class="line">        <span class="comment">//指定编码，否则在浏览器中会中文乱码</span></span><br><span class="line">        response.getHeaders().add(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="comment">//输出http响应</span></span><br><span class="line">        <span class="keyword">return</span> response.writeWith(Mono.just(buffer));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、修改前端"><a href="#3、修改前端" class="headerlink" title="3、修改前端"></a>3、修改前端</h3><blockquote><p>guli-site的utils/request.js中修改响应过滤器 ，添加分支：</p></blockquote><ul><li>如果响应码为20004，则证明认证失败，用户没有登录，此时让用户跳转到登录页</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (res.code === <span class="number">28004</span>) &#123; <span class="comment">// 鉴权失败</span></span><br><span class="line">    <span class="built_in">window</span>.location.href = <span class="string">&#x27;/login&#x27;</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><ul><li>修改pages/login.vue的submitLogin方法：登录后回到原来的页面</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 跳转到首页</span></span><br><span class="line"><span class="comment">// window.location.href = &#x27;/&#x27;</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">document</span>.referrer.indexOf(<span class="string">&#x27;register&#x27;</span>) !== -<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">window</span>.location.href = <span class="string">&#x27;/&#x27;</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    history.go(-<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-2、统一处理跨域问题"><a href="#4-2、统一处理跨域问题" class="headerlink" title="4.2、统一处理跨域问题"></a>4.2、统一处理跨域问题</h2><h3 id="1、什么是跨域？"><a href="#1、什么是跨域？" class="headerlink" title="1、什么是跨域？"></a>1、什么是跨域？</h3><blockquote><p>当一个请求url的<strong>协议、域名、端口</strong>三者之间任意一个与当前页面url不同即为跨域</p></blockquote><table><thead><tr><th><strong>当前页面url</strong></th><th><strong>被请求页面url</strong></th><th><strong>是否跨域</strong></th><th><strong>原因</strong></th></tr></thead><tbody><tr><td><a href="http://www.test.com/">http://www.test.com/</a></td><td><a href="http://www.test.com/index.html">http://www.test.com/index.html</a></td><td>否</td><td>同源（协议、域名、端口号相同）</td></tr><tr><td><a href="http://www.test.com/">http://www.test.com/</a></td><td><a href="https://www.test.com/index.html">https://www.test.com/index.html</a></td><td>跨域</td><td>协议不同（http/https）</td></tr><tr><td><a href="http://www.test.com/">http://www.test.com/</a></td><td><a href="http://www.baidu.com/">http://www.baidu.com/</a></td><td>跨域</td><td>主域名不同（test/baidu）</td></tr><tr><td><a href="http://www.test.com/">http://www.test.com/</a></td><td><a href="http://blog.test.com/">http://blog.test.com/</a></td><td>跨域</td><td>子域名不同（www/blog）</td></tr><tr><td><a href="http://www.test.com:8080/">http://www.test.com:8080/</a></td><td><a href="http://www.test.com:7001/">http://www.test.com:7001/</a></td><td>跨域</td><td>端口号不同（8080/7001）</td></tr></tbody></table><h3 id="2、Spring-Boot中解决跨域的几种方法"><a href="#2、Spring-Boot中解决跨域的几种方法" class="headerlink" title="2、Spring Boot中解决跨域的几种方法"></a>2、Spring Boot中解决跨域的几种方法</h3><blockquote><p>在gateway中创建一个配置类，这个配置类用于解决跨域问题</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CorsConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CorsWebFilter <span class="title">corsFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CorsConfiguration config = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line">        config.addAllowedMethod(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        config.addAllowedOrigin(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">        config.addAllowedHeader(<span class="string">&quot;*&quot;</span>);</span><br><span class="line"></span><br><span class="line">        UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource(<span class="keyword">new</span> PathPatternParser());</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, config);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CorsWebFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在Spring Boot控制器中添加@CrossOrigin注解，这个注解可以加在<strong>类上</strong>或者<strong>方法</strong>上</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;课程分类管理&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/edu/subject&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubjectController</span> </span>&#123;</span><br></pre></td></tr></table></figure><blockquote><p>说明，这两种方法只取一种使用即可，如果使用了配置类，那么最好将控制器上的注解删去。</p></blockquote><blockquote><p>参考教程如下：</p></blockquote><ul><li><p>[1]  <a href="https://www.bilibili.com/video/BV1fi4y1x7on">尚硅谷在线教育项目</a></p></li><li><p>[2]  <a href="https://blog.csdn.net/qq_38128179/article/details/84956552">什么是跨域？跨域的结局方法</a></p></li><li><p>[3]  <a href="https://www.bilibili.com/video/BV18E411x7eT">尚硅谷SpringCloud(H版&amp;alibaba)框架开发教程</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Spring Cloud </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
            <tag> 🚪网关 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在线教育项目总结（四）-使用递归查询嵌套列表和删除嵌套列表</title>
      <link href="posts/4109687940.html"/>
      <url>posts/4109687940.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、需求及数据库说明"><a href="#一、需求及数据库说明" class="headerlink" title="一、需求及数据库说明"></a>一、需求及数据库说明</h1><blockquote><p>在在线教育项目中，我们使用Spring Security作为安全框架，在权限管理需求中，<strong>不同角色的用户登录后台管理系统拥有不同的菜单权限与功能权限，</strong>权限管理包含三个功能模块：菜单管理、角色管理和用户管理。</p><p>在菜单管理中，要求我们使用树形结构展示菜单列表。</p></blockquote><blockquote><p>创建acl_permission表，省略部分数据</p></blockquote><ul><li>在permission表中，pid为0的为权限菜单顶层数据</li><li>根据pid =  id来确定数据间的父子关系</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE &#96;acl_permission&#96; (</span><br><span class="line">  &#96;id&#96; char(19) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;编号&#39;,</span><br><span class="line">  &#96;pid&#96; char(19) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;所属上级&#39;,</span><br><span class="line">  &#96;name&#96; varchar(20) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;名称&#39;,</span><br><span class="line">  &#96;type&#96; tinyint(3) NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;类型(1:菜单,2:按钮)&#39;,</span><br><span class="line">  &#96;permission_value&#96; varchar(50) DEFAULT NULL COMMENT &#39;权限值&#39;,</span><br><span class="line">  &#96;path&#96; varchar(100) DEFAULT NULL COMMENT &#39;访问路径&#39;,</span><br><span class="line">  &#96;component&#96; varchar(100) DEFAULT NULL COMMENT &#39;组件路径&#39;,</span><br><span class="line">  &#96;icon&#96; varchar(50) DEFAULT NULL COMMENT &#39;图标&#39;,</span><br><span class="line">  &#96;status&#96; tinyint(4) DEFAULT NULL COMMENT &#39;状态(0:禁止,1:正常)&#39;,</span><br><span class="line">  &#96;is_deleted&#96; tinyint(1) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;逻辑删除 1（true）已删除， 0（false）未删除&#39;,</span><br><span class="line">  &#96;gmt_create&#96; datetime DEFAULT NULL COMMENT &#39;创建时间&#39;,</span><br><span class="line">  &#96;gmt_modified&#96; datetime DEFAULT NULL COMMENT &#39;更新时间&#39;,</span><br><span class="line">  PRIMARY KEY (&#96;id&#96;),</span><br><span class="line">  KEY &#96;idx_pid&#96; (&#96;pid&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8mb4 COMMENT&#x3D;&#39;权限&#39;;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Data for table &quot;acl_permission&quot;</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line">INSERT INTO &#96;acl_permission&#96; VALUES (&#39;1&#39;,&#39;0&#39;,&#39;全部数据&#39;,0,NULL,NULL,NULL,NULL,NULL,0,&#39;2019-11-15 17:13:06&#39;,&#39;2019-11-15 17:13:06&#39;),(&#39;1195268474480156673&#39;,&#39;1&#39;,&#39;权限管理&#39;,1,NULL,&#39;&#x2F;acl&#39;,&#39;Layout&#39;,NULL,NULL,0,&#39;2019-11-15 17:13:06&#39;,&#39;2019-11-18 13:54:25&#39;),(&#39;1195268616021139457&#39;,&#39;1195268474480156673&#39;,&#39;用户管理&#39;,1,NULL,&#39;user&#x2F;list&#39;,&#39;&#x2F;acl&#x2F;user&#x2F;list&#39;,NULL,NULL,0,&#39;2019-11-15 17:13:40&#39;,&#39;2019-11-18 13:53:12&#39;),(&#39;1195268788138598401&#39;,&#39;1195268474480156673&#39;,&#39;角色管理&#39;,1,NULL,&#39;role&#x2F;list&#39;,&#39;&#x2F;acl&#x2F;role&#x2F;list&#39;,NULL,NULL,0,&#39;2019-11-15 17:14:21&#39;,&#39;2019-11-15 17:14:21&#39;),(&#39;1195268893830864898&#39;,&#39;1195268474480156673&#39;,&#39;菜单管理&#39;,1,NULL,&#39;menu&#x2F;list&#39;,&#39;&#x2F;acl&#x2F;menu&#x2F;list&#39;,NULL,NULL,0,&#39;2019-11-15 17:14:46&#39;,&#39;2019-11-15 17:14:46&#39;),(&#39;1195269143060602882&#39;,&#39;1195268616021139457&#39;,&#39;查看&#39;,2,&#39;user.list&#39;,&#39;&#39;,&#39;&#39;,NULL,NULL,0,&#39;2019-11-15 17:15:45&#39;,&#39;2019-11-17 21:57:16&#39;),(&#39;1195269295926206466&#39;,&#39;1195268616021139457&#39;,&#39;添加&#39;,2,&#39;user.add&#39;,&#39;user&#x2F;add&#39;,&#39;&#x2F;acl&#x2F;user&#x2F;form&#39;,NULL,NULL,0,&#39;2019-11-15 17:16:22&#39;,&#39;2019-11-15 17:16:22&#39;),(&#39;1195269473479483394&#39;,&#39;1195268616021139457&#39;,&#39;修改&#39;,2,&#39;user.update&#39;,&#39;user&#x2F;update&#x2F;:id&#39;,&#39;&#x2F;acl&#x2F;user&#x2F;form&#39;,NULL,NULL,0,&#39;2019-11-15 17:17:04&#39;,&#39;2019-11-15 17:17:04&#39;),(&#39;1195269547269873666&#39;,&#39;1195268616021139457&#39;,&#39;删除&#39;,2,&#39;user.remove&#39;,&#39;&#39;,&#39;&#39;,NULL,NULL,0,&#39;2019-11-15 17:17:22&#39;,&#39;2019-11-15 17:17:22&#39;),(&#39;1195269821262782465&#39;,&#39;1195268788138598401&#39;,&#39;修改&#39;,2,&#39;role.update&#39;,&#39;role&#x2F;update&#x2F;:id&#39;,&#39;&#x2F;acl&#x2F;role&#x2F;form&#39;,NULL,NULL,0,&#39;2019-11-15 17:18:27&#39;,&#39;2019-11-15 17:19:53&#39;),(&#39;1195269903542444034&#39;,&#39;1195268788138598401&#39;,&#39;查看&#39;,2,&#39;role.list&#39;,&#39;&#39;,&#39;&#39;,NULL,NULL,0,&#39;2019-11-15 17:18:47&#39;,&#39;2019-11-15 17:18:47&#39;);</span><br></pre></td></tr></table></figure><h1 id="二、使用递归查询嵌套列表"><a href="#二、使用递归查询嵌套列表" class="headerlink" title="二、使用递归查询嵌套列表"></a>二、使用递归查询嵌套列表</h1><h2 id="2-1、实体类"><a href="#2-1、实体类" class="headerlink" title="2.1、实体类"></a>2.1、实体类</h2><blockquote><p>为了实现嵌套列表的查询，我们需要为实体类添加一些额外的属性</p></blockquote><ul><li>添加一个Integer类型的level属性，这个属性用于表示当前permission对象在哪一级菜单</li><li>添加一个List&lt; Permission &gt;类型的children属性，这个属性用于存放当前permission对象的子菜单</li><li>由于这两个属性不属于数据库中的属性，所以我们需要添加@TableField(exist = false) 注解</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@TableName(&quot;acl_permission&quot;)</span></span><br><span class="line"><span class="meta">@ApiModel(value=&quot;Permission对象&quot;, description=&quot;权限&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Permission</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;所属上级&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String pid;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;名称&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;类型(1:菜单,2:按钮)&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer type;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;权限值&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String permissionValue;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;访问路径&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;组件路径&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String component;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;图标&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String icon;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;状态(0:禁止,1:正常)&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;逻辑删除 1（true）已删除， 0（false）未删除&quot;)</span></span><br><span class="line">    <span class="meta">@TableLogic</span></span><br><span class="line">    <span class="keyword">private</span> Integer isDeleted;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 下面是业务中手动添加的属性</span></span><br><span class="line"><span class="comment">     * 并非数据库中的字段</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;表示当前permission对象是哪一级菜单&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer level;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;下级&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Permission&gt; children;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TableField(exist = false)</span></span><br><span class="line">    <span class="meta">@ApiModelProperty(&quot;是否被选中&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isSelect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-2、Controller层"><a href="#2-2、Controller层" class="headerlink" title="2.2、Controller层"></a>2.2、Controller层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;查询所有菜单&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">indexAllPermission</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Permission&gt; list = permissionService.queryAllMenu();</span><br><span class="line">    <span class="keyword">return</span> R.ok().data(<span class="string">&quot;children&quot;</span>,list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-3、Service层"><a href="#2-3、Service层" class="headerlink" title="2.3、Service层"></a>2.3、Service层</h2><blockquote><p>第一步，先查询出permission表中所有数据，根据id排序</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 递归查询所有菜单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Permission&gt; <span class="title">queryAllMenu</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1 查询菜单表中所有数据，根据id排序</span></span><br><span class="line">    QueryWrapper&lt;Permission&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    wrapper.orderByAsc(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    List&lt;Permission&gt; permissionList = baseMapper.selectList(wrapper);</span><br><span class="line">    <span class="comment">//2 将查询出来的菜单List集合按照要求进行封装</span></span><br><span class="line">    <span class="keyword">return</span> buildPermission(permissionList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>第二步，创建一个buildPermission方法，这个方法将查询出来的permission集合转换为嵌套列表集合</p></blockquote><ul><li>先查询出所有permission对象中pid为0，即最顶层的元素</li><li>将该permission对象的level设置为1</li><li>将这个顶层元素加入到要返回给Controller层的List集合中</li><li>写一个selectChildren方法，传入当前permission和第一步查询出的所有permission集合，这个方法用于递归组装顶层元素的子元素和后代元素</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 封装传入的菜单集合</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> permissionList 要封装的菜单列表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 封装好的嵌套菜单列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Permission&gt; <span class="title">buildPermission</span><span class="params">(List&lt;Permission&gt; permissionList)</span> </span>&#123;</span><br><span class="line">    List&lt;Permission&gt; finalNode = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//遍历传入的菜单列表，得到最顶层元素，即pid = 0的菜单对象，设置其level值为1</span></span><br><span class="line">    <span class="keyword">for</span> (Permission permission : permissionList) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;0&quot;</span>.equals(permission.getPid())) &#123;</span><br><span class="line">            <span class="comment">//设置顶层菜单的level值为1</span></span><br><span class="line">            permission.setLevel(<span class="number">1</span>);</span><br><span class="line">            <span class="comment">//根据顶层菜单，向里面进行查询子菜单，封装到finalNode</span></span><br><span class="line">            finalNode.add(selectChildren(permission,permissionList));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> finalNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>第三步，写一个selectChildren方法，根据传入的permission对象和permission集合递归组装嵌套列表。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 真正的递归在这里进行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> permission</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> permissionList</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Permission <span class="title">selectChildren</span><span class="params">(Permission permission, List&lt;Permission&gt; permissionList)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1 由于我们要向上一层菜单对象的children中放置对象，所以我们先初始化对象</span></span><br><span class="line">    permission.setChildren(<span class="keyword">new</span> ArrayList&lt;Permission&gt;());</span><br><span class="line">    <span class="comment">//2 遍历所有菜单列表，进行判断比较，比较id值与pid是否相同</span></span><br><span class="line">    permissionList.forEach(per -&gt; &#123;</span><br><span class="line">        <span class="comment">//判断id和pid是否相同</span></span><br><span class="line">        <span class="keyword">if</span>(permission.getId().equals(per.getPid())) &#123;</span><br><span class="line">            <span class="comment">//此时证明当前per对象是permission对象的子节点</span></span><br><span class="line">            <span class="comment">//所以子节点的level值应该为父节点的level+1</span></span><br><span class="line">            per.setLevel(permission.getLevel() + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span>(CollectionUtils.isEmpty(permission.getChildren())) &#123;</span><br><span class="line">                permission.setChildren(<span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//把查询出来的当前菜单放在上一层菜单对象的children中</span></span><br><span class="line">            permission.getChildren().add(selectChildren(per,permissionList));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> permission;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-4、测试"><a href="#2-4、测试" class="headerlink" title="2.4、测试"></a>2.4、测试</h2><blockquote><p>使用Swagger进行测试</p></blockquote><ul><li>界面</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210233136.png" alt="image-20210210233136804"></p><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210233105.png" alt="image-20210210233104615"></p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210233608.png" alt="image-20210210233608819"></p><h1 id="三、通过id递归删除嵌套菜单"><a href="#三、通过id递归删除嵌套菜单" class="headerlink" title="三、通过id递归删除嵌套菜单"></a>三、通过id递归删除嵌套菜单</h1><blockquote><p>需要删除自身及所有的后代元素</p></blockquote><h2 id="3-1、Controller层"><a href="#3-1、Controller层" class="headerlink" title="3.1、Controller层"></a>3.1、Controller层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@DeleteMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;递归删除菜单&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">deletePermission</span><span class="params">(<span class="meta">@PathVariable</span> String id)</span> </span>&#123;</span><br><span class="line">    permissionService.recurDeletePermissionById(id);</span><br><span class="line">    <span class="keyword">return</span> R.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-2、Service层"><a href="#3-2、Service层" class="headerlink" title="3.2、Service层"></a>3.2、Service层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 根据id递归删除菜单及子菜单</span></span><br><span class="line"><span class="comment"> * 获取id为传入id的菜单及子菜单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recurDeletePermissionById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1 创建一个list集合，用于封装所有删除菜单id值</span></span><br><span class="line">    List&lt;String&gt; idList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">//2 向idList中设置要删除的菜单id</span></span><br><span class="line">    <span class="keyword">this</span>.selectPermissionChildById(id,idList);</span><br><span class="line">    <span class="comment">//放入要删除的id，递归封装的只是子菜单的id</span></span><br><span class="line">    idList.add(id);</span><br><span class="line">    permissionMapper.deleteBatchIds(idList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>编写selectPermissionChildById方法，传入父级id和用于批量删除的id列表，这个方法用于查询所有待删除元素的后代元素的id</p></blockquote><ul><li>使用Mybatis-Plus自带的QueryWrapper查询出pid为传入id的permission元素</li><li>遍历上一步查询到的permission列表，然后以列表中每一个元素的id作为pid，进行递归查询</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 根据传入的菜单id，查询菜单中的所有子菜单id，然后封装到list集合中</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> idList</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">selectPermissionChildById</span><span class="params">(String id, List&lt;String&gt; idList)</span> </span>&#123;</span><br><span class="line">    QueryWrapper&lt;Permission&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    wrapper.eq(<span class="string">&quot;pid&quot;</span>,id);</span><br><span class="line">    wrapper.select(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    List&lt;Permission&gt; childIdList = permissionMapper.selectList(wrapper);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把childIdList中的菜单id一一取出，封装到idList中，做递归查询</span></span><br><span class="line">    childIdList.forEach(item -&gt; &#123;</span><br><span class="line">        idList.add(item.getId());</span><br><span class="line">        <span class="comment">//递归查询</span></span><br><span class="line">        <span class="keyword">this</span>.selectPermissionChildById(item.getId(),idList);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-3、测试"><a href="#3-3、测试" class="headerlink" title="3.3、测试"></a>3.3、测试</h2><blockquote><p>在数据库中插入几条测试数据</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210235954.png" alt="image-20210210235953698"></p><blockquote><p>打开swagger，我们测试删除id为2的菜单及其后代。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211000114.png" alt="image-20210211000114430"></p><blockquote><p>查看数据库，发现测试数据已经被逻辑删除。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211000230.png" alt="image-20210211000230171"></p>]]></content>
      
      
      <categories>
          
          <category> 项目总结 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在线教育项目总结（三）-EasyExcel的使用</title>
      <link href="posts/765379126.html"/>
      <url>posts/765379126.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、介绍和入门使用"><a href="#一、介绍和入门使用" class="headerlink" title="一、介绍和入门使用"></a>一、介绍和入门使用</h1><h2 id="1-1、Excel的应用场景"><a href="#1-1、Excel的应用场景" class="headerlink" title="1.1、Excel的应用场景"></a>1.1、Excel的应用场景</h2><blockquote><p>数据导入：<strong>减轻录入工作量</strong></p></blockquote><blockquote><p>数据导出：<strong>统计信息归档</strong></p></blockquote><blockquote><p>数据传输：<strong>异构系统之间数据传输</strong></p></blockquote><h2 id="1-2、EasyExcel"><a href="#1-2、EasyExcel" class="headerlink" title="1.2、EasyExcel"></a>1.2、EasyExcel</h2><blockquote><p><strong>Github地址：</strong><a href="https://github.com/alibaba/easyexcel">EasyExcel</a></p><p><strong>官方网站：</strong><a href="https://www.yuque.com/easyexcel/doc/easyexcel">EasyExcel</a></p></blockquote><h3 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h3><blockquote><p>EasyExcel是一个基于Java的简单、省内存的读写Excel的开源项目。在尽可能节约内存的情况下支持读写百M的Excel。</p></blockquote><h3 id="2、特点"><a href="#2、特点" class="headerlink" title="2、特点"></a>2、特点</h3><ul><li>Java领域解析、生成Excel比较有名的框架有Apache poi、jxl等。但他们都存在一个严重的问题就是非常的耗内存。如果你的系统并发量不大的话可能还行，但是一旦并发上来后一定会OOM或者JVM频繁的full gc。</li><li>EasyExcel是阿里巴巴开源的一个excel处理框架，<strong>以使用简单、节省内存著称</strong>。EasyExcel能大大减少占用内存的主要原因是在解析Excel时没有将文件数据一次性全部加载到内存中，而是从磁盘上一行行读取数据，逐个解析。</li><li>EasyExcel采用一行一行的解析模式，并将一行的解析结果以观察者的模式通知处理（AnalysisEventListener）。</li></ul><h2 id="1-3、入门使用"><a href="#1-3、入门使用" class="headerlink" title="1.3、入门使用"></a>1.3、入门使用</h2><h3 id="1、创建项目并引入依赖"><a href="#1、创建项目并引入依赖" class="headerlink" title="1、创建项目并引入依赖"></a>1、创建项目并引入依赖</h3><blockquote><p>创建一个测试用<strong>Maven</strong>项目，并导入以下依赖</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easyexcel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-simple<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlbeans<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xmlbeans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2、最简单的写"><a href="#2、最简单的写" class="headerlink" title="2、最简单的写"></a>2、最简单的写</h3><blockquote><p>创建实体类</p></blockquote><ul><li>使用@ExcelProperty注解可以指定excel列名，即name对应excel中的”姓名”列，birthday属性对应excel中的生日列…</li><li>使用Lombok插件简化开发</li><li>可以使用@ExcelIgnore字段来让EasyExcel忽略该属性</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelEmpData</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ExcelProperty(&quot;姓名&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExcelProperty(&quot;生日&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ExcelProperty(&quot;薪资&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Double salary;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 使用<span class="doctag">@ExcelIgnore</span>注解来使EasyExcel忽略这个属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelIgnore</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>测试用例，在test包下创建一个TestWriteExcelData测试类，用于测试EasyExcel的写功能</p></blockquote><ul><li>07版本的Excel和03版本的写入方式有所不同</li><li>03版本的Excel写入最多一次可写65536行</li></ul><blockquote><p>编写一个静态方法，这个方法用于生成测试数据</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;ExcelEmpData&gt; <span class="title">getEmpData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;ExcelEmpData&gt; excelEmpDataList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    ExcelEmpData data = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">65535</span>; i++) &#123;</span><br><span class="line">        data = <span class="keyword">new</span> ExcelEmpData();</span><br><span class="line">        data.setName(<span class="string">&quot;芜湖&quot;</span> + i);</span><br><span class="line">        <span class="comment">//password属性的值不会被写入Excel中</span></span><br><span class="line">        data.setPassword(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        data.setSalary(<span class="number">43.96</span>);</span><br><span class="line">        data.setBirthday(<span class="keyword">new</span> Date());</span><br><span class="line">        excelEmpDataList.add(data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> excelEmpDataList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在测试类中编写一个testWrite07方法，用于对.xlsx文件进行数据写入</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWrite07</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 指定数据写入到哪个excel文件</span></span><br><span class="line">    String fileName = <span class="string">&quot;F:/testExcel/01-simpleWrite-07.xlsx&quot;</span>;</span><br><span class="line">    <span class="comment">// 这里 需要指定写用哪个class去写，然后写到第一个sheet，名字为模板 然后文件流会自动关闭</span></span><br><span class="line">    EasyExcel.write(fileName, ExcelEmpData.class).sheet(<span class="string">&quot;模板&quot;</span>).doWrite(getEmpData());</span><br><span class="line">    System.out.println(<span class="string">&quot;excel写入成功！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210209235417.png" alt="image-20210209235416173"></p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210209235558.png" alt="image-20210209235558290"></p><blockquote><p>在测试类中编写一个testWrite03方法，用于对.xls文件进行数据写入</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">simpleWrite03</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String fileName = <span class="string">&quot;F:/testExcel/02-simpleWrite-03.xls&quot;</span>;</span><br><span class="line">    <span class="comment">// 如果这里想使用03 则 传入excelType参数即可</span></span><br><span class="line">    EasyExcel.write(fileName, ExcelEmpData.class).excelType(ExcelTypeEnum.XLS).sheet(<span class="string">&quot;模板&quot;</span>).doWrite(getEmpData());</span><br><span class="line">    System.out.println(<span class="string">&quot;excel写入成功！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210209235836.png" alt="image-20210209235835844"></p><blockquote><p>向.xls文件写入数据时，一次最多写入65536行</p></blockquote><ul><li>将getData()函数中的循环次数提高到65537</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWrongWrite03</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String fileName = <span class="string">&quot;F:/testExcel/03-simpleWrite-03.xls&quot;</span>;</span><br><span class="line">    <span class="comment">// 如果这里想使用03 则 传入excelType参数即可</span></span><br><span class="line">    EasyExcel.write(fileName, ExcelEmpData.class).excelType(ExcelTypeEnum.XLS).sheet(<span class="string">&quot;模板&quot;</span>).doWrite(getEmpData());</span><br><span class="line">    System.out.println(<span class="string">&quot;excel写入成功！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210000144.png" alt="image-20210210000144286"></p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210000202.png" alt="image-20210210000202523"></p><h3 id="3、指定easyExcel的写入列"><a href="#3、指定easyExcel的写入列" class="headerlink" title="3、指定easyExcel的写入列"></a>3、指定easyExcel的写入列</h3><blockquote><p>为实体类中的字段配置index属性</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelEmpData</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;姓名&quot;,index = 1)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;生日&quot;,index = 3)</span></span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;薪资&quot;,index = 5)</span></span><br><span class="line">    <span class="keyword">private</span> Double salary;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 使用<span class="doctag">@ExcelIgnore</span>注解来使EasyExcel忽略这个属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelIgnore</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>重新执行测试方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWrite07</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 指定数据写入到哪个excel文件</span></span><br><span class="line">    String fileName = <span class="string">&quot;F:/testExcel/04-simpleWrite-07.xlsx&quot;</span>;</span><br><span class="line">    <span class="comment">// 这里 需要指定写用哪个class去写，然后写到第一个sheet，名字为模板 然后文件流会自动关闭</span></span><br><span class="line">    EasyExcel.write(fileName, ExcelEmpData.class).sheet(<span class="string">&quot;模板&quot;</span>).doWrite(getEmpData());</span><br><span class="line">    System.out.println(<span class="string">&quot;excel写入成功！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210000729.png" alt="image-20210210000729446"></p><h3 id="4、指定属性的格式化"><a href="#4、指定属性的格式化" class="headerlink" title="4、指定属性的格式化"></a>4、指定属性的格式化</h3><blockquote><p>根据实体类属性的类型为属性添加不同的格式化注解</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelEmpData</span> </span>&#123;</span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;姓名&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DateTimeFormat(&quot;yyyy年MM月dd日HH时mm分ss秒&quot;)</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;生日&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date birthday;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NumberFormat(&quot;#.##%&quot;)</span><span class="comment">//百分比表示，保留两位小数</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;薪资&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Double salary;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 使用<span class="doctag">@ExcelIgnore</span>注解来使EasyExcel忽略这个属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ExcelIgnore</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>重新执行方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWrite07</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 指定数据写入到哪个excel文件</span></span><br><span class="line">    String fileName = <span class="string">&quot;F:/testExcel/05-simpleWrite-07.xlsx&quot;</span>;</span><br><span class="line">    <span class="comment">// 这里 需要指定写用哪个class去写，然后写到第一个sheet，名字为模板 然后文件流会自动关闭</span></span><br><span class="line">    EasyExcel.write(fileName, ExcelEmpData.class).sheet(<span class="string">&quot;模板&quot;</span>).doWrite(getEmpData());</span><br><span class="line">    System.out.println(<span class="string">&quot;excel写入成功！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210001029.png" alt="image-20210210001029235"></p><h3 id="5、xlsx和xls的区别"><a href="#5、xlsx和xls的区别" class="headerlink" title="5、xlsx和xls的区别"></a>5、xlsx和xls的区别</h3><blockquote><p>存储相同数量的数据，用xlsx占用的空间较小</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210001155.png" alt="image-20210210001155925"></p><blockquote><p>xls一次性最多写入65536条数据</p></blockquote><h2 id="1-4、使用EasyExcel读取文件"><a href="#1-4、使用EasyExcel读取文件" class="headerlink" title="1.4、使用EasyExcel读取文件"></a>1.4、使用EasyExcel读取文件</h2><blockquote><p>参考地址：<a href="https://www.yuque.com/easyexcel/doc/read">https://www.yuque.com/easyexcel/doc/read</a></p></blockquote><h3 id="1、创建监听器"><a href="#1、创建监听器" class="headerlink" title="1、创建监听器"></a>1、创建监听器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelEmpDataListener</span> <span class="keyword">extends</span> <span class="title">AnalysisEventListener</span>&lt;<span class="title">ExcelEmpData</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 每隔5条存储数据库，实际使用中可以3000条，然后清理list ，方便内存回收</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BATCH_COUNT = <span class="number">5</span>;</span><br><span class="line">    List&lt;ExcelEmpData&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个每一条数据解析都会来调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     *            one row value. Is is same as &#123;<span class="doctag">@link</span> AnalysisContext#readRowHolder()&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(ExcelEmpData data, AnalysisContext context)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;解析到一条数据:&#123;&#125;&quot;</span>, data);</span><br><span class="line">        list.add(data);</span><br><span class="line">        <span class="comment">// 达到BATCH_COUNT了，需要去存储一次数据库，防止数据几万条数据在内存，容易OOM</span></span><br><span class="line">        <span class="keyword">if</span> (list.size() &gt;= BATCH_COUNT) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;存数据库&quot;</span>);</span><br><span class="line">            <span class="comment">// 存储完成清理 list</span></span><br><span class="line">            list.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有数据解析完成了 都会来调用</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterAllAnalysed</span><span class="params">(AnalysisContext context)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;所有数据解析完成！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、测试"><a href="#2、测试" class="headerlink" title="2、测试"></a>2、测试</h3><blockquote><p>创建testRead.xlsx文件，添加测试数据</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210002105.png" alt="image-20210210002105220"></p><blockquote><p>创建测试方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 最简单的读</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">simpleRead07</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String fileName = <span class="string">&quot;F:/testExcel/testRead.xlsx&quot;</span>;</span><br><span class="line">    <span class="comment">// 这里默认读取第一个sheet</span></span><br><span class="line">    EasyExcel.read(fileName, ExcelEmpData.class, <span class="keyword">new</span> ExcelEmpDataListener()).sheet().doRead();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">simpleRead03</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String fileName = <span class="string">&quot;F:/testExcel/testRead.xls&quot;</span>;</span><br><span class="line">    <span class="comment">// 这里默认读取第一个sheet</span></span><br><span class="line">    EasyExcel.read(fileName, ExcelEmpData.class, <span class="keyword">new</span> ExcelEmpDataListener()).excelType(ExcelTypeEnum.XLS).sheet().doRead();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210002620.png" alt="image-20210210002619823"></p><h1 id="二、在线教育项目整合EasyExcel"><a href="#二、在线教育项目整合EasyExcel" class="headerlink" title="二、在线教育项目整合EasyExcel"></a>二、在线教育项目整合EasyExcel</h1><blockquote><p>在在线教育项目的课程分类管理中，我们需要接收管理员从前端传过来的课程分类excel，在解析后将excel中的数据存入课程分类表</p></blockquote><h2 id="2-1、添加依赖"><a href="#2-1、添加依赖" class="headerlink" title="2.1、添加依赖"></a>2.1、添加依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easyexcel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlbeans<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xmlbeans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2-2、创建与Excel对应的实体类"><a href="#2-2、创建与Excel对应的实体类" class="headerlink" title="2.2、创建与Excel对应的实体类"></a>2.2、创建与Excel对应的实体类</h2><blockquote><p>excel模板文件格式如下：</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210003102.png" alt="image-20210210003102353"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelSubjectData</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;一级分类&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String levelOneTitle;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;二级分类&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String levelTwoTitle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-3、实现Excel导入"><a href="#2-3、实现Excel导入" class="headerlink" title="2.3、实现Excel导入"></a>2.3、实现Excel导入</h2><h3 id="1、创建监听器-1"><a href="#1、创建监听器-1" class="headerlink" title="1、创建监听器"></a>1、创建监听器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span> <span class="comment">//全参</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span> <span class="comment">//无参</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExcelSubjectDataListener</span> <span class="keyword">extends</span> <span class="title">AnalysisEventListener</span>&lt;<span class="title">ExcelSubjectData</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 假设这个是一个DAO，当然有业务逻辑这个也可以是一个service。当然如果不用存储这个对象没用。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SubjectMapper subjectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *遍历每一行的记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> data</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> context</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(ExcelSubjectData data, AnalysisContext context)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;解析到一条记录: &#123;&#125;&quot;</span>, data);</span><br><span class="line">        <span class="comment">//处理读取出来的数据</span></span><br><span class="line">        String levelOneTitle = data.getLevelOneTitle();<span class="comment">//一级标题</span></span><br><span class="line">        String levelTwoTitle = data.getLevelTwoTitle();<span class="comment">//二级标题</span></span><br><span class="line">        log.info(<span class="string">&quot;levelOneTitle: &#123;&#125;&quot;</span>, levelOneTitle);</span><br><span class="line">        log.info(<span class="string">&quot;levelTwoTitle: &#123;&#125;&quot;</span>, levelTwoTitle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 组装数据：Subject</span></span><br><span class="line">        <span class="comment">// 存入数据库：subjectMapper.insert()</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有数据解析完成了 都会来调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAfterAllAnalysed</span><span class="params">(AnalysisContext context)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;所有数据解析完成！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、监听器中添加辅助方法"><a href="#2、监听器中添加辅助方法" class="headerlink" title="2、监听器中添加辅助方法"></a>2、监听器中添加辅助方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类名称查询这个一级分类是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> title</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Subject <span class="title">getByTitle</span><span class="params">(String title)</span> </span>&#123;</span><br><span class="line">    QueryWrapper&lt;Subject&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">&quot;title&quot;</span>, title);</span><br><span class="line">    queryWrapper.eq(<span class="string">&quot;parent_id&quot;</span>, <span class="string">&quot;0&quot;</span>);<span class="comment">//一级分类</span></span><br><span class="line">    <span class="keyword">return</span> subjectMappter.selectOne(queryWrapper);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据分类名称和父id查询这个二级分类是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> title</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Subject <span class="title">getSubByTitle</span><span class="params">(String title, String parentId)</span> </span>&#123;</span><br><span class="line">    QueryWrapper&lt;Subject&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">&quot;title&quot;</span>, title);</span><br><span class="line">    queryWrapper.eq(<span class="string">&quot;parent_id&quot;</span>, parentId);</span><br><span class="line">    <span class="keyword">return</span> subjectMappter.selectOne(queryWrapper);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、完善invoke方法"><a href="#3、完善invoke方法" class="headerlink" title="3、完善invoke方法"></a>3、完善invoke方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个每一条数据解析都会来调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(ExcelSubjectData data, AnalysisContext context)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;解析到一条数据:&#123;&#125;&quot;</span>, data);</span><br><span class="line">    <span class="comment">//处理读取进来的数据</span></span><br><span class="line">    String titleLevelOne = data.getLevelOneTitle();</span><br><span class="line">    String titleLevelTwo = data.getLevelTwoTitle();</span><br><span class="line">    <span class="comment">//判断一级分类是否重复</span></span><br><span class="line">    Subject subjectLevelOne = <span class="keyword">this</span>.getByTitle(titleLevelOne);</span><br><span class="line">    String parentId = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(subjectLevelOne == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//将一级分类存入数据库</span></span><br><span class="line">        Subject subject = <span class="keyword">new</span> Subject();</span><br><span class="line">        subject.setParentId(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">        subject.setTitle(titleLevelOne);<span class="comment">//一级分类名称</span></span><br><span class="line">        subjectMappter.insert(subject);</span><br><span class="line">        parentId = subject.getId();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        parentId = subjectLevelOne.getId();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//判断二级分类是否重复</span></span><br><span class="line">    Subject subjectLevelTwo = <span class="keyword">this</span>.getSubByTitle(titleLevelTwo, parentId);</span><br><span class="line">    <span class="keyword">if</span>(subjectLevelTwo == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="comment">//将二级分类存入数据库</span></span><br><span class="line">        Subject subject = <span class="keyword">new</span> Subject();</span><br><span class="line">        subject.setTitle(titleLevelTwo);</span><br><span class="line">        subject.setParentId(parentId);</span><br><span class="line">        subjectMappter.insert(subject);<span class="comment">//添加</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4、SubjectService"><a href="#4、SubjectService" class="headerlink" title="4、SubjectService"></a><strong>4、SubjectService</strong></h3><p>接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">batchImport</span><span class="params">(InputStream inputStream)</span></span>;</span><br></pre></td></tr></table></figure><p>实现：获取Excel记录并逐条导入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">batchImport</span><span class="params">(InputStream inputStream)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里 需要指定读用哪个class去读，然后读取第一个sheet 文件流会自动关闭</span></span><br><span class="line">    EasyExcel.read(inputStream, ExcelSubjectData.class, <span class="keyword">new</span> ExcelSubjectDataListener(baseMapper))</span><br><span class="line">        .excelType(ExcelTypeEnum.XLS).sheet().doRead();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5、Controller"><a href="#5、Controller" class="headerlink" title="5、Controller"></a>5、Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;课程分类管理&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/edu/subject&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubjectController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SubjectService subjectService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;import&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;Excel批量导入课程分类&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">batchImport</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@ApiParam(value = &quot;Excel文件&quot;,required = true)</span></span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//调用service层的批量导入方法</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subjectService.batchImport(file.getInputStream());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">//打印日志</span></span><br><span class="line">            log.error(ExceptionUtils.getMessage(e));</span><br><span class="line">            <span class="comment">//抛出一个Excel导入失败异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GrainException(ResultCodeEnum.EXCEL_DATA_IMPORT_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> R.ok().message(<span class="string">&quot;批量导入成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;nested&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;嵌套分类数据列表&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">nestedList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//返回分类VO列表</span></span><br><span class="line">        List&lt;SubjectVo&gt; subjectVoList = subjectService.nestedList();</span><br><span class="line">        <span class="keyword">return</span> R.ok().data(<span class="string">&quot;items&quot;</span>,subjectVoList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6、使用swagger进行测试"><a href="#6、使用swagger进行测试" class="headerlink" title="6、使用swagger进行测试"></a>6、使用swagger进行测试</h3><blockquote><p>删除数据库中的所有课程分类</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210003822.png" alt="image-20210210003821966"></p><blockquote><p>打开swagger，选择文件进行上传</p></blockquote><ul><li>swagger页面</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210004001.png" alt="image-20210210004001328"></p><ul><li>要上传的文件</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210003944.png" alt="image-20210210003944206"></p><blockquote><p>结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210004050.png" alt="image-20210210004050124"></p><ul><li>数据库</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210004116.png" alt="image-20210210004116897"></p>]]></content>
      
      
      <categories>
          
          <category> 项目总结 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
            <tag> ✨EasyExcel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在线教育项目总结（二）-用户认证</title>
      <link href="posts/650479038.html"/>
      <url>posts/650479038.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、有状态登录和无状态登录"><a href="#一、有状态登录和无状态登录" class="headerlink" title="一、有状态登录和无状态登录"></a>一、有状态登录和无状态登录</h1><h2 id="1-1-什么是有状态？"><a href="#1-1-什么是有状态？" class="headerlink" title="1.1.什么是有状态？"></a>1.1.什么是有状态？</h2><blockquote><p>有状态服务，即服务端需要记录每次会话的客户端信息，从而识别客户端身份，根据用户身份进行请求的处理，典型的设计如tomcat中的session。</p><p>例如登录：用户登录后，我们把登录者的信息保存在服务端session中，并且给用户一个cookie值，记录对应的session。然后下次请求，用户携带cookie值来，我们就能识别到对应session，从而找到用户的信息。</p></blockquote><p>缺点：</p><ul><li>服务端保存大量数据，增加服务端压力</li><li>服务端保存用户状态，无法进行水平扩展</li><li>客户端请求依赖服务端，多次请求必须访问同一台服务器</li></ul><h2 id="1-2、什么是无状态？"><a href="#1-2、什么是无状态？" class="headerlink" title="1.2、什么是无状态？"></a>1.2、什么是无状态？</h2><blockquote><p>服务器不保存用户的登录信息！</p><p>微服务集群中的每个服务，对外提供的都是Rest风格的接口。而Rest风格的一个最重要的规范就是：服务的无状态性，即：</p><ul><li><strong>服务端不保存任何客户端请求者信息</strong></li><li>客户端的每次请求必须具备自描述信息（jwt），通过这些信息识别客户端身份</li></ul></blockquote><p><strong>优点：</strong></p><ul><li>无状态： token是无状态，session是有状态的</li><li>基于标准化：你的API可以采用标准化的 JSON Web Token (JWT)</li><li>客户端请求不依赖服务端的信息，任何多次请求不需要必须访问到同一台服务</li><li>服务端的集群和状态对客户端透明</li><li>服务端可以任意的迁移和伸缩</li><li>减小服务端存储压力</li></ul><p><strong>缺点：</strong></p><ul><li>占用带宽</li><li>无法在服务器端销毁</li></ul><h1 id="二、常见登录方式"><a href="#二、常见登录方式" class="headerlink" title="二、常见登录方式"></a>二、常见登录方式</h1><h2 id="2-1、单一服务器模式"><a href="#2-1、单一服务器模式" class="headerlink" title="2.1、单一服务器模式"></a>2.1、单一服务器模式</h2><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205210527.png" alt="image-20210205210527360"></p><p><strong>一般过程如下：</strong></p><ol><li>用户向服务器发送用户名和密码。</li><li>验证服务器后，相关数据（如用户名，用户角色等）将保存在当前会话（session）中。</li><li>服务器向用户返回session_id，session信息都会写入到用户的Cookie。</li><li>用户的每个后续请求都将通过在Cookie中取出session_id传给服务器。</li><li>服务器收到session_id并对比之前保存的数据，确认用户的身份。</li></ol><p><strong>缺点：</strong></p><ul><li>单点性能压力，无法扩展。</li><li>分布式架构中，需要session共享方案，session共享方案存在性能瓶颈。</li></ul><h2 id="2-2、单点登录（Single-Sign-On）"><a href="#2-2、单点登录（Single-Sign-On）" class="headerlink" title="2.2、单点登录（Single  Sign  On）"></a>2.2、单点登录（Single  Sign  On）</h2><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205210648.png" alt="image-20210205210648124"></p><p>分布式，SSO(single sign on)模式：单点登录英文全称Single Sign On，简称就是SSO。它的解释是：在多个应用系统中，只需要登录一次，就可以访问其他相互信任的应用系统。</p><ul><li>如图所示，图中有3个系统，分别是业务A、业务B、和SSO。</li><li>业务A、业务B没有登录模块。</li><li>而SSO只有登录模块，没有其他的业务模块。</li></ul><p><strong>一般过程如下：</strong></p><ol><li>当业务A、业务B需要登录时，将跳到SSO系统。</li><li>SSO从用户信息数据库中获取用户信息并校验用户信息，SSO系统完成登录。</li><li>然后将用户信息存入缓存（例如redis）。</li><li>当用户访问业务A或业务B，需要判断用户是否登录时，将跳转到SSO系统中进行用户身份验证，SSO判断缓存中是否存在用户身份信息。</li><li>这样，只要其中一个系统完成登录，其他的应用系统也就随之登录了。这就是单点登录（SSO）的定义。</li></ol><p><strong>优点 ：</strong>  </p><p>用户身份信息独立管理，更好的分布式管理。可以自己扩展安全策略</p><p><strong>缺点：</strong></p><p>认证服务器访问压力较大。</p><h2 id="2-3、Token模式"><a href="#2-3、Token模式" class="headerlink" title="2.3、Token模式"></a>2.3、Token模式</h2><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205210734.png" alt="image-20210205210734269"></p><p><strong>优点：</strong></p><ul><li>无状态： token是无状态，session是有状态的</li><li>基于标准化：你的API可以采用标准化的 JSON Web Token (JWT)</li></ul><p><strong>缺点：</strong></p><ul><li>占用带宽</li><li>无法在服务器端销毁</li></ul><blockquote><p>无状态登录的流程：</p></blockquote><ul><li>当客户端第一次请求服务时，服务端对用户进行信息认证（登录）</li><li>认证通过，将用户信息进行加密形成token，返回给客户端，作为登录凭证</li><li>以后每次请求，客户端都携带认证的token</li><li>服务的对token进行解密，判断是否有效。</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205211358.png" alt="image-20210205211358667"></p><p>整个登录过程中，最关键的点是什么？</p><p><strong>token的安全性</strong></p><h1 id="三、JWT"><a href="#三、JWT" class="headerlink" title="三、JWT"></a>三、JWT</h1><h2 id="3-1、什么是JWT令牌"><a href="#3-1、什么是JWT令牌" class="headerlink" title="3.1、什么是JWT令牌"></a>3.1、什么是JWT令牌</h2><blockquote><p>JWT是JSON Web Token的缩写，即JSON Web令牌，是一种自包含令牌。 </p></blockquote><h3 id="1、使用场景"><a href="#1、使用场景" class="headerlink" title="1、使用场景"></a>1、使用场景</h3><ul><li>一种情况是webapi，类似阿里云播放凭证的功能。</li><li>另一种情况是多web服务器下实现无状态分布式身份验证。</li></ul><h3 id="2、交互流程"><a href="#2、交互流程" class="headerlink" title="2、交互流程"></a>2、交互流程</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205211838.png" alt="image-20210205211838506"></p><p>步骤翻译：</p><ul><li>1、用户登录</li><li>2、服务的认证，通过后根据secret生成token</li><li>3、将生成的token返回给浏览器</li><li>4、用户每次请求携带token</li><li>5、服务端利用公钥解读jwt签名，判断签名有效后，从Payload中获取用户信息</li><li>6、处理请求，返回响应结果</li></ul><p>因为JWT签发的token中已经包含了用户的身份信息，并且每次请求都会携带，这样服务的就无需保存用户信息，甚至无需去数据库查询，完全符合了Rest的无状态规范。</p><h3 id="3、作用"><a href="#3、作用" class="headerlink" title="3、作用"></a>3、作用</h3><blockquote><p>JWT 最重要的作用就是对 token信息的防伪作用</p></blockquote><h3 id="4、原理"><a href="#4、原理" class="headerlink" title="4、原理"></a>4、原理</h3><ul><li>一个JWT由三个部分组成：JWT头、有效载荷、签名哈希</li><li>最后由这三者组合进行base64编码得到JWT</li></ul><h2 id="3-2、JWT令牌的组成"><a href="#3-2、JWT令牌的组成" class="headerlink" title="3.2、JWT令牌的组成"></a>3.2、JWT令牌的组成</h2><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205212928.png" alt="image-20210205212928770"></p><p><strong>JWT头</strong></p><p>JWT头部分是一个描述JWT元数据的JSON对象，通常如下所示。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;alg&quot;: &quot;HS256&quot;,</span><br><span class="line">  &quot;typ&quot;: &quot;JWT&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在上面的代码中，alg属性表示签名使用的算法，默认为HMAC SHA256（写为HS256）；typ属性表示令牌的类型，JWT令牌统一写为JWT。最后，使用Base64 URL算法将上述JSON对象转换为字符串保存。</p><p><strong>有效载荷</strong></p><p>有效载荷部分，是JWT的主体内容部分，也是一个JSON对象，包含需要传递的数据。 JWT指定七个默认字段供选择。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iss: jwt签发者</span><br><span class="line">sub: 主题</span><br><span class="line">aud: 接收jwt的一方</span><br><span class="line">exp: jwt的过期时间，这个过期时间必须要大于签发时间</span><br><span class="line">nbf: 定义在什么时间之前，该jwt都是不可用的.</span><br><span class="line">iat: jwt的签发时间</span><br><span class="line">jti: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</span><br></pre></td></tr></table></figure><p>除以上默认字段外，我们还可以自定义私有字段，如下例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;Helen&quot;,</span><br><span class="line">  &quot;admin&quot;: true,</span><br><span class="line">  &quot;avatar&quot;: &quot;helen.jpg&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>请注意，默认情况下JWT是未加密的，任何人都可以解读其内容，因此不要构建隐私信息字段，存放保密信息，以防止信息泄露。</p><p>JSON对象也使用Base64 URL算法转换为字符串保存。</p><p><strong>签名哈希</strong></p><p>签名哈希部分是对上面两部分数据签名，通过指定的算法生成哈希，以确保数据不会被篡改。</p><p>首先，需要指定一个密码（secret）。该密码仅仅为保存在服务器中，并且不能向用户公开。然后，使用标头中指定的签名算法（默认情况下为HMAC SHA256）根据以下公式生成签名。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(claims), secret)</span><br></pre></td></tr></table></figure><p>在计算出签名哈希后，JWT头，有效载荷和签名哈希的三个部分组合成一个字符串，每个部分用”.”分隔，就构成整个JWT对象。</p><p><strong>Base64URL算法</strong></p><p>如前所述，JWT头和有效载荷序列化的算法都用到了Base64URL。该算法和常见Base64算法类似，稍有差别。</p><p>作为令牌的JWT可以放在URL中（例如api.example/?token=xxx）。 Base64中用的三个字符是”+”，”/“和”=”，由于在URL中有特殊含义，因此Base64URL中对他们做了替换：”=”去掉，”+”用”-“替换，”/“用”_”替换，这就是Base64URL算法。</p><p><strong>注意：</strong>base64编码，并不是加密，只是把明文信息变成了不可见的字符串。但是其实只要用一些工具就可以把base64编码解成明文，所以不要在JWT中放入涉及私密的信息。</p><h2 id="3-3、JWT的用法"><a href="#3-3、JWT的用法" class="headerlink" title="3.3、JWT的用法"></a>3.3、JWT的用法</h2><blockquote><p>客户端接收服务器返回的JWT，将其存储在Cookie或localStorage中。</p><p>此后，客户端将在与服务器交互中都会带JWT。如果将它存储在Cookie中，就可以自动发送，但是不会跨域，因此一般是将它放入HTTP请求的Header Authorization字段中。</p><p>当跨域时，也可以将JWT放置于POST请求的数据主体中。</p></blockquote><h2 id="3-4、问题和趋势"><a href="#3-4、问题和趋势" class="headerlink" title="3.4、问题和趋势"></a>3.4、问题和趋势</h2><p>1、JWT默认不加密，但可以加密。生成原始令牌后，可以使用该令牌再次对其进行加密。</p><p>2、当JWT未加密时，一些私密数据无法通过JWT传输。</p><p>3、JWT不仅可用于认证，还可用于信息交换。善用JWT有助于减少服务器请求数据库的次数。</p><p>4、JWT的最大缺点是服务器不保存会话状态，所以在使用期间不可能取消令牌或更改令牌的权限。也就是说，一旦JWT签发，在有效期内将会一直有效。</p><p>5、JWT本身包含认证信息，因此一旦信息泄露，任何人都可以获得令牌的所有权限。为了减少盗用，JWT的有效期不宜设置太长。对于某些重要操作，用户在使用时应该每次都进行身份验证。</p><p>6、为了减少盗用和窃取，JWT不建议使用HTTP协议来传输代码，而是使用加密的HTTPS协议进行传输。</p><h1 id="四、用户身份认证"><a href="#四、用户身份认证" class="headerlink" title="四、用户身份认证"></a>四、用户身份认证</h1><h2 id="4-1、引入依赖"><a href="#4-1、引入依赖" class="headerlink" title="4.1、引入依赖"></a>4.1、引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>joda-time<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>joda-time<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="4-2、引入工具类和用户有效载荷类"><a href="#4-2、引入工具类和用户有效载荷类" class="headerlink" title="4.2、引入工具类和用户有效载荷类"></a>4.2、引入工具类和用户有效载荷类</h2><blockquote><p>JwtUtils.java，用于根据<strong>用户信息</strong>生成<strong>token</strong>、判断token是否有效的工具类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String APP_SECRET = <span class="string">&quot;ukc8BDbRigUDaY6pZFfWus2jZWLPHO&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Key <span class="title">getKeyInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        SignatureAlgorithm signatureAlgorithm = SignatureAlgorithm.HS256;</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = DatatypeConverter.parseBase64Binary(APP_SECRET);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SecretKeySpec(bytes,signatureAlgorithm.getJcaName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getJwtToken</span><span class="params">(JwtInfo jwtInfo, <span class="keyword">int</span> expire)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        String JwtToken = Jwts.builder()</span><br><span class="line">                .setHeaderParam(<span class="string">&quot;typ&quot;</span>, <span class="string">&quot;JWT&quot;</span>)</span><br><span class="line">                .setHeaderParam(<span class="string">&quot;alg&quot;</span>, <span class="string">&quot;HS256&quot;</span>)</span><br><span class="line">                .setSubject(<span class="string">&quot;guli-user&quot;</span>)<span class="comment">//主题</span></span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> Date())<span class="comment">//颁发时间</span></span><br><span class="line">                .setExpiration(DateTime.now().plusSeconds(expire).toDate())<span class="comment">//过期时间</span></span><br><span class="line">                .claim(<span class="string">&quot;id&quot;</span>, jwtInfo.getId())<span class="comment">//用户id</span></span><br><span class="line">                .claim(<span class="string">&quot;nickname&quot;</span>, jwtInfo.getNickname())<span class="comment">//用户昵称</span></span><br><span class="line">                .claim(<span class="string">&quot;avatar&quot;</span>, jwtInfo.getAvatar())<span class="comment">//用户头像</span></span><br><span class="line">                .signWith(SignatureAlgorithm.HS256, getKeyInstance())</span><br><span class="line">                .compact();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JwtToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断token是否存在与有效</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwtToken</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkJwtTToken</span><span class="params">(String jwtToken)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(jwtToken)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Jwts.parser().setSigningKey(getKeyInstance()).parseClaimsJws(jwtToken);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断token是否存在与有效</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkJwtTToken</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String jwtToken = request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(StringUtils.isEmpty(jwtToken)) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            Jwts.parser().setSigningKey(getKeyInstance()).parseClaimsJws(jwtToken);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据token获取会员id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JwtInfo <span class="title">getMemberIdByJwtToken</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String jwtToken = request.getHeader(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(jwtToken)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        Jws&lt;Claims&gt; claimsJws = Jwts.parser().setSigningKey(getKeyInstance()).parseClaimsJws(jwtToken);</span><br><span class="line">        Claims claims = claimsJws.getBody();</span><br><span class="line">        JwtInfo jwtInfo = <span class="keyword">new</span> JwtInfo(claims.get(<span class="string">&quot;id&quot;</span>).toString(), claims.get(<span class="string">&quot;nickname&quot;</span>).toString(), claims.get(<span class="string">&quot;avatar&quot;</span>).toString());</span><br><span class="line">        <span class="keyword">return</span> jwtInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>JwtInfo，存放用户的有效信息</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtInfo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String nickname;</span><br><span class="line">    <span class="keyword">private</span> String avatar;</span><br><span class="line">    <span class="comment">//权限、角色等</span></span><br><span class="line">    <span class="comment">//不要存敏感信息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-3、定义LoginVo"><a href="#4-3、定义LoginVo" class="headerlink" title="4.3、定义LoginVo"></a>4.3、定义LoginVo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginVo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String mobile;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-4、定义控制层接口"><a href="#4-4、定义控制层接口" class="headerlink" title="4.4、定义控制层接口"></a>4.4、定义控制层接口</h2><blockquote><p>该接口接收Service层生成的Token，然后将token返回至前端</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;会员登录&quot;)</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;login&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">login</span><span class="params">(<span class="meta">@RequestBody</span> LoginVo loginVo)</span> </span>&#123;</span><br><span class="line">    String token = memberService.login(loginVo);</span><br><span class="line">    <span class="keyword">return</span> R.ok().data(<span class="string">&quot;token&quot;</span>, token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-5、定义Service层"><a href="#4-5、定义Service层" class="headerlink" title="4.5、定义Service层"></a>4.5、定义Service层</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(LoginVo loginVo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String mobile = loginVo.getMobile();</span><br><span class="line">    String password = loginVo.getPassword();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验参数</span></span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(mobile)</span><br><span class="line">        || !FormUtils.isMobile(mobile)</span><br><span class="line">        || StringUtils.isEmpty(password)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> GuliException(ResultCodeEnum.PARAM_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验手机号</span></span><br><span class="line">    QueryWrapper&lt;Member&gt; queryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">&quot;mobile&quot;</span>, mobile);</span><br><span class="line">    Member member = baseMapper.selectOne(queryWrapper);</span><br><span class="line">    <span class="keyword">if</span>(member == <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> GuliException(ResultCodeEnum.LOGIN_MOBLE_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//校验密码</span></span><br><span class="line">    <span class="keyword">if</span>(!MD5.encrypt(password).equals(member.getPassword()))&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> GuliException(ResultCodeEnum.LOGIN_PASSWORD_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检验用户是否被禁用</span></span><br><span class="line">    <span class="keyword">if</span>(member.getDisabled())&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> GuliException(ResultCodeEnum.LOGIN_DISABLED_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JwtInfo jwtInfo = <span class="keyword">new</span> JwtInfo();</span><br><span class="line">    jwtInfo.setId(member.getId());</span><br><span class="line">    jwtInfo.setNickname(member.getNickname());</span><br><span class="line">    jwtInfo.setAvatar(member.getAvatar());</span><br><span class="line">    String jwtToken = JwtUtils.getJwtToken(jwtInfo, <span class="number">1800</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jwtToken;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-6、测试"><a href="#4-6、测试" class="headerlink" title="4.6、测试"></a>4.6、测试</h2><blockquote><p>往数据库中插入一条测试数据，mobile为13711111111，密码为123</p></blockquote><blockquote><p>打开swagger，进行测试</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205215334.png" alt="image-20210205215334387"></p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205215350.png" alt="image-20210205215350880"></p><blockquote><p>当mobile和密码均输入无误时，后端会返回一个token</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205215435.png" alt="image-20210205215435940"></p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205215449.png" alt="image-20210205215449715"></p>]]></content>
      
      
      <categories>
          
          <category> 项目总结 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
            <tag> 🆔JWT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据结构与算法学习（三）-二叉排序树详解</title>
      <link href="posts/3310991137.html"/>
      <url>posts/3310991137.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、简介"><a href="#一、简介" class="headerlink" title="一、简介"></a>一、简介</h1><blockquote><p><strong>二叉排序树</strong>亦称<strong>二叉查找树</strong>，是树形数据结构的一种，在一般情况下，二叉排序树的查找效率要<strong>高于</strong>普通链表，它要么是一棵空树，要么具有以下性质：</p><ul><li>若它的左子树不为空，则<strong>左子树上所有结点的值均小于它的根结点的值</strong>；</li><li>若它的右子树不为空，则<strong>右子树上所有结点的值均大于它的根结点的值</strong>；</li><li><strong>它的左、右子树分别为二叉排序树</strong>。</li><li>下面是一棵标准的二叉排序树</li></ul></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205180351.png" alt="image-20210205180344323"></p><h1 id="二、二叉排序树的生成与节点插入"><a href="#二、二叉排序树的生成与节点插入" class="headerlink" title="二、二叉排序树的生成与节点插入"></a>二、二叉排序树的生成与节点插入</h1><h2 id="2-1、生成"><a href="#2-1、生成" class="headerlink" title="2.1、生成"></a>2.1、生成</h2><h3 id="1、创建Node类和Tree类"><a href="#1、创建Node类和Tree类" class="headerlink" title="1、创建Node类和Tree类"></a>1、创建Node类和Tree类</h3><blockquote><p>创建一个<strong>Node</strong>类作为二叉排序树的<strong>节点类</strong>，这里省略getter、setter和toString方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 节点的值</span></span><br><span class="line">    <span class="keyword">int</span> data;</span><br><span class="line">    <span class="comment">// 当前节点的左子节点</span></span><br><span class="line">    Node left;</span><br><span class="line">    <span class="comment">// 当前节点的右子节点</span></span><br><span class="line">    Node right;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure><blockquote><p>创建一个<strong>Tree</strong>类，这个类包含一个Node类型的root属性。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Tree</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当前树的根节点</span></span><br><span class="line">    Node root;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure><h3 id="2、生成思路"><a href="#2、生成思路" class="headerlink" title="2、生成思路"></a>2、生成思路</h3><blockquote><p>既可以在创建二叉树对象时直接使用有参构造函数传入根节点对象，也可以在添加节点时才插入root节点</p><p>注：当一棵树root节点为空时，第一个插入该树的节点就是根节点。</p></blockquote><h2 id="2、节点插入"><a href="#2、节点插入" class="headerlink" title="2、节点插入"></a>2、节点插入</h2><h3 id="1、思路"><a href="#1、思路" class="headerlink" title="1、思路"></a>1、思路</h3><blockquote><p>在Tree类中添加一个addNode方法，<strong>如果当前树的根节点为空，那么将要添加到二叉排序树的节点设置为根节点</strong>，否则就<strong>调用root节点对象的add方法</strong>，在root对象的add方法中：</p><ul><li>  如果传入要添加的节点node为空，那么直接返回，不做添加。</li><li>如果传入要添加的节点node的数值小于当前节点的数值，那么进行判断，如果当前节点的左子树为空，那么直接让当前节点的左子树为要添加的节点node。否则向左进行递归添加，判断待添加节点node的数据与当前左子节点数据的关系，重复以上操作。</li><li>如果传入要添加的节点node的数值大于等于当前节点的数值，这种情况需要尽量避免，这个时候进行判断，如果当前节点右子树为空，那么令当前节点右子树等于要添加的节点node。否则向右进行递归添加，判断待添加节点node的数据与当前右子节点数据的关系，重复以上操作。</li></ul></blockquote><h3 id="2、插入节点–Tree"><a href="#2、插入节点–Tree" class="headerlink" title="2、插入节点–Tree"></a>2、插入节点–Tree</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNode</span><span class="params">(Node node)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.root == <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">this</span>.root = node; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="keyword">this</span>.root.add(node); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、节点的比较与插入–Node"><a href="#3、节点的比较与插入–Node" class="headerlink" title="3、节点的比较与插入–Node"></a>3、节点的比较与插入–Node</h3><blockquote><p><strong>比较节点树的静态方法</strong>如下</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">compare</span><span class="params">(Node node1,Node node2)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> node1.data &gt; node2.data; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><blockquote><p>Node类中插入节点的方法如下</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Node node)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(node == <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">return</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span>(compare(<span class="keyword">this</span>,node)) &#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.left == <span class="keyword">null</span>) &#123; </span><br><span class="line">            <span class="keyword">this</span>.left = node; </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="keyword">this</span>.left.add(node); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.right == <span class="keyword">null</span>) &#123; </span><br><span class="line">            <span class="keyword">this</span>.right = node; </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="keyword">this</span>.right.add(node); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="三、二叉树的前中后序遍历"><a href="#三、二叉树的前中后序遍历" class="headerlink" title="三、二叉树的前中后序遍历"></a>三、二叉树的前中后序遍历</h1><blockquote><p>前序遍历的顺序：<strong>根节点–左子节点–右子节点</strong></p><p>中序遍历的顺序：<strong>左子节点–根节点–右子节点</strong></p><p>后序遍历的顺序：<strong>左子节点–右子节点–根节点</strong></p></blockquote><h2 id="3-1、递归实现"><a href="#3-1、递归实现" class="headerlink" title="3.1、递归实现"></a>3.1、递归实现</h2><h3 id="1、前序遍历"><a href="#1、前序遍历" class="headerlink" title="1、前序遍历"></a>1、前序遍历</h3><blockquote><p>先输出当前节点，然后判断当前节点的左子树是否为空，如果不为空，就向左递归进行前序遍历。然后判断当前节点的右子树是否为空，若不为空，向右递归进行前序遍历。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Tree类 </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preOrder</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.root != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">this</span>.root.preOrder(); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        System.out.println(<span class="string">&quot;二叉树为空，无法遍历！&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"><span class="comment">//Node类 </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preOrder</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    System.out.println(<span class="keyword">this</span>); </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.getLeft() != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">this</span>.getLeft().preOrder(); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.getRight() != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">this</span>.getRight().preOrder(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、中序遍历"><a href="#2、中序遍历" class="headerlink" title="2、中序遍历"></a>2、中序遍历</h3><blockquote><p>先判断当前节点左子树是否为空，若不为空，向左递归进行中序遍历，然后输出当前节点；最后判断当前节点的右子树是否为空，若不为空，向右递归进行中序遍历。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Tree类 </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">infixOrder</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.root != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">this</span>.root.infixOrder(); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        System.out.println(<span class="string">&quot;二叉树为空，无法遍历！&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"><span class="comment">//Node类 </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">infixOrder</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.getLeft() != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">this</span>.getLeft().infixOrder(); </span><br><span class="line">    &#125; </span><br><span class="line">    System.out.println(<span class="keyword">this</span>); </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.getRight() != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">this</span>.getRight().infixOrder(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、后序遍历"><a href="#3、后序遍历" class="headerlink" title="3、后序遍历"></a>3、后序遍历</h3><blockquote><p>先判断当前节点左子树是否为空，若不为空，向左递归进行后序遍历；然后判断当前节点的右子树是否为空，若不为空，向右递归进行后序遍历。最后输出当前节点。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Tree类 </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postOrder</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.root != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">this</span>.root.postOrder(); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        System.out.println(<span class="string">&quot;二叉树为空，无法遍历！&quot;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"><span class="comment">//Node类 </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postOrder</span><span class="params">()</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.getLeft() != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">this</span>.getLeft().postOrder(); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.getRight() != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">this</span>.getRight().postOrder(); </span><br><span class="line">    &#125; </span><br><span class="line">    System.out.println(<span class="keyword">this</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-2、非递归实现"><a href="#3-2、非递归实现" class="headerlink" title="3.2、非递归实现"></a>3.2、非递归实现</h2><blockquote><p>我们需要使用到<strong>栈</strong>这一数据结构来解决问题</p></blockquote><h3 id="1、前序遍历-1"><a href="#1、前序遍历-1" class="headerlink" title="1、前序遍历"></a>1、前序遍历</h3><blockquote><p>如果当前节点不为空，先输出当前节点信息，然后将该节点压入栈，并将指针移动到当前节点的左子节点，此时如果该左子树为空，就退出循环，此时如果栈不为空，就弹出栈顶数据，将指针移动到当前结点右子树，循环，直到栈空或者当前节点为空。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">preOrder</span><span class="params">(Node node)</span> </span>&#123; </span><br><span class="line">    Stack&lt;Node&gt; nodeStack = <span class="keyword">new</span> Stack&lt;&gt;(); </span><br><span class="line">    <span class="keyword">while</span>(node != <span class="keyword">null</span> || !nodeStack.empty()) &#123; </span><br><span class="line">        <span class="keyword">while</span>(node != <span class="keyword">null</span>) &#123; </span><br><span class="line">            System.out.println(node); </span><br><span class="line">            nodeStack.push(node); </span><br><span class="line">            node = node.getLeft(); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">if</span>(!nodeStack.empty()) &#123; </span><br><span class="line">            node = nodeStack.pop(); </span><br><span class="line">            node = node.getRight(); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、中序遍历-1"><a href="#2、中序遍历-1" class="headerlink" title="2、中序遍历"></a>2、中序遍历</h3><blockquote><p>如果当前节点不为空，将当前节点压入栈中，然后将指针指向当前节点左子树，直到左子树为空，此时栈不为空，将栈顶元素弹出并输出后，将指针移动到当前结点右子树，循环，直到栈空或者当前节点为空。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">midOrder</span><span class="params">(Node node)</span> </span>&#123; </span><br><span class="line">    Stack&lt;Node&gt; nodeStack = <span class="keyword">new</span> Stack&lt;&gt;(); </span><br><span class="line">    <span class="keyword">while</span>(node != <span class="keyword">null</span> || !nodeStack.empty()) &#123; </span><br><span class="line">        <span class="keyword">while</span>(node != <span class="keyword">null</span>) &#123; </span><br><span class="line">            nodeStack.push(node); </span><br><span class="line">            node = node.getLeft(); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">if</span>(!nodeStack.empty()) &#123; </span><br><span class="line">            node = nodeStack.pop(); </span><br><span class="line">            System.out.println(node); </span><br><span class="line">            node = node.getRight(); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、后序遍历-1"><a href="#3、后序遍历-1" class="headerlink" title="3、后序遍历"></a>3、后序遍历</h3><blockquote><p>需要利用到一个辅助栈用于输出结果，由于栈具有先进后出的特点，而后序遍历的顺序是左右根，所以压入栈顺序为根、右、左。最后使用辅助栈输出</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postOrder</span><span class="params">(Node node)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(node == <span class="keyword">null</span>) &#123; </span><br><span class="line">        System.out.println(<span class="string">&quot;要遍历的二叉树为空！&quot;</span>); </span><br><span class="line">        <span class="keyword">return</span>; </span><br><span class="line">    &#125; </span><br><span class="line">    Stack&lt;Node&gt; stack = <span class="keyword">new</span> Stack&lt;&gt;(); </span><br><span class="line">    <span class="comment">//辅助栈 </span></span><br><span class="line">    Stack&lt;Node&gt; assistStack = <span class="keyword">new</span> Stack&lt;&gt;(); </span><br><span class="line">    <span class="keyword">while</span>(node != <span class="keyword">null</span> || !stack.isEmpty()) &#123; </span><br><span class="line">        <span class="keyword">while</span>(node != <span class="keyword">null</span>) &#123; </span><br><span class="line">            stack.push(node); </span><br><span class="line">            assistStack.push(node); </span><br><span class="line">            node = node.getRight(); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">if</span>(!stack.isEmpty()) &#123; </span><br><span class="line">            node = stack.pop(); </span><br><span class="line">            node = node.getLeft(); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">while</span>(!assistStack.isEmpty()) &#123; </span><br><span class="line">        System.out.println(assistStack.pop()); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="四、二叉排序树节点的删除"><a href="#四、二叉排序树节点的删除" class="headerlink" title="四、二叉排序树节点的删除"></a>四、二叉排序树节点的删除</h1><blockquote><p>二叉排序树中的节点可以分为以下三种：</p><ul><li>叶子节点</li><li>有一棵子树的节点</li><li>有两棵子树的节点</li></ul><p>我们需要判断待删除节点为什么类型，然后根据节点类型进行删除操作。</p></blockquote><h2 id="4-1、编写用于搜索待删除节点和待删除节点父节点的方法"><a href="#4-1、编写用于搜索待删除节点和待删除节点父节点的方法" class="headerlink" title="4.1、编写用于搜索待删除节点和待删除节点父节点的方法"></a>4.1、编写用于搜索待删除节点和待删除节点父节点的方法</h2><h3 id="1、搜索待删除节点的方法"><a href="#1、搜索待删除节点的方法" class="headerlink" title="1、搜索待删除节点的方法"></a>1、搜索待删除节点的方法</h3><blockquote><p>搜索待删除节点，首先判断当前二叉排序树是否为空，若为空，直接返回，否则调用当前二叉排序树根节点的search方法</p><ul><li><p>如果当前传入的数据data的值刚好等于当前节点的data值，那么当前节点就是待删除节点，直接返回即可</p></li><li><p> 如果当前传入的数据data的值小于当前节点的值且当前节点的左子树为空，证明当前二叉排序树中没有要删除的节点；如果当前传入数据data值小于当前节点值且当前节点左子树不为空，那么调用当前节点左子树的search方法，向左递归查询。</p></li><li><p>同理，如果当前传入的数据data值大于当前节点值且当前节点右子树为空，证明当前二叉排序树没有要删除节点，此刻只能返回null；如果当前传入数据data值大于当前节点且当前节点右子树不为空，那么调用当前右子树的search方法，向右递归查询。</p></li></ul><p>代码如下</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** </span></span><br><span class="line"><span class="comment"> * 根据节点的data数据搜索Node节点 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data 目标节点的data值 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 如果找到符合条件的node节点，那么返回该node节点 </span></span><br><span class="line"><span class="comment"> *         否则返回null </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> Node <span class="title">search</span><span class="params">(<span class="keyword">int</span> data)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(data == <span class="keyword">this</span>.data) &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>; </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(data &lt; <span class="keyword">this</span>.data) &#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.left == <span class="keyword">null</span>) &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.left.search(data); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.right == <span class="keyword">null</span>) &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.right.search(data); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、搜索待删除节点父节点的方法"><a href="#2、搜索待删除节点父节点的方法" class="headerlink" title="2、搜索待删除节点父节点的方法"></a>2、搜索待删除节点父节点的方法</h3><blockquote><p>搜索待删除节点的父节点的方法，同理先判断当前二叉排序树的根节点是否为空，若为空，返回null，否则调用当前二叉排序树的根节点的搜索待删除节点父节点（searchParent）的方法。</p><ul><li><p>如果当前节点的左子树不为空且当前节点左子树的data值等于用户传入的要检索的data值或者当前节点右子树不为空且当前节点右子树的data值等于用户传入的要检索的data值，那么证明当前节点就是待检索节点，返回当前节点。</p></li><li><p>如果传入的data值小于当前节点值且当前左子树不为空，那么调用当前左子节点的searchParent的方法。</p></li><li><p>同理，如果传入data值大于等于当前节点的data值且当前节点右子树不为空，那么调用当前节点右子节点的searchParent方法。</p></li><li><p>如果程序走到此处，证明没有找到待删除数据的父节点，此时返回null。</p></li></ul><p>代码如下</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** </span></span><br><span class="line"><span class="comment"> * 查找要删除节点的父节点 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data 要删除的节点的数据 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 待删除节点的父节点 </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> Node <span class="title">searchParent</span><span class="params">(<span class="keyword">int</span> data)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>((<span class="keyword">this</span>.left != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.left.data == data) || (<span class="keyword">this</span>.right != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.right.data == data)) &#123; </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="comment">//如果要查找的值小于当前节点值，且当前节点左子节点不为空 </span></span><br><span class="line">        <span class="comment">//递归向左 </span></span><br><span class="line">        <span class="keyword">if</span>(data &lt; <span class="keyword">this</span>.data &amp;&amp; <span class="keyword">this</span>.left != <span class="keyword">null</span>) &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.left.searchParent(data); </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(data &gt;= <span class="keyword">this</span>.data &amp;&amp; <span class="keyword">this</span>.right != <span class="keyword">null</span>) &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.right.searchParent(data); </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-2、删除叶子节点"><a href="#4-2、删除叶子节点" class="headerlink" title="4.2、删除叶子节点"></a>4.2、删除叶子节点</h2><blockquote><p>对于叶子节点，我们需要先找到待删除节点target和待删除节点的父节点parent，然后判断待删除叶子节点是其父节点的左子树还是右子树，如果为左子树，那么令parent.left = null，否则让parent.right = null。</p></blockquote><ul><li>二叉排序树中判断待删除节点是否为叶子节点的静态方法与Node类中判断传入节点为当前左子树/右子树的方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** </span></span><br><span class="line"><span class="comment"> * 判断node节点是否为叶子节点 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> node </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isLeaf</span><span class="params">(Node node)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> node.left == <span class="keyword">null</span> &amp;&amp; node.right == <span class="keyword">null</span>; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/*** </span></span><br><span class="line"><span class="comment"> * 判断传入节点是否为当前节点左子节点的方法 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLeft</span><span class="params">(Node target)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.left != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.left.data == target.data; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/*** </span></span><br><span class="line"><span class="comment"> * 判断传入节点是否为当前节点右子节点的方法 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRight</span><span class="params">(Node target)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.right != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.right.data == target.data; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-3、删除有一棵子树的节点"><a href="#4-3、删除有一棵子树的节点" class="headerlink" title="4.3、删除有一棵子树的节点"></a>4.3、删除有一棵子树的节点</h2><blockquote><p>对于有一棵子树的节点的删除，我们需要找到待删除节点和待删除节点的父节点，然后判断两个条件：1（待删除节点是其父节点的左子树还是右子树）、2（待删除节点有左子树还是右子树）</p><ul><li><p>如果待删除节点有左子树且为其父节点的左子树：此时让待删除节点的父节点的左子树等于待删除节点的左子树，即parent.left = target.left。</p></li><li><p> 如果待删除节点有左子树且为其父节点的右子树：此时根据二叉排序树的性质，待删除节点的左子树的数据要全部大于（等于）其父节点的数据，所以令待删除节点父节点的右子树等于待删除节点的左子树，即parent.right = target.left。</p></li><li><p>如果待删除节点有右子树且为其父节点的左子树：此时让parent.left = target.right</p></li><li><p>如果待删除节点有右子树且为其父节点的右子树，此时让parent.right = target.right</p></li></ul></blockquote><ul><li>Node类中判断传入节点是否为当前节点左/右子树的方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** </span></span><br><span class="line"><span class="comment"> * 判断传入节点是否为当前节点左子节点的方法 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLeft</span><span class="params">(Node target)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.left != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.left.data == target.data; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/*** </span></span><br><span class="line"><span class="comment"> * 判断传入节点是否为当前节点右子节点的方法 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> target </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRight</span><span class="params">(Node target)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.right != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.right.data == target.data; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-4、删除有两棵树的节点"><a href="#4-4、删除有两棵树的节点" class="headerlink" title="4.4、删除有两棵树的节点"></a>4.4、删除有两棵树的节点</h2><blockquote><p>对于有两棵子树的节点的删除：需要先取到待删除节点的右子树的最小节点的值，然后将数值最小的节点删除，最后将前面取到的最小节点的值赋值给待删除节点。</p></blockquote><ul><li>获取待删除节点右子树中最小节点的值并删除最小节点的方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** </span></span><br><span class="line"><span class="comment"> * 1 返回以node为根节点的二叉排序树的最小节点的值 </span></span><br><span class="line"><span class="comment"> * 2 删除以node为根节点的二叉排序树的最小节点 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> node 传入的节点（二叉排序树的根节点） </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回的以Node为根节点的二叉排序树的根节点的值 </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delTreeMin</span><span class="params">(Node node)</span> </span>&#123; </span><br><span class="line">    Node target = node; </span><br><span class="line">    <span class="comment">//循环的查找左节点，就能找到最小值 </span></span><br><span class="line">    <span class="keyword">while</span>(target.left != <span class="keyword">null</span>) &#123; </span><br><span class="line">        target = target.left; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">//此时循环结束后，target指向最小节点 </span></span><br><span class="line">    <span class="comment">//删除最小节点 </span></span><br><span class="line">    delNode(target.data); </span><br><span class="line">    <span class="keyword">return</span> target.data; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>判断当前节点是否有两棵子树的方法</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** </span></span><br><span class="line"><span class="comment"> * 判断传入节点是否有左右子树的方法 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> node </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasTwoSon</span><span class="params">(Node node)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> node.left != <span class="keyword">null</span> &amp;&amp; node.right != <span class="keyword">null</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-5、二叉排序树中根据节点数据删除节点的方法"><a href="#4-5、二叉排序树中根据节点数据删除节点的方法" class="headerlink" title="4.5、二叉排序树中根据节点数据删除节点的方法"></a>4.5、二叉排序树中根据节点数据删除节点的方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** </span></span><br><span class="line"><span class="comment"> * 根据data删除节点 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> data 要删除的节点的data </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delNode</span><span class="params">(<span class="keyword">int</span> data)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(root == <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="keyword">return</span>; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        <span class="comment">//1 先找到要删除的节点target </span></span><br><span class="line">        Node target = search(data); </span><br><span class="line">        <span class="comment">//1.1 如果要删除的节点不存在，直接返回 </span></span><br><span class="line">        <span class="keyword">if</span>(target == <span class="keyword">null</span>) &#123; </span><br><span class="line">            <span class="keyword">return</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">//1.2 如果当前树只有一个节点，且为待删除节点，那么直接置空 </span></span><br><span class="line">        <span class="keyword">if</span>(root.left == <span class="keyword">null</span> &amp;&amp; root.right == <span class="keyword">null</span>) &#123; </span><br><span class="line">            root = <span class="keyword">null</span>; </span><br><span class="line">            <span class="keyword">return</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">//2 去找到target的父节点 </span></span><br><span class="line">        Node parent = searchParent(data); </span><br><span class="line">        <span class="comment">//2.1 如果要删除的节点是叶子节点 </span></span><br><span class="line">        <span class="keyword">if</span>(isLeaf(target)) &#123; </span><br><span class="line">            <span class="comment">//a 判断target是父节点的左子节点还是有子节点 </span></span><br><span class="line">            <span class="keyword">if</span>(parent.isLeft(target)) &#123; </span><br><span class="line">                <span class="comment">//如果是左子节点 </span></span><br><span class="line">                parent.left = <span class="keyword">null</span>; </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(parent.isRight(target)) &#123; </span><br><span class="line">                <span class="comment">//如果是右子节点 </span></span><br><span class="line">                parent.right = <span class="keyword">null</span>; </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(hasTwoSon(target)) &#123; </span><br><span class="line">            <span class="comment">//2.2 如果要删除的节点有左右子树 </span></span><br><span class="line">            <span class="comment">//删除右子树最小节点，同时将最小节点的值取出来 </span></span><br><span class="line">            <span class="keyword">int</span> minData = delTreeMin(target.right); </span><br><span class="line">            target.data = minData; </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="comment">//2.3 删除只有一棵子树的节点 </span></span><br><span class="line">            <span class="comment">//如果待删除节点有左子节点 </span></span><br><span class="line">            <span class="keyword">if</span>(target.left != <span class="keyword">null</span>) &#123; </span><br><span class="line">                <span class="comment">//如果target是parent的左子节点 </span></span><br><span class="line">                <span class="keyword">if</span>(parent.isLeft(target)) &#123; </span><br><span class="line">                    parent.left = target.left; </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                    <span class="comment">//说明target是parent的右子节点 </span></span><br><span class="line">                    parent.right = target.left; </span><br><span class="line">                &#125; </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                <span class="comment">//待删除节点有右子节点 </span></span><br><span class="line">                <span class="comment">//如果target是parent的左节点 </span></span><br><span class="line">                <span class="keyword">if</span>(parent.isLeft(target)) &#123; </span><br><span class="line">                    parent.left = target.right; </span><br><span class="line">                &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                    parent.right = target.right; </span><br><span class="line">                &#125; </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="五、使用递归获取二叉树深度"><a href="#五、使用递归获取二叉树深度" class="headerlink" title="五、使用递归获取二叉树深度"></a>五、使用递归获取二叉树深度</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** </span></span><br><span class="line"><span class="comment"> * 递归获取二叉树深度的方法 </span></span><br><span class="line"><span class="comment"> * 如果根为空：返回0 </span></span><br><span class="line"><span class="comment"> * 否则分别递归深入左右节点，返回深度 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> root 二叉树的根节点 </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 二叉树深度 </span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getTreeDepth</span><span class="params">(Node root)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> root == <span class="keyword">null</span> ? <span class="number">0</span> : (<span class="number">1</span> + Math.max(getTreeDepth(root.left), getTreeDepth(root.right))); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="六、测试"><a href="#六、测试" class="headerlink" title="六、测试"></a>六、测试</h1><h2 id="6-1、测试二叉排序树的生成和插入"><a href="#6-1、测试二叉排序树的生成和插入" class="headerlink" title="6.1、测试二叉排序树的生成和插入"></a>6.1、测试二叉排序树的生成和插入</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Tree tree = <span class="keyword">new</span> Tree(<span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">int</span>[] arr = &#123;<span class="number">7</span>,<span class="number">8</span>,<span class="number">19</span>,-<span class="number">1</span>,<span class="number">26</span>,<span class="number">100</span>,<span class="number">777</span>,-<span class="number">1012</span>,<span class="number">222</span>,<span class="number">18</span>&#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> data = arr[i];</span><br><span class="line">    Node node = <span class="keyword">new</span> Node(data);</span><br><span class="line">    tree.addNode(node);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">&quot;tree:&quot;</span>);</span><br><span class="line">Tree.show(tree.root);</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205232121.png" alt="image-20210205232120723"></p><h2 id="6-2、测试二叉排序树的删除"><a href="#6-2、测试二叉排序树的删除" class="headerlink" title="6.2、测试二叉排序树的删除"></a>6.2、测试二叉排序树的删除</h2><h3 id="1、删除叶子节点"><a href="#1、删除叶子节点" class="headerlink" title="1、删除叶子节点"></a>1、删除叶子节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">&quot;---------------------------------删除叶子节点-1012，删除前：&quot;</span>); </span><br><span class="line">Tree.show(tree.root); </span><br><span class="line">tree.delNode(-<span class="number">1012</span>); </span><br><span class="line">System.out.println(<span class="string">&quot;---------------------------------删除叶子节点-1012，删除后：&quot;</span>); </span><br><span class="line">Tree.show(tree.root);</span><br></pre></td></tr></table></figure><blockquote><p>删除前：</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205232357.png" alt="image-20210205232357649"></p><blockquote><p>删除后：</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205232418.png" alt="image-20210205232417944"></p><h3 id="2、删除有一棵子树的节点"><a href="#2、删除有一棵子树的节点" class="headerlink" title="2、删除有一棵子树的节点"></a>2、删除有一棵子树的节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">&quot;---------------------------------删除有一棵树的节点-1，删除前：&quot;</span>); </span><br><span class="line">Tree.show(tree.root); </span><br><span class="line">tree.delNode(-<span class="number">1</span>); </span><br><span class="line">System.out.println(<span class="string">&quot;---------------------------------删除有一棵树的节点-1，删除后：&quot;</span>); </span><br><span class="line">Tree.show(tree.root);</span><br></pre></td></tr></table></figure><blockquote><p>删除前：</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205232621.png" alt="image-20210205232621385"></p><blockquote><p>删除后：</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205232636.png" alt="image-20210205232635923"></p><h3 id="3、删除有两棵子树的节点"><a href="#3、删除有两棵子树的节点" class="headerlink" title="3、删除有两棵子树的节点"></a>3、删除有两棵子树的节点</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(<span class="string">&quot;---------------------------------删除有两棵子树的节点7，删除前：&quot;</span>); </span><br><span class="line">Tree.show(tree.root); </span><br><span class="line">tree.delNode(<span class="number">7</span>); </span><br><span class="line">System.out.println(<span class="string">&quot;---------------------------------删除有两棵子树的节点7，删除后：&quot;</span>); </span><br><span class="line">Tree.show(tree.root);</span><br></pre></td></tr></table></figure><blockquote><p>删除前：</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205232821.png" alt="image-20210205232820859"></p><blockquote><p>删除后：</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205232835.png" alt="image-20210205232834775"></p>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 🎄树 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis学习手册（三）--配置文件、持久化与存储验证码</title>
      <link href="posts/3873979871.html"/>
      <url>posts/3873979871.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="七、Redis-conf配置文件"><a href="#七、Redis-conf配置文件" class="headerlink" title="七、Redis.conf配置文件"></a>七、Redis.conf配置文件</h1><h2 id="7-1、网络"><a href="#7-1、网络" class="headerlink" title="7.1、网络"></a>7.1、网络</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span>  127.0.0.1  <span class="comment"># 绑定的ip </span></span><br><span class="line">protected-mode  yes  <span class="comment">#  保护模式，默认开启</span></span><br><span class="line">port  6379  <span class="comment">#  端口设置</span></span><br></pre></td></tr></table></figure><h2 id="7-2、快照"><a href="#7-2、快照" class="headerlink" title="7.2、快照"></a>7.2、快照</h2><h3 id="1、持久化"><a href="#1、持久化" class="headerlink" title="1、持久化"></a>1、持久化</h3><blockquote><p>在规定时间内执行了多少操作，就会持久到文件（.rdb、.aof）</p><p><strong>由于redis是内存数据库，如果没有持久化，那么数据断电即失</strong></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果900s内至少有一个key进行了修改，我们就进行持久化操作</span></span><br><span class="line">save 900 1</span><br><span class="line"><span class="comment"># 如果300s内至少有10个key进行了修改，我们就进行持久化操作</span></span><br><span class="line">save 300 10</span><br><span class="line"><span class="comment"># 如果60s内至少有一万个key进行了修改，我们就进行持久化操作</span></span><br><span class="line">save 60 10000</span><br><span class="line"><span class="comment"># 之后我们可以设置自己的</span></span><br></pre></td></tr></table></figure><h3 id="2、限制Clients"><a href="#2、限制Clients" class="headerlink" title="2、限制Clients"></a>2、限制Clients</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">maxclients   10000  <span class="comment"># 最多有10000个客户端能连接上此redis</span></span><br><span class="line"></span><br><span class="line">maxmemory    &lt;bytes&gt;  <span class="comment"># redis设置最大内存容量</span></span><br></pre></td></tr></table></figure><h3 id="3、内存达到上限的处理策略"><a href="#3、内存达到上限的处理策略" class="headerlink" title="3、内存达到上限的处理策略"></a>3、内存达到上限的处理策略</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maxmemory-policy   noeviction   <span class="comment"># 内存到达上限后的处理策略，默认不删除数据，直接报错</span></span><br></pre></td></tr></table></figure><blockquote><p>有六种策略：</p><p>1   volatile-lru:从已设置过期时间的内存数据集中挑选最近最少使用的数据 淘汰；</p><p>2    volatile-ttl: 从已设置过期时间的内存数据集中挑选即将过期的数据 淘汰；</p><p>3    volatile-random:从已设置过期时间的内存数据集中任意挑选数据 淘汰；</p><p>4    allkeys-lru:从内存数据集中挑选最近最少使用的数据 淘汰；</p><p>5     allkeys-random:从数据集中任意挑选数据 淘汰；</p><p>6     noenviction(驱逐)：禁止驱逐数据。</p></blockquote><h1 id="八、持久化"><a href="#八、持久化" class="headerlink" title="八、持久化"></a>八、持久化</h1><blockquote><p>Redis是一个内存数据库，如果不对Redis数据进行持久化操作，那么一旦服务器进程退出，服务器中的数据库状态也会消失。</p><p>Redis的持久化可分为RDB（Redis DataBase）和AOF（Append Only File）</p></blockquote><h2 id="8-1、RDB"><a href="#8-1、RDB" class="headerlink" title="8.1、RDB"></a>8.1、RDB</h2><h3 id="1、什么是RDB"><a href="#1、什么是RDB" class="headerlink" title="1、什么是RDB"></a>1、什么是RDB</h3><blockquote><p>在指定时间间隔将内存集的数据集快照写入磁盘，恢复时将快照文件直接读入内存。在进行写入的过程中，Redis会<strong>单独创建</strong>一个<strong>子进程</strong>，会先将数据写入一个临时文件中，待持久化过程结束后，再将这个临时文件替换上次持久化好的文件。整个过程中，<strong>主线程不进行任何IO操作</strong>，确保了极高的性能。</p><p>如果要进行大规模的数据恢复，且对于数据恢复完整性并不是特别敏感，则RDB方式要比AOF方式更加高效，Rdb的<strong>缺点</strong>是<strong>最后一次持久化后的数据可能丢失</strong>，Redis<strong>默认使用RDB进行持久化操作</strong>。</p></blockquote><h3 id="2、RDB保存的文件是dump-rdb"><a href="#2、RDB保存的文件是dump-rdb" class="headerlink" title="2、RDB保存的文件是dump.rdb"></a>2、RDB保存的文件是dump.rdb</h3><h3 id="3、优点："><a href="#3、优点：" class="headerlink" title="3、优点："></a>3、优点：</h3><ul><li>适合大规模数据恢复</li><li>对数据完整性要求不高</li></ul><h3 id="4、缺点："><a href="#4、缺点：" class="headerlink" title="4、缺点："></a>4、缺点：</h3><ul><li>需要一定的时间间隔进程操作，如果redis意外宕机，最后一次修改数据会消失</li><li>fork进程时会占用一定空间</li></ul><h3 id="5、触发机制"><a href="#5、触发机制" class="headerlink" title="5、触发机制"></a>5、触发机制</h3><ul><li>save的规则满足的条件下，会自动触发RDB规则</li><li>执行flashall命令，会触发RDB规则</li><li>退出redis，也会产生rdb文件</li><li>备份生成一个dump.rdb文件</li></ul><h3 id="6、如何恢复rdb文件"><a href="#6、如何恢复rdb文件" class="headerlink" title="6、如何恢复rdb文件"></a>6、如何恢复rdb文件</h3><blockquote><p>只需要将rdb文件放在redis启动目录下即可，redis启动时会检查并恢复dump.rdb中的数据</p></blockquote><h2 id="8-2、AOF"><a href="#8-2、AOF" class="headerlink" title="8.2、AOF"></a>8.2、AOF</h2><h3 id="1、什么是AOF"><a href="#1、什么是AOF" class="headerlink" title="1、什么是AOF?"></a>1、什么是AOF?</h3><blockquote><p>以日志的形式来记录每个写操作，将Redis执行过的所有指令<strong>（读操作不记录）</strong>记录下来，只许追加文件但不可以改写文件，redis启动之初会读取文件重新构建数据，换言之，redis重启的话就要根据日志文件的内容将写指令<strong>从头到尾</strong>执行一次以<strong>完成数据的恢复工作</strong></p></blockquote><h3 id="2、使用"><a href="#2、使用" class="headerlink" title="2、使用"></a>2、使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">appendonly yes</span><br></pre></td></tr></table></figure><h1 id="九、Redis实现手机验证码"><a href="#九、Redis实现手机验证码" class="headerlink" title="九、Redis实现手机验证码"></a>九、Redis实现手机验证码</h1><h2 id="9-1、实现原理"><a href="#9-1、实现原理" class="headerlink" title="9.1、实现原理"></a>9.1、实现原理</h2><ul><li>使用工具类生成4位或6位的数字验证码</li><li>校验手机号为合法后通过短信微服务发送验证码</li><li>将手机号作为key，验证码作为value存入redis中，并设置一个过期时间</li><li>用户进行登录/注册时通过key（手机号）到redis中取出验证码</li><li>进行验证码比对，若匹配则登录/注册通过，随机删除redis中的key-value</li></ul><h2 id="9-2、实现"><a href="#9-2、实现" class="headerlink" title="9.2、实现"></a>9.2、实现</h2><h3 id="1、校验手机号是否合法的工具类"><a href="#1、校验手机号是否合法的工具类" class="headerlink" title="1、校验手机号是否合法的工具类"></a>1、校验手机号是否合法的工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FormUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Pattern NUMBER_PATTERN = Pattern.compile(<span class="string">&quot;^[1][3,4,5,7,8,9][0-9]&#123;9&#125;$&quot;</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 手机号验证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMobile</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//验证手机号的正则表达式</span></span><br><span class="line">        <span class="keyword">return</span> NUMBER_PATTERN.matcher(str).matches();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、生成验证码的工具类"><a href="#2、生成验证码的工具类" class="headerlink" title="2、生成验证码的工具类"></a>2、生成验证码的工具类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DecimalFormat fourdf = <span class="keyword">new</span> DecimalFormat(<span class="string">&quot;0000&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DecimalFormat sixdf = <span class="keyword">new</span> DecimalFormat(<span class="string">&quot;000000&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getFourBitRandom</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> fourdf.format(random.nextInt(<span class="number">10000</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getSixBitRandom</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> sixdf.format(random.nextInt(<span class="number">1000000</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 给定数组，抽取n个数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> list</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> n</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ArrayList <span class="title">getRandom</span><span class="params">(List list, <span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 生成随机数字并存入HashMap</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; list.size(); i++) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> number = random.nextInt(<span class="number">100</span>) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">hashMap.put(number, i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从HashMap导入数组</span></span><br><span class="line">Object[] robjs = hashMap.values().toArray();</span><br><span class="line"></span><br><span class="line">ArrayList r = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历数组并打印数据</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">r.add(list.get((<span class="keyword">int</span>) robjs[i]));</span><br><span class="line">System.out.print(list.get((<span class="keyword">int</span>) robjs[i]) + <span class="string">&quot;\t&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">System.out.print(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、短信微服务Controller"><a href="#3、短信微服务Controller" class="headerlink" title="3、短信微服务Controller"></a>3、短信微服务Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;短信管理控制器&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/sms&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiSmsController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SmsService smsService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 根据传入的手机号来生成并发送验证码</span></span><br><span class="line"><span class="comment">     * 并将验证码存入redis缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mobile 手机号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;send/&#123;mobile&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;一个用于生成验证码，并将验证码存入redis中的接口&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">getCode</span><span class="params">(<span class="meta">@PathVariable(&quot;mobile&quot;)</span> String mobile)</span> <span class="keyword">throws</span> ClientException </span>&#123;</span><br><span class="line">        <span class="comment">//0 校验手机号是否合法</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(mobile) || !FormUtils.isMobile(mobile)) &#123;</span><br><span class="line">            <span class="comment">//如果手机号为空或手机号不合法</span></span><br><span class="line">            log.error(<span class="string">&quot;手机号不合法！&quot;</span>);</span><br><span class="line">            <span class="comment">// new GrainException(ResultCodeEnum.LOGIN_MOBILE_ERROR);</span></span><br><span class="line">            <span class="keyword">return</span> R.error().message(<span class="string">&quot;手机号不正确！&quot;</span>).code(<span class="number">28001</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//1 使用工具类生成生成验证码</span></span><br><span class="line">        String checkCode = RandomUtils.getSixBitRandom();</span><br><span class="line">        <span class="comment">//2 发送验证码</span></span><br><span class="line">        smsService.send(mobile,checkCode);</span><br><span class="line">        <span class="comment">//3 存储验证码到redis</span></span><br><span class="line">        <span class="comment">//使用redisTemplate，使用手机号作为键，保存时长为5分钟</span></span><br><span class="line">        redisTemplate.opsForValue().set(mobile,checkCode,<span class="number">5</span>, TimeUnit.MINUTES);</span><br><span class="line">        <span class="keyword">return</span> R.ok().message(<span class="string">&quot;短信发送成功！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4、短信微服务Service层"><a href="#4、短信微服务Service层" class="headerlink" title="4、短信微服务Service层"></a>4、短信微服务Service层</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsServiceImpl</span> <span class="keyword">implements</span> <span class="title">SmsService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SmsProperties smsProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String mobile, String checkCode)</span> <span class="keyword">throws</span> ClientException, ClientException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用短信发送SDK，创建client对象</span></span><br><span class="line">        DefaultProfile profile = DefaultProfile.getProfile(</span><br><span class="line">                smsProperties.getRegionId(),</span><br><span class="line">                smsProperties.getKeyId(),</span><br><span class="line">                smsProperties.getKeySecret());</span><br><span class="line">        IAcsClient client = <span class="keyword">new</span> DefaultAcsClient(profile);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//组装请求参数</span></span><br><span class="line">        CommonRequest request = <span class="keyword">new</span> CommonRequest();</span><br><span class="line">        request.setSysMethod(MethodType.POST);</span><br><span class="line">        request.setSysDomain(<span class="string">&quot;dysmsapi.aliyuncs.com&quot;</span>);</span><br><span class="line">        request.setSysVersion(<span class="string">&quot;2017-05-25&quot;</span>);</span><br><span class="line">        request.setSysAction(<span class="string">&quot;SendSms&quot;</span>);</span><br><span class="line">        request.putQueryParameter(<span class="string">&quot;RegionId&quot;</span>, smsProperties.getRegionId());</span><br><span class="line">        request.putQueryParameter(<span class="string">&quot;PhoneNumbers&quot;</span>, mobile);</span><br><span class="line">        request.putQueryParameter(<span class="string">&quot;SignName&quot;</span>, smsProperties.getSignName());</span><br><span class="line">        request.putQueryParameter(<span class="string">&quot;TemplateCode&quot;</span>, smsProperties.getTemplateCode());</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; param = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        param.put(<span class="string">&quot;code&quot;</span>, checkCode);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将包含验证码的集合转换为json字符串</span></span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        request.putQueryParameter(<span class="string">&quot;TemplateParam&quot;</span>, gson.toJson(param));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//发送短信</span></span><br><span class="line">        CommonResponse response = client.getCommonResponse(request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//得到json字符串格式的响应结果</span></span><br><span class="line">        String data = response.getData();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//解析json字符串格式的响应结果</span></span><br><span class="line">        HashMap&lt;String, String&gt; map = gson.fromJson(data, HashMap.class);</span><br><span class="line">        String code = map.get(<span class="string">&quot;Code&quot;</span>);</span><br><span class="line">        String message = map.get(<span class="string">&quot;Message&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置参考：短信服务-&gt;系统设置-&gt;国内消息设置</span></span><br><span class="line">        <span class="comment">//错误码参考：</span></span><br><span class="line">        <span class="comment">//https://help.aliyun.com/document_detail/101346.html?spm=a2c4g.11186623.6.613.3f6e2246sDg6Ry</span></span><br><span class="line">        <span class="comment">//控制所有短信流向限制（同一手机号：一分钟一条、一个小时五条、一天十条）</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;isv.BUSINESS_LIMIT_CONTROL&quot;</span>.equals(code)) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;短信发送过于频繁 &quot;</span> + <span class="string">&quot;【code】&quot;</span> + code + <span class="string">&quot;, 【message】&quot;</span> + message);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GrainException(ResultCodeEnum.SMS_SEND_ERROR_BUSINESS_LIMIT_CONTROL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">&quot;OK&quot;</span>.equals(code)) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;短信发送失败 &quot;</span> + <span class="string">&quot; - code: &quot;</span> + code + <span class="string">&quot;, message: &quot;</span> + message);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GrainException(ResultCodeEnum.SMS_SEND_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5、用户注册微服务Controller"><a href="#5、用户注册微服务Controller" class="headerlink" title="5、用户注册微服务Controller"></a>5、用户注册微服务Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;会员管理控制器&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/api/ucenter/member&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApiMemberController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberService memberService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;会员注册&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;register&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">register</span><span class="params">(<span class="meta">@RequestBody</span> RegisterVo registerVo)</span> </span>&#123;</span><br><span class="line">        memberService.register(registerVo);</span><br><span class="line">        <span class="keyword">return</span> R.ok().message(<span class="string">&quot;注册成功！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6、用户注册微服务Service"><a href="#6、用户注册微服务Service" class="headerlink" title="6、用户注册微服务Service"></a>6、用户注册微服务Service</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemberServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">MemberMapper</span>, <span class="title">Member</span>&gt; <span class="keyword">implements</span> <span class="title">MemberService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MemberMapper memberMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(RegisterVo registerVo)</span> </span>&#123;</span><br><span class="line">        String nickname = registerVo.getNickname();</span><br><span class="line">        String mobile = registerVo.getMobile();</span><br><span class="line">        String code = registerVo.getCode();</span><br><span class="line">        String password = registerVo.getPassword();</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(mobile) || !FormUtils.isMobile(mobile)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GrainException(ResultCodeEnum.LOGIN_MOBILE_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isBlank(nickname) || StringUtils.isBlank(password) || StringUtils.isBlank(code)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GrainException(ResultCodeEnum.PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//校验验证码</span></span><br><span class="line">        String checkCode = (String)redisTemplate.opsForValue().get(mobile);</span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.equals(code,checkCode)) &#123;</span><br><span class="line">            <span class="comment">//如果用户输入验证码和redis中验证码不相等</span></span><br><span class="line">            <span class="comment">//校验失败</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GrainException(ResultCodeEnum.CODE_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断用户手机号是否注册</span></span><br><span class="line">        QueryWrapper&lt;Member&gt; memberQueryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        memberQueryWrapper.eq(<span class="string">&quot;mobile&quot;</span>,mobile);</span><br><span class="line">        Integer result = memberMapper.selectCount(memberQueryWrapper);</span><br><span class="line">        <span class="keyword">if</span>(result &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> GrainException(ResultCodeEnum.REGISTER_MOBLE_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注册</span></span><br><span class="line">        Member member = <span class="keyword">new</span> Member();</span><br><span class="line">        member.setNickname(nickname);</span><br><span class="line">        member.setMobile(mobile);</span><br><span class="line">        <span class="comment">//密码需要加密</span></span><br><span class="line">        member.setPassword(MD5.encrypt(password));</span><br><span class="line">        member.setAvatar(<span class="string">&quot;http://tiebapic.baidu.com/forum/w%3D580/sign=21e19fd45010b912bfc1f6f6f3fcfcb5/c0d5d04b20a44623e5077d0d8f22720e0ef3d78e.jpg&quot;</span>);</span><br><span class="line">        member.setDisabled(<span class="keyword">false</span>);</span><br><span class="line">        memberMapper.insert(member);</span><br><span class="line">        <span class="comment">//将redis缓存中的验证码删除</span></span><br><span class="line">        redisTemplate.delete(mobile);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="9-3、测试"><a href="#9-3、测试" class="headerlink" title="9.3、测试"></a>9.3、测试</h2><blockquote><p>启动短信微服务和用户注册微服务，使用Swagger进行测试</p></blockquote><h3 id="1、使用短信微服务向指定手机号发送验证码"><a href="#1、使用短信微服务向指定手机号发送验证码" class="headerlink" title="1、使用短信微服务向指定手机号发送验证码"></a>1、使用短信微服务向指定手机号发送验证码</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204000422.png" alt="image-20210204000422442"></p><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204000623.png" alt="image-20210204000623694"></p><h3 id="2、查看Redis缓存和短信"><a href="#2、查看Redis缓存和短信" class="headerlink" title="2、查看Redis缓存和短信"></a>2、查看Redis缓存和短信</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204000652.png" alt="image-20210204000652056"></p><blockquote><p>短信</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204001029.png" alt="image-20210204001029230"></p><h3 id="3、打开用户中心微服务进行测试"><a href="#3、打开用户中心微服务进行测试" class="headerlink" title="3、打开用户中心微服务进行测试"></a>3、打开用户中心微服务进行测试</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204000749.png" alt="image-20210204000749533"></p><h3 id="4、结果"><a href="#4、结果" class="headerlink" title="4、结果"></a>4、结果</h3><blockquote><p>swagger提示注册成功</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204000814.png" alt="image-20210204000813999"></p><blockquote><p>redis缓存中该键值对被删除</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204000908.png" alt="image-20210204000908928"></p><blockquote><p>数据库</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204000944.png" alt="image-20210204000944206"></p>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis学习手册（二）--事务、Jedis和Spring Boot整合Redis</title>
      <link href="posts/2589988718.html"/>
      <url>posts/2589988718.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="四、事务"><a href="#四、事务" class="headerlink" title="四、事务"></a>四、事务</h1><h2 id="4-1、介绍"><a href="#4-1、介绍" class="headerlink" title="4.1、介绍"></a>4.1、介绍</h2><blockquote><p>Redis事务是一个单独的隔离过程：事务中的所有命令都会被序列化、按顺序地执行。事务在执行过程中不会被其他客户端发送来的命令请求所打断，redis事务的主要作用就是串联多个命令防止别的命令插队。</p></blockquote><h2 id="4-2、Redis事务的特性"><a href="#4-2、Redis事务的特性" class="headerlink" title="4.2、Redis事务的特性"></a>4.2、Redis事务的特性</h2><blockquote><p>单独的隔离操作：</p><ul><li>事务中的所有命令都会被序列化、按顺序地执行。事务在执行过程中不会被其他客户端发送来的命令请求所打断</li></ul></blockquote><blockquote><p>没有隔离级别的概念</p><ul><li>队列中的命令没有提交之前都不会实际的被执行。</li></ul></blockquote><blockquote><p>不保证原子性</p><ul><li>Redis同一个事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚</li></ul></blockquote><h2 id="4-3、使用"><a href="#4-3、使用" class="headerlink" title="4.3、使用"></a>4.3、使用</h2><ul><li>开启事务（multi）</li><li>命令入队</li><li>执行事务（exec）</li></ul><blockquote><p>正常执行事务</p></blockquote><ul><li>使用redis事务</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi    <span class="comment"># 开启事务</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k1 v1   <span class="comment"># QUEUED代表命令入队列</span></span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k3 v3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k4 1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incr k4</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exec</span>       <span class="comment"># exec代表执行事务</span></span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">3) <span class="string">&quot;v1&quot;</span></span><br><span class="line">4) OK</span><br><span class="line">5) OK</span><br><span class="line">6) (<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure><blockquote><p>放弃事务（discard）</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k2 v2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k3 1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incrby k3 50</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; decrby k3 26</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; DISCARD</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get k3</span><br><span class="line">(nil)         <span class="comment">#放弃事务后发现k3值为null</span></span><br></pre></td></tr></table></figure><blockquote><p>（报告错误）编译型异常（代码/命令有问题），<strong>事务中所有命令都不会被执行</strong></p></blockquote><blockquote><p>（执行错误）运行时异常（例如：1/0或空指针），如果事务队列中存在运行时异常，那么这条发生异常的命令不会被执行，其他命令继续执行（redis事务没有一致性），错误命令抛出异常</p></blockquote><blockquote><p>原子性：指事务的不可分割性，一个事务的所有操作要么不间断地全部被执行，要么一个也没有执行。</p></blockquote><h2 id="4-4、注意点"><a href="#4-4、注意点" class="headerlink" title="4.4、注意点"></a>4.4、注意点</h2><blockquote><p><strong>Redis单条命令是保证原子性的，但是Redis的事务是不保证原子性的！</strong></p></blockquote><h2 id="4-5、监控"><a href="#4-5、监控" class="headerlink" title="4.5、监控"></a>4.5、监控</h2><h3 id="1、悲观锁"><a href="#1、悲观锁" class="headerlink" title="1、悲观锁"></a>1、悲观锁</h3><ul><li>无论做什么都加锁（会影响性能）</li></ul><h3 id="2、乐观锁"><a href="#2、乐观锁" class="headerlink" title="2、乐观锁"></a>2、乐观锁</h3><ul><li>认为什么时候都不会出问题，所以不会上锁！更新数据时去判断以下期间有没有人修改过此数据。</li><li>mysql中：获取version，比较version</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210203224610.png" alt="image-20210203224610835"></p><h3 id="3、使用watch来监控"><a href="#3、使用watch来监控" class="headerlink" title="3、使用watch来监控"></a>3、使用watch来监控</h3><blockquote><p>在执行multi之前，先执行watch key1 [key2]，可以监视一个或多个key，如果在事务执行之前这个（或这些）key被其他命令所改动，那么事务将被<strong>打断</strong></p></blockquote><ul><li>正常执行成功</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> money 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> out 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; watch money       <span class="comment">#使用watch监视money对象</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; decrby money 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incrby out 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exec</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 80</span><br><span class="line">2) (<span class="built_in">integer</span>) 20</span><br></pre></td></tr></table></figure><h1 id="五、Jedis"><a href="#五、Jedis" class="headerlink" title="五、Jedis"></a>五、Jedis</h1><blockquote><p>JRedis是Redis官方推荐的java连接开发工具，使用java操作redis的中间件，类似JDBCDriver</p></blockquote><h2 id="5-1、常用API"><a href="#5-1、常用API" class="headerlink" title="5.1、常用API"></a>5.1、常用API</h2><h3 id="1、导入依赖"><a href="#1、导入依赖" class="headerlink" title="1、导入依赖"></a>1、导入依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 导入Jedis的包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.62<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2、编码测试"><a href="#2、编码测试" class="headerlink" title="2、编码测试"></a>2、编码测试</h3><blockquote><p>使用Jedis连接Redis</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestPing</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//1 new 一个Jedis对象，构造参数填入地址和端口号</span></span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        <span class="comment">//jedis 的函数就是我们之前学习的所有命令</span></span><br><span class="line">        System.out.println(jedis.ping());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210203225023.png" alt="image-20210203225023793"></p><h3 id="3、操作命令"><a href="#3、操作命令" class="headerlink" title="3、操作命令"></a>3、操作命令</h3><blockquote><p>Jedis的方法和上面的命令几乎一样，这里列出Redis-key的</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;清空指定数据库中的数据：&quot;</span> + jedis.flushDB());</span><br><span class="line">System.out.println(<span class="string">&quot;清空所有数据：&quot;</span> + jedis.flushAll());</span><br><span class="line">System.out.println(<span class="string">&quot;新增&lt;&#x27;username&#x27;,&#x27;wuhu&#x27;&gt;的键值对：&quot;</span> + jedis.set(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;wuhu&quot;</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;新增&lt;&#x27;password&#x27;,&#x27;qifei&#x27;&gt;的键值对：&quot;</span> + jedis.set(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;qifei&quot;</span>));</span><br><span class="line">System.out.print(<span class="string">&quot;系统中所有的键如下：&quot;</span>);</span><br><span class="line">Set&lt;String&gt; keys = jedis.keys(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">System.out.println(keys);</span><br><span class="line">System.out.println(<span class="string">&quot;删除键password：&quot;</span> + jedis.del(<span class="string">&quot;password&quot;</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;判断键password是否存在：&quot;</span> + jedis.exists(<span class="string">&quot;password&quot;</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;查看键username所存储的值的类型&quot;</span> + jedis.type(<span class="string">&quot;username&quot;</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;随机返回key空间的一个&quot;</span> + jedis.randomKey());</span><br><span class="line">System.out.println(<span class="string">&quot;重命名key：&quot;</span> + jedis.rename(<span class="string">&quot;username&quot;</span>,<span class="string">&quot;userName&quot;</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;取出改后的userName：&quot;</span> + jedis.get(<span class="string">&quot;userName&quot;</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;按索引查询：&quot;</span> + jedis.select(<span class="number">0</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;返回当前数据库中key的数量：&quot;</span> + jedis.dbSize());</span><br><span class="line">System.out.println(<span class="string">&quot;删除当前选择数据库中所有的key：&quot;</span> + jedis.flushDB());</span><br><span class="line">System.out.println(<span class="string">&quot;返回当前数据库中key的数量：&quot;</span> + jedis.dbSize());</span><br><span class="line">System.out.println(<span class="string">&quot;删除所有数据库中那个所有key：&quot;</span> + jedis.flushAll());</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210203225132.png" alt="image-20210203225132042"></p><blockquote><p>断开连接</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jedis.close();</span><br></pre></td></tr></table></figure><h2 id="5-2、使用Jedis模拟Redis中的事务"><a href="#5-2、使用Jedis模拟Redis中的事务" class="headerlink" title="5.2、使用Jedis模拟Redis中的事务"></a>5.2、使用Jedis模拟Redis中的事务</h2><h3 id="1、模拟事务成功执行"><a href="#1、模拟事务成功执行" class="headerlink" title="1、模拟事务成功执行"></a>1、模拟事务成功执行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">jsonObject.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;wuhu&quot;</span>);</span><br><span class="line">jsonObject.put(<span class="string">&quot;age&quot;</span>,<span class="number">18</span>);</span><br><span class="line">String jsonStr = jsonObject.toJSONString();</span><br><span class="line"><span class="comment">//开启事务</span></span><br><span class="line">Transaction multi = jedis.multi();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//将方法放入执行队列</span></span><br><span class="line">    multi.set(<span class="string">&quot;user1&quot;</span>,jsonStr);</span><br><span class="line">    multi.set(<span class="string">&quot;user2&quot;</span>,jsonStr);</span><br><span class="line">    multi.set(<span class="string">&quot;user3&quot;</span>,jsonStr);</span><br><span class="line">    multi.set(<span class="string">&quot;user4&quot;</span>,jsonStr);</span><br><span class="line">    <span class="comment">//执行事务</span></span><br><span class="line">    multi.exec();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="comment">//如果出现异常，就放弃事务</span></span><br><span class="line">    multi.discard();</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">//如果没有异常，那么可以输出值</span></span><br><span class="line">    System.out.println(jedis.get(<span class="string">&quot;user1&quot;</span>));</span><br><span class="line">    System.out.println(jedis.get(<span class="string">&quot;user2&quot;</span>));</span><br><span class="line">    System.out.println(jedis.get(<span class="string">&quot;user3&quot;</span>));</span><br><span class="line">    System.out.println(jedis.get(<span class="string">&quot;user4&quot;</span>));</span><br><span class="line">    jedis.close();<span class="comment">//关闭连接</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210203225306.png" alt="image-20210203225306161"></p><h3 id="2、模拟事务出现异常的情况"><a href="#2、模拟事务出现异常的情况" class="headerlink" title="2、模拟事务出现异常的情况"></a>2、模拟事务出现异常的情况</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">jedis.flushAll();<span class="comment">//先清除所有键值对</span></span><br><span class="line">JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">jsonObject.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;wuhu&quot;</span>);</span><br><span class="line">jsonObject.put(<span class="string">&quot;age&quot;</span>,<span class="number">18</span>);</span><br><span class="line">String jsonStr = jsonObject.toJSONString();</span><br><span class="line"><span class="comment">//开启事务</span></span><br><span class="line">Transaction multi = jedis.multi();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//将方法放入执行队列</span></span><br><span class="line">    multi.set(<span class="string">&quot;user1&quot;</span>,jsonStr);</span><br><span class="line">    multi.set(<span class="string">&quot;user2&quot;</span>,jsonStr);</span><br><span class="line">    multi.set(<span class="string">&quot;user3&quot;</span>,jsonStr);</span><br><span class="line">    multi.set(<span class="string">&quot;user4&quot;</span>,jsonStr);</span><br><span class="line">    <span class="comment">//模拟异常</span></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//执行事务</span></span><br><span class="line">    multi.exec();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="comment">//如果出现异常，就放弃事务</span></span><br><span class="line">    multi.discard();</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">//如果没有异常，那么可以输出值</span></span><br><span class="line">    System.out.println(jedis.get(<span class="string">&quot;user1&quot;</span>));</span><br><span class="line">    System.out.println(jedis.get(<span class="string">&quot;user2&quot;</span>));</span><br><span class="line">    System.out.println(jedis.get(<span class="string">&quot;user3&quot;</span>));</span><br><span class="line">    System.out.println(jedis.get(<span class="string">&quot;user4&quot;</span>));</span><br><span class="line">    jedis.close();<span class="comment">//关闭连接</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210203225346.png" alt="image-20210203225346130"></p><h1 id="六、Spring-Boot整合Redis"><a href="#六、Spring-Boot整合Redis" class="headerlink" title="六、Spring Boot整合Redis"></a>六、Spring Boot整合Redis</h1><blockquote><p>Spring Boot Data redis提供了<strong>RedisTemplate</strong>和<strong>StringTemplate</strong>，其中StringTemplate是RedisTemplate的子类，RedisTemplate中两个泛型都是Object，意味着存储的key和value都可以是一个对象，而StringTemplate两个泛型都是String</p><p><strong>注：对象的保存需要序列化</strong></p></blockquote><h2 id="6-1、引入依赖"><a href="#6-1、引入依赖" class="headerlink" title="6.1、引入依赖"></a>6.1、引入依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 操作redis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>在springboot2.x后，原来的jedis被替换为了lecture</li><li>jedis：采用直连，多线程操作不安全，需要使用连接池，BIO</li><li>lecture：底层使用netty，不存在性能不安全的情况,NIO</li></ul><h2 id="6-2、配置"><a href="#6-2、配置" class="headerlink" title="6.2、配置"></a>6.2、配置</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure><h2 id="6-3、测试"><a href="#6-3、测试" class="headerlink" title="6.3、测试"></a>6.3、测试</h2><blockquote><p>分析源码可知，Spring Boot已经为我们注册了一个<strong>key和value均为Object</strong>的RedisTemplate，我们可以自己注册一个<strong>RedisTemplate</strong>来替换Spring Boot为我们自动注入的RedisTemplate</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210203225717.png" alt="image-20210203225717224"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//redisTemplate</span></span><br><span class="line">    <span class="comment">//opsForValue 操作字符串，类似String</span></span><br><span class="line">    <span class="comment">//opsForList  操作list，类似List</span></span><br><span class="line">    <span class="comment">//opsForSet   操作Set，类似Set</span></span><br><span class="line">    <span class="comment">//opsForZset  操作Zset，类似Zset</span></span><br><span class="line">    <span class="comment">//opsForHash  操作Hash，类似Hash</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//基本操作已经封装到redisTemplate中</span></span><br><span class="line">    <span class="comment">//        RedisConnection connection = redisTemplate.getConnectionFactory().getConnection();</span></span><br><span class="line">    <span class="comment">//        connection.flushAll();</span></span><br><span class="line">    <span class="comment">//        connection.flushDb();</span></span><br><span class="line"></span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;key&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Spring Boot 默认使用JDK序列化，JDK序列化会使字符转义，我们可以自定义配置类，使用JSON进行序列化。</p></blockquote><h2 id="6-4、自定义RedisTemplate"><a href="#6-4、自定义RedisTemplate" class="headerlink" title="6.4、自定义RedisTemplate"></a>6.4、自定义RedisTemplate</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.JsonAutoDetect;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.annotation.PropertyAccessor;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;all&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;String, Object&gt;();</span><br><span class="line">        template.setConnectionFactory(factory);</span><br><span class="line">        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</span><br><span class="line">        ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line">        StringRedisSerializer stringRedisSerializer = <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// key采用String的序列化方式</span></span><br><span class="line">        template.setKeySerializer(stringRedisSerializer);</span><br><span class="line">        <span class="comment">// hash的key也采用String的序列化方式</span></span><br><span class="line">        template.setHashKeySerializer(stringRedisSerializer);</span><br><span class="line">        <span class="comment">// value序列化方式采用jackson</span></span><br><span class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        <span class="comment">// hash的value序列化方式采用jackson</span></span><br><span class="line">        template.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        template.afterPropertiesSet();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在自定义的RedisTemplate中，将键从Object换为String，同时使用JSON序列化对象。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       User user = <span class="keyword">new</span> User(<span class="number">1</span>,<span class="string">&quot;芜湖&quot;</span>,<span class="string">&quot;起飞&quot;</span>);</span><br><span class="line">       String userJson = JSON.toJSONString(user);</span><br><span class="line">       redisTemplate.opsForValue().set(<span class="string">&quot;user2&quot;</span>,userJson);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h3 id="1、使用JDK序列化对象"><a href="#1、使用JDK序列化对象" class="headerlink" title="1、使用JDK序列化对象"></a>1、使用JDK序列化对象</h3><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210203231614.png" alt="image-20210203231614676"></p><h3 id="2、使用JSON序列化对象"><a href="#2、使用JSON序列化对象" class="headerlink" title="2、使用JSON序列化对象"></a>2、使用JSON序列化对象</h3><blockquote><p>删除Redis中的键值对，引入我们自定义的RedisTemplate，重新执行上面的方法。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210203231754.png" alt="image-20210203231753977"></p><h2 id="6-5、RedisUtils"><a href="#6-5、RedisUtils" class="headerlink" title="6.5、RedisUtils"></a>6.5、RedisUtils</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hzx.springboot_redis.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// =============================common============================</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定缓存失效时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 时间(秒)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">expire</span><span class="params">(String key, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                redisTemplate.expire(key, time, TimeUnit.SECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据key 获取过期时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 时间(秒) 返回0代表为永久有效</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getExpire</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.getExpire(key, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断key是否存在</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 存在 false不存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasKey</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.hasKey(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 可以传一个值 或多个</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(String... key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key != <span class="keyword">null</span> &amp;&amp; key.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (key.length == <span class="number">1</span>) &#123;</span><br><span class="line">                redisTemplate.delete(key[<span class="number">0</span>]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                redisTemplate.delete(CollectionUtils.arrayToList(key));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================String=============================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通缓存获取</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key == <span class="keyword">null</span> ? <span class="keyword">null</span> : redisTemplate.opsForValue().get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通缓存放入</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true成功 false失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">set</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForValue().set(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 普通缓存放入并设置时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  时间(秒) time要大于0 如果time小于等于0 将设置无限期</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true成功 false 失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">set</span><span class="params">(String key, Object value, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                redisTemplate.opsForValue().set(key, value, time, TimeUnit.SECONDS);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                set(key, value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 递增</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta 要增加几(大于0)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">incr</span><span class="params">(String key, <span class="keyword">long</span> delta)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (delta &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;递增因子必须大于0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().increment(key, delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 递减</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> delta 要减少几(小于0)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">decr</span><span class="params">(String key, <span class="keyword">long</span> delta)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (delta &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;递减因子必须大于0&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForValue().increment(key, -delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================================Map=================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HashGet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项 不能为null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">hget</span><span class="params">(String key, String item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().get(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取hashKey对应的所有键值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 对应的多个键值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Object, Object&gt; <span class="title">hmget</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().entries(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HashSet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map 对应多个键值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hmset</span><span class="params">(String key, Map&lt;String, Object&gt; map)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().putAll(key, map);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * HashSet 并设置时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map  对应多个键值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 时间(秒)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true成功 false失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hmset</span><span class="params">(String key, Map&lt;String, Object&gt; map, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().putAll(key, map);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                expire(key, time);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向一张hash表中放入数据,如果不存在将创建</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item  项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功 false失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hset</span><span class="params">(String key, String item, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().put(key, item, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向一张hash表中放入数据,如果不存在将创建</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item  项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  时间(秒) 注意:如果已存在的hash表有时间,这里将会替换原有的时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 成功 false失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hset</span><span class="params">(String key, String item, Object value, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForHash().put(key, item, value);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                expire(key, time);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除hash表中的值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项 可以使多个 不能为null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hdel</span><span class="params">(String key, Object... item)</span> </span>&#123;</span><br><span class="line">        redisTemplate.opsForHash().delete(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断hash表中是否有该项的值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项 不能为null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 存在 false不存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hHasKey</span><span class="params">(String key, String item)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().hasKey(key, item);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * hash递增 如果不存在,就会创建一个 并把新增后的值返回</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> by   要增加几(大于0)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">hincr</span><span class="params">(String key, String item, <span class="keyword">double</span> by)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().increment(key, item, by);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * hash递减</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key  键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> item 项</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> by   要减少记(小于0)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">hdecr</span><span class="params">(String key, String item, <span class="keyword">double</span> by)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.opsForHash().increment(key, item, -by);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ============================set=============================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据key获取Set中的所有值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;Object&gt; <span class="title">sGet</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().members(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据value从一个set中查询,是否存在</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> true 存在 false不存在</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">sHasKey</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().isMember(key, value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将数据放入set缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key    键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values 值 可以是多个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 成功个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sSet</span><span class="params">(String key, Object... values)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().add(key, values);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将set数据放入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key    键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time   时间(秒)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values 值 可以是多个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 成功个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sSetAndTime</span><span class="params">(String key, <span class="keyword">long</span> time, Object... values)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Long count = redisTemplate.opsForSet().add(key, values);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>)</span><br><span class="line">                expire(key, time);</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取set缓存的长度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">sGetSetSize</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForSet().size(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除值为value的</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key    键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> values 值 可以是多个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 移除的个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">setRemove</span><span class="params">(String key, Object... values)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Long count = redisTemplate.opsForSet().remove(key, values);</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ===============================list=================================</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取list缓存的内容</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> start 开始</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end   结束 0 到 -1代表所有值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Object&gt; <span class="title">lGet</span><span class="params">(String key, <span class="keyword">long</span> start, <span class="keyword">long</span> end)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().range(key, start, end);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取list缓存的长度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 键</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">lGetListSize</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().size(key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过索引 获取list中的值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index 索引 index&gt;=0时， 0 表头，1 第二个元素，依次类推；index&lt;0时，-1，表尾，-2倒数第二个元素，依次类推</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">lGetIndex</span><span class="params">(String key, <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> redisTemplate.opsForList().index(key, index);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将list放入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lSet</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPush(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将list放入缓存</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  时间(秒)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lSet</span><span class="params">(String key, Object value, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPush(key, value);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>)</span><br><span class="line">                expire(key, time);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将list放入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lSet</span><span class="params">(String key, List&lt;Object&gt; value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPushAll(key, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将list放入缓存</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time  时间(秒)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lSet</span><span class="params">(String key, List&lt;Object&gt; value, <span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().rightPushAll(key, value);</span><br><span class="line">            <span class="keyword">if</span> (time &gt; <span class="number">0</span>)</span><br><span class="line">                expire(key, time);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据索引修改list中的某条数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index 索引</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">lUpdateIndex</span><span class="params">(String key, <span class="keyword">long</span> index, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            redisTemplate.opsForList().set(key, index, value);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 移除N个值为value</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key   键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count 移除多少个</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 移除的个数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">lRemove</span><span class="params">(String key, <span class="keyword">long</span> count, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Long remove = redisTemplate.opsForList().remove(key, count, value);</span><br><span class="line">            <span class="keyword">return</span> remove;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis学习手册（一）--NoSQL、redis入门及基本数据类型</title>
      <link href="posts/2005124203.html"/>
      <url>posts/2005124203.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、NoSQL"><a href="#一、NoSQL" class="headerlink" title="一、NoSQL"></a>一、NoSQL</h1><blockquote><p>NoSQL = Not Only SQL，不仅仅是SQL，泛指非关系数据库</p><p>使用场景：数据变化不是很频繁，访问量相对较大</p></blockquote><h1 id="二、Redis入门"><a href="#二、Redis入门" class="headerlink" title="二、Redis入门"></a>二、Redis入门</h1><h2 id="2-1、概述"><a href="#2-1、概述" class="headerlink" title="2.1、概述"></a>2.1、概述</h2><ul><li><p>Redis指Remote Dictionary Server，即<strong>远程字典服务</strong></p></li><li><p>一个开源的由ANSI C语言编写，支持网络、可基于内存也可持久化的日志型Key-value数据库，支持多种语言</p></li><li><p>redis会周期性将更新的数据写入磁盘或者把修改操作写入追加的记录文件</p></li></ul><h2 id="2-2、特性"><a href="#2-2、特性" class="headerlink" title="2.2、特性"></a>2.2、特性</h2><ul><li>开源</li><li>支持多种语言</li><li>支持持久化、集群和事务</li></ul><h2 id="2-3、基础知识"><a href="#2-3、基础知识" class="headerlink" title="2.3、基础知识"></a>2.3、基础知识</h2><ul><li>redis有16个数据库，默认使用第1个数据库（下标为0）</li><li>使用select可以切换数据库，使用DBSIZE可以查看当前数据库的数据数量</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210203220924.png"></p><ul><li>清除当前数据库：flushdb</li><li>清楚所有数据库：flushall</li><li>redis是单线程的，redis的瓶颈是根据机器的内存和网络带宽。</li></ul><h1 id="三、五大数据类型"><a href="#三、五大数据类型" class="headerlink" title="三、五大数据类型"></a>三、五大数据类型</h1><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210203221317.png" alt="image-20210203221317019"></p><h2 id="3-1、Redis-key"><a href="#3-1、Redis-key" class="headerlink" title="3.1、Redis-key"></a>3.1、Redis-key</h2><blockquote><p>EXISTS 键名，如果有这个键，返回1，否则返回0<br>exists 键名</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210203221451.png" alt="image-20201011214514520"></p><h2 id="3-2、String（字符串）"><a href="#3-2、String（字符串）" class="headerlink" title="3.2、String（字符串）"></a>3.2、String（字符串）</h2><h3 id="1、append-键名-要追加的内容："><a href="#1、append-键名-要追加的内容：" class="headerlink" title="1、append 键名 要追加的内容："></a>1、append 键名 要追加的内容：</h3><blockquote><p>往已有的键值对的值中拼接新内容，如果没有该键，那么就新建一个键值对（相当于set）</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> name hello</span><br><span class="line">get name</span><br><span class="line">输出hello</span><br><span class="line">append name world</span><br><span class="line">输出10--&gt;返回拼接后值的长度</span><br><span class="line">get name</span><br><span class="line">输出helloworld</span><br></pre></td></tr></table></figure><ul><li>先设置一个键值对，即name–&gt;hello，然后往该键值对的值中拼接字符world，最后使用get name查看结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142557.png" alt="image-20201011222603013"></p><h3 id="2、strlen-键名-："><a href="#2、strlen-键名-：" class="headerlink" title="2、strlen 键名 ："></a>2、strlen 键名 ：</h3><blockquote><p>获取该键值对中值的长度</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">strlen name</span><br><span class="line">输出10</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142558.png" alt="image-20201011222916865"></p><h3 id="3、incr-键名："><a href="#3、incr-键名：" class="headerlink" title="3、incr 键名："></a>3、incr 键名：</h3><blockquote><p>针对数值使用，让数值的值+1</p></blockquote><ul><li>初始化一个键值对（views–0），然后使用incr 命令让其+1</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> views 0</span><br><span class="line">输出0</span><br><span class="line">incr views</span><br><span class="line">get views</span><br><span class="line">输出1</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142559.png" alt="image-20201011224023734"></p><h3 id="4、decr-键名："><a href="#4、decr-键名：" class="headerlink" title="4、decr 键名："></a>4、decr 键名：</h3><blockquote><p>同针对数值使用，让该数值的值-1</p></blockquote><ul><li>将上面的views从3减到2</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">decr views</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142600.png" alt="image-20201011224227673"></p><h3 id="5、incrby-decrby："><a href="#5、incrby-decrby：" class="headerlink" title="5、incrby/decrby："></a>5、incrby/decrby：</h3><blockquote><p>类似incr/decr，多了个步长</p></blockquote><ul><li>将views的值从2直接加到12（步长设置为10），然后把views的值从12降到7（步长为5）</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">incrby views 10</span><br><span class="line">decrby views 5</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142601.png" alt="image-20201011224913175"></p><h3 id="6、GETRANGE-键名-起始坐标-终止坐标（类似java中String类的substring）"><a href="#6、GETRANGE-键名-起始坐标-终止坐标（类似java中String类的substring）" class="headerlink" title="6、GETRANGE 键名 起始坐标 终止坐标（类似java中String类的substring）"></a>6、GETRANGE 键名 起始坐标 终止坐标（类似java中String类的substring）</h3><blockquote><p>截取（终止坐标 - 起始坐标） + 1个字符，闭区间[起始,终止]</p></blockquote><ul><li>设置一个键值对，然后截取该值的一部分</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142602.png" alt="image-20201011225254904"></p><blockquote><p>使用GETRANGE 键名 0  -1获取值对应的整个字符串，相当于get 键名</p></blockquote><ul><li>获取该键值对值的全部内容</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142603.png" alt="image-20201011225441783"></p><h3 id="7、SETRANGE-键名-偏移量n-要替换的字符串"><a href="#7、SETRANGE-键名-偏移量n-要替换的字符串" class="headerlink" title="7、SETRANGE 键名 偏移量n 要替换的字符串"></a>7、SETRANGE 键名 偏移量n 要替换的字符串</h3><blockquote><p>替换指定字符开始的字符串</p></blockquote><ul><li>先设置一个键值对：key2–&gt;abcdefg，然后偏移一个单位，将xx替换到目标串中</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142604.png" alt="image-20201011230122084"></p><h3 id="8、setex-键名-过期时间-值"><a href="#8、setex-键名-过期时间-值" class="headerlink" title="8、setex 键名 过期时间 值"></a>8、setex 键名 过期时间 值</h3><blockquote><p>为指定的key设置值和过期时间，如果key已经存在，SETEX命令会替换旧的值</p></blockquote><ul><li>先设置一个键值对，然后使用setex覆盖</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142605.png" alt="image-20201011232438878"></p><h3 id="9、setnx-SET-IF-NOT-EXISTS-键名-值"><a href="#9、setnx-SET-IF-NOT-EXISTS-键名-值" class="headerlink" title="9、setnx(SET IF NOT EXISTS) 键名 值"></a>9、setnx(SET IF NOT EXISTS) 键名 值</h3><blockquote><p>当指定的key不存在时，为key设置指定的值，如果存在会覆盖失败，返回0，成功返回1，这个命令经常在分布式锁中用到</p></blockquote><ul><li>先设置一个键值对，然后尝试使用setnx覆盖，观察结果，发现返回0，且key的值还是wuhu111</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142606.png" alt="image-20201011232537974"></p><h3 id="10、mset-键1-值1-键2-值2-…"><a href="#10、mset-键1-值1-键2-值2-…" class="headerlink" title="10、mset 键1 值1 键2 值2 …"></a>10、mset 键1 值1 键2 值2 …</h3><blockquote><p>使用这个命令可以批量添加键值对</p></blockquote><ul><li>添加三个键值对</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142607.png" alt="image-20201011233358741"></p><h3 id="11、mget-键1-键2-…"><a href="#11、mget-键1-键2-…" class="headerlink" title="11、mget 键1 键2 …"></a>11、mget 键1 键2 …</h3><blockquote><p>批量取得值</p></blockquote><ul><li>取得上面添加的值</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142608.png" alt="image-20201011233547127"></p><h3 id="12、msetnx-键1-值1-…"><a href="#12、msetnx-键1-值1-…" class="headerlink" title="12、msetnx 键1 值1 …"></a>12、msetnx 键1 值1 …</h3><blockquote><p>同时插入多个键值对，如果有一个键已经存在，就不执行插入操作，所有键都不存在时才插入</p></blockquote><h3 id="13、设置对象"><a href="#13、设置对象" class="headerlink" title="13、设置对象"></a>13、设置对象</h3><blockquote><p>set user : 1 {username : zhuo,age : 18}</p></blockquote><ul><li>使用mset和mget存储和获取对象</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; mset user:1:name hzx user:1:age 18</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mget user:1:name user:1:age</span><br><span class="line">1) <span class="string">&quot;hzx&quot;</span></span><br><span class="line">2) <span class="string">&quot;18&quot;</span></span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142609.png" alt="image-20201011234455595"></p><h3 id="14、getset-先取后赋值"><a href="#14、getset-先取后赋值" class="headerlink" title="14、getset 先取后赋值"></a>14、getset 先取后赋值</h3><blockquote><p>由于是先get后set，所以注意结果是上次的值，先返回当前值，后设置新值</p></blockquote><ul><li>设置一个键值对k1-v1，然后使用getset将值变为value1，观察</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210204142610.png" alt="image-20201011235025047"></p><h3 id="15、String应用场景："><a href="#15、String应用场景：" class="headerlink" title="15、String应用场景："></a>15、String应用场景：</h3><ul><li>由于redis中没有数值类型，所以数字也是用string存储</li><li>可以用作计数器</li><li>统计数量</li><li>对象缓存存储</li></ul><h2 id="3-3、List"><a href="#3-3、List" class="headerlink" title="3.3、List"></a>3.3、List</h2><ul><li>在redis中，我们可以通过设置规则来使list成为一个栈或队列</li><li>所有list命令大部分以l开头</li></ul><h3 id="1、LPUSH-集合名-值"><a href="#1、LPUSH-集合名-值" class="headerlink" title="1、LPUSH 集合名 值"></a>1、LPUSH 集合名 值</h3><blockquote><p>将一个或多个值从左边插进列表</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; LPUSH list one <span class="comment"># 在列表左边插入值</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; LPUSH list two three <span class="comment"># 在列表中插入多个值</span></span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; LRANGE list 0 -1  <span class="comment"># 获取列表中所有的值</span></span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">3) <span class="string">&quot;one&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; Lrange list 0 1 <span class="comment">#获取列表中下标在[0,1]的值</span></span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="2、RPUSH-集合名-值"><a href="#2、RPUSH-集合名-值" class="headerlink" title="2、RPUSH 集合名 值"></a>2、RPUSH 集合名 值</h3><blockquote><p>将一个或多个值从右边插进列表</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; Rpush list right</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; rpush list right1 right2</span><br><span class="line">(<span class="built_in">integer</span>) 6</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;three&quot;</span></span><br><span class="line">2) <span class="string">&quot;two&quot;</span></span><br><span class="line">3) <span class="string">&quot;one&quot;</span></span><br><span class="line">4) <span class="string">&quot;right&quot;</span></span><br><span class="line">5) <span class="string">&quot;right1&quot;</span></span><br><span class="line">6) <span class="string">&quot;right2&quot;</span></span><br></pre></td></tr></table></figure><h3 id="3、LPOP-列表名"><a href="#3、LPOP-列表名" class="headerlink" title="3、LPOP 列表名"></a>3、LPOP 列表名</h3><blockquote><p>从左边弹出（移出）一个元素</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; LPOP list </span><br><span class="line"><span class="string">&quot;three&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;two&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">3) <span class="string">&quot;right&quot;</span></span><br><span class="line">4) <span class="string">&quot;right1&quot;</span></span><br><span class="line">5) <span class="string">&quot;right2&quot;</span></span><br></pre></td></tr></table></figure><h3 id="4、RPOP-列表名"><a href="#4、RPOP-列表名" class="headerlink" title="4、RPOP 列表名"></a>4、RPOP 列表名</h3><blockquote><p>从右边弹出一个元素</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; RPOP list</span><br><span class="line"><span class="string">&quot;right2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;two&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">3) <span class="string">&quot;right&quot;</span></span><br><span class="line">4) <span class="string">&quot;right1&quot;</span></span><br></pre></td></tr></table></figure><h3 id="5、LINDEX-列表名-下标"><a href="#5、LINDEX-列表名-下标" class="headerlink" title="5、LINDEX 列表名 下标"></a>5、LINDEX 列表名 下标</h3><blockquote><p>通过下标获取值</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; LINDEX list 0</span><br><span class="line"><span class="string">&quot;two&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; LINDEX list 3</span><br><span class="line"><span class="string">&quot;right1&quot;</span></span><br></pre></td></tr></table></figure><h3 id="6、Llen-列表名"><a href="#6、Llen-列表名" class="headerlink" title="6、Llen 列表名"></a>6、Llen 列表名</h3><blockquote><p>获取列表长度</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; LRANGE list 0 -1</span><br><span class="line">1) <span class="string">&quot;two&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">3) <span class="string">&quot;right&quot;</span></span><br><span class="line">4) <span class="string">&quot;right1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; Llen list</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="7、Lrem-列表名-移除个数-精确值"><a href="#7、Lrem-列表名-移除个数-精确值" class="headerlink" title="7、Lrem  列表名  移除个数  精确值"></a>7、Lrem  列表名  移除个数  精确值</h3><blockquote><p>移除列表中的一个或多个值，精确匹配</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;one&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">3) <span class="string">&quot;one&quot;</span></span><br><span class="line">4) <span class="string">&quot;one&quot;</span></span><br><span class="line">5) <span class="string">&quot;two&quot;</span></span><br><span class="line">6) <span class="string">&quot;one&quot;</span></span><br><span class="line">7) <span class="string">&quot;right&quot;</span></span><br><span class="line">8) <span class="string">&quot;right1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrem list 1 two</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;one&quot;</span></span><br><span class="line">2) <span class="string">&quot;one&quot;</span></span><br><span class="line">3) <span class="string">&quot;one&quot;</span></span><br><span class="line">4) <span class="string">&quot;one&quot;</span></span><br><span class="line">5) <span class="string">&quot;one&quot;</span></span><br><span class="line">6) <span class="string">&quot;right&quot;</span></span><br><span class="line">7) <span class="string">&quot;right1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrem list 5 one</span><br><span class="line">(<span class="built_in">integer</span>) 5</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;right&quot;</span></span><br><span class="line">2) <span class="string">&quot;right1&quot;</span></span><br></pre></td></tr></table></figure><h3 id="8、ltrim-列表名-起始坐标-结束坐标"><a href="#8、ltrim-列表名-起始坐标-结束坐标" class="headerlink" title="8、ltrim  列表名  起始坐标  结束坐标"></a>8、ltrim  列表名  起始坐标  结束坐标</h3><blockquote><p>截断列表，列表元素变为[start ,end]</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello2&quot;</span></span><br><span class="line">3) <span class="string">&quot;hello3&quot;</span></span><br><span class="line">4) <span class="string">&quot;hello4&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; ltrim list 1 2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;hello2&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello3&quot;</span></span><br></pre></td></tr></table></figure><h3 id="9、exists-列表名"><a href="#9、exists-列表名" class="headerlink" title="9、exists 列表名"></a>9、exists 列表名</h3><blockquote><p>判断列表中有几个值</p></blockquote><h3 id="10、LSET-列表名-下标-值"><a href="#10、LSET-列表名-下标-值" class="headerlink" title="10、LSET 列表名  下标  值"></a>10、LSET 列表名  下标  值</h3><blockquote><p>替换列表指定下标的值，如果当前列表中不存在指定下标所对应的值，就报错</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;value3&quot;</span></span><br><span class="line">2) <span class="string">&quot;value2&quot;</span></span><br><span class="line">3) <span class="string">&quot;value1&quot;</span></span><br><span class="line">4) <span class="string">&quot;hello2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lset list 0 item</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;item&quot;</span></span><br><span class="line">2) <span class="string">&quot;value2&quot;</span></span><br><span class="line">3) <span class="string">&quot;value1&quot;</span></span><br><span class="line">4) <span class="string">&quot;hello2&quot;</span></span><br></pre></td></tr></table></figure><h3 id="11、LINSERT-列表名-前-后-要插入的位置-要插入的值"><a href="#11、LINSERT-列表名-前-后-要插入的位置-要插入的值" class="headerlink" title="11、LINSERT   列表名   前|后   要插入的位置    要插入的值"></a>11、LINSERT   列表名   前|后   要插入的位置    要插入的值</h3><blockquote><p>在列表的某个值前|后插入一个值</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; rpush list hello</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; rpush list world</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br><span class="line"><span class="comment"># 在world单词前插入一个值：other</span></span><br><span class="line">127.0.0.1:6379&gt; linsert list before <span class="string">&quot;world&quot;</span> other</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;other&quot;</span></span><br><span class="line">3) <span class="string">&quot;world&quot;</span></span><br></pre></td></tr></table></figure><ul><li>往上面list的other元素后插入一个值wuhu</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; linsert list after <span class="string">&quot;other&quot;</span> wuhu</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; lrange list 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;other&quot;</span></span><br><span class="line">3) <span class="string">&quot;wuhu&quot;</span></span><br><span class="line">4) <span class="string">&quot;world&quot;</span></span><br></pre></td></tr></table></figure><h3 id="12、小结："><a href="#12、小结：" class="headerlink" title="12、小结："></a>12、小结：</h3><ul><li><p>list实际上是一个链表，所以可以在节点前后插入节点，也可以在最左端、最右端插入元素</p></li><li><p>如果key不存在，创建新的链表</p></li><li><p>如果key存在，新增内容</p></li><li><p>如果移除了key，那么链表被移除</p></li><li><p>在两边插入或改动值效率最高！操作中间值效率会降低</p></li><li><p>可以用来模拟栈（LPUSH、LPOP）、消息队列（LPUSHR、RPOP）</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 💻后端学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>在线教育项目总结（一）-使用MP的QueryWrapper进行自定义sql与提升嵌套查询效率。</title>
      <link href="posts/2126557972.html"/>
      <url>posts/2126557972.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、使用条件构造器自定义SQL"><a href="#一、使用条件构造器自定义SQL" class="headerlink" title="一、使用条件构造器自定义SQL"></a>一、使用条件构造器自定义SQL</h1><blockquote><p>在在线教育项目的学习过程中，遇到一个需要展示课程详细信息的需求，这个课程信息页面需要展示课程title、课程一级类别、二级类别、讲师姓名、课时数、课程价格、课程封面、课程购买量、浏览量、课程状态（已发布、未发布）和课程创建时间。</p></blockquote><h2 id="1-1、所需依赖"><a href="#1-1、所需依赖" class="headerlink" title="1.1、所需依赖"></a>1.1、所需依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">mybatis-plus.version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">mybatis-plus.version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">swagger.version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">swagger.version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.19<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--mybatis-plus--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--mysql--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--swagger--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.swagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.swagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-models<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-bootstrap-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.swagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.swagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-models<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--lombok用来简化实体类：需要安装lombok插件--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!-- org.apache.commons.lang3.StringUtils --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="1-2、实体类"><a href="#1-2、实体类" class="headerlink" title="1.2、实体类"></a>1.2、实体类</h2><blockquote><p>该业务所涉及的实体类如下所示</p></blockquote><h3 id="1、BaseEntity"><a href="#1、BaseEntity" class="headerlink" title="1、BaseEntity"></a>1、BaseEntity</h3><blockquote><p>这个实体类定义了实体类的<strong>共同属性</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = false)</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseEntity</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;讲师ID&quot;)</span></span><br><span class="line">    <span class="meta">@TableId(value = &quot;id&quot;, type = IdType.ASSIGN_ID)</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;创建时间&quot;)</span></span><br><span class="line">    <span class="meta">@TableField(fill = FieldFill.INSERT)</span></span><br><span class="line">    <span class="keyword">private</span> Date gmtCreate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;更新时间&quot;)</span></span><br><span class="line">    <span class="meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span></span><br><span class="line">    <span class="keyword">private</span> Date gmtModified;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、Course"><a href="#2、Course" class="headerlink" title="2、Course"></a>2、Course</h3><blockquote><p>课程实体类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@TableName(&quot;edu_course&quot;)</span></span><br><span class="line"><span class="meta">@ApiModel(value=&quot;Course对象&quot;, description=&quot;课程&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Course</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 课程未发布</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String COURSE_DRAFT = <span class="string">&quot;Draft&quot;</span>;</span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 课程已发布</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String COURSE_NORMAL = <span class="string">&quot;Normal&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程讲师ID&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String teacherId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程专业ID&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String subjectId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程专业父级ID&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String subjectParentId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程标题&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程销售价格，设置为0则可免费观看&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;总课时&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer lessonNum;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程封面图片路径&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String cover;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;销售数量&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long buyCount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;浏览数量&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long viewCount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;乐观锁&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Long version;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;课程状态 Draft未发布  Normal已发布&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、Teacher"><a href="#3、Teacher" class="headerlink" title="3、Teacher"></a>3、Teacher</h3><blockquote><p>教师实体类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@TableName(&quot;edu_teacher&quot;)</span></span><br><span class="line"><span class="meta">@ApiModel(value=&quot;Teacher对象&quot;, description=&quot;讲师&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Teacher</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;讲师姓名&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;讲师简介&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String intro;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;讲师资历,一句话说明讲师&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String career;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;头衔 1高级讲师 2首席讲师&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer level;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;讲师头像&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String avatar;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;排序&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer sort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;入驻时间&quot;)</span></span><br><span class="line">    <span class="meta">@JsonFormat(timezone = &quot;GMT+8&quot;, pattern = &quot;yyyy-MM-dd&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date joinDate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;逻辑删除 1（true）已删除， 0（false）未删除&quot;)</span></span><br><span class="line">    <span class="meta">@TableLogic</span></span><br><span class="line">    <span class="keyword">private</span> Integer isDeleted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4、Subject"><a href="#4、Subject" class="headerlink" title="4、Subject"></a>4、Subject</h3><blockquote><p><strong>课程分类实体类</strong></p><p>一级分类和二级分类共用一个实体类，如果分类对象的parentId为0，证明其是一级分类，如果不为0，证明为二级分类。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode(callSuper = true)</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="meta">@TableName(&quot;edu_subject&quot;)</span></span><br><span class="line"><span class="meta">@ApiModel(value=&quot;Subject对象&quot;, description=&quot;课程科目&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Subject</span> <span class="keyword">extends</span> <span class="title">BaseEntity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID=<span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;类别名称&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;父ID&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String parentId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty(value = &quot;排序字段&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer sort;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5、CourseVo"><a href="#5、CourseVo" class="headerlink" title="5、CourseVo"></a>5、CourseVo</h3><blockquote><p>这个Vo类用于定义需要展示在课程详情页面的属性</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseVo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="comment">// 课程标题</span></span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="comment">// 课程一级分类</span></span><br><span class="line">    <span class="keyword">private</span> String subjectParentTitle;</span><br><span class="line">    <span class="comment">// 课程二级分类</span></span><br><span class="line">    <span class="keyword">private</span> String subjectTitle;</span><br><span class="line">    <span class="comment">// 讲师姓名</span></span><br><span class="line">    <span class="keyword">private</span> String teacherName;</span><br><span class="line">    <span class="comment">// 课程课时数</span></span><br><span class="line">    <span class="keyword">private</span> Integer lessonNum;</span><br><span class="line">    <span class="comment">// 课程价格</span></span><br><span class="line">    <span class="keyword">private</span> String price;</span><br><span class="line">    <span class="comment">// 课程封面</span></span><br><span class="line">    <span class="keyword">private</span> String cover;</span><br><span class="line">    <span class="comment">// 课程购买数</span></span><br><span class="line">    <span class="keyword">private</span> Long buyCount;</span><br><span class="line">    <span class="comment">// 课程浏览量</span></span><br><span class="line">    <span class="keyword">private</span> Long viewCount;</span><br><span class="line">    <span class="comment">// 课程状态</span></span><br><span class="line">    <span class="keyword">private</span> String status;</span><br><span class="line">    <span class="comment">// 课程创建时间</span></span><br><span class="line">    <span class="keyword">private</span> String gmtCreate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6、CourseQueryVo"><a href="#6、CourseQueryVo" class="headerlink" title="6、CourseQueryVo"></a>6、CourseQueryVo</h3><blockquote><p>该业务还需要用到分页查询与条件查询，所以引入一个用于构造条件查询的查询实体类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseQueryVo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String teacherId;</span><br><span class="line">    <span class="keyword">private</span> String subjectParentId;</span><br><span class="line">    <span class="keyword">private</span> String subjectId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-3、Controller层"><a href="#1-3、Controller层" class="headerlink" title="1.3、Controller层"></a>1.3、Controller层</h2><blockquote><p>定义一个CourseListPage接口，需要传入三个参数：</p><ul><li>page：当前页码</li><li>limit：每页记录数</li><li>courseQueryVo：由查询条件封装成的查询对象</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;课程管理控制器&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/admin/edu/course&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CourseService courseService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ApiOperation(&quot;课程分页列表&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;list/&#123;page&#125;/&#123;limit&#125;&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">courseListPage</span><span class="params">(<span class="meta">@ApiParam(value = &quot;当前页码&quot;,required = true)</span> <span class="meta">@PathVariable</span> Long page,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="meta">@ApiParam(value = &quot;每页记录数&quot;,required = true)</span> <span class="meta">@PathVariable</span> Long limit,</span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="meta">@ApiParam(value = &quot;课程列表查询对象&quot;)</span>CourseQueryVo courseQueryVo)</span> </span>&#123;</span><br><span class="line">        IPage&lt;CourseVo&gt; pageModel = courseService.selectPage(page, limit, courseQueryVo);</span><br><span class="line">        List&lt;CourseVo&gt; records = pageModel.getRecords();</span><br><span class="line">        <span class="keyword">long</span> total = pageModel.getTotal();</span><br><span class="line">        <span class="keyword">return</span>  R.ok().data(<span class="string">&quot;total&quot;</span>, total).data(<span class="string">&quot;rows&quot;</span>, records);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-4、Service实现类"><a href="#1-4、Service实现类" class="headerlink" title="1.4、Service实现类"></a>1.4、Service实现类</h2><blockquote><p>使用QueryWrapper组装sql的步骤如下：</p><ul><li>分别取出查询对象中的查询属性并判断是否为空</li><li>若不为空，则使用条件构造器根据属性类型构造查询条件</li><li>在使用条件构造器构造查询条件时需要使用<strong>表别名.属性名</strong>的形式构造条件</li><li>将组装好的条件构造器传入Mapper层</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CourseServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">CourseMapper</span>, <span class="title">Course</span>&gt; <span class="keyword">implements</span> <span class="title">CourseService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> VideoMapper videoMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ChapterMapper chapterMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CommentMapper commentMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CourseCollectMapper courseCollectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CourseMapper courseMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IPage&lt;CourseVo&gt; <span class="title">selectPage</span><span class="params">(Long page, Long limit, CourseQueryVo courseQueryVo)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//组装查询条件</span></span><br><span class="line">        QueryWrapper&lt;CourseVo&gt; courseVoQueryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        courseVoQueryWrapper.orderByDesc(<span class="string">&quot;c.gmt_create&quot;</span>);</span><br><span class="line">        <span class="comment">//四个查询条件如下</span></span><br><span class="line">        String title = courseQueryVo.getTitle();</span><br><span class="line">        String teacherId = courseQueryVo.getTeacherId();</span><br><span class="line">        String subjectParentId = courseQueryVo.getSubjectParentId();</span><br><span class="line">        String subjectId = courseQueryVo.getSubjectId();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(title)) &#123;</span><br><span class="line">            courseVoQueryWrapper.like(<span class="string">&quot;c.title&quot;</span>, title);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(teacherId)) &#123;</span><br><span class="line">            courseVoQueryWrapper.eq(<span class="string">&quot;c.teacher_id&quot;</span>, teacherId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(subjectParentId)) &#123;</span><br><span class="line">            courseVoQueryWrapper.eq(<span class="string">&quot;c.subject_parent_id&quot;</span>, subjectParentId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(subjectId)) &#123;</span><br><span class="line">            courseVoQueryWrapper.eq(<span class="string">&quot;c.subject_id&quot;</span>, subjectId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//组装分页</span></span><br><span class="line">        Page&lt;CourseVo&gt; pageParam = <span class="keyword">new</span> Page&lt;&gt;(page, limit);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行查询</span></span><br><span class="line">        List&lt;CourseVo&gt; courseVoList = courseMapper.selectPageByQueryVo(pageParam, courseVoQueryWrapper);</span><br><span class="line">        pageParam.setRecords(courseVoList);</span><br><span class="line">        <span class="keyword">return</span> pageParam;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="1-5、Mapper层"><a href="#1-5、Mapper层" class="headerlink" title="1.5、Mapper层"></a>1.5、Mapper层</h2><h3 id="1、Mapper接口"><a href="#1、Mapper接口" class="headerlink" title="1、Mapper接口"></a>1、Mapper接口</h3><blockquote><p>对于Service层中传入的条件构造器，需要使Mybatis-plus能够识别，此时我们需要在Mapper层中的条件构造器对象前添加**@Param(Constants.WRAPPER)**注解</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CourseMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Course</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">List&lt;CourseVo&gt; <span class="title">selectPageByQueryVo</span><span class="params">(Page&lt;CourseVo&gt; pageParam,</span></span></span><br><span class="line"><span class="function"><span class="params">                                       <span class="meta">@Param(Constants.WRAPPER)</span> QueryWrapper&lt;CourseVo&gt; courseVoQueryWrapper)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、Mapper-xml文件"><a href="#2、Mapper-xml文件" class="headerlink" title="2、Mapper.xml文件"></a>2、Mapper.xml文件</h3><blockquote><p>除去Mapper接口添加的**@Param(Constants.WRAPPER)<strong>注解外，我们还需要在自定义的sql语句后添加</strong>${ew.customSqlSegment}**</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.hzx.grain.service.edu.mapper.CourseMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectPageByQueryVo&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.hzx.grain.service.edu.entity.vo.CourseVo&quot;</span>&gt;</span></span><br><span class="line">        SELECT</span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;courseVoColumns&quot;</span>/&gt;</span></span><br><span class="line">        FROM</span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;tables&quot;</span>/&gt;</span></span><br><span class="line">        $&#123;ew.customSqlSegment&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 抽取sql片段 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;courseVoColumns&quot;</span>&gt;</span></span><br><span class="line">           c.id,</span><br><span class="line">           c.title,</span><br><span class="line">           c.lesson_num AS lessonNum,</span><br><span class="line">           c.price,</span><br><span class="line">           c.cover,</span><br><span class="line">           c.buy_count AS buyCount,</span><br><span class="line">           c.view_count AS viewCount,</span><br><span class="line">           c.status,</span><br><span class="line">           c.gmt_create AS gmtCreate,</span><br><span class="line">           t.name AS teacherName,</span><br><span class="line">           s1.title AS subjectParentTitle,</span><br><span class="line">           s2.title AS subjectTitle</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 抽取sql片段：与course表连接的其余表 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;tables&quot;</span>&gt;</span></span><br><span class="line">            guli_edu.edu_course c</span><br><span class="line">        LEFT JOIN guli_edu.edu_teacher t ON c.teacher_id = t.id</span><br><span class="line">        LEFT JOIN guli_edu.edu_subject s1 ON c.subject_parent_id = s1.id</span><br><span class="line">        LEFT JOIN guli_edu.edu_subject s2 ON c.subject_id = s2.id</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="3、注意事项"><a href="#3、注意事项" class="headerlink" title="3、注意事项"></a>3、注意事项</h3><blockquote><p>需要<code>mybatis-plus</code>版本 &gt;= <code>3.0.7</code></p></blockquote><h2 id="1-6、测试"><a href="#1-6、测试" class="headerlink" title="1.6、测试"></a>1.6、测试</h2><blockquote><p>打开Swagger进行测试</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210203201739.png"></p><h3 id="1、结果"><a href="#1、结果" class="headerlink" title="1、结果"></a>1、结果</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;success&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;code&quot;</span>: <span class="number">20000</span>,</span><br><span class="line">  <span class="attr">&quot;message&quot;</span>: <span class="string">&quot;成功&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;data&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;rows&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;1353316219423391746&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Spring Boot框架入门教程&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;subjectParentTitle&quot;</span>: <span class="string">&quot;后端开发&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;subjectTitle&quot;</span>: <span class="string">&quot;Java&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;teacherName&quot;</span>: <span class="string">&quot;刘德华&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;lessonNum&quot;</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span>: <span class="string">&quot;0.00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;cover&quot;</span>: <span class="string">&quot;https://edu-system-1010.oss-cn-shenzhen.aliyuncs.com/cover/2021/01/24/2afcb3fd-da73-40d1-ba41-4d6cf74c7e7a.jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;buyCount&quot;</span>: <span class="number">8</span>,</span><br><span class="line">        <span class="attr">&quot;viewCount&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;Normal&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;gmtCreate&quot;</span>: <span class="string">&quot;2021-01-24 20:18:25&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;1353313325668200450&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;Mybatis-Plus框架入门教程&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;subjectParentTitle&quot;</span>: <span class="string">&quot;后端开发&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;subjectTitle&quot;</span>: <span class="string">&quot;Java&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;teacherName&quot;</span>: <span class="string">&quot;刘德华&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;lessonNum&quot;</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span>: <span class="string">&quot;1.00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;cover&quot;</span>: <span class="string">&quot;https://edu-system-1010.oss-cn-shenzhen.aliyuncs.com/cover/2021/01/24/804b29e5-4ca7-4819-9bac-eb34f65068ca.jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;buyCount&quot;</span>: <span class="number">9</span>,</span><br><span class="line">        <span class="attr">&quot;viewCount&quot;</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;Normal&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;gmtCreate&quot;</span>: <span class="string">&quot;2021-01-24 20:06:55&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;1353310049325309953&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;java--从入门到入土&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;subjectParentTitle&quot;</span>: <span class="string">&quot;后端开发&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;subjectTitle&quot;</span>: <span class="string">&quot;Java&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;teacherName&quot;</span>: <span class="string">&quot;刘德华&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;lessonNum&quot;</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span>: <span class="string">&quot;6.00&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;cover&quot;</span>: <span class="string">&quot;https://edu-system-1010.oss-cn-shenzhen.aliyuncs.com/cover/2021/01/24/d7c25aaa-5c09-4b46-a56d-5000f9265bc7.jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;buyCount&quot;</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">&quot;viewCount&quot;</span>: <span class="number">5</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;Normal&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;gmtCreate&quot;</span>: <span class="string">&quot;2021-01-24 19:53:54&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、执行的sql语句"><a href="#2、执行的sql语句" class="headerlink" title="2、执行的sql语句"></a>2、执行的sql语句</h3><blockquote><p>使用Idea的Mybatis插件查看执行的sql语句</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">SELECT </span><br><span class="line">c.id, </span><br><span class="line">c.title, </span><br><span class="line">c.lesson_num AS lessonNum, </span><br><span class="line">c.price, </span><br><span class="line">c.cover, </span><br><span class="line">c.buy_count AS buyCount, </span><br><span class="line">c.view_count AS viewCount, </span><br><span class="line">c.status, </span><br><span class="line">c.gmt_create AS gmtCreate, </span><br><span class="line">t.name AS teacherName, </span><br><span class="line">s1.title AS subjectParentTitle, </span><br><span class="line">s2.title AS subjectTitle</span><br><span class="line">FROM guli_edu.edu_course c</span><br><span class="line">LEFT JOIN guli_edu.edu_teacher t ON c.teacher_id &#x3D; t.id</span><br><span class="line">LEFT JOIN guli_edu.edu_subject s1 ON c.subject_parent_id &#x3D; s1.id</span><br><span class="line">LEFT JOIN guli_edu.edu_subject s2 ON c.subject_id &#x3D; s2.id</span><br><span class="line">WHERE c.title LIKE &#39;%入门%&#39;</span><br><span class="line">AND c.teacher_id &#x3D; &#39;1&#39;</span><br><span class="line">AND c.subject_parent_id &#x3D; &#39;1352924754100617218&#39;</span><br><span class="line">AND c.subject_id &#x3D; &#39;1352924754167726082&#39;</span><br><span class="line">ORDER BY c.gmt_create DESC</span><br><span class="line">LIMIT 0, 3;</span><br></pre></td></tr></table></figure><h1 id="二、总结嵌套查询"><a href="#二、总结嵌套查询" class="headerlink" title="二、总结嵌套查询"></a>二、总结嵌套查询</h1><h2 id="2-1、使用子查询"><a href="#2-1、使用子查询" class="headerlink" title="2.1、使用子查询"></a>2.1、使用子查询</h2><h3 id="1、Controller层"><a href="#1、Controller层" class="headerlink" title="1、Controller层"></a>1、Controller层</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;nested&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;嵌套分类数据列表&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">nestedList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//返回分类VO列表</span></span><br><span class="line">    List&lt;SubjectVo&gt; subjectVoList = subjectService.nestedList();</span><br><span class="line">    <span class="keyword">return</span> R.ok().data(<span class="string">&quot;items&quot;</span>,subjectVoList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、Service实现类"><a href="#2、Service实现类" class="headerlink" title="2、Service实现类"></a>2、Service实现类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;SubjectVo&gt; <span class="title">nestedList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> subjectMapper.selectNestedListByParentId(<span class="string">&quot;0&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、Mapper-xml文件"><a href="#3、Mapper-xml文件" class="headerlink" title="3、Mapper.xml文件"></a>3、Mapper.xml文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 使用ResultMap进行映射 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;subjectVoMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.hzx.grain.service.edu.entity.vo.SubjectVo&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 将表中字段与类中属性一一映射 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;title&quot;</span> <span class="attr">column</span>=<span class="string">&quot;title&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;sort&quot;</span> <span class="attr">column</span>=<span class="string">&quot;sort&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 这里根据原来的方法进行嵌套查询 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;children&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">column</span>=<span class="string">&quot;id&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">select</span>=<span class="string">&quot;selectNestedListByParentId&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">ofType</span>=<span class="string">&quot;com.hzx.grain.service.edu.entity.vo.SubjectVo&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 嵌套查询一级分类与二级分类并组装为SubjectVo列表的sql语句 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectNestedListByParentId&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;subjectVoMap&quot;</span>&gt;</span></span><br><span class="line">    SELECT</span><br><span class="line">     `id`,</span><br><span class="line">     `sort`,</span><br><span class="line">     `title`</span><br><span class="line">    FROM</span><br><span class="line">     guli_edu.edu_subject</span><br><span class="line">    WHERE</span><br><span class="line">     `parent_id` = #&#123;parentId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="4、SubjectVo实体类"><a href="#4、SubjectVo实体类" class="headerlink" title="4、SubjectVo实体类"></a>4、SubjectVo实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SubjectVo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> Integer sort;</span><br><span class="line">    <span class="keyword">private</span> List&lt;SubjectVo&gt; children = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5、总结"><a href="#5、总结" class="headerlink" title="5、总结"></a>5、总结</h3><blockquote><p>这种使用子查询的嵌套查询实现简单，但查询效率会随着数据量增大而降低。</p></blockquote><h2 id="2-2、三层嵌套查询中使用冗余字段提高查询效率"><a href="#2-2、三层嵌套查询中使用冗余字段提高查询效率" class="headerlink" title="2.2、三层嵌套查询中使用冗余字段提高查询效率"></a>2.2、三层嵌套查询中使用冗余字段提高查询效率</h2><blockquote><p>该业务需求是：根据课程Id查询课程详情信息，包括课程信息、嵌套章节课时列表</p><p>即一个课程下有多个章节，而一个章节下又有多个小节</p></blockquote><h3 id="1、CourseVo"><a href="#1、CourseVo" class="headerlink" title="1、CourseVo"></a>1、CourseVo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebCourseVo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> BigDecimal price;</span><br><span class="line">    <span class="keyword">private</span> Integer lessonNum;</span><br><span class="line">    <span class="keyword">private</span> String cover;</span><br><span class="line">    <span class="keyword">private</span> Long buyCount;</span><br><span class="line">    <span class="keyword">private</span> Long viewCount;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    <span class="keyword">private</span> String teacherId;</span><br><span class="line">    <span class="keyword">private</span> String teacherName;</span><br><span class="line">    <span class="keyword">private</span> String intro;</span><br><span class="line">    <span class="keyword">private</span> String avatar;</span><br><span class="line">    <span class="keyword">private</span> String subjectLevelOneId;</span><br><span class="line">    <span class="keyword">private</span> String subjectLevelOne;</span><br><span class="line">    <span class="keyword">private</span> String subjectLevelTwoId;</span><br><span class="line">    <span class="keyword">private</span> String subjectLevelTwo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、ChapterVo"><a href="#2、ChapterVo" class="headerlink" title="2、ChapterVo"></a>2、ChapterVo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChapterVo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> Integer sort;</span><br><span class="line">    <span class="keyword">private</span> List&lt;VideoVo&gt; children = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、VideoVo"><a href="#3、VideoVo" class="headerlink" title="3、VideoVo"></a>3、VideoVo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VideoVo</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> Boolean free;</span><br><span class="line">    <span class="keyword">private</span> Integer sort;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String videoSourceId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4、控制器层"><a href="#4、控制器层" class="headerlink" title="4、控制器层"></a>4、控制器层</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;get/&#123;courseId&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;根据courseId查询课程详细信息&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">getById</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@ApiParam(value = &quot;课程id&quot;,required = true)</span></span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="meta">@PathVariable</span> String courseId)</span> </span>&#123;</span><br><span class="line">    WebCourseVo courseVo = courseService.selectWebCourseVoById(courseId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询当前课程的嵌套章节和课时信息</span></span><br><span class="line">    List&lt;ChapterVo&gt; chapterVoList = chapterService.nestedList(courseId);</span><br><span class="line">    <span class="keyword">return</span> R.ok().data(<span class="string">&quot;course&quot;</span>,courseVo).data(<span class="string">&quot;chapterVoList&quot;</span>,chapterVoList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5、service层"><a href="#5、service层" class="headerlink" title="5、service层"></a>5、service层</h3><blockquote><p>CourseServiceImpl</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WebCourseVo <span class="title">selectWebCourseVoById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//更新课程浏览数</span></span><br><span class="line">    Course course = baseMapper.selectById(id);</span><br><span class="line">    course.setViewCount(course.getViewCount() + <span class="number">1</span>);</span><br><span class="line">    baseMapper.updateById(course);</span><br><span class="line">    <span class="comment">//获取课程信息</span></span><br><span class="line">    <span class="keyword">return</span> baseMapper.selectWebCourseVoById(id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ChapterServiceImpl</p><p>由于前面使用子查询导致查询速率低下，所以在这里使用video表冗余的CourseId字段来提高查询速率，步骤如下</p><ul><li>通过Chapter类的courseId获取该课程下的所有章节对象</li><li>通过Video类冗余的courseId获取该课程下的所有小节对象</li><li>循环遍历该课程下的章节对象列表，通过Chapter对象的id和Video对象的chapterId字段来建立联系，组装Chapter对象的Video列表</li></ul></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;ChapterVo&gt; <span class="title">nestedList</span><span class="params">(String courseId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1 通过courseId获取章节列表信息：List&lt;Chapter&gt;</span></span><br><span class="line">    QueryWrapper&lt;Chapter&gt; chapterQueryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    chapterQueryWrapper.eq(<span class="string">&quot;course_id&quot;</span>,courseId);</span><br><span class="line">    List&lt;Chapter&gt; chapterList = chapterMapper.selectList(chapterQueryWrapper);</span><br><span class="line">    <span class="comment">//2 通过edu_video表中冗余的course_id获取属于这个课程的所有Video列表：List&lt;Video&gt;</span></span><br><span class="line">    QueryWrapper&lt;Video&gt; videoQueryWrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">    videoQueryWrapper.eq(<span class="string">&quot;course_id&quot;</span>,courseId);</span><br><span class="line">    List&lt;Video&gt; videoList = videoMapper.selectList(videoQueryWrapper);</span><br><span class="line">    <span class="comment">//3 先获取章节信息ChapterVo列表，再获取VideoVo列表</span></span><br><span class="line">    List&lt;ChapterVo&gt; chapterVoList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    chapterList.forEach(chapter -&gt; &#123;</span><br><span class="line">        ChapterVo chapterVo = <span class="keyword">new</span> ChapterVo();</span><br><span class="line">        BeanUtils.copyProperties(chapter,chapterVo);</span><br><span class="line">        chapterVoList.add(chapterVo);</span><br><span class="line">        List&lt;VideoVo&gt; videoVoList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">//4 循环组装章节信息列表</span></span><br><span class="line">        videoList.forEach(video -&gt; &#123;</span><br><span class="line">            <span class="comment">//如果当前chapter的id的值等于video的chapterId值</span></span><br><span class="line">            <span class="comment">//证明当前video对象属于该Chapter对象</span></span><br><span class="line">            <span class="keyword">if</span>(StringUtils.equals(chapter.getId(),video.getChapterId())) &#123;</span><br><span class="line">                VideoVo videoVo = <span class="keyword">new</span> VideoVo();</span><br><span class="line">                BeanUtils.copyProperties(video,videoVo);</span><br><span class="line">                videoVoList.add(videoVo);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        chapterVo.setChildren(videoVoList);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> chapterVoList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 项目总结 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
            <tag> 💎Mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java应用学习（三）-SSM框架整合及基本使用</title>
      <link href="posts/3009255528.html"/>
      <url>posts/3009255528.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>SSM框架多种整合方式，这里使用注解+XML文件的方式来进行整合开发</p></blockquote><h1 id="一、前期准备"><a href="#一、前期准备" class="headerlink" title="一、前期准备"></a>一、前期准备</h1><h2 id="1-1、创建数据库与表"><a href="#1-1、创建数据库与表" class="headerlink" title="1.1、创建数据库与表"></a>1.1、创建数据库与表</h2><blockquote><p>打开数据库可视化工具，执行以下sql语句</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE ssm;</span><br><span class="line"></span><br><span class="line">USE ssm;</span><br><span class="line"></span><br><span class="line">CREATE TABLE &#96;student&#96;(</span><br><span class="line">    id INT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">    &#96;name&#96; VARCHAR(32),</span><br><span class="line">    score DOUBLE</span><br><span class="line">);</span><br><span class="line">INSERT INTO &#96;student&#96; VALUES (1, &#39;A&#39;, 80);</span><br><span class="line">INSERT INTO &#96;student&#96; VALUES (2, &#39;B&#39;, 95);</span><br><span class="line">INSERT INTO &#96;student&#96; VALUES (3, &#39;C&#39;, 90);</span><br><span class="line">INSERT INTO &#96;student&#96; VALUES (4, &#39;D&#39;, 100);</span><br></pre></td></tr></table></figure><h2 id="1-2、创建maven项目"><a href="#1-2、创建maven项目" class="headerlink" title="1.2、创建maven项目"></a>1.2、创建maven项目</h2><blockquote><p>注：这里需要以maven-archetype-webapp为骨架构建项目</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210131125931.png" alt="image-20210131125931386"></p><blockquote><p>设置项目路径与坐标后，点击next</p></blockquote><blockquote><p>选择项目使用的maven版本及settings.xml文件，<strong>在属性中添加一键值对</strong>：**(archetypeCatalog:internal)**，这个键值对可以解决maven项目构建速度过慢的问题。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210131130358.png" alt="image-20210131130358733"></p><h2 id="1-3、编辑pom-xml"><a href="#1-3、编辑pom-xml" class="headerlink" title="1.3、编辑pom.xml"></a>1.3、编辑pom.xml</h2><blockquote><p>在pom.xml文件中<strong>引入项目依赖</strong>与<strong>版本锁定</strong></p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">spring.version</span>&gt;</span>5.0.2.RELEASE<span class="tag">&lt;/<span class="name">spring.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">slf4j.version</span>&gt;</span>1.6.6<span class="tag">&lt;/<span class="name">slf4j.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">log4j.version</span>&gt;</span>1.2.12<span class="tag">&lt;/<span class="name">log4j.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mysql.version</span>&gt;</span>8.0.19<span class="tag">&lt;/<span class="name">mysql.version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mybatis.version</span>&gt;</span>3.4.5<span class="tag">&lt;/<span class="name">mybatis.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- spring --&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- aop相关的技术 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- aop --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- context容器 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- web --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- webmvc --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- spring测试 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 事务 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-tx<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- jdbc模板技术 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- 单元测试 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- mysql连接 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- servlet --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- jsp --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsp-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- EL JL TL表达式 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- log start --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;log4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;slf4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;slf4j.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- log end --&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- mybatis相关 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mybatis.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- druid 连接池 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="1-4、完善目录结构"><a href="#1-4、完善目录结构" class="headerlink" title="1.4、完善目录结构"></a>1.4、完善目录结构</h2><ul><li>在src/main目录下创建java文件夹与resource文件夹。</li><li>在上一步创建的java目录下创建com.hzx.entity、com.hzx.dao、com.hzx.controller、com.hzx.service和com.hzx.test包</li></ul><blockquote><p>完善后的目录如下：</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210131131024.png" alt="image-20210131131024222"></p><h2 id="1-5、创建基本类"><a href="#1-5、创建基本类" class="headerlink" title="1.5、创建基本类"></a>1.5、创建基本类</h2><blockquote><p>根据数据库的表结构创建实体类，这里使用了<strong>Lombok</strong>简化开发</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hzx.entity;</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Double score;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在service包下创建一个StudentService接口，再创建一个impl包，然后在impl包下新建一个StudentServiceImpl实现类，这个类实现StudentService接口。</p></blockquote><ul><li>接口</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hzx.service;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StudentService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>实现类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hzx.service.impl;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentServiceImpl</span> <span class="keyword">implements</span> <span class="title">StudentService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在mapper包下创建StudentMapper接口</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hzx.mapper;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StudentMapper</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在controller包下创建一个StudentController接口</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hzx.controller;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentController</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="二、Spring相关环境配置"><a href="#二、Spring相关环境配置" class="headerlink" title="二、Spring相关环境配置"></a>二、Spring相关环境配置</h1><h2 id="2-1、编写Spring核心配置文件"><a href="#2-1、编写Spring核心配置文件" class="headerlink" title="2.1、编写Spring核心配置文件"></a>2.1、编写Spring核心配置文件</h2><blockquote><p>在resource目录下创建Spring核心配置文件–applicationContext.xml</p><p>在这个核心配置文件中，我们需要</p></blockquote><ul><li>开启组件扫描，扫描com.hzx包下的所有组件</li><li>由于controller包下的控制器组件属于SpringMVC，所以我们需要在组件扫描中排除com.hzx包下所有添加了@Controller注解的组件。</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/aop/spring-aop.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="tag"><span class="string">   http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 开启注解扫描，处理service和dao，但是不需要处理 controller --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.hzx&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 配置哪些注解不扫描 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2-2、测试"><a href="#2-2、测试" class="headerlink" title="2.2、测试"></a>2.2、测试</h2><blockquote><p>在StudentServiceImpl上添加@Service注解，同时添加两个方法进行测试</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentServiceImpl</span> <span class="keyword">implements</span> <span class="title">StudentService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Student&gt; <span class="title">getAllStudent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Service层的getAll方法，需要调用Mapper层与数据库交互.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在com.hzx.test包下创建一个TestSpring类，编写方法使用junit进行测试</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSpring</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testGetAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ApplicationContext ioc = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">&quot;applicationContext.xml&quot;</span>);</span><br><span class="line">        StudentService studentService = ioc.getBean(StudentServiceImpl.class);</span><br><span class="line">        studentService.getAllStudent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210131133141.png" alt="image-20210131133141706"></p><blockquote><p>出现以上结果证明Spring基本环境已经搭建完成，下面配置SpringMVC</p></blockquote><h1 id="三、SpringMVC相关环境配置"><a href="#三、SpringMVC相关环境配置" class="headerlink" title="三、SpringMVC相关环境配置"></a>三、SpringMVC相关环境配置</h1><h2 id="3-1、配置web-xml"><a href="#3-1、配置web-xml" class="headerlink" title="3,1、配置web.xml"></a>3,1、配置web.xml</h2><blockquote><p>配置SpringMVC的核心前端控制器：<strong>DispatcherServlet</strong></p><p>web.xml文件位置如下</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210131133440.png" alt="image-20210131133440460"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置前端控制器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--加载springmvc.xml配置文件--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:springmvc.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--启动服务器，创建该servlet--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>dispatcherServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><p>配置前端控制器的过程中，可以直接指定springmvc的核心配置文件位置，在resource目录下创建springmvc核心配置文件–<strong>springmvc.xml</strong></p></li><li><p>使用该前端控制器拦截所有请求，在服务器启动时创建该servlet</p></li></ul><blockquote><p>配置字符编码过滤器，用于解决中文乱码</p><p>注：<strong>如果配置了多个过滤器，那么这个字符编码过滤器必须放在最前</strong></p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置过滤器，解决中文乱码--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>characterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>characterEncodingFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>可选：如果你在SSM框架中想使用REST风格的API，那么需要配置一个<strong>HiddenHttpMethodFilter</strong></p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置使用Rest风格的URL --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>hiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.HiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>hiddenHttpMethodFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="3-2、配置springmvc-xml"><a href="#3-2、配置springmvc-xml" class="headerlink" title="3.2、配置springmvc.xml"></a>3.2、配置springmvc.xml</h2><blockquote><p>在resource目录下创建一个springmvc.xml配置文件</p></blockquote><ul><li><p>创建配置文件，引入命名空间</p></li><li><p>开启组件扫描，由于Spring核心配置文件中已经扫描除<strong>控制器</strong>之外的组件，所以在springmvc核心配置文件中只需要扫描控制器即可。</p></li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--1  开启只对controller的扫描--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.hzx&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>配置视图解析器，在WEB-INF文件夹下创建一个pages文件夹</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--2 配置视图解析器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;org&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--JSP 目录--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/pages/&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--文件后缀--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>在webapp目录下创建三个用于存放静态资源的文件夹（css、images、js），并放行静态资源</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--3 不过滤静态资源--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">&quot;/css/**&quot;</span> <span class="attr">location</span>=<span class="string">&quot;/css/&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">&quot;/images/**&quot;</span> <span class="attr">location</span>=<span class="string">&quot;/images/&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">&quot;/js/**&quot;</span> <span class="attr">location</span>=<span class="string">&quot;/js/&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>开启注解支持</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--4 开启注解支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>springmvc.xml配置如下：</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:mvc</span>=<span class="string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/mvc</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/mvc/spring-mvc.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--1  开启只对controller的扫描--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.hzx&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--2 配置视图解析器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;org&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--JSP 目录--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/pages/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--文件后缀--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--3 不过滤静态资源--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">&quot;/css/**&quot;</span> <span class="attr">location</span>=<span class="string">&quot;/css/&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">&quot;/images/**&quot;</span> <span class="attr">location</span>=<span class="string">&quot;/images/&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:resources</span> <span class="attr">mapping</span>=<span class="string">&quot;/js/**&quot;</span> <span class="attr">location</span>=<span class="string">&quot;/js/&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--4 开启注解支持--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="3-3、编写页面"><a href="#3-3、编写页面" class="headerlink" title="3.3、编写页面"></a>3.3、编写页面</h2><blockquote><p>修改index.jsp</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;主页&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;a href=&quot;student/getAll&quot;&gt;查询所有学生&lt;/a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><blockquote><p>在WEB-INF/pages目录下创建一个list.jsp</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> isELIgnored=<span class="string">&quot;false&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;查询所有页面&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h3&gt;这是学生列表&lt;/h3&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h2 id="3-4、测试"><a href="#3-4、测试" class="headerlink" title="3.4、测试"></a>3.4、测试</h2><blockquote><p>在StudentController添加一方法，这个方法用于跳转到list.jsp页面</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/student&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getAll&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setViewName(<span class="string">&quot;list&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>配置tomcat</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210131140153.png" alt="image-20210131140153219"></p><blockquote><p>点击超链接后跳转成功，证明Springmvc基本配置完成</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210131140235.png" alt="image-20210131140235530"></p><h1 id="四、Spring整合Spring-MVC"><a href="#四、Spring整合Spring-MVC" class="headerlink" title="四、Spring整合Spring MVC"></a>四、Spring整合Spring MVC</h1><h2 id="4-1、配置监听器"><a href="#4-1、配置监听器" class="headerlink" title="4.1、配置监听器"></a>4.1、配置监听器</h2><blockquote><p>通过对 Spring MVC 的代码编写，我们知道，在服务器启动的时候就回去加载 springmvc.xml 这个配置，现在我们就需要继续在 web.xml 中配置，使得在项目启动的时候，就去加载applicationContext.xml的配置文件</p><p>所以我们可以在 <strong>web.xml</strong> 中，<strong>配置spring核心监听器</strong>，它默认会以 /WEB-INF/applicationContext.xml作为配置文件，这里需要注意web.xml文件中各个组件的存放位置</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--设置配置文件路径--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:applicationContext.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--配置 Spring 的监听器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="4-2、使用controller调用service"><a href="#4-2、使用controller调用service" class="headerlink" title="4.2、使用controller调用service"></a>4.2、使用controller调用service</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/student&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StudentService studentService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getAll&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;控制层的getAll方法...&quot;</span>);</span><br><span class="line">        studentService.getAllStudent();</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.setViewName(<span class="string">&quot;list&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-3、重新启动tomcat，测试"><a href="#4-3、重新启动tomcat，测试" class="headerlink" title="4.3、重新启动tomcat，测试"></a>4.3、重新启动tomcat，测试</h2><blockquote><p>在tomcat的VM options中填入：-Dfile.encoding=UTF-8，用于解决IDEA的控制台乱码问题</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210131141119.png" alt="image-20210131141119573"></p><h1 id="五、使用Spring整合Mybatis"><a href="#五、使用Spring整合Mybatis" class="headerlink" title="五、使用Spring整合Mybatis"></a>五、使用Spring整合Mybatis</h1><h2 id="5-1、编写Mybatis核心配置文件"><a href="#5-1、编写Mybatis核心配置文件" class="headerlink" title="5.1、编写Mybatis核心配置文件"></a>5.1、编写Mybatis核心配置文件</h2><blockquote><p>在resource目录下新建一个SqlMapConfig.xml，这个文件其实可以省略，但我们还是用它来编写类名简化配置。</p></blockquote><ul><li>创建SqlMapConfig.xml配置文件</li><li>扫描com.hzx包，为包下的实体类起一个别名，并在控制台输出执行的sql</li><li>与数据库连接相关的配置我们放在Spring的核心配置文件中配置。</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 打印查询语句 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;logImpl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;STDOUT_LOGGING&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.hzx&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="5-2、编写StudentMapper接口"><a href="#5-2、编写StudentMapper接口" class="headerlink" title="5.2、编写StudentMapper接口"></a>5.2、编写StudentMapper接口</h2><blockquote><p>使用注解形式编写sql语句，也可以使用xml配置文件的方式</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StudentMapper</span> </span>&#123;</span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 查询所有学生</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from `ssm`.`student`&quot;)</span></span><br><span class="line">    <span class="function">List&lt;Student&gt; <span class="title">getAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 向数据库中插入一个学生</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> student</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Insert(&quot;insert into `ssm`.`student`(name,score) values(#&#123;name&#125;,#&#123;score&#125;)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">addStudent</span><span class="params">(Student student)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-3、编写链接数据库的配置文件"><a href="#5-3、编写链接数据库的配置文件" class="headerlink" title="5.3、编写链接数据库的配置文件"></a>5.3、编写链接数据库的配置文件</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">jdbc.driver</span>=<span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"><span class="meta">jdbc.url</span>=<span class="string">jdbc:mysql://localhost:3306/ssm?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;nullCatalogMeansCurrent=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="meta">jdbc.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">jdbc.password</span>=<span class="string">tianxin1230.</span></span><br></pre></td></tr></table></figure><h2 id="5-4、修改Spring核心配置文件"><a href="#5-4、修改Spring核心配置文件" class="headerlink" title="5.4、修改Spring核心配置文件"></a>5.4、修改Spring核心配置文件</h2><blockquote><p>在Spring核心配置文件配置数据库连接池，引入properties文件</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;classpath:db.properties&quot;</span> <span class="attr">ignore-unresolvable</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!--配置数据库连接池--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 数据库基本信息配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.url&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置SqlSessionFactory工厂 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 配置StudentMapper接口所在包 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;mapperScanner&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;basePackage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.hzx.mapper&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="5-5、修改service实现类和controller层"><a href="#5-5、修改service实现类和controller层" class="headerlink" title="5.5、修改service实现类和controller层"></a>5.5、修改service实现类和controller层</h2><blockquote><p>service实现类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentServiceImpl</span> <span class="keyword">implements</span> <span class="title">StudentService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StudentMapper studentMapper;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Student&gt; <span class="title">getAllStudent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Service层的getAll方法，需要调用Mapper层与数据库交互.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> studentMapper.getAll();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addStudent</span><span class="params">(Student student)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Service层的addStudent方法，需要调用Mapper层与数据库交互.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> studentMapper.addStudent(student);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>controller层</p><p>修改getAll方法，并添加add方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/student&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StudentController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> StudentService studentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/getAll&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;控制层的getAll方法...&quot;</span>);</span><br><span class="line">        List&lt;Student&gt; students = studentService.getAllStudent();</span><br><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span><br><span class="line">        mv.addObject(<span class="string">&quot;students&quot;</span>,students);</span><br><span class="line">        mv.setViewName(<span class="string">&quot;list&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Student student, HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, IOException </span>&#123;</span><br><span class="line">        studentService.addStudent(student);</span><br><span class="line">        response.sendRedirect(request.getContextPath()+<span class="string">&quot;/student/getAll&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-6、修改index-jsp和"><a href="#5-6、修改index-jsp和" class="headerlink" title="5.6、修改index.jsp和"></a>5.6、修改index.jsp和</h2><blockquote><p>index.jsp</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;主页&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;a href=&quot;student/getAll&quot;&gt;查询所有学生&lt;/a&gt;</span><br><span class="line">    &lt;form action=<span class="string">&quot;student/add&quot;</span> method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">        学生姓名:&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;name&quot;</span>&gt;&lt;br/&gt;</span><br><span class="line">        学科成绩:&lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;score&quot;</span>&gt;&lt;br/&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;添加&quot;</span>/&gt;&lt;br/&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><blockquote><p>list.jsp</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ taglib prefix=<span class="string">&quot;c&quot;</span> uri=<span class="string">&quot;http://java.sun.com/jsp/jstl/core&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> isELIgnored=<span class="string">&quot;false&quot;</span> %&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;学生列表&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;h3&gt;学生列表&lt;/h3&gt;</span><br><span class="line">    &lt;c:forEach items=<span class="string">&quot;$&#123;students&#125;&quot;</span> <span class="keyword">var</span>=<span class="string">&quot;student&quot;</span>&gt;</span><br><span class="line">        $&#123;student.name&#125; 的成绩为: $&#123;student.score&#125;</span><br><span class="line">    &lt;/c:forEach&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><blockquote><p>测试查询所有学生方法</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210131143231.png" alt="image-20210131143231582"></p><blockquote><p>测试添加所有学生方法</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210131143459.png" alt="image-20210131143459450"></p><blockquote><p>结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210131144430.png" alt="image-20210131144429826"></p><h2 id="5-7、添加事务控制"><a href="#5-7、添加事务控制" class="headerlink" title="5.7、添加事务控制"></a>5.7、添加事务控制</h2><blockquote><p>修改spring核心配置文件</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--配置Spring框架声明式事务管理--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--配置事务管理器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--配置事务通知--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;txAdvice&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;find*&quot;</span> <span class="attr">read-only</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;*&quot;</span> <span class="attr">isolation</span>=<span class="string">&quot;DEFAULT&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--配置AOP增强--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;txAdvice&quot;</span> <span class="attr">pointcut</span>=<span class="string">&quot;execution(* cn.ideal.service.impl.*ServiceImpl.*(..))&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 框架学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 💎Mybatis </tag>
            
            <tag> 🍃Spring </tag>
            
            <tag> 🍃Spring MVC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java应用学习（二）-Springboot整合swagger/swagger-Bootstrap-UI使用</title>
      <link href="posts/2938255980.html"/>
      <url>posts/2938255980.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、Swagger及Swagger-Bootstrap-UI简介"><a href="#一、Swagger及Swagger-Bootstrap-UI简介" class="headerlink" title="一、Swagger及Swagger-Bootstrap-UI简介"></a>一、Swagger及Swagger-Bootstrap-UI简介</h1><h2 id="1-1、swagger简介"><a href="#1-1、swagger简介" class="headerlink" title="1.1、swagger简介"></a>1.1、swagger简介</h2><blockquote><p><a href="https://swagger.io/">Swagger</a> 是一款RESTFUL接口的、基于YAML、JSON语言的文档在线自动生成、代码自动生成的工具。是一个规范和完整的框架，用于生成、描述、调用和可视化 RESTful 风格的 Web 服务。</p><p>总体目标是使客户端和文件系统作为服务器以同样的速度来更新。文件的方法、参数和模型紧密集成到服务器端的代码，允许 API 来始终保持同步。Swagger 让部署管理和使用功能强大的 API 从未如此简单。</p></blockquote><h2 id="1-2、关于Swagger-Bootstrap-UI"><a href="#1-2、关于Swagger-Bootstrap-UI" class="headerlink" title="1.2、关于Swagger-Bootstrap-UI"></a>1.2、关于Swagger-Bootstrap-UI</h2><h3 id="1-2-1、简介"><a href="#1-2-1、简介" class="headerlink" title="1.2.1、简介"></a>1.2.1、简介</h3><blockquote><p><a href="https://gitee.com/xiaoym/swagger-bootstrap-ui">swagger-bootstrap-ui</a>是springfox-swagger的增强UI实现，为Java开发者在使用Swagger的时候，能拥有一份简洁、强大的接口文档体验。</p></blockquote><h3 id="1-2-2、核心功能"><a href="#1-2-2、核心功能" class="headerlink" title="1.2.2、核心功能"></a>1.2.2、核心功能</h3><blockquote><p>该UI增强包主要包括两大核心功能：<strong>文档说明</strong> 和 <strong>在线调试</strong></p><ul><li><p><strong>文档说明</strong>：根据Swagger的规范说明，详细列出接口文档的说明，包括接口地址、类型、请求示例、请求参数、响应示例、响应参数、响应码等信息，使用swagger-bootstrap-ui能根据该文档说明，对该接口的使用情况一目了然。</p></li><li><p><strong>在线调试</strong>：提供在线接口联调的强大功能，自动解析当前接口参数,同时包含表单验证，调用参数可返回接口响应内容、headers、Curl请求命令实例、响应时间、响应状态码等信息，帮助开发者在线调试，而不必通过其他测试工具测试接口是否正确,简介、强大。</p></li></ul></blockquote><h3 id="1-2-3、UI增强"><a href="#1-2-3、UI增强" class="headerlink" title="1.2.3、UI增强"></a>1.2.3、UI增强</h3><blockquote><p>同时，swagger-bootstrap-ui在满足以上功能的同时，还提供了文档的增强功能，这些功能是官方swagger-ui所没有的，每一个增强的功能都是贴合实际,考虑到开发者的实际开发需要,是比不可少的功能，主要包括：</p><ul><li><p><strong>个性化配置</strong>：通过个性化ui配置项，可自定义UI的相关显示信息</p></li><li><p><strong>离线文档</strong>：根据标准规范，生成的在线markdown离线文档，开发者可以进行拷贝生成markdown接口文档，通过其他第三方markdown转换工具转换成html或pdf，这样也可以放弃swagger2markdown组件</p></li><li><p><strong>接口排序</strong>：自1.8.5后，ui支持了接口排序功能，例如一个注册功能主要包含了多个步骤,可以根据swagger-bootstrap-ui提供的接口排序规则实现接口的排序，step化接口操作，方便其他开发者进行接口对接</p></li></ul></blockquote><h3 id="1-2-4、UI特点"><a href="#1-2-4、UI特点" class="headerlink" title="1.2.4、UI特点"></a>1.2.4、UI特点</h3><blockquote><ul><li>以markdown形式展示文档,将文档的请求地址、类型、请求参数、示例、响应参数分层次依次展示,接口文档一目了然,方便开发者对接</li><li>在线调试栏除了自动解析参数外,针对必填项着颜色区分,同时支持tab键快速输入上下切换.调试时可自定义Content-Type请求头类型</li><li>个性化配置项,支持接口地址、接口description属性、UI增强等个性化配置功能</li><li>接口排序,支持分组及接口的排序功能</li><li>支持markdown文档离线文档导出,也可在线查看离线文档</li><li>调试信息全局缓存,页面刷新后依然存在,方便开发者调试</li><li>以更人性化的treetable组件展示Swagger Models功能</li><li>响应内容可全屏查看,针对响应内容很多的情况下，全屏查看，方便调试、复制</li><li>文档以多tab方式可显示多个接口文档</li><li>请求参数栏请求类型、是否必填着颜色区分</li><li>主页中粗略统计接口不同类型数量</li><li>支持接口在线搜索功能</li><li>左右菜单和内容页可自由拖动宽度</li><li>支持自定义全局参数功能，主页包括header及query两种类型</li><li>i18n国际化支持,目前支持：中文简体、中文繁体、英文</li><li>JSR-303 annotations 注解的支持</li></ul></blockquote><h1 id="二、Spring-boot整合Swagger-Bootstrap-UI"><a href="#二、Spring-boot整合Swagger-Bootstrap-UI" class="headerlink" title="二、Spring-boot整合Swagger-Bootstrap-UI"></a>二、Spring-boot整合Swagger-Bootstrap-UI</h1><blockquote><p>使用上次复习Mybatis-Plus时建立的项目，在该项目的基础上对Swagger-Bootstrap-ui进行初步学习。</p></blockquote><h2 id="2-1、引入依赖、编写配置类"><a href="#2-1、引入依赖、编写配置类" class="headerlink" title="2.1、引入依赖、编写配置类"></a>2.1、引入依赖、编写配置类</h2><blockquote><p>如果使用原有的swagger，那么需要引入的依赖有</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--swagger--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.swagger<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>如果使用swagger-bootstrap-ui，那么只需要引入下面两个依赖即可</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--swagger--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-bootstrap-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>在config包下新建一个配置类</p><p>与普通swagger的配置类相比，swagger-bootstap-ui的配置类多了一个@EnableSwaggerBootstrapUI注解</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableSwagger2</span></span><br><span class="line"><span class="meta">@EnableSwaggerBootstrapUI</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SwaggerConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Docket <span class="title">webApiConfig</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Docket(DocumentationType.SWAGGER_2)</span><br><span class="line">                .groupName(<span class="string">&quot;webApi&quot;</span>)</span><br><span class="line">                .apiInfo(webApiInfo())</span><br><span class="line">                .select()</span><br><span class="line">                .paths(Predicates.not(PathSelectors.regex(<span class="string">&quot;/admin/.*&quot;</span>)))</span><br><span class="line">                .paths(Predicates.not(PathSelectors.regex(<span class="string">&quot;/error.*&quot;</span>)))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ApiInfo <span class="title">webApiInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ApiInfoBuilder()</span><br><span class="line">                .title(<span class="string">&quot;测试API&quot;</span>)</span><br><span class="line">                .description(<span class="string">&quot;本文档描述了课程中心微服务接口定义&quot;</span>)</span><br><span class="line">                .version(<span class="string">&quot;1.0&quot;</span>)</span><br><span class="line">                .contact(<span class="keyword">new</span> Contact(<span class="string">&quot;蔡大头&quot;</span>, <span class="string">&quot;http://wuhuqifei.com&quot;</span>, <span class="string">&quot;763882220@qq.com&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-2、编写Controller并使用注解来添加信息"><a href="#2-2、编写Controller并使用注解来添加信息" class="headerlink" title="2.2、编写Controller并使用注解来添加信息"></a>2.2、编写Controller并使用注解来添加信息</h2><h3 id="2-2-1、UserController"><a href="#2-2-1、UserController" class="headerlink" title="2.2.1、UserController"></a>2.2.1、UserController</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;用户管理控制器&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据用户id获取用户信息&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUserById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.getById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;addUser&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;添加用户对象&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.save(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping(&quot;update&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;修改用户信息&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.saveOrUpdate(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;根据id删除用户&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">deleteUser</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.removeById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;findAll&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">getAllUser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userService.list();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-2-2、常用注解说明"><a href="#2-2-2、常用注解说明" class="headerlink" title="2.2.2、常用注解说明"></a>2.2.2、常用注解说明</h3><blockquote><p>swagger及swagger-bootstrap-ui的常用注解有两个，分别为@Api与@ApiOperation</p></blockquote><ul><li>@Api</li></ul><blockquote><p>这个注解用于Controller类上，可以使用该注解的tags属性来为控制器添加备注</p></blockquote><ul><li>@ApiOperation</li></ul><blockquote><p>这个注解用于控制器的方法上，用于给控制器的具体方法添加注解</p></blockquote><h2 id="2-3、使用"><a href="#2-3、使用" class="headerlink" title="2.3、使用"></a>2.3、使用</h2><h3 id="2-3-1、在主启动类中添加注解，将swagger配置类纳入被扫描范围"><a href="#2-3-1、在主启动类中添加注解，将swagger配置类纳入被扫描范围" class="headerlink" title="2.3.1、在主启动类中添加注解，将swagger配置类纳入被扫描范围"></a>2.3.1、在主启动类中添加注解，将swagger配置类纳入被扫描范围</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan(&quot;com.hzx.mpblog.mapper&quot;)</span></span><br><span class="line"><span class="meta">@ComponentScan(&quot;com.hzx.mpblog&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MpApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MpApplication.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;http://localhost:8848/doc.html&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;http://localhost:8848/swagger-ui.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在主启动类的两个输出语句中，<a href="http://localhost:8848/doc.html%E6%98%AFswagger-bootstrap-ui%E7%9A%84%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80%E3%80%82">http://localhost:8848/doc.html是swagger-bootstrap-ui的访问地址。</a></p><p><a href="http://localhost:8848/swagger-ui.html%E6%98%AFswagger%E7%9A%84%E8%AE%BF%E9%97%AE%E5%9C%B0%E5%9D%80%E3%80%82">http://localhost:8848/swagger-ui.html是swagger的访问地址。</a></p></blockquote><h3 id="2-3-2、启动主启动类"><a href="#2-3-2、启动主启动类" class="headerlink" title="2.3.2、启动主启动类"></a>2.3.2、启动主启动类</h3><blockquote><p>分别进入两个链接中查看效果</p></blockquote><ul><li>swagger</li></ul><blockquote><p>主页面说明</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153717308.png" alt="image-20210129153717308"></p><blockquote><p>点击方法进入方法说明及测试界面，点击try it out</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153734979.png" alt="image-20210129153734979"></p><blockquote><p>在参数输入框中输入参数，点击execute执行方法</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153751549.png" alt="image-20210129153751549"></p><blockquote><p>测试结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153803544.png" alt="image-20210129153803544"></p><ul><li>swagger-bootstrap-ui</li></ul><blockquote><p>主页面说明</p><p>swagger-bootstrap-ui将测试页面与方法说明页面分开，在</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153813279.png" alt="image-20210129153813279"></p><blockquote><p>方法说明</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153821304.png" alt="image-20210129153821304"></p><blockquote><p>方法测试</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153830894.png" alt="image-20210129153830894"></p><blockquote><p>测试结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153838469.png" alt="image-20210129153838469"></p>]]></content>
      
      
      <categories>
          
          <category> 框架学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java应用学习（一）-Mybatis-plus框架</title>
      <link href="posts/2091692756.html"/>
      <url>posts/2091692756.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="一、MP简介"><a href="#一、MP简介" class="headerlink" title="一、MP简介"></a>一、MP简介</h1><blockquote><p><a href="https://github.com/baomidou/mybatis-plus">MyBatis-Plus</a>（简称 MP）是一个 <a href="http://www.mybatis.org/mybatis-3/">MyBatis</a> 的增强工具，在 MyBatis 的基础上只做增强不做改变，为简化开发、提高效率而生。</p></blockquote><h2 id="1-1、特性"><a href="#1-1、特性" class="headerlink" title="1.1、特性"></a>1.1、特性</h2><ul><li><strong>无侵入</strong>：只做增强不做改变，引入它不会对现有工程产生影响，如丝般顺滑</li><li><strong>损耗小</strong>：启动即会自动注入基本 CURD，性能基本无损耗，直接面向对象操作</li><li><strong>强大的 CRUD 操作</strong>：内置通用 Mapper、通用 Service，仅仅通过少量配置即可实现单表大部分 CRUD 操作，更有强大的条件构造器，满足各类使用需求</li><li><strong>支持 Lambda 形式调用</strong>：通过 Lambda 表达式，方便的编写各类查询条件，无需再担心字段写错</li><li><strong>支持主键自动生成</strong>：支持多达 4 种主键策略（内含分布式唯一 ID 生成器 - Sequence），可自由配置，完美解决主键问题</li><li><strong>支持 ActiveRecord 模式</strong>：支持 ActiveRecord 形式调用，实体类只需继承 Model 类即可进行强大的 CRUD 操作</li><li><strong>支持自定义全局通用操作</strong>：支持全局通用方法注入（ Write once, use anywhere ）</li><li><strong>内置代码生成器</strong>：采用代码或者 Maven 插件可快速生成 Mapper 、 Model 、 Service 、 Controller 层代码，支持模板引擎，更有超多自定义配置等您来使用</li><li><strong>内置分页插件</strong>：基于 MyBatis 物理分页，开发者无需关心具体操作，配置好插件之后，写分页等同于普通 List 查询</li><li><strong>分页插件支持多种数据库</strong>：支持 MySQL、MariaDB、Oracle、DB2、H2、HSQL、SQLite、Postgre、SQLServer 等多种数据库</li><li><strong>内置性能分析插件</strong>：可输出 Sql 语句以及其执行时间，建议开发测试时启用该功能，能快速揪出慢查询</li><li><strong>内置全局拦截插件</strong>：提供全表 delete 、 update 操作智能分析阻断，也可自定义拦截规则，预防误操作</li></ul><h2 id="1-2、支持的数据库"><a href="#1-2、支持的数据库" class="headerlink" title="1.2、支持的数据库"></a>1.2、支持的数据库</h2><blockquote><p>任何能使用 mybatis 进行 crud, 并且支持标准 sql 的数据库</p></blockquote><h1 id="二、快速入门"><a href="#二、快速入门" class="headerlink" title="二、快速入门"></a>二、快速入门</h1><blockquote><p>使用一个springboot项目来体验MP的强大之处。</p></blockquote><h2 id="2-1、建立入门项目的数据库与项目"><a href="#2-1、建立入门项目的数据库与项目" class="headerlink" title="2.1、建立入门项目的数据库与项目"></a>2.1、建立入门项目的数据库与项目</h2><blockquote><p>建表</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">create database mp;</span><br><span class="line">use mp;</span><br><span class="line"></span><br><span class="line">create table user(</span><br><span class="line">    id bigint(20) primary key auto_increment,</span><br><span class="line">    name varchar(50),</span><br><span class="line">    email varchar(50),</span><br><span class="line">    age int</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">insert into</span><br><span class="line">    user(name, email, age)</span><br><span class="line">VALUES</span><br><span class="line">       (&#39;A&#39;,&#39;a@qq.com&#39;,18),</span><br><span class="line">       (&#39;B&#39;,&#39;b@qq.com&#39;,19),</span><br><span class="line">       (&#39;C&#39;,&#39;c@qq.com&#39;,12),</span><br><span class="line">       (&#39;D&#39;,&#39;d@qq.com&#39;,11),</span><br><span class="line">       (&#39;E&#39;,&#39;e@qq.com&#39;,111);</span><br></pre></td></tr></table></figure><blockquote><p>建立spring-boot项目，引入依赖</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.19<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>项目的application.yml配置文件如下</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/mp?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;nullCatalogMeansCurrent=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">tianxin1230.</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br></pre></td></tr></table></figure><blockquote><p>编写主启动类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MapperScan(&quot;com.hzx.mpblog.mapper&quot;)</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MpApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MpApplication.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>根据数据库表建立对应entity实体类，这里使用Lombok插件并开启链式编程来简化开发</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>编写UserMapper接口，该接口需要继承BaseMapper&lt; T &gt;，其中T为要操作的数据库表对应的实体类</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">User</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2-2、编写测试类进行测试"><a href="#2-2、编写测试类进行测试" class="headerlink" title="2.2、编写测试类进行测试"></a>2.2、编写测试类进行测试</h2><blockquote><p>编写测试类，测试mybatis-plus为我们提供的查询所有方法</p></blockquote><ul><li>在selectList中，可以传入一个QueryWrapper查询条件构造器对象，但由于这里需要查询所有对象，所以不加条件筛选，传入null</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MpApplicationTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFindAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        List&lt;User&gt; userList = userMapper.selectList(<span class="keyword">null</span>);</span><br><span class="line">        userList.forEach(user -&gt;</span><br><span class="line">            System.out.println(user)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153047772.png" alt="image-20210129153047772"></p><h2 id="2-3、添加配置输出sql语句"><a href="#2-3、添加配置输出sql语句" class="headerlink" title="2.3、添加配置输出sql语句"></a>2.3、添加配置输出sql语句</h2><blockquote><p>我们可以在application.yml中添加配置，让mybatis-plus在执行时输出的sql语句</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打印sql语句</span></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br></pre></td></tr></table></figure><blockquote><p>重新启动，测试结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153056405.png" alt="image-20210129153056405"></p><h1 id="三、CRUD扩展"><a href="#三、CRUD扩展" class="headerlink" title="三、CRUD扩展"></a>三、CRUD扩展</h1><h2 id="3-1、insert测试插入数据"><a href="#3-1、insert测试插入数据" class="headerlink" title="3.1、insert测试插入数据"></a>3.1、insert测试插入数据</h2><blockquote><p>使用Mybatis-plus自带的插入方法进行测试</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setName(<span class="string">&quot;小明&quot;</span>)</span><br><span class="line">            .setAge(<span class="number">18</span>)</span><br><span class="line">            .setEmail(<span class="string">&quot;xiaoming@qq.com&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> result = userMapper.insert(user);</span><br><span class="line">    System.out.println(result == <span class="number">1</span> ? <span class="string">&quot;插入成功！&quot;</span> : <span class="string">&quot;插入失败！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>查看testInsert()的执行结果并再次启动testFindAll()方法</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153116620.png" alt="image-20210129153116620"></p><blockquote><p>在这次插入操作中，我们没有指定插入数据库对象的id，这个属性是Mybatis-plus为我们生成的，Mybatis-plus提供的主键生成策略在枚举类IdType中.</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">IdType</span> </span>&#123;</span><br><span class="line">    AUTO(<span class="number">0</span>),</span><br><span class="line">    NONE(<span class="number">1</span>),</span><br><span class="line">    INPUT(<span class="number">2</span>),</span><br><span class="line">    ID_WORKER(<span class="number">3</span>),</span><br><span class="line">    UUID(<span class="number">4</span>),</span><br><span class="line">    ID_WORKER_STR(<span class="number">5</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-1-1、雪花算法"><a href="#3-1-1、雪花算法" class="headerlink" title="3.1.1、雪花算法"></a>3.1.1、雪花算法</h3><blockquote><ul><li>雪花算法是推特开源的分布式ID生成算法，结果是一个long型的ID。</li><li>核心思想是：使用41bit作为毫秒数，10bit作为及其的ID（5个bit是数据中心，5个bit的及其ID），12bit作为毫秒的流水号（意味着每个节点在每秒可以产生4096个Id），最后还有一个符号位永远是0</li></ul></blockquote><h3 id="3-1-2、主键自增"><a href="#3-1-2、主键自增" class="headerlink" title="3.1.2、主键自增"></a>3.1.2、主键自增</h3><blockquote><p>配置主键自增</p><ul><li>在实体类字段上使用@TableId(type = IdType.AUTO)</li><li>要求数据库字段一定是自增的，否则会报错</li></ul></blockquote><h3 id="3-1-3、其余主键类型"><a href="#3-1-3、其余主键类型" class="headerlink" title="3.1.3、其余主键类型"></a>3.1.3、其余主键类型</h3><blockquote><p>AUTO(0)：自增<br>NONE(1)：不使用<br>INPUT(2)：手动输入<br>ID_WORKER(3)：默认唯一全局id<br>UUID(4)：uuid<br>ID_WORKER_STR(5)：默认唯一全局id字符串形式</p></blockquote><h2 id="3-2、update更新操作"><a href="#3-2、update更新操作" class="headerlink" title="3.2、update更新操作"></a>3.2、update更新操作</h2><blockquote><p>使用mybatis-plus提供的updateById方法可以快速修改表中数据，更新Id为2L的对象信息</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setId(<span class="number">2L</span>)</span><br><span class="line">        .setName(<span class="string">&quot;芜湖&quot;</span>)</span><br><span class="line">        .setEmail(<span class="string">&quot;wuhu@qq.com&quot;</span>)</span><br><span class="line">        .setAge(<span class="number">18</span>);</span><br><span class="line">    <span class="keyword">int</span> result = userMapper.updateById(user);</span><br><span class="line">    System.out.println(result == <span class="number">1</span> ? <span class="string">&quot;修改成功！&quot;</span> : <span class="string">&quot;修改失败！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>查看结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153136022.png" alt="image-20210129153136022"></p><h2 id="3-3、Mybatis-plus的自动填充功能"><a href="#3-3、Mybatis-plus的自动填充功能" class="headerlink" title="3.3、Mybatis-plus的自动填充功能"></a>3.3、Mybatis-plus的自动填充功能</h2><blockquote><p>在实际开发中，数据库往往有create_time和update_time两个字段，对于这两个字段，我们不希望手动填充，而希望程序或者数据库自动填充，mp提供了这个功能。</p><p>在数据库中添加create_time和update_time两个属性，并在实体类中添加对于字段。</p></blockquote><h3 id="3-3-1、数据库级别填充"><a href="#3-3-1、数据库级别填充" class="headerlink" title="3.3.1、数据库级别填充"></a>3.3.1、数据库级别填充</h3><blockquote><p>在新建的两个属性下面勾选根据时间戳自动更新即可，这种方式不推荐使用</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153147791.png" alt="image-20210129153147791"></p><h3 id="3-3-2、代码级别自动填充"><a href="#3-3-2、代码级别自动填充" class="headerlink" title="3.3.2、代码级别自动填充"></a>3.3.2、代码级别自动填充</h3><ul><li>在实体类的createTime和updateTime字段上添加注解</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Accessors(chain = true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String email;</span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 字段添加时填充内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(fill = FieldFill.INSERT)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 字段添加/更新时填充内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@TableField(fill = FieldFill.INSERT_UPDATE)</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>编写一个处理器用于处理这两个注解</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMetaObjectHandler</span> <span class="keyword">implements</span> <span class="title">MetaObjectHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">//插入时的填充策略</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setFieldValByName(<span class="string">&quot;createTime&quot;</span>,<span class="keyword">new</span> Date(),metaObject);</span><br><span class="line">        <span class="keyword">this</span>.setFieldValByName(<span class="string">&quot;updateTime&quot;</span>,<span class="keyword">new</span> Date(),metaObject);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新时的填充策略</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setFieldValByName(<span class="string">&quot;updateTime&quot;</span>,<span class="keyword">new</span> Date(),metaObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>在主启动类中添加组件扫描注解</li><li>测试插入，查看是否自动填充</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInsert</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setName(<span class="string">&quot;小明111&quot;</span>)</span><br><span class="line">            .setAge(<span class="number">18</span>)</span><br><span class="line">            .setEmail(<span class="string">&quot;xiaoming@qq.com&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> result = userMapper.insert(user);</span><br><span class="line">    System.out.println(result == <span class="number">1</span> ? <span class="string">&quot;插入成功！&quot;</span> : <span class="string">&quot;插入失败！&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setId(<span class="number">2L</span>)</span><br><span class="line">        .setName(<span class="string">&quot;芜湖222&quot;</span>)</span><br><span class="line">        .setEmail(<span class="string">&quot;wuhu@qq.com&quot;</span>)</span><br><span class="line">        .setAge(<span class="number">18</span>);</span><br><span class="line">    <span class="keyword">int</span> result = userMapper.updateById(user);</span><br><span class="line">    System.out.println(result == <span class="number">1</span> ? <span class="string">&quot;修改成功！&quot;</span> : <span class="string">&quot;修改失败！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>启动testFindAll方法查看结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153158628.png" alt="image-20210129153158628"></p><ul><li>自动填充使用成功。</li></ul><h2 id="3-4、乐观锁和悲观锁"><a href="#3-4、乐观锁和悲观锁" class="headerlink" title="3.4、乐观锁和悲观锁"></a>3.4、乐观锁和悲观锁</h2><blockquote><p>悲观锁十分悲观，他总是认为会出现问题，无论干什么都会上锁！</p><p>而乐观锁十分乐观，他总是认为不会出现问题，无论干什么都不去上锁！如果出现了问题，再次更新值测试。</p><p>下面介绍Mybatis-plus中乐观锁的实现方法</p></blockquote><h3 id="3-4-1、乐观锁的实现方式"><a href="#3-4-1、乐观锁的实现方式" class="headerlink" title="3.4.1、乐观锁的实现方式"></a>3.4.1、乐观锁的实现方式</h3><blockquote><p>取出记录时，获取当前version</p><p>更新时带上这个version</p><p>执行更新时，set version = newVersion where version = oldVersion</p><p>如果version不对，就更新失败</p></blockquote><ul><li>例子</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 乐观锁：</span><br><span class="line"># 1 先查询，获得版本号version &#x3D; 1</span><br><span class="line"># 假设现有AB两个线程在执行这条update语句，当A未执行完成时，B抢先完成这次更新，那么此时由于版本号version已经为2，所以A线程的更新工作不会成功，此时就保证了线程间的通讯安全</span><br><span class="line"></span><br><span class="line">update user set name &#x3D; &quot;芜湖&quot;,version &#x3D; version + 1 where id &#x3D; 2 and version &#x3D; 1;</span><br></pre></td></tr></table></figure><blockquote><p>给数据库表中添加一个version属性</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153213565.png" alt="image-20210129153213565"></p><blockquote><p>给实体类中添加一个version字段，同时在上面添加一个@Version注解，表明这是一个乐观锁</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Version</span></span><br><span class="line"><span class="keyword">private</span> Integer version;</span><br></pre></td></tr></table></figure><blockquote><p>在配置类中注册乐观锁组件</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBatisPlusConfig</span>  </span>&#123;</span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 注册乐观锁插件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OptimisticLockerInterceptor <span class="title">optimisticLockerInterceptor</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OptimisticLockerInterceptor();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-5、select查询操作"><a href="#3-5、select查询操作" class="headerlink" title="3.5、select查询操作"></a>3.5、select查询操作</h2><h3 id="3-5-1、根据id查询数据"><a href="#3-5-1、根据id查询数据" class="headerlink" title="3.5.1、根据id查询数据"></a>3.5.1、根据id查询数据</h3><blockquote><p>根据传入的主键值查询数据</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelectById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user = userMapper.selectById(<span class="number">1L</span>);</span><br><span class="line">    System.out.println(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153228587.png" alt="image-20210129153228587"></p><h3 id="3-5-2、根据集合对象查询数据"><a href="#3-5-2、根据集合对象查询数据" class="headerlink" title="3.5.2、根据集合对象查询数据"></a>3.5.2、根据集合对象查询数据</h3><blockquote><p>传入一个主键集合，根据传入的多个主键值查询多条数据，使用selectBatchIds方法，该方法实际上使用mysql中的in关键字</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelectByIds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectBatchIds(Arrays.asList(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">5L</span>));</span><br><span class="line">    users.forEach(user -&gt;</span><br><span class="line">        System.out.println(user)</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153239557.png" alt="image-20210129153239557"></p><h3 id="3-5-3、根据Map对象查询数据"><a href="#3-5-3、根据Map对象查询数据" class="headerlink" title="3.5.3、根据Map对象查询数据"></a>3.5.3、根据Map对象查询数据</h3><blockquote><p>传入一个map，mp将会以键为字段，值为字段值进行拼接并查询，如果map中有多个键值对，那么会以and关键词拼接</p></blockquote><ul><li>当map中只有一个键值对时</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelectByMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;id&quot;</span>,<span class="number">1L</span>);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectByMap(map);</span><br><span class="line">    users.forEach(user -&gt; System.out.println(user));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153248616.png" alt="image-20210129153248616"></p><ul><li>当map中包含多个键值对时</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSelectByMaps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    map.put(<span class="string">&quot;id&quot;</span>,<span class="number">2L</span>);</span><br><span class="line">    map.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;芜湖222&quot;</span>);</span><br><span class="line">    List&lt;User&gt; users = userMapper.selectByMap(map);</span><br><span class="line">    users.forEach(user -&gt; System.out.println(user));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153259081.png" alt="image-20210129153259081"></p><h3 id="3-5-4、分页查询"><a href="#3-5-4、分页查询" class="headerlink" title="3.5.4、分页查询"></a>3.5.4、分页查询</h3><blockquote><p>一般来说，分页查询的实现有以下几种方式</p><ul><li>使用limit关键字进行分页</li><li>使用PageHelper和PageInfo等第三方插件进行分页</li><li>使用Mybatis-plus自带的分页插件进行分页</li></ul><p>下面介绍mp的分页插件</p></blockquote><ul><li>在mybatis-plus配置类中配置拦截器组件</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 第一个参数：当前页</span></span><br><span class="line"><span class="comment">     * 第二个参数：每页数据条数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Page&lt;User&gt; page = <span class="keyword">new</span> Page&lt;&gt;(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//使用Mybatis-plus提供的selectPage方法，传入分页对象page</span></span><br><span class="line">    IPage&lt;User&gt; userIPage = userMapper.selectPage(page, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">//得到的Page对象中，records属性就是需要的集合，该集合中包含了查询的结果</span></span><br><span class="line">    List&lt;User&gt; records = userIPage.getRecords();</span><br><span class="line">    records.forEach(user -&gt; System.out.println(user));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153308347.png" alt="image-20210129153308347"></p><h3 id="3-5-5、分页插件Page属性简介"><a href="#3-5-5、分页插件Page属性简介" class="headerlink" title="3.5.5、分页插件Page属性简介"></a>3.5.5、分页插件Page属性简介</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Page</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">IPage</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;T&gt; records;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> total;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> size;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> current;</span><br><span class="line">    <span class="keyword">private</span> String[] ascs;</span><br><span class="line">    <span class="keyword">private</span> String[] descs;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> optimizeCountSql;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isSearchCount;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure><blockquote><ul><li>List<T> records–用来存放查询出来的数据</li><li>long total–返回记录的总数</li><li>long size–每页显示条数，默认 10</li><li>long current–当前页,默认1</li><li>String[] ascs–升序字段集合</li><li>String[] descs–降序字段集合</li><li>boolean optimizeCountSql–自动优化count  sql，默认为true</li><li>boolean isSearchCount–是否进行count查询，默认为true</li></ul></blockquote><h2 id="3-6、delete删除操作"><a href="#3-6、delete删除操作" class="headerlink" title="3.6、delete删除操作"></a>3.6、delete删除操作</h2><h3 id="3-6-1、根据id删除记录"><a href="#3-6-1、根据id删除记录" class="headerlink" title="3.6.1、根据id删除记录"></a>3.6.1、根据id删除记录</h3><blockquote><p>使用mp提供的deleteById方法，返回值为数据库表中受影响数据条数</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = userMapper.deleteById(<span class="number">1L</span>);</span><br><span class="line">    System.out.println(result == <span class="number">1</span> ? <span class="string">&quot;删除成功！&quot;</span> : <span class="string">&quot;删除失败！&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153320211.png" alt="image-20210129153320211"></p><h3 id="3-6-2、通过传入的集合对象进行批量删除"><a href="#3-6-2、通过传入的集合对象进行批量删除" class="headerlink" title="3.6.2、通过传入的集合对象进行批量删除"></a>3.6.2、通过传入的集合对象进行批量删除</h3><blockquote><p>使用mp提供的deleteBatchIds方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteByIds</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = userMapper.deleteBatchIds(Arrays.asList(<span class="number">2L</span>,<span class="number">3L</span>,<span class="number">1L</span>));</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果：由于数据库中id为1L的数据不存在，所以影响的数据条数只有两条，与批量插入一样，使用了mysql中的In关键字</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153331310.png" alt="image-20210129153331310"></p><h3 id="3-6-3、通过传入的map进行删除"><a href="#3-6-3、通过传入的map进行删除" class="headerlink" title="3.6.3、通过传入的map进行删除"></a>3.6.3、通过传入的map进行删除</h3><blockquote><p>与通过map进行查询类似，当有多个键值对时，使用and拼接</p></blockquote><ul><li>只有一个键值对时</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteByMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap();</span><br><span class="line">    map.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;E&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> result = userMapper.deleteByMap(map);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153341026.png" alt="image-20210129153341026"></p><ul><li>传入多个键值对时</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDeleteByMaps</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap();</span><br><span class="line">    map.put(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;小明&quot;</span>);</span><br><span class="line">    map.put(<span class="string">&quot;age&quot;</span>,<span class="number">18</span>);</span><br><span class="line">    <span class="keyword">int</span> result = userMapper.deleteByMap(map);</span><br><span class="line">    System.out.println(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153354773.png" alt="image-20210129153354773"></p><h2 id="3-7、配置逻辑删除"><a href="#3-7、配置逻辑删除" class="headerlink" title="3.7、配置逻辑删除"></a>3.7、配置逻辑删除</h2><blockquote><p>逻辑删除：在数据库中没有被移除，只是使用一个变量来使这一条记录失效</p><p>物理删除：从数据库中直接移除</p><p>管理员可以查看被删除的记录，类似于回收站</p></blockquote><h3 id="3-7-1、配置步骤"><a href="#3-7-1、配置步骤" class="headerlink" title="3.7.1、配置步骤"></a>3.7.1、配置步骤</h3><blockquote><p>在表中添加一个deleted字段，</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153422780.png" alt="image-20210129153422780"></p><blockquote><p>在实体类中添加一个deleted字段，并添加注解</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 逻辑删除字段</span></span><br><span class="line"><span class="comment"> * 添加一个逻辑删除注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@TableLogic</span></span><br><span class="line"><span class="keyword">private</span> Integer deleted;</span><br></pre></td></tr></table></figure><blockquote><p>配置逻辑删除组件</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//配置逻辑删除组件</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ISqlInjector <span class="title">sqlInjector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LogicSqlInjector();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在application.yml文件中配置</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">global-config:</span></span><br><span class="line">    <span class="attr">db-config:</span></span><br><span class="line">      <span class="attr">logic-delete-value:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">logic-not-delete-value:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><ul><li>当deleted值为1时，证明该数据被逻辑删除</li><li>当deleted值为0时，证明该数据没有被逻辑删除</li></ul><h3 id="3-7-2、测试逻辑删除"><a href="#3-7-2、测试逻辑删除" class="headerlink" title="3.7.2、测试逻辑删除"></a>3.7.2、测试逻辑删除</h3><blockquote><p>先在数据库中新插入几条数据，以便后面的测试</p></blockquote><ul><li>逻辑删除id为3L的数据</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLoginDeleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = userMapper.deleteById(<span class="number">3L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果：使用了update语句</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153433435.png" alt="image-20210129153433435"></p><h1 id="四、性能分析插件"><a href="#四、性能分析插件" class="headerlink" title="四、性能分析插件"></a>四、性能分析插件</h1><blockquote><p>我们在平时开发中，会遇到一些慢sql，mp提供了一个性能分析插件，如果超过指定时间，就停止运行</p></blockquote><h2 id="4-1、作用"><a href="#4-1、作用" class="headerlink" title="4.1、作用"></a>4.1、作用</h2><blockquote><p>性能分析拦截器，用于输出每条sql语句及其执行时间</p></blockquote><h2 id="4-2、使用"><a href="#4-2、使用" class="headerlink" title="4.2、使用"></a>4.2、使用</h2><blockquote><p>在application.yml中配置开发环境，将当前环境设置为dev</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure><blockquote><p>在配置类中配置sql执行效率分析插件</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * sql执行效率分析插件</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Profile</span>(&#123;&quot;dev&quot;,&quot;test&quot;&#125;)表示此插件只在生产和测试环境下使用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Profile(&#123;&quot;dev&quot;,&quot;test&quot;&#125;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PerformanceInterceptor <span class="title">performanceInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    PerformanceInterceptor performanceInterceptor = <span class="keyword">new</span> PerformanceInterceptor();</span><br><span class="line">    <span class="comment">//设置sql执行的最大时间，如果超过这个时间就不执行</span></span><br><span class="line">    performanceInterceptor.setMaxTime(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//设置格式化SQL语句（美化）</span></span><br><span class="line">    performanceInterceptor.setFormat(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> performanceInterceptor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-3、测试"><a href="#4-3、测试" class="headerlink" title="4.3、测试"></a>4.3、测试</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpdateAndSelect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    User user = <span class="keyword">new</span> User();</span><br><span class="line">    user.setId(<span class="number">1L</span>);</span><br><span class="line">    user.setName(<span class="string">&quot;芜湖&quot;</span>);</span><br><span class="line">    user.setEmail(<span class="string">&quot;wuhu@qq.com&quot;</span>);</span><br><span class="line">    user.setAge(<span class="number">1222</span>);</span><br><span class="line">    <span class="keyword">int</span> result = userMapper.updateById(user);</span><br><span class="line"></span><br><span class="line">    System.out.println(result);</span><br><span class="line">    List&lt;User&gt; userList = userMapper.selectList(<span class="keyword">null</span>);</span><br><span class="line">    userList.forEach(System.out :: println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果–报告该sql超时</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153444986.png" alt="image-20210129153444986"></p><blockquote><p>将最大时间设置为100ms，再次测试，修改       performanceInterceptor.setMaxTime(100);</p></blockquote><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153458241.png" alt="image-20210129153458241"></p><h1 id="五、条件构造器Wrapper"><a href="#五、条件构造器Wrapper" class="headerlink" title="五、条件构造器Wrapper"></a>五、条件构造器Wrapper</h1><blockquote><p>Wrapper是一个接口，我们使用Wrapper的实现类：QueryWrapper来实现条件构造</p></blockquote><h2 id="5-1、QueryWrapper的一些方法"><a href="#5-1、QueryWrapper的一些方法" class="headerlink" title="5.1、QueryWrapper的一些方法"></a>5.1、QueryWrapper的一些方法</h2><h3 id="5-1-1、isNotNull-“列名”"><a href="#5-1-1、isNotNull-“列名”" class="headerlink" title="5.1.1、isNotNull(“列名”)"></a>5.1.1、isNotNull(“列名”)</h3><blockquote><p>这个字段的值不为空</p></blockquote><h3 id="5-1-2、ge-eq-ne-le-gt-lt-“列名”-值"><a href="#5-1-2、ge-eq-ne-le-gt-lt-“列名”-值" class="headerlink" title="5.1.2、ge/eq/ne/le/gt/lt(“列名”,值)"></a>5.1.2、ge/eq/ne/le/gt/lt(“列名”,值)</h3><blockquote><p>这个字段的值必须大于等于/等于/不等于/小于等于/严格大于/严格小于传入的值</p></blockquote><h3 id="5-1-3、between-“列名”-左边值-右边值"><a href="#5-1-3、between-“列名”-左边值-右边值" class="headerlink" title="5.1.3、between(“列名”,左边值,右边值)"></a>5.1.3、between(“列名”,左边值,右边值)</h3><blockquote><p>这个属性的值必须在左边值和右边值之间</p></blockquote><h3 id="5-1-4、notLike-“列名”-值"><a href="#5-1-4、notLike-“列名”-值" class="headerlink" title="5.1.4、notLike(“列名”,值)"></a>5.1.4、notLike(“列名”,值)</h3><blockquote><p>字段值 not like “%值%”</p></blockquote><h3 id="5-1-5、likeLeft-likeRight-“列名”-值"><a href="#5-1-5、likeLeft-likeRight-“列名”-值" class="headerlink" title="5.1.5、likeLeft/likeRight(“列名”,值)"></a>5.1.5、likeLeft/likeRight(“列名”,值)</h3><blockquote><p>字段 like “%值”/“值%”</p></blockquote><h3 id="5-1-6、in-notIn-“列名”-Object-…values"><a href="#5-1-6、in-notIn-“列名”-Object-…values" class="headerlink" title="5.1.6、in/notIn(“列名”,Object …values)"></a>5.1.6、in/notIn(“列名”,Object …values)</h3><blockquote><p>字段  in/notIn(v0,v1…vn)</p></blockquote><h3 id="5-1-7、inSql-noInSql-“列名”-sql语句"><a href="#5-1-7、inSql-noInSql-“列名”-sql语句" class="headerlink" title="5.1.7、inSql/noInSql(“列名”,sql语句)"></a>5.1.7、inSql/noInSql(“列名”,sql语句)</h3><blockquote><p>字段 in/notIn (sql语句)，例如 inSql/notInSql(“id”,select * from user where id &lt; 3)</p><p>等价于id in/notIn (select * from user where id &lt; 3)</p></blockquote><h3 id="5-1-8、分组排序"><a href="#5-1-8、分组排序" class="headerlink" title="5.1.8、分组排序"></a>5.1.8、分组排序</h3><blockquote><ul><li>groupBy(R… columns); // 等价于 GROUP BY 字段, …， 例: groupBy(“id”, “name”) —&gt; group by id,name</li><li>orderByAsc(R… columns); // 等价于 ORDER BY 字段, … ASC， 例: orderByAsc(“id”, “name”) —&gt; order by id ASC,name ASC</li><li>orderByDesc(R… columns); // 等价于 ORDER BY 字段, … DESC， 例: orderByDesc(“id”, “name”) —&gt; order by id DESC,name DESC</li><li>having(String sqlHaving, Object… params); // 等价于 HAVING ( sql语句 )， 例: having(“sum(age) &gt; {0}”, 11) —&gt; having sum(age) &gt; 11</li></ul></blockquote><h2 id="5-2、查询示例"><a href="#5-2、查询示例" class="headerlink" title="5.2、查询示例"></a>5.2、查询示例</h2><blockquote><p>查询name、email不为空，且年龄大于等于12岁的用户(.isNotNull()、.ge())</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 查询name、email不为空，且年龄大于等于12岁的用户(.isNotNull()、.ge())</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQuestion01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    QueryWrapper wrapper = <span class="keyword">new</span> QueryWrapper();</span><br><span class="line">    wrapper.isNotNull(<span class="string">&quot;email&quot;</span>);</span><br><span class="line">    wrapper.isNotNull(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    wrapper.ge(<span class="string">&quot;age&quot;</span>,<span class="number">12</span>);</span><br><span class="line">    List users = userMapper.selectList(wrapper);</span><br><span class="line">    users.forEach(user -&gt; System.out.println(user));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>结果</p></li><li><p>sql语句为：</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&gt;  Preparing: SELECT id,name,age,email,create_time,update_time,version,deleted FROM user WHERE deleted&#x3D;0 AND email IS NOT NULL AND name IS NOT NULL AND age &gt;&#x3D; ? </span><br><span class="line">&#x3D;&#x3D;&gt; Parameters: 12(Integer)</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153512076.png" alt="image-20210129153512076"></p><blockquote><p>查询name属性等于”小明”的用户</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 查询name属性等于&quot;小明&quot;的用户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQuestion02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    QueryWrapper wrapper = <span class="keyword">new</span> QueryWrapper();</span><br><span class="line">    wrapper.eq(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;小明&quot;</span>);</span><br><span class="line">    List users = userMapper.selectList(wrapper);</span><br><span class="line">    users.forEach(user -&gt; System.out.println(user));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153519861.png" alt="image-20210129153519861"></p><blockquote><p>查询年龄在10-30之间的<strong>用户个数</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 查询年龄在10-30之间的用户个数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQuestion03</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    QueryWrapper wrapper = <span class="keyword">new</span> QueryWrapper();</span><br><span class="line">    wrapper.between(<span class="string">&quot;age&quot;</span>,<span class="number">10</span>,<span class="number">30</span>);</span><br><span class="line">    <span class="keyword">int</span> count = userMapper.selectCount(wrapper);</span><br><span class="line">    System.out.println(count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153527524.png" alt="image-20210129153527524"></p><blockquote><p>查询id小于等于4且没被逻辑删除的用户</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 查询id小于等于4且没被逻辑删除的用户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQuestion04</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    QueryWrapper wrapper = <span class="keyword">new</span> QueryWrapper();</span><br><span class="line">    String inSql = <span class="string">&quot;select id from user where id &lt;= 4&quot;</span>;</span><br><span class="line">    wrapper.inSql(<span class="string">&quot;id&quot;</span>,inSql);</span><br><span class="line">    List users = userMapper.selectList(wrapper);</span><br><span class="line">    users.forEach(user -&gt; System.out.println(user));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>sql语句为：</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT id,name,age,email,create_time,update_time,version,deleted FROM user WHERE deleted&#x3D;0 AND id IN (select id from user where id &lt;&#x3D; 4)</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153535669.png" alt="image-20210129153535669"></p><blockquote><p>通过id进行降序排序</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 查询所有用户，并根据id进行降序排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testQuestion05</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    QueryWrapper wrapper = <span class="keyword">new</span> QueryWrapper();</span><br><span class="line">    wrapper.orderByDesc(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    List users = userMapper.selectList(wrapper);</span><br><span class="line">    users.forEach(user -&gt; System.out.println(user));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153544738.png" alt="image-20210129153544738"></p><h1 id="六、代码生成器"><a href="#六、代码生成器" class="headerlink" title="六、代码生成器"></a>六、代码生成器</h1><h2 id="6-1、介绍"><a href="#6-1、介绍" class="headerlink" title="6.1、介绍"></a>6.1、介绍</h2><blockquote><p>AutoGenerator 是 MyBatis-Plus 的代码生成器，通过 AutoGenerator 可以快速生成 Entity、Mapper、Mapper XML、Service、Controller 等各个模块的代码，极大的提升了开发效率。</p></blockquote><h2 id="6-2、使用"><a href="#6-2、使用" class="headerlink" title="6.2、使用"></a>6.2、使用</h2><h3 id="6-2-1、引入依赖"><a href="#6-2-1、引入依赖" class="headerlink" title="6.2.1、引入依赖"></a>6.2.1、引入依赖</h3><blockquote><p>代码生成器需要使用模板引擎，这里使用velocity模板引擎</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.velocity<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>velocity-engine-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>配置需要生成对于后台的数据库，这里以leyou_shop数据库的user表为例，生成后台代码</p></blockquote><h3 id="6-2-2、编写代码自动生成器CodeAutoCreator类"><a href="#6-2-2、编写代码自动生成器CodeAutoCreator类" class="headerlink" title="6.2.2、编写代码自动生成器CodeAutoCreator类"></a>6.2.2、编写代码自动生成器CodeAutoCreator类</h3><blockquote><p>这里以leyou_shop库的spu表为例</p></blockquote><ul><li>表结构如下</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153552969.png" alt="image-20210129153552969"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.AutoGenerator;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.DataSourceConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.GlobalConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.PackageConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.StrategyConfig;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.DateType;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> 蔡大头</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span>: CodeAutoGenerator</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@projectName</span> mybatis-plus-blog</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: TODO</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/12/1016:47</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CodeAutoGenerator</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">generator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 1、创建代码生成器</span></span><br><span class="line">        AutoGenerator mpg = <span class="keyword">new</span> AutoGenerator();</span><br><span class="line">        <span class="comment">// 2、全局配置</span></span><br><span class="line">        GlobalConfig gc = <span class="keyword">new</span> GlobalConfig();</span><br><span class="line">        String projectPath = System.getProperty(<span class="string">&quot;user.dir&quot;</span>);</span><br><span class="line">        gc.setOutputDir(<span class="string">&quot;E:\\java\\blog\\src\\main\\java&quot;</span>);</span><br><span class="line">        gc.setAuthor(<span class="string">&quot;蔡大头&quot;</span>);</span><br><span class="line">        gc.setOpen(<span class="keyword">false</span>); <span class="comment">//生成后是否打开资源管理器</span></span><br><span class="line">        gc.setFileOverride(<span class="keyword">false</span>); <span class="comment">//重新生成时文件是否覆盖</span></span><br><span class="line">        gc.setServiceName(<span class="string">&quot;%sService&quot;</span>);<span class="comment">//去掉Service接口的首字母I</span></span><br><span class="line">        gc.setIdType(IdType.AUTO); <span class="comment">//主键策略</span></span><br><span class="line">        gc.setDateType(DateType.ONLY_DATE);<span class="comment">//定义生成的实体类中日期类型</span></span><br><span class="line">        gc.setSwagger2(<span class="keyword">true</span>);<span class="comment">//开启Swagger2模式</span></span><br><span class="line"></span><br><span class="line">        mpg.setGlobalConfig(gc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、数据源配置</span></span><br><span class="line">        DataSourceConfig dsc = <span class="keyword">new</span> DataSourceConfig();</span><br><span class="line">        dsc.setUrl(<span class="string">&quot;jdbc:mysql://localhost:3306/leyou_shop?serverTimezone=UTC&quot;</span>);</span><br><span class="line">        dsc.setDriverName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">        dsc.setUsername(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        dsc.setPassword(<span class="string">&quot;tianxin1230.&quot;</span>);</span><br><span class="line">        dsc.setDbType(DbType.MYSQL);</span><br><span class="line">        mpg.setDataSource(dsc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4、包配置</span></span><br><span class="line">        PackageConfig pc = <span class="keyword">new</span> PackageConfig();</span><br><span class="line">        pc.setParent(<span class="string">&quot;com.hzx&quot;</span>);</span><br><span class="line">        pc.setModuleName(<span class="string">&quot;mpblog&quot;</span>); <span class="comment">//模块名</span></span><br><span class="line">        pc.setController(<span class="string">&quot;controller&quot;</span>);</span><br><span class="line">        pc.setEntity(<span class="string">&quot;entity&quot;</span>);</span><br><span class="line">        pc.setService(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">        pc.setMapper(<span class="string">&quot;mapper&quot;</span>);</span><br><span class="line">        mpg.setPackageInfo(pc);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5、策略配置</span></span><br><span class="line">        StrategyConfig strategy = <span class="keyword">new</span> StrategyConfig();</span><br><span class="line">        strategy.setInclude(<span class="string">&quot;spu&quot;</span>);</span><br><span class="line">        strategy.setNaming(NamingStrategy.underline_to_camel);<span class="comment">//数据库表映射到实体的命名策略</span></span><br><span class="line">        strategy.setTablePrefix(pc.getModuleName() + <span class="string">&quot;_&quot;</span>); <span class="comment">//生成实体时去掉表前缀</span></span><br><span class="line"></span><br><span class="line">        strategy.setColumnNaming(NamingStrategy.underline_to_camel);<span class="comment">//数据库表字段映射到实体的命名策略</span></span><br><span class="line">        strategy.setEntityLombokModel(<span class="keyword">true</span>); <span class="comment">// lombok 模型 @Accessors(chain = true) setter链式操作</span></span><br><span class="line"></span><br><span class="line">        strategy.setRestControllerStyle(<span class="keyword">true</span>); <span class="comment">//restful api风格控制器</span></span><br><span class="line">        strategy.setControllerMappingHyphenStyle(<span class="keyword">true</span>); <span class="comment">//url中驼峰转连字符</span></span><br><span class="line"></span><br><span class="line">        mpg.setStrategy(strategy);</span><br><span class="line">        <span class="comment">// 6、执行</span></span><br><span class="line">        mpg.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-3、测试及说明"><a href="#6-3、测试及说明" class="headerlink" title="6.3、测试及说明"></a>6.3、测试及说明</h2><blockquote><p>生成路径、主键策略</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153604973.png" alt="image-20210129153604973"></p><blockquote><p>设置包名和模块名</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153612043.png" alt="image-20210129153612043"></p><blockquote><p>设置要生成的表</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153620219.png" alt="image-20210129153620219"></p><blockquote><p>启动程序，查看结果</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153637898.png" alt="image-20210129153637898"></p><blockquote><p>Mybatis-plus只对mybatis做增强，不做修改，所以Mybatis有的功能，MP均能实现，对于一些复杂的查询，可以使用写xml文件的方式来完成。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> 框架学习 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
            <tag> 👢Spring Boot </tag>
            
            <tag> 💎Mybatis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>设计模式学习总结（一）-单例模式</title>
      <link href="posts/1986796058.html"/>
      <url>posts/1986796058.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1、单例模式介绍"><a href="#1、单例模式介绍" class="headerlink" title="1、单例模式介绍"></a>1、单例模式介绍</h2><blockquote><p>单例模式（Singleton Pattern）是 Java 中最简单的设计模式之一。这种类型的设计模式属于创建型模式，它提供了一种创建对象的最佳方式。</p><p>这种模式涉及到一个单一的类，该类负责创建自己的对象，同时确保只有单个对象被创建。这个类提供了一种访问其唯一的对象的方式，可以直接访问，不需要实例化该类的对象。</p><p><strong>注意：</strong></p><ul><li>1、单例类只能有一个实例。</li><li>2、单例类必须自己创建自己的唯一实例。</li><li>3、单例类必须给所有其他对象提供这一实例。</li></ul><p>下面介绍几种单例模式的实现方法</p></blockquote><h2 id="2、饿汉式"><a href="#2、饿汉式" class="headerlink" title="2、饿汉式"></a>2、饿汉式</h2><blockquote><p>这种单例模式实现简单，且在多线程环境下保证了并发全，但缺点是无法实现懒加载，方法单例在类加载的时候就会被创建，可能会造成空间浪费，这种单例模式会被反射和序列化工具破坏。</p></blockquote><blockquote><p>实现思路</p></blockquote><ul><li>在类中new 一个静态类对象instance</li><li>私有化构造方法</li><li>编写一个静态方法用于返回第一步new的instance对象</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton01</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton01 instance = <span class="keyword">new</span> Singleton01();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton01</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton01 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这个实现方法在高并发下线程安全，但可以被反射和序列化工具破坏，下面一一进行测试</p></blockquote><h3 id="2-1、使用反射破坏"><a href="#2-1、使用反射破坏" class="headerlink" title="2.1、使用反射破坏"></a>2.1、使用反射破坏</h3><ul><li>测试代码</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Class clazz = Singleton01.class;</span><br><span class="line">Constructor constructor = clazz.getDeclaredConstructor();</span><br><span class="line">constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"><span class="comment">//使用反射获取的构造器新建的对象</span></span><br><span class="line">Singleton01 singleton01 = (Singleton01) constructor.newInstance();</span><br><span class="line"><span class="comment">//使用单例类方法获取的对象</span></span><br><span class="line">Singleton01 instance = getInstance();</span><br><span class="line"><span class="comment">//比较地址</span></span><br><span class="line">System.out.println(singleton01 == instance);</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129152932524.png" alt="image-20210129152932524"></p><h3 id="2-2、使用序列化工具进行破坏，下面给出序列化工具及演示代码"><a href="#2-2、使用序列化工具进行破坏，下面给出序列化工具及演示代码" class="headerlink" title="2.2、使用序列化工具进行破坏，下面给出序列化工具及演示代码"></a>2.2、使用序列化工具进行破坏，下面给出序列化工具及演示代码</h3><ul><li>序列化工具类</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SerializationUtils</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列化对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> obj 对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 序列化后的字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == obj) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">                ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                ObjectOutputStream out = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line">        ) &#123;</span><br><span class="line"></span><br><span class="line">            out.writeObject(obj);</span><br><span class="line">            <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 反序列化</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bytes 对象序列化后的字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 反序列化后的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> ClassNotFoundException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == bytes) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">                ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(bytes);</span><br><span class="line">                ObjectInputStream in = <span class="keyword">new</span> ObjectInputStream(byteArrayInputStream);</span><br><span class="line">        ) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> in.readObject();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>测试代码</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取单例对象并进行序列化</span></span><br><span class="line">Singleton01 instance = getInstance();</span><br><span class="line"><span class="keyword">byte</span>[] bytes = SerializationUtils.serialize(instance);</span><br><span class="line"><span class="comment">//进行反序列化，获取instance对象</span></span><br><span class="line">Singleton01 deserializeInstance = (Singleton01)SerializationUtils.deserialize(bytes);</span><br><span class="line"><span class="comment">//比较两个对象的地址</span></span><br><span class="line">System.out.println(instance);</span><br><span class="line">System.out.println(deserializeInstance);</span><br><span class="line">System.out.println(instance == deserializeInstance);</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129152944497.png" alt="image-20210129152944497"></p><h3 id="2-3、问题解决方案"><a href="#2-3、问题解决方案" class="headerlink" title="2.3、问题解决方案"></a>2.3、问题解决方案</h3><blockquote><p>对于反射，我们可以在私有的构造函数中做一些处理，当用户进入饿汉式单例模式的构造方法时，我们可以判断当前静态对象instance是否为空，如果不为空，直接抛出一个异常，让其他人不能用反射来破坏单例模式。</p></blockquote><ul><li>代码实现</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Singleton01</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(instance != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>再次执行上面的测试代码，结果为</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://raw.githubusercontent.com/tianxin763882220/images/master/blog/20201208151900.png" alt="image-20201208151900669"></p><blockquote><p>由于类的静态成员的序列化问题，所以每次反序列化都会new一个类对象，我们可以写一个readReslove方法来时其序列化和反序列化使用的都是同一个instance对象。</p></blockquote><ul><li>代码实现</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129152958851.png" alt="image-20210129152958851"></p><h2 id="3、饿汉式单例模式的改进–登记式"><a href="#3、饿汉式单例模式的改进–登记式" class="headerlink" title="3、饿汉式单例模式的改进–登记式"></a>3、饿汉式单例模式的改进–登记式</h2><blockquote><p>登记式单例模式采用了一个静态内部类来持有该类的单实例对象，在外部类被加载时，静态内部类不会被加载，即类的单例对象不会被创建，当用户第一次使用类的getInstance方法时，类的单实例才会被加载，这样既保证了线程安全，又起到了懒加载的效果。</p></blockquote><h3 id="3-1、登记式实现思路"><a href="#3-1、登记式实现思路" class="headerlink" title="3.1、登记式实现思路"></a>3.1、登记式实现思路</h3><ul><li>在类中添加一个静态内部类SingtonHolder，类中存放外部类的唯一实例instance</li><li>私有化构造器，在构造器中通过判断静态内部类中instance实例是否为空来决定要不要抛出异常。</li><li>在外部类中构建一个静态方法getInstance来返回类的单实例。</li><li>写一个readReslove方法来防止序列化破坏单例。</li></ul><h3 id="3-2、代码实现"><a href="#3-2、代码实现" class="headerlink" title="3.2、代码实现"></a>3.2、代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton02</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Singleton02 instance = <span class="keyword">new</span> Singleton02();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton02</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(SingletonHolder.instance != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton02 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>静态内部类的加载时机，我们可以在Sington2的构造函数中输出一段语句来判断静态内部类的加载时间。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Class clazz = Class.forName(<span class="string">&quot;singleton.Singleton02&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;-----------------------------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">Singleton02 instance = getInstance();</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153010304.png" alt="image-20210129153010304"></p><ul><li>结论：静态内部类在外部类加载时不会被加载，而是在用户第一次调用getInstance方法时才加载。</li></ul><blockquote><p>小结：对于饿汉式，推荐使用登记式。</p></blockquote><h2 id="4、懒汉式和双检锁"><a href="#4、懒汉式和双检锁" class="headerlink" title="4、懒汉式和双检锁"></a>4、懒汉式和双检锁</h2><blockquote><p>懒汉式单例模式意味着在类加载时不创建类的单实例对象，而是当用户需要实例时才去创建对象，这种方法实现了懒加载，且实现简单，但不能保证多线程环境下的单例唯一性。</p></blockquote><h3 id="4-1、代码实现"><a href="#4-1、代码实现" class="headerlink" title="4.1、代码实现"></a>4.1、代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton03</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton03 instance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton03</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Singleton03 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> Singleton03();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这种单例模式存在许多问题，除了前面提到的可以用反射和序列化工具破坏外，这种单例模式在多线程并发环境下不能保证单例的唯一性，给出测试代码</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            System.out.println(getInstance());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果：可以看到出现了两个对象，所以需要对这种模式进行改进</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129153022773.png" alt="image-20210129153022773"></p><h3 id="4-2、解决懒汉式在多线程并发下的线程安全问题"><a href="#4-2、解决懒汉式在多线程并发下的线程安全问题" class="headerlink" title="4.2、解决懒汉式在多线程并发下的线程安全问题"></a>4.2、解决懒汉式在多线程并发下的线程安全问题</h3><blockquote><p>在getInstance方法中添加一个synchronizd块锁定代码，就可以解决线程安全问题，下面给出代码实现</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton04 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (Singleton04.class) &#123;</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> Singleton04();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这样就可以保证多线程下的线程安全问题，但这种直接加同步块的代码会影响程序的性能，所以我们可以通过引进双检锁模式的方法在保证线程安全的前提下尽可能地保证性能。</p></blockquote><h3 id="4-3、双检锁"><a href="#4-3、双检锁" class="headerlink" title="4.3、双检锁"></a>4.3、双检锁</h3><blockquote><p>同样对getInstance方法进行改造，在同步块外再次添加一个判断，即单例对象为空时，才进入同步块及以后代码，代码实现如下</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DoubleCheckLock <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (DoubleCheckLock.class) &#123;</span><br><span class="line">            <span class="keyword">if</span>(instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                instance = <span class="keyword">new</span> DoubleCheckLock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>假设AB同时进入第一个if判断，由于synchronized块的存在，AB有一个线程会进入同步块中，其他线程等待，进入同步块的线程判断当前单实例对象为空，于是会初始化对象，然后退出synchronized块，此时另外的线程进入代码块时，由于instance已经被初始化，所以会直接返回已经初始化的instance。之后的线程在进入synchronized块时会先进行一次判断，此时的instance已经不为空，所以直接返回instance。</p></blockquote><ul><li>可能遇到的问题</li></ul><blockquote><p>由于JVM机存在指令重排，同时初始化instance对象（instance = new DoubleCheckLock()）执行的操作如下</p><p>1 分配对象内存空间</p><p>2 初始化对象</p><p>3 instance指向1分配的空间</p><p>出现指令重排后，执行的操作如下</p><p>1 分配对象内存空间</p><p>2 instance指向1分配的空间</p><p>3 初始化对象</p><p>如果此时其他线程在指令重排的第2步就对instance进行判断，那么可能拿到一个空的instance对象，因为在指令排序的第2步操作后，instance指向的地址已经不为空。</p></blockquote><ul><li>解决方案：使用<strong>volatile</strong>关键字修饰instance变量</li></ul><blockquote><p>双检锁的完整实现代码如下</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DoubleCheckLock</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> DoubleCheckLock instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 在构造方法中防止反射破坏单例</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DoubleCheckLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(instance != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DoubleCheckLock <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (DoubleCheckLock.class) &#123;</span><br><span class="line">                <span class="keyword">if</span>(instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> DoubleCheckLock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 编写一个readResolve方法防止序列化破坏单例模式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 当前类的单实例对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据结构与算法学习（二）-字符串相关问题</title>
      <link href="posts/4173931752.html"/>
      <url>posts/4173931752.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1、String、StringBuffer与StringBuilder的区别"><a href="#1、String、StringBuffer与StringBuilder的区别" class="headerlink" title="1、String、StringBuffer与StringBuilder的区别"></a>1、String、StringBuffer与StringBuilder的区别</h2><h3 id="1-1、String类"><a href="#1-1、String类" class="headerlink" title="1.1、String类"></a>1.1、String类</h3><blockquote><p>分析源码可知，String对象的内容是存储在一个char数组中，且这个数组使用final修饰，这也是String对象不可变的原因。当进行字符串拼接时，虚拟机会新建一个字符串对象，然后将新的字符串对象赋值给原来的引用，而不是真的修改了原来字符串对象的值。</p><p>字符串重写了Object父类的equals方法。</p></blockquote><h3 id="1-2、StringBuffer类和StringBuilder类"><a href="#1-2、StringBuffer类和StringBuilder类" class="headerlink" title="1.2、StringBuffer类和StringBuilder类"></a>1.2、StringBuffer类和StringBuilder类</h3><blockquote><p>这两个类均继承于AbstractStringBuilder类，但分析源码可知StringBuffer的方法都添加了synchronized关键词进行修饰，所以StringBuffer是线程安全的，而没有使用synchronized修饰方法的StringBuilder是线程不安全的，但StringBuilder的速度要远远高于StringBuffer，所以在能保证线程安全的情况下，StringBuilder的优先级要高于StringBuffer。</p></blockquote><h3 id="1-3、总结"><a href="#1-3、总结" class="headerlink" title="1.3、总结"></a>1.3、总结</h3><ul><li>String是一个final修饰的类，所有的属性也是final的，所以String具有不可变性，也就是对字符串的操作，如拼接、剪切都会产生新的String对象。</li><li>StringBuffer本质是一个线程安全的可修改字符串序列。因为保证线程安全，所以会带来额外的性能消耗。</li><li>StringBuilder本质上和StringBuffer没有区别，但是StringBuilder去掉了线程安全部分提高了操作效率，是绝大部分情况下字符串拼接的首选。</li><li>如果确定拼接字符串会发生多次，并且长度可预计，那么可以在开始的时候指定合适的大小，避免数组扩容造成的开销。</li></ul><h2 id="2、找出字符串中出现最多次的字符和出现的次数"><a href="#2、找出字符串中出现最多次的字符和出现的次数" class="headerlink" title="2、找出字符串中出现最多次的字符和出现的次数"></a>2、找出字符串中出现最多次的字符和出现的次数</h2><blockquote><p>遍历字符串，并使用一个HashMap来存储出现字符及出现的次数，以字符为key，次数为value。解题思路如下</p></blockquote><ul><li><p>假定字符串中出现最多的字符maxCode为当前字符串的第一个元素，出现次数maxCount初始化为0</p></li><li><p>遍历字符串，判断当前字符是否在hashmap的key中，如果包含，令次数+1，否则将该字符为key，1为value放入hashmap中</p></li><li><p>判断maxCount和当前字符出现次数的关系，如果maxCount小于当前字符出现次数，就令maxCode = 当前字符，然后更新maxCode，最后返回maxCode和maxCount即可。</p></li></ul><blockquote><p>代码实现</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 找出字符串中出现最多次的字符和出现的次数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> str 目标字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 以maxCode为键、maxCount为值的map</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;Character, Integer&gt; <span class="title">findMostCodeAndCount</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> maxCode = str.charAt(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> maxCount = <span class="number">0</span>;</span><br><span class="line">    Map&lt;Character, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; str.length(); i++) &#123;</span><br><span class="line">        Character currentCode = str.charAt(i);</span><br><span class="line">        Integer count = map.get(currentCode);</span><br><span class="line">        <span class="keyword">if</span>(count == <span class="keyword">null</span>) &#123;</span><br><span class="line">            count = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        map.put(currentCode, count);</span><br><span class="line">        <span class="keyword">if</span>(maxCount &lt; count) &#123;</span><br><span class="line">            maxCode = currentCode;</span><br><span class="line">            maxCount = count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Map&lt;Character, Integer&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    result.put(maxCode,maxCount);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>测试代码及结果</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="string">&quot;abcacba&quot;</span>;</span><br><span class="line">Map result = findMostCodeAndCount(str);</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129152842664.png" alt="image-20210129152842664"></p><h2 id="3、找出字符串中第一次重复出现的字符"><a href="#3、找出字符串中第一次重复出现的字符" class="headerlink" title="3、找出字符串中第一次重复出现的字符"></a>3、找出字符串中第一次重复出现的字符</h2><blockquote><p>使用一个HashSet来解决问题，由于Set有不允许元素重复的性质，Set的add方法在添加重复值是会返回false，所以我们可以用这个性质来判断元素是否重复。</p></blockquote><blockquote><p>代码实现</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 找出字符串中第一次重复出现的字符</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> str 目标字符串</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回第一次重复的字符</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Character <span class="title">getFirstRepeat</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">    Set&lt;Character&gt; set = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    Character result = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; str.length(); i++) &#123;</span><br><span class="line">        Character currentCode = str.charAt(i);</span><br><span class="line">        <span class="keyword">if</span>(!set.add(currentCode)) &#123;</span><br><span class="line">            result = currentCode;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>测试代码和结果</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="string">&quot;abcacba&quot;</span>;</span><br><span class="line">Character result = getFirstRepeat(str);</span><br><span class="line">System.out.println(result);</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129152855053.png" alt="image-20210129152855053"></p><h2 id="4、两个大数之和"><a href="#4、两个大数之和" class="headerlink" title="4、两个大数之和"></a>4、两个大数之和</h2><blockquote><p>题目描述：现在有两个数，位数均超过1000位，例如</p><ul><li><p>String a = “123343432…”</p></li><li><p>String b = “3974928374928…”</p></li></ul><p>这两个大数无法转换为Integer计算，所以我们使用两个数组来存储这两个数，然后进行计算。</p><p>解题思路如下</p></blockquote><ul><li>设这两个数中大的数的位数位m，则结果的最大位数位m+1</li><li>用一个int数组来存储结果</li></ul><blockquote><p>代码实现</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 编程两个大数之和</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> num1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> num2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">sumOfBigNum</span><span class="params">(String num1,String num2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>[] largeArray = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">char</span>[] smallArray = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(num1.length() &gt;= num2.length()) &#123;</span><br><span class="line">        largeArray = num1.toCharArray();</span><br><span class="line">        smallArray = num2.toCharArray();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        largeArray = num2.toCharArray();</span><br><span class="line">        smallArray = num1.toCharArray();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span>[] res = <span class="keyword">new</span> <span class="keyword">int</span>[largeArray.length + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; largeArray.length; i++) &#123;</span><br><span class="line">        res[i] = largeArray[largeArray.length - i - <span class="number">1</span>] - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; smallArray.length; i++) &#123;</span><br><span class="line">        res[i] += smallArray[smallArray.length - i - <span class="number">1</span>] - <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; res.length - <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(res[i] &gt; <span class="number">9</span>) &#123;</span><br><span class="line">            res[i + <span class="number">1</span>] += res[i] / <span class="number">10</span>;</span><br><span class="line">            res[i] %= <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = res.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        stringBuilder.append(res[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String result = stringBuilder.toString();</span><br><span class="line">    <span class="keyword">if</span>(result.startsWith(<span class="string">&quot;0&quot;</span>)) &#123;</span><br><span class="line">        result = result.substring(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>测试代码和结果</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">String num1 = <span class="string">&quot;12345&quot;</span>;</span><br><span class="line">String num2 = <span class="string">&quot;56756&quot;</span>;</span><br><span class="line">Integer n1 = Integer.valueOf(num1);</span><br><span class="line">Integer n2 = Integer.valueOf(num2);</span><br><span class="line">Integer sum = n1 + n2;</span><br><span class="line">System.out.println(<span class="string">&quot;计算机计算结果为：&quot;</span> + sum);</span><br><span class="line">System.out.println(<span class="string">&quot;函数计算结果位：&quot;</span> + sumOfBigNum(num1,num2));</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129152910086.png" alt="image-20210129152910086"></p>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据结构与算法学习（一）--单链表相关算法</title>
      <link href="posts/3227196086.html"/>
      <url>posts/3227196086.html</url>
      
        <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="1、使用java实现单链表"><a href="#1、使用java实现单链表" class="headerlink" title="1、使用java实现单链表"></a>1、使用java实现单链表</h2><blockquote><p>建立Node节点类的代码如下</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span> </span>&#123;</span><br><span class="line">    Integer data;</span><br><span class="line">    Node next;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Node</span><span class="params">(Integer data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Node&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;data=&quot;</span> + data +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>建立链表类并编写链表类的添加节点和遍历方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span> </span>&#123;</span><br><span class="line">    Node head;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 添加节点的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> node 待添加节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addNode</span><span class="params">(Node node)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.head == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//如果当前头节点为空，那么将传入的节点作为头节点</span></span><br><span class="line">            <span class="keyword">this</span>.head = node;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//由于单链表的头节点不可移动，所以我们使用一个临时指针来辅助我们添加节点。</span></span><br><span class="line">        Node temp = head;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(temp.next == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            temp = temp.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//退出循环时，temp节点指向链表最后一个节点，此时将传入节点挂在temp之后即可</span></span><br><span class="line">        temp.next = node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * 遍历链表的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">list</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.head == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;链表为空，无法遍历！&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Node temp = head;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(temp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(temp);</span><br><span class="line">            temp = temp.next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2、编写代码实现单链表的反转"><a href="#2、编写代码实现单链表的反转" class="headerlink" title="2、编写代码实现单链表的反转"></a>2、编写代码实现单链表的反转</h2><blockquote><p>这里使用<strong>递归</strong>来完成单链表的反转，这个算法的思路大体如下</p></blockquote><ul><li>假设现在有一条单链表：1-2-3-4-NULL，在每次进入倒置函数reverse之前，需要对传入的节点进行判断，当传入的节点为空或者传入节点的next指针域为空时，证明该链表不需要反转，直接返回该节点。</li><li>当传入节点的指针域不为空时，将该节点的下一个节点的next域指向自己，同时将该节点的next指针域置为空，这样就形成了局部意义上的链表节点反转，由于我们使用了递归，并设置了递归退出条件（当前传入节点为空或者当前传入节点的next指针域为空），所以我们可以使用这个思路，完成对链表的反转</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129152444803.png" alt="image-20210129152444803"></p><blockquote><p>实现代码如下</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> head</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Node <span class="title">reverse</span><span class="params">(Node head)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(head == <span class="keyword">null</span> || head.next == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//如果进入这个if块中，证明当前head与其之后结点形成的链表不需要反转</span></span><br><span class="line">        <span class="comment">//例如1-2-3-4中的4不需要反转，直接返回该节点即可</span></span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果链表长度大于等于2，进行递归</span></span><br><span class="line">    Node reverseNode = reverse(head.next);</span><br><span class="line">    <span class="comment">//将当前节点下一个节点的next指针域指向自己</span></span><br><span class="line">    head.next.next = head;</span><br><span class="line">    <span class="comment">//将当前节点的next指针域置空</span></span><br><span class="line">    head.next = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> reverseNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>创建一个链表：1-2-3-4-5，测试代码与结果如下</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LinkedList linkedList = <span class="keyword">new</span> LinkedList();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    linkedList.addNode(<span class="keyword">new</span> Node(i + <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">&quot;反转前:&quot;</span>);</span><br><span class="line">linkedList.list();</span><br><span class="line">LinkedList reverseList = <span class="keyword">new</span> LinkedList(reverse(linkedList.head));</span><br><span class="line">System.out.println(<span class="string">&quot;反转后:&quot;</span>);</span><br><span class="line">reverseList.list();</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129152457748.png" alt="image-20210129152457748"></p><h2 id="3、将两个有序单链表合并为一个有序单链表"><a href="#3、将两个有序单链表合并为一个有序单链表" class="headerlink" title="3、将两个有序单链表合并为一个有序单链表"></a>3、将两个有序单链表合并为一个有序单链表</h2><blockquote><p>将A链表：1-2-3-null与B链表2-3-6-null合并为一张有序链表，解题思路如下</p></blockquote><ul><li>新建一个链表temp，然后使用指针遍历AB链表，对每一次遍历出来的节点的data值进行比较，将data值较小的节点从原链表中摘除，然后加到temp链表中，直到有一条链表被摘空。</li><li>此时如果A链表被摘空，那么将B链表剩余的节点挂在temp节点的最后面，由于B链表和temp链表本来就是有序的，所以得出的结果仍然是一个有序列表，反之亦然。</li></ul><blockquote><p>代码实现</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 合并两个有序链表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> list1 链表1</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> list2 链表2</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LinkedList <span class="title">mergeTwoList</span><span class="params">(LinkedList list1,LinkedList list2)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//创建一个</span></span><br><span class="line">    LinkedList temp = <span class="keyword">new</span> LinkedList(<span class="keyword">new</span> Node(Integer.MIN_VALUE));</span><br><span class="line">    Node cur = temp.head;</span><br><span class="line">    <span class="keyword">while</span>(list1.head != <span class="keyword">null</span> &amp;&amp; list2.head != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(list1.head.data &lt; list2.head.data) &#123;</span><br><span class="line">            cur.next = list1.head;</span><br><span class="line">            list1.head = list1.head.next;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            cur.next = list2.head;</span><br><span class="line">            list2.head = list2.head.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//每一次循环后都需要将cur后移</span></span><br><span class="line">        cur = cur.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//退出循环时，至少有一个链表为空</span></span><br><span class="line">    <span class="comment">//如果是第一个链表为空，那么将cur.next指向第二个链表的头节点，由于第二个链表本身就是有序的，所以合并后仍然有序</span></span><br><span class="line">    <span class="keyword">if</span>(list1.head == <span class="keyword">null</span>) &#123;</span><br><span class="line">        cur.next = list2.head;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(list2.head == <span class="keyword">null</span>) &#123;</span><br><span class="line">        cur.next = list1.head;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//由于temp的第一个节点为MIN_VALUE，为无效节点，所以返回下一个</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LinkedList(temp.head.next);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>测试代码及结果</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">LinkedList list1 = <span class="keyword">new</span> LinkedList();</span><br><span class="line">list1.addNode(<span class="keyword">new</span> Node(<span class="number">1</span>));</span><br><span class="line">list1.addNode(<span class="keyword">new</span> Node(<span class="number">2</span>));</span><br><span class="line">list1.addNode(<span class="keyword">new</span> Node(<span class="number">4</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;链表1为:&quot;</span>);</span><br><span class="line">list1.list();</span><br><span class="line"></span><br><span class="line">LinkedList list2 = <span class="keyword">new</span> LinkedList();</span><br><span class="line">list2.addNode(<span class="keyword">new</span> Node(<span class="number">1</span>));</span><br><span class="line">list2.addNode(<span class="keyword">new</span> Node(<span class="number">3</span>));</span><br><span class="line">list2.addNode(<span class="keyword">new</span> Node(<span class="number">4</span>));</span><br><span class="line">System.out.println(<span class="string">&quot;链表2为:&quot;</span>);</span><br><span class="line">list2.list();</span><br><span class="line"></span><br><span class="line">LinkedList result = mergeTwoList(list1,list2);</span><br><span class="line">System.out.println(<span class="string">&quot;合并结果为:&quot;</span>);</span><br><span class="line">result.list();</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129152513991.png" alt="image-20210129152513991"></p><h2 id="4、返回链表中倒数第K个结点"><a href="#4、返回链表中倒数第K个结点" class="headerlink" title="4、返回链表中倒数第K个结点"></a>4、返回链表中倒数第K个结点</h2><blockquote><p>返回链表倒数第K个结点，结题思路如下</p></blockquote><ul><li>创建两个指针before和after，并将其指向链表头节点head</li><li>先让after结点前进k步，如果在此过程中after结点已经走出链表的范围（即移动过程中after已为空），那么证明输入的k不合法，此时返回null。</li><li>完成上一步的操作后，进行循环并使before和after同时进行移动，直到after为空时退出循环，此时before指向的元素即为链表的倒数第k个结点。</li></ul><blockquote><p>代码实现</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * 获取链表的倒数第k个结点</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> list 链表</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> k</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Node <span class="title">getKthFromEnd</span><span class="params">(LinkedList list,<span class="keyword">int</span> k)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(list.head == <span class="keyword">null</span> || list == <span class="keyword">null</span> || k &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Node before = list.head;</span><br><span class="line">    Node after = list.head;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; k;i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(after == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        after = after.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(after != <span class="keyword">null</span>) &#123;</span><br><span class="line">        before = before.next;</span><br><span class="line">        after = after.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> before;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>测试代码以及结果，这里的链表使用上面合并链表的结果</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LinkedList result = mergeTwoList(list1,list2);</span><br><span class="line">System.out.println(<span class="string">&quot;合并结果为:&quot;</span>);</span><br><span class="line">result.list();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">&quot;倒数第3个结点值为:&quot;</span> + getKthFromEnd(result,<span class="number">2</span>));</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><p><img src= "/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/image-20210129152527059.png" alt="image-20210129152527059"></p>]]></content>
      
      
      <categories>
          
          <category> 数据结构与算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ☕Java </tag>
            
            <tag> 💻后端学习 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
