<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>æ•°æ®ç»“æ„ä¸ç®—æ³•å­¦ä¹ ï¼ˆä¸ƒï¼‰-ConcurrentHashMapæºç è§£è¯» | Arno</title><meta name="keywords" content="â˜•Java,ğŸ’»åç«¯å­¦ä¹ "><meta name="author" content="å¤©æ˜•"><meta name="copyright" content="å¤©æ˜•"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="é¢è¯•ä¸­HashMapå’ŒConcurrentHashMapçš„æºç ä¸€èˆ¬ä¼šæ”¾ä¸€èµ·é—®ï¼Œæ‰€ä»¥ç°åœ¨èŠ±ä¸€ç‚¹æ—¶é—´å­¦ä¹ ä¸€ä¸‹ConcurrentHashMapçš„æºç ã€‚"><meta property="og:type" content="article"><meta property="og:title" content="æ•°æ®ç»“æ„ä¸ç®—æ³•å­¦ä¹ ï¼ˆä¸ƒï¼‰-ConcurrentHashMapæºç è§£è¯»"><meta property="og:url" content="https://sutianxin.top/posts/2912697261.html"><meta property="og:site_name" content="Arno"><meta property="og:description" content="é¢è¯•ä¸­HashMapå’ŒConcurrentHashMapçš„æºç ä¸€èˆ¬ä¼šæ”¾ä¸€èµ·é—®ï¼Œæ‰€ä»¥ç°åœ¨èŠ±ä¸€ç‚¹æ—¶é—´å­¦ä¹ ä¸€ä¸‹ConcurrentHashMapçš„æºç ã€‚"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://gitee.com/sutianxin/blogImage/raw/master/20210504191133.jpg"><meta property="article:published_time" content="2021-03-05T07:27:53.000Z"><meta property="article:modified_time" content="2021-10-17T13:42:33.466Z"><meta property="article:author" content="å¤©æ˜•"><meta property="article:tag" content="â˜•Java"><meta property="article:tag" content="ğŸ’»åç«¯å­¦ä¹ "><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://gitee.com/sutianxin/blogImage/raw/master/20210504191133.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://sutianxin.top/posts/2912697261"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"ç¹",msgToSimplifiedChinese:"ç°¡"},noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0},copy:{success:"å¤åˆ¶æˆåŠŸ",error:"å¤åˆ¶é”™è¯¯",noSupport:"æµè§ˆå™¨ä¸æ”¯æŒ"},relativeDate:{homepage:!1,post:!1},runtime:"å¤©",date_suffix:{just:"åˆšåˆš",min:"åˆ†é’Ÿå‰",hour:"å°æ—¶å‰",day:"å¤©å‰",month:"ä¸ªæœˆå‰"},copyright:void 0,lightbox:"mediumZoom",Snackbar:{chs_to_cht:"ä½ å·²åˆ‡æ¢ä¸ºç¹ä½“",cht_to_chs:"ä½ å·²åˆ‡æ¢ä¸ºç®€ä½“",day_to_night:"ä½ å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼",night_to_day:"ä½ å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼",bgLight:"#49b1f5",bgDark:"#121212",position:"top-right"},source:{jQuery:"https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js",justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css"},fancybox:{js:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js",css:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isanchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2021-10-17 21:42:33"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,a={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(a)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme");"dark"===e?activateDarkMode():"light"===e&&activateLightMode();e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"))})(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zyoushuo/Blog@latest/hexo/css/loading_style_1.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zhheo/JS-Heo@main/hidescrollbar/hidescrollbar.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zyoushuo/Blog@latest/hexo/css/loading_style_2.css"><link rel="stylesheet" href="/css/cover.css"><link rel="stylesheet" href="/css/copyright.css"><link href="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/font-awesome-animation.min.css"><link rel="stylesheet" href="/css/flipcountdown.css"><link rel="stylesheet" href="/css/year.css"><link rel="stylesheet" href="/css/Lete.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PaddyLin-xum/wenjian@master/css/fontanimation.css"><link href="https://cdn.bootcdn.net/ajax/libs/botui/0.3.9/botui-theme-default.css" rel="stylesheet"><link rel="stylesheet" href="/css/iconfont.css"><link rel="stylesheet" href="/css/twikoo.css"><style>#article-container.post-content h1:before,h2:before,h3:before,h4:before,h5:before,h6:before{-webkit-animation:avatar_turn_around 1s linear infinite;-moz-animation:avatar_turn_around 1s linear infinite;-o-animation:avatar_turn_around 1s linear infinite;-ms-animation:avatar_turn_around 1s linear infinite;animation:avatar_turn_around 1s linear infinite}</style><link rel="stylesheet" href="/css/font.css" media="defer" onload='this.media="all"'><meta name="generator" content="Hexo 5.4.0"></head><body><a href="javascript:void(0);" onclick="preloader.endLoading()" title="ç‚¹å‡»è·³è¿‡åŠ¨ç”»"><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div></a><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">81</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">17</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">12</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gucheng"></use></svg><span>é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gushu1"></use></svg><span>æ–‡ç« </span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gushu"></use></svg><span>å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guwan"></use></svg><span>æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gujianzhu-01"></use></svg><span>åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gufengwujianzhongguofengwenfangsibaoyantaimoyan_huaban_huaban"></use></svg><span>ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-red_envelope"></use></svg><span>æ‹“å±•</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/random/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingbaozhu"></use></svg><span>éšæœºæ–‡ç« </span></a></li><li><a class="site-page child faa-parent animated-hover" href="/adjust/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingguadeng"></use></svg><span>æ›´æ¢èƒŒæ™¯</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/statistics/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingjiutan"></use></svg><span>æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://sutianxin.gitee.io"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingzhongguojie"></use></svg><span>å›½å†…é•œåƒ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingzhuzi"></use></svg><span>å¯¼èˆªæ </span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bb/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxinghulu"></use></svg><span>å“”å“”</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingshanzi"></use></svg><span>éŸ³ä¹</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gufengwujianzhongguofenggudaiqiwujiuqijue_huaban_huaban"></use></svg><span>ç¤¾äº¤</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gufengwujianzhongguofenggudaileqixun_huaban_huaban_huaban"></use></svg><span>å‹é“¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gufengwujianzhongguofenggudaileqibianzhong_huaban_huaban_huaban_huaban"></use></svg><span>æœ‹å‹åœˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guqin"></use></svg><span>å…³äºæˆ‘</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://gitee.com/sutianxin/blogImage/raw/master/20210504191133.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Arno</a></span><span id="weather-v2-plugin-simple"></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gucheng"></use></svg><span>é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gushu1"></use></svg><span>æ–‡ç« </span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gushu"></use></svg><span>å½’æ¡£</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guwan"></use></svg><span>æ ‡ç­¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gujianzhu-01"></use></svg><span>åˆ†ç±»</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/comments/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gufengwujianzhongguofengwenfangsibaoyantaimoyan_huaban_huaban"></use></svg><span>ç•™è¨€æ¿</span></a></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-red_envelope"></use></svg><span>æ‹“å±•</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/random/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingbaozhu"></use></svg><span>éšæœºæ–‡ç« </span></a></li><li><a class="site-page child faa-parent animated-hover" href="/adjust/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingguadeng"></use></svg><span>æ›´æ¢èƒŒæ™¯</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/statistics/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingjiutan"></use></svg><span>æ–‡ç« ç»Ÿè®¡</span></a></li><li><a class="site-page child faa-parent animated-hover" target="_blank" rel="noopener" href="https://sutianxin.gitee.io"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingzhongguojie"></use></svg><span>å›½å†…é•œåƒ</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/box/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingzhuzi"></use></svg><span>å¯¼èˆªæ </span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bb/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxinghulu"></use></svg><span>å“”å“”</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/music/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-xianxingshanzi"></use></svg><span>éŸ³ä¹</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="javascript:void(0);"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gufengwujianzhongguofenggudaiqiwujiuqijue_huaban_huaban"></use></svg><span>ç¤¾äº¤</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gufengwujianzhongguofenggudaileqixun_huaban_huaban_huaban"></use></svg><span>å‹é“¾</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-gufengwujianzhongguofenggudaileqibianzhong_huaban_huaban_huaban_huaban"></use></svg><span>æœ‹å‹åœˆ</span></a></li></ul></div><div class="menus_item"><a class="site-page faa-parent animated-hover" href="/about/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-guqin"></use></svg><span>å…³äºæˆ‘</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">æ•°æ®ç»“æ„ä¸ç®—æ³•å­¦ä¹ ï¼ˆä¸ƒï¼‰-ConcurrentHashMapæºç è§£è¯»</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2021-03-05T07:27:53.000Z" title="å‘è¡¨äº 2021-03-05 15:27:53">2021-03-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2021-10-17T13:42:33.466Z" title="æ›´æ–°äº 2021-10-17 21:42:33">2021-10-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">æ•°æ®ç»“æ„ä¸ç®—æ³•</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">6.8k</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="ä¸€ã€JDK8ConcurrentHashMapåˆå§‹åŒ–"><a href="#ä¸€ã€JDK8ConcurrentHashMapåˆå§‹åŒ–" class="headerlink" title="ä¸€ã€JDK8ConcurrentHashMapåˆå§‹åŒ–"></a>ä¸€ã€JDK8ConcurrentHashMapåˆå§‹åŒ–</h1><h2 id="1-1ã€æºç åˆ†æ"><a href="#1-1ã€æºç åˆ†æ" class="headerlink" title="1.1ã€æºç åˆ†æ"></a>1.1ã€æºç åˆ†æ</h2><blockquote><p>åœ¨ <strong>JDK8</strong> çš„ ConcurrentHashMap ä¸­ä¸€ä¸ªæœ‰äº”ä¸ªæ„é€ æ–¹æ³•ï¼Œå’Œ JDK8 çš„ HashMap ä¸€æ ·ï¼Œè¿™äº”ä¸ªæ„é€ æ–¹æ³•ä¸­éƒ½æ²¡æœ‰å¯¹ Map å†…éƒ¨çš„ <strong>Node</strong> æ•°ç»„è¿›è¡Œåˆå§‹åŒ–ï¼Œåªæ˜¯å¯¹ä¸€äº›å˜é‡çš„åˆå§‹å€¼åšäº†å¤„ç†ã€‚</p><p><strong>JDK8 çš„ ConcurrentHashMap çš„ Node æ•°ç»„åˆå§‹åŒ–æ˜¯åœ¨ç¬¬ä¸€æ¬¡æ·»åŠ å…ƒç´ æ—¶å®Œæˆçš„ã€‚</strong></p></blockquote><h3 id="1ã€æ— å‚æ„é€ å‡½æ•°"><a href="#1ã€æ— å‚æ„é€ å‡½æ•°" class="headerlink" title="1ã€æ— å‚æ„é€ å‡½æ•°"></a>1ã€æ— å‚æ„é€ å‡½æ•°</h3><blockquote><p>åˆ›å»ºä¸€ä¸ª<strong>æ–°</strong>çš„ã€<strong>ç©º</strong>çš„ï¼Œ<strong>æ•°ç»„é•¿åº¦ä¸ºåˆå§‹åŒ–é•¿åº¦ï¼ˆ16ï¼‰</strong>çš„ConcurrentHashMapå¯¹è±¡</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new, empty map with the default initial table size (16).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ConcurrentHashMapçš„æ•°ç»„é»˜è®¤åˆå§‹åŒ–é•¿åº¦ä¸º <code>16</code>ï¼Œä¸”</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The default initial table capacity.  Must be a power of 2</span></span><br><span class="line"><span class="comment"> * (i.e., at least 1) and at most MAXIMUM_CAPACITY.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_CAPACITY = <span class="number">16</span>;</span><br></pre></td></tr></table></figure><h3 id="2ã€ä¼ å…¥åˆå§‹å®¹é‡çš„æ„é€ å‡½æ•°"><a href="#2ã€ä¼ å…¥åˆå§‹å®¹é‡çš„æ„é€ å‡½æ•°" class="headerlink" title="2ã€ä¼ å…¥åˆå§‹å®¹é‡çš„æ„é€ å‡½æ•°"></a>2ã€ä¼ å…¥åˆå§‹å®¹é‡çš„æ„é€ å‡½æ•°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new, empty map with an initial table size</span></span><br><span class="line"><span class="comment"> * accommodating the specified number of elements without the need</span></span><br><span class="line"><span class="comment"> * to dynamically resize.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> initialCapacity The implementation performs internal</span></span><br><span class="line"><span class="comment"> * sizing to accommodate this many elements.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if the initial capacity of</span></span><br><span class="line"><span class="comment"> * elements is negative</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">int</span> cap = ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">               MAXIMUM_CAPACITY :</span><br><span class="line">               tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>ConcurrentHashMap</strong> ä¼šåŸºäºä¼ å…¥çš„ <code>initialCapacity</code> è®¡ç®—ä¸€ä¸ª<strong>æ¯”è¿™ä¸ªå€¼å¤§ä¸”ä¸º2çš„å¹‚æ¬¡æ–¹çš„æ•´æ•°</strong>ä½œä¸º ConcurrentHashMap çš„<strong>åˆå§‹å®¹é‡</strong>ã€‚</p><p>å’Œ <strong>HashMap</strong> ä¸€æ ·ï¼Œè¿™ä¸ªåŠŸèƒ½ç”± <code>tableSizeFor</code> æ–¹æ³•å®Œæˆ</p><p>ä½†åœ¨ConcurrentHashMapä¸­ï¼Œå³ä½¿ä¼ å…¥çš„åˆå§‹å®¹é‡ <code>initialCapacity</code> ä¸º2çš„å¹‚æ¬¡æ–¹ï¼Œåœ¨ç»è¿‡ <code>tableSizeFor</code> æ–¹æ³•åä¹Ÿä¼šè¿”å›ä¸€ä¸ªæ¯” <code>initialCapacity</code> å¤§çš„ä¸”ä¸º2çš„å¹‚æ¬¡æ–¹çš„å€¼ã€‚</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210304220258.png" alt="image-20210304220256402"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a power of two table size for the given desired capacity.</span></span><br><span class="line"><span class="comment"> * See Hackers Delight, sec 3.2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = c - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç±»æ¯”ä¸Šé¢çš„ <code>tableSizeFor</code> æ–¹æ³•å’Œ <strong>æ„é€ æ–¹æ³•</strong> è¿›è¡Œæµ‹è¯•</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentHashMapStudy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAXIMUM_CAPACITY = <span class="number">1</span> &lt;&lt; <span class="number">30</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(getCapacity(<span class="number">32</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getCapacity</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tableSizeFor(n + (n &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span>  <span class="keyword">int</span> <span class="title">tableSizeFor</span><span class="params">(<span class="keyword">int</span> c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = c - <span class="number">1</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">        n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">        <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç»“æœ</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210304221040.png" alt="image-20210304221040912"></p><h3 id="3ã€å«æœ‰ä¸‰ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•"><a href="#3ã€å«æœ‰ä¸‰ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•" class="headerlink" title="3ã€å«æœ‰ä¸‰ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•"></a>3ã€å«æœ‰ä¸‰ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•</h3><blockquote><p>è¿™ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸ºï¼š<code>initialCapacity</code> ï¼ˆåˆå§‹å®¹é‡ï¼‰ã€ <code>loadFactor</code> ï¼ˆè´Ÿè½½å› å­ï¼‰ å’Œ <code>concurrencyLevel</code></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new, empty map with an initial table size based on</span></span><br><span class="line"><span class="comment"> * the given number of elements (&#123;<span class="doctag">@code</span> initialCapacity&#125;), table</span></span><br><span class="line"><span class="comment"> * density (&#123;<span class="doctag">@code</span> loadFactor&#125;), and number of concurrently</span></span><br><span class="line"><span class="comment"> * updating threads (&#123;<span class="doctag">@code</span> concurrencyLevel&#125;).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> initialCapacity the initial capacity. The implementation</span></span><br><span class="line"><span class="comment"> * performs internal sizing to accommodate this many elements,</span></span><br><span class="line"><span class="comment"> * given the specified load factor.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> loadFactor the load factor (table density) for</span></span><br><span class="line"><span class="comment"> * establishing the initial table size</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> concurrencyLevel the estimated number of concurrently</span></span><br><span class="line"><span class="comment"> * updating threads. The implementation may use this value as</span></span><br><span class="line"><span class="comment"> * a sizing hint.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException if the initial capacity is</span></span><br><span class="line"><span class="comment"> * negative or the load factor or concurrencyLevel are</span></span><br><span class="line"><span class="comment"> * nonpositive</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity,</span></span></span><br><span class="line"><span class="function"><span class="params">                         <span class="keyword">float</span> loadFactor, <span class="keyword">int</span> concurrencyLevel)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0.0f</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; concurrencyLevel)   <span class="comment">// Use at least as many bins</span></span><br><span class="line">        initialCapacity = concurrencyLevel;   <span class="comment">// as estimated threads</span></span><br><span class="line">    <span class="keyword">long</span> size = (<span class="keyword">long</span>)(<span class="number">1.0</span> + (<span class="keyword">long</span>)initialCapacity / loadFactor);</span><br><span class="line">    <span class="keyword">int</span> cap = (size &gt;= (<span class="keyword">long</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">        MAXIMUM_CAPACITY : tableSizeFor((<span class="keyword">int</span>)size);</span><br><span class="line">    <span class="keyword">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å«æœ‰ä¸¤ä¸ªå‚æ•°çš„æ„é€ å‡½æ•°å®é™…ä¸Šè°ƒç”¨äº†æ­¤æ„é€ å‡½æ•°ï¼Œä¸” concurrencyLevel ä¸º1</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(initialCapacity, loadFactor, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4ã€ä¼ å…¥ä¸€ä¸ªMapçš„æ„é€ å‡½æ•°"><a href="#4ã€ä¼ å…¥ä¸€ä¸ªMapçš„æ„é€ å‡½æ•°" class="headerlink" title="4ã€ä¼ å…¥ä¸€ä¸ªMapçš„æ„é€ å‡½æ•°"></a>4ã€ä¼ å…¥ä¸€ä¸ªMapçš„æ„é€ å‡½æ•°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentHashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.sizeCtl = DEFAULT_CAPACITY;</span><br><span class="line">    putAll(m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5ã€ConcurrentHashMap-ä¸­æ•°ç»„çš„åˆå§‹åŒ–æ—¶æœº"><a href="#5ã€ConcurrentHashMap-ä¸­æ•°ç»„çš„åˆå§‹åŒ–æ—¶æœº" class="headerlink" title="5ã€ConcurrentHashMap ä¸­æ•°ç»„çš„åˆå§‹åŒ–æ—¶æœº"></a>5ã€ConcurrentHashMap ä¸­æ•°ç»„çš„åˆå§‹åŒ–æ—¶æœº</h3><blockquote><p>æŸ¥çœ‹æºç ï¼Œæˆ‘ä»¬å‘ç° ConcurrentHashMap</p><p>ä¸­ Node æ•°ç»„ä¹Ÿæ˜¯æ‡’åŠ è½½çš„ï¼Œåœ¨ç¬¬ä¸€æ¬¡ put æ—¶æ‰åˆ›å»ºæ•°ç»„ã€‚</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/blogImage/raw/master/img/20211017142131.png" alt="image-20211017142032826"></p><h2 id="1-2ã€-sizeCtl-å«ä¹‰è§£é‡Š"><a href="#1-2ã€-sizeCtl-å«ä¹‰è§£é‡Š" class="headerlink" title="1.2ã€ sizeCtl å«ä¹‰è§£é‡Š"></a>1.2ã€ sizeCtl å«ä¹‰è§£é‡Š</h2><blockquote><p><strong>æ³¨æ„ï¼šä»¥ä¸Šè¿™äº›æ„é€ æ–¹æ³•ä¸­ï¼Œéƒ½æ¶‰åŠåˆ°ä¸€ä¸ªå˜é‡ <code>sizeCtl</code> ï¼Œè¿™ä¸ªå˜é‡æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å˜é‡ï¼Œè€Œä¸”å…·æœ‰éå¸¸ä¸°å¯Œçš„å«ä¹‰ï¼Œå®ƒçš„å€¼ä¸åŒï¼Œå¯¹åº”çš„å«ä¹‰ä¹Ÿä¸ä¸€æ ·ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆå¯¹è¿™ä¸ªå˜é‡ä¸åŒçš„å€¼çš„å«ä¹‰åšä¸€ä¸‹è¯´æ˜ï¼Œåç»­æºç åˆ†æè¿‡ç¨‹ä¸­ï¼Œè¿›ä¸€æ­¥è§£é‡Š</strong></p></blockquote><ul><li><p><code>sizeCtl</code>ä¸º0ï¼Œä»£è¡¨æ•°ç»„æœªåˆå§‹åŒ–ï¼Œ ä¸”æ•°ç»„çš„åˆå§‹å®¹é‡ä¸º16</p></li><li><p><code>sizeCtl</code>ä¸ºæ­£æ•°</p></li></ul><ol><li><strong>å¦‚æœæ•°ç»„æœªåˆå§‹åŒ–ï¼Œé‚£ä¹ˆå…¶è®°å½•çš„æ˜¯æ•°ç»„çš„åˆå§‹å®¹é‡</strong></li><li><strong>å¦‚æœæ•°ç»„å·²åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå…¶è®°å½•çš„æ˜¯æ•°ç»„çš„æ‰©å®¹é˜ˆå€¼</strong></li></ol><blockquote><p>æ‰©å®¹é˜ˆå€¼ = æ•°ç»„çš„åˆå§‹å®¹é‡ * è´Ÿè½½å› å­ï¼ˆé»˜è®¤æ˜¯ 0.75 ï¼‰</p></blockquote><ul><li><p><code>sizeCtl</code>ä¸º -1ï¼Œè¡¨ç¤ºæ•°ç»„æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–</p></li><li><p><code>sizeCtl</code>å°äº0ï¼Œå¹¶ä¸”ä¸æ˜¯ -1ï¼Œè¡¨ç¤ºæ•°ç»„æ­£åœ¨æ‰©å®¹ï¼Œ -(1+n)ï¼Œè¡¨ç¤ºæ­¤æ—¶æœ‰nä¸ªçº¿ç¨‹æ­£åœ¨å…±åŒå®Œæˆæ•°ç»„çš„æ‰©å®¹æ“ä½œ</p></li><li><p><code>sizeCtl</code>æ˜¯ä¸€ä¸ªè¢« <strong>volatile</strong> ä¿®é¥°çš„å˜é‡ï¼Œä¿è¯å…¶å¯è§æ€§</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">int</span> sizeCtl;</span><br></pre></td></tr></table></figure><h1 id="äºŒã€JDK8æ·»åŠ å®‰å…¨"><a href="#äºŒã€JDK8æ·»åŠ å®‰å…¨" class="headerlink" title="äºŒã€JDK8æ·»åŠ å®‰å…¨"></a>äºŒã€JDK8æ·»åŠ å®‰å…¨</h1><h2 id="2-1ã€putæ–¹æ³•å’ŒputValæ–¹æ³•"><a href="#2-1ã€putæ–¹æ³•å’ŒputValæ–¹æ³•" class="headerlink" title="2.1ã€putæ–¹æ³•å’ŒputValæ–¹æ³•"></a>2.1ã€putæ–¹æ³•å’ŒputValæ–¹æ³•</h2><blockquote><p><strong>å’Œ HashMapä¸€æ ·ï¼ŒConcurrentHashMap çš„ put æ–¹æ³•åº•å±‚åŒæ ·è°ƒç”¨äº†putValæ–¹æ³•</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> V <span class="title">putVal</span><span class="params">(K key, V value, <span class="keyword">boolean</span> onlyIfAbsent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//å¦‚æœæœ‰ç©ºå€¼æˆ–è€…ç©ºé”®ï¼Œç›´æ¥æŠ›å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span> || value == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">//åŸºäºkeyè®¡ç®—hashå€¼ï¼Œå¹¶è¿›è¡Œä¸€å®šçš„æ‰°åŠ¨</span></span><br><span class="line">    <span class="keyword">int</span> hash = spread(key.hashCode());</span><br><span class="line">    <span class="comment">//è®°å½•æŸä¸ªæ¡¶ä¸Šå…ƒç´ çš„ä¸ªæ•°ï¼Œå¦‚æœè¶…è¿‡8ä¸ªï¼Œä¼šè½¬æˆçº¢é»‘æ ‘</span></span><br><span class="line">    <span class="keyword">int</span> binCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> n, i, fh;</span><br><span class="line">        <span class="comment">//å¦‚æœæ•°ç»„è¿˜æœªåˆå§‹åŒ–ï¼Œå…ˆå¯¹æ•°ç»„è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            tab = initTable();</span><br><span class="line">	    <span class="comment">//å¦‚æœhashè®¡ç®—å¾—åˆ°çš„æ¡¶ä½ç½®æ²¡æœ‰å…ƒç´ ï¼Œåˆ©ç”¨caså°†å…ƒç´ æ·»åŠ </span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//cas+è‡ªæ—‹ï¼ˆå’Œå¤–ä¾§çš„foræ„æˆè‡ªæ—‹å¾ªç¯ï¼‰ï¼Œä¿è¯å…ƒç´ æ·»åŠ å®‰å…¨</span></span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                         <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœhashè®¡ç®—å¾—åˆ°çš„æ¡¶ä½ç½®å…ƒç´ çš„hashå€¼ä¸ºMOVEDï¼Œè¯æ˜æ­£åœ¨æ‰©å®¹ï¼Œé‚£ä¹ˆååŠ©æ‰©å®¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//hashè®¡ç®—çš„æ¡¶ä½ç½®å…ƒç´ ä¸ä¸ºç©ºï¼Œä¸”å½“å‰æ²¡æœ‰å¤„äºæ‰©å®¹æ“ä½œï¼Œè¿›è¡Œå…ƒç´ æ·»åŠ </span></span><br><span class="line">            V oldVal = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//å¯¹å½“å‰æ¡¶è¿›è¡ŒåŠ é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ‰§è¡Œå…ƒç´ æ·»åŠ æ“ä½œ</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">//æ™®é€šé“¾è¡¨èŠ‚ç‚¹</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                          value, <span class="keyword">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//æ ‘èŠ‚ç‚¹ï¼Œå°†å…ƒç´ æ·»åŠ åˆ°çº¢é»‘æ ‘ä¸­</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                       value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//é“¾è¡¨é•¿åº¦å¤§äº/ç­‰äº8ï¼Œå°†é“¾è¡¨è½¬æˆçº¢é»‘æ ‘</span></span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="comment">//å¦‚æœæ˜¯é‡å¤é”®ï¼Œç›´æ¥å°†æ—§å€¼è¿”å›</span></span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//æ·»åŠ çš„æ˜¯æ–°å…ƒç´ ï¼Œç»´æŠ¤é›†åˆé•¿åº¦ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦è¦è¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨ <code>putVal</code>æ–¹æ³•ä¸­å¯ä»¥å‘ç°ï¼Œ<strong>ConcurrentHashMap</strong>åœ¨ç¬¬ä¸€æ¬¡<code>put</code>çš„æ—¶å€™æ‰åˆå§‹åŒ–Nodeæ•°ç»„ï¼Œè¿™ä¸€ç‚¹å’Œ<strong>HashMap</strong>ç±»ä¼¼</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¦‚æœæ•°ç»„è¿˜æœªåˆå§‹åŒ–ï¼Œå…ˆå¯¹æ•°ç»„è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">if</span> (tab == <span class="keyword">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">    tab = initTable();</span><br></pre></td></tr></table></figure><h3 id="1ã€ä½¿ç”¨-spread-æ‰°åŠ¨æ–¹æ³•ä½¿å¾—åˆ°çš„å“ˆå¸Œå€¼æ›´åŠ åˆ†æ•£"><a href="#1ã€ä½¿ç”¨-spread-æ‰°åŠ¨æ–¹æ³•ä½¿å¾—åˆ°çš„å“ˆå¸Œå€¼æ›´åŠ åˆ†æ•£" class="headerlink" title="1ã€ä½¿ç”¨ spread æ‰°åŠ¨æ–¹æ³•ä½¿å¾—åˆ°çš„å“ˆå¸Œå€¼æ›´åŠ åˆ†æ•£"></a>1ã€ä½¿ç”¨ spread æ‰°åŠ¨æ–¹æ³•ä½¿å¾—åˆ°çš„å“ˆå¸Œå€¼æ›´åŠ åˆ†æ•£</h3><blockquote><p>ä¸ HashMap ç›¸åŒï¼Œ ConcurrentHashMap åŒæ ·æœ‰ä¸€ä¸ªæ–¹æ³•æ¥å¯¹ Key è®¡ç®—å¾—åˆ°çš„å“ˆå¸Œå€¼è¿›è¡Œæ‰°åŠ¨ï¼Œä¸ HashMap ä¸åŒçš„æ˜¯ï¼ŒConcurrentHashMap è¿˜å¼•å…¥äº†ä¸€ä¸ª <code>HASH_BITS</code> å¸¸é‡æ¥å‚ä¸è®¡ç®—ï¼Œ<strong>ç›®çš„æ˜¯ä¸ºäº†è®©å¾—åˆ°çš„å“ˆå¸Œå€¼ä¸€å®šä¸ºæ­£æ•°</strong></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// usable bits of normal node hash</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HASH_BITS = <span class="number">0x7fffffff</span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">spread</span><span class="params">(<span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (h ^ (h &gt;&gt;&gt; <span class="number">16</span>)) &amp; HASH_BITS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å°† <code>HASH_BITS</code> æ¢ç®—ä¸ºäºŒè¿›åˆ¶ç»“æœå¦‚ä¸‹ï¼Œä»»ä½•æ•°ä¸ <code>HASH_BITS</code> è¿›è¡Œè¿ç®—åï¼Œå¾—åˆ°çš„ç»“æœç¬¬ä¸€ä½éƒ½ä¼šæ˜¯ 0 ï¼Œè€ŒäºŒè¿›åˆ¶çš„ç¬¬ä¸€ä½ä¸ºç¬¦å·ä½ï¼Œç¬¦å·ä½ 0 ä¸ºæ­£æ•°</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/blogImage/raw/master/img/20211017151227.png" alt="image-20211017151227503"></p><h3 id="2ã€initTableåˆå§‹åŒ–æ•°ç»„æ–¹æ³•"><a href="#2ã€initTableåˆå§‹åŒ–æ•°ç»„æ–¹æ³•" class="headerlink" title="2ã€initTableåˆå§‹åŒ–æ•°ç»„æ–¹æ³•"></a>2ã€initTableåˆå§‹åŒ–æ•°ç»„æ–¹æ³•</h3><blockquote><p>åˆå§‹åŒ– <strong>Node</strong> æ•°ç»„çš„æ–¹æ³•ï¼Œè¿™é‡Œä½¿ç”¨ CAS è‡ªæ—‹ä¿è¯çº¿ç¨‹å®‰å…¨</p></blockquote><ul><li>å¦‚æœå½“å‰ <code>sizeCtl &lt; 0</code> ï¼Œé‚£ä¹ˆæ ¹æ®è¡¨ç¤ºæœ‰çº¿ç¨‹æ­£åœ¨å¯¹ <strong>Node</strong> æ•°ç»„è¿›è¡Œåˆå§‹åŒ–ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è®©å‡ºcpuè°ƒåº¦æƒç»™æ­£åœ¨è¿›è¡Œåˆå§‹åŒ–æ•°ç»„çš„çº¿ç¨‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¦‚æœsizeCtlçš„å€¼ï¼ˆ-1ï¼‰å°äº0ï¼Œè¯´æ˜æ­¤æ—¶æ­£åœ¨åˆå§‹åŒ–ï¼Œ è®©å‡ºcpu</span></span><br><span class="line"><span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">    Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br></pre></td></tr></table></figure><ul><li>å¦‚æœ <code>sizeCtl != 0</code> ï¼Œé‚£ä¹ˆå½“å‰çº¿ç¨‹å¯ä»¥å¯¹ <strong>Node</strong> æ•°ç»„è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™é‡Œä½¿ç”¨CASè‡ªé€‰æ¥å¯¹ <code>sizeCtl</code> è¿›è¡Œä¿®æ”¹ï¼Œå¦‚æœä¿®æ”¹æˆåŠŸå°±ç»§ç»­åˆå§‹åŒ–ï¼Œå¦åˆ™ç»§ç»­è‡ªæ—‹</li><li>å¦‚æœä¿®æ”¹ <code>sizeCtl</code> æˆåŠŸï¼Œæ­¤æ—¶å…ˆå¯¹ <strong>Node</strong> æ•°ç»„è¿›è¡Œåˆ¤ç©ºæ£€æŸ¥</li><li>å¦‚æœ <strong>Node</strong> æ•°ç»„ä¸ºç©ºï¼Œå°± new ä¸€ä¸ª <strong>Node</strong> æ•°ç»„ï¼ŒåŒæ—¶è®¡ç®—æ‰©å®¹é˜ˆå€¼</li></ul><blockquote><p>ç”±äº<strong>ConcurrentHashMapçš„é»˜è®¤è´Ÿè½½å› å­ä¸º 0.75</strong> ï¼Œè€Œ n å³ç§»ä¸¤ä½çš„å€¼åˆšå¥½ç­‰äºåŸå€¼nçš„å››åˆ†ä¹‹ä¸€ï¼Œ<strong>æ•… n - (n &gt;&gt;&gt; 2) æ­£å¥½ä¸ºåŸå€¼nçš„ 0.75 å€</strong>ï¼Œè¿™é‡Œä½¿ç”¨äº†ä½è¿ç®—æ¥é¿å…é™¤æ³•æé«˜æ•ˆç‡ã€‚</p></blockquote><ul><li>åœ¨è®¡ç®—å®Œé˜ˆå€¼ä¹‹åï¼Œä½¿ç”¨ <code>break</code> è·³å‡ºå¾ªç¯ã€‚</li></ul><blockquote><p>åœ¨ initTable æ–¹æ³•ä¸­æ²¡æœ‰æ˜¾å¼åŠ é”ï¼Œè€Œæ˜¯ä½¿ç”¨ CAS è‡ªæ—‹çš„æ–¹å¼æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p><p>å½“ä¸€ä¸ªçº¿ç¨‹æŠ¢åˆ° CPU çš„æ‰§è¡Œæƒæ—¶ï¼Œå¦‚æœæ­¤æ—¶ sc çš„å€¼å°äº 0 ï¼Œé‚£ä¹ˆè¯æ˜å·²ç»æœ‰çº¿ç¨‹åœ¨å¯¹è¿™ä¸ª ConcurrentHashMap å¯¹è±¡è¿›è¡Œåˆå§‹åŒ–ï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹éœ€è¦è®©å‡º CPU çš„æ‰§è¡Œæƒã€‚å¦‚æœæ­¤æ—¶ sc çš„å€¼ä¸å°äº 0 ï¼Œé‚£ä¹ˆè¯æ˜è¿˜æ²¡æœ‰å¯¹æ•°ç»„è¿›è¡Œåˆå§‹åŒ–ï¼Œæ­¤æ—¶ä½¿ç”¨ CAS ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯¹æ•°ç»„è¿›è¡Œåˆå§‹åŒ–ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="keyword">int</span> sc;</span><br><span class="line">    <span class="comment">//cas+è‡ªæ—‹ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¯¹æ•°ç»„è¿›è¡Œåˆå§‹åŒ–æ“ä½œ</span></span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœsizeCtlçš„å€¼ï¼ˆ-1ï¼‰å°äº0ï¼Œè¯´æ˜æ­¤æ—¶æ­£åœ¨åˆå§‹åŒ–ï¼Œ è®©å‡ºcpu</span></span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">            Thread.yield(); <span class="comment">// lost initialization race; just spin</span></span><br><span class="line">        <span class="comment">//casä¿®æ”¹sizeCtlçš„å€¼ä¸º-1ï¼Œä¿®æ”¹æˆåŠŸï¼Œè¿›è¡Œæ•°ç»„åˆå§‹åŒ–ï¼Œå¤±è´¥ï¼Œç»§ç»­è‡ªæ—‹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// åœ¨è¿™é‡Œä½¿ç”¨åŒé‡æ£€æŸ¥é˜²æ­¢å¤šæ¬¡åˆå§‹åŒ–</span></span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="keyword">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//sizeCtlä¸º0ï¼Œå–é»˜è®¤é•¿åº¦16ï¼Œå¦åˆ™å»sizeCtlçš„å€¼ï¼Œå¦‚æœ sizeCtl &gt; 0 ä¸”æ•°ç»„æœªåˆå§‹åŒ–ï¼Œåˆ™ sizeCtl ä¸ºåˆå§‹åŒ–çš„å¤§å°</span></span><br><span class="line">                    <span class="keyword">int</span> n = (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                    <span class="comment">//åŸºäºåˆå§‹é•¿åº¦ï¼Œæ„å»ºæ•°ç»„å¯¹è±¡</span></span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n];</span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    <span class="comment">//è®¡ç®—æ‰©å®¹é˜ˆå€¼ï¼Œå¹¶èµ‹å€¼ç»™sc</span></span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">//å°†æ‰©å®¹é˜ˆå€¼ï¼Œèµ‹å€¼ç»™sizeCtl</span></span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3ã€è®¡ç®—é”®å€¼å¯¹æ·»åŠ çš„ä½ç½®"><a href="#3ã€è®¡ç®—é”®å€¼å¯¹æ·»åŠ çš„ä½ç½®" class="headerlink" title="3ã€è®¡ç®—é”®å€¼å¯¹æ·»åŠ çš„ä½ç½®"></a>3ã€è®¡ç®—é”®å€¼å¯¹æ·»åŠ çš„ä½ç½®</h3><ul><li><p>ä¸ HashMap ç›¸åŒï¼Œ<strong>ConcurrentHashMap ä¸­çš„å¯»å€æ–¹æ³•ä¹Ÿæ˜¯ Key çš„å“ˆå¸Œå€¼ä¸æ•°ç»„é•¿åº¦ - 1 ç›¸ä¸</strong></p></li><li><p>åœ¨åˆå§‹åŒ–å®Œæ•°ç»„ä¹‹åï¼Œä¼šä½¿ç”¨<code>tabAt</code> å‡½æ•°è®¡ç®—è¦æ·»åŠ çš„<code>Entry</code> å¯¹è±¡åœ¨æ•°ç»„ä¸­çš„ä½ç½®</p></li></ul><blockquote><p>è¿™é‡Œä½¿ç”¨ä¸¤ä¸ª CAS æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åŒæ—¶èµ°åˆ°ä¸‹é¢çš„ if ä¸­ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œ<strong>ä¸‹é¢çš„ tabAt å’Œ casTabAt éƒ½æ˜¯ CAS æ“ä½œ</strong>ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¦‚æœhashè®¡ç®—å¾—åˆ°çš„æ¡¶ä½ç½®æ²¡æœ‰å…ƒç´ ï¼Œåˆ©ç”¨caså°†å…ƒç´ æ·»åŠ </span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">//cas+è‡ªæ—‹ï¼ˆå’Œå¤–ä¾§çš„foræ„æˆè‡ªæ—‹å¾ªç¯ï¼‰ï¼Œä¿è¯å…ƒç´ æ·»åŠ å®‰å…¨</span></span><br><span class="line">    <span class="keyword">if</span> (casTabAt(tab, i, <span class="keyword">null</span>,</span><br><span class="line">                 <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key, value, <span class="keyword">null</span>)))</span><br><span class="line">        <span class="keyword">break</span>;                   <span class="comment">// no lock when adding to empty bin</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>tabAt</code>å‡½æ•°åº•å±‚ä½¿ç”¨äº†CAS</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="function">Node&lt;K,V&gt; <span class="title">tabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((<span class="keyword">long</span>)i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœ<strong>table</strong>æ•°ç»„ä¸­è®¡ç®—å‡ºæ¥çš„ä½ç½®å…ƒç´ ä¸ºç©ºï¼Œé‚£ä¹ˆç›´æ¥å°†ç›´æ¥åˆ›å»ºä¸€ä¸ª<strong>Node</strong>èŠ‚ç‚¹å¹¶æ·»åŠ åˆ°è¯¥ä½ç½®å³å¯ã€‚</li></ul><h3 id="4ã€å¤šçº¿ç¨‹ååŠ©æ‰©å®¹"><a href="#4ã€å¤šçº¿ç¨‹ååŠ©æ‰©å®¹" class="headerlink" title="4ã€å¤šçº¿ç¨‹ååŠ©æ‰©å®¹"></a>4ã€å¤šçº¿ç¨‹ååŠ©æ‰©å®¹</h3><blockquote><p>å¦‚æœè®¡ç®—å‡ºæ¥<strong>Node</strong>æ•°ç»„ä¸­è¦æ’å…¥ä½ç½®çš„å…ƒç´ çš„hashå€¼ä¸º<code>MOVED</code> ï¼Œé‚£ä¹ˆè¯æ˜å½“å‰ <strong>Node</strong> æ•°ç»„ä¸­è¦æ’å…¥ä½ç½®çš„å…ƒç´ ä¸º <strong>forwarding</strong> èŠ‚ç‚¹ï¼Œè¿™ä¸ªèŠ‚ç‚¹çš„hashå€¼ä¸º -1ã€‚</p><p><strong>forwarding</strong> èŠ‚ç‚¹å’Œ <strong>å¤šçº¿ç¨‹ååŠ©æ‰©å®¹</strong> æœ‰å…³ï¼Œå½“æ•°ç»„ä¸­æŸä¸ªä½ç½®å­˜æ”¾çš„èŠ‚ç‚¹å€¼çš„ hash å€¼ä¸º -1 æ—¶ï¼Œä»£è¡¨è¿™ä¸ªæ•°ç»„ä¸­çš„å…ƒç´ æ­£åœ¨è¿›è¡Œæ‰©å®¹æ“ä½œï¼Œæ­¤æ—¶ä¸èƒ½è¿›è¡Œæ·»åŠ æ“ä½œï¼Œä½†æ˜¯å¯ä»¥è¿›è¡ŒååŠ©æ‰©å®¹ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨äº† <code>helpTransfer</code> æ–¹æ³•è¿›è¡Œæ‰©å®¹æ“ä½œã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">    tab = helpTransfer(tab, f);</span><br></pre></td></tr></table></figure><blockquote><p><strong>ConcurrentHashMap</strong> ä¸­ <code>MOVED</code> çš„å®šä¹‰å¦‚ä¸‹</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MOVED     = -<span class="number">1</span>; <span class="comment">// hash for forwarding nodes</span></span><br></pre></td></tr></table></figure><h3 id="5ã€putæ–¹æ³•åŠ é”å›¾è§£"><a href="#5ã€putæ–¹æ³•åŠ é”å›¾è§£" class="headerlink" title="5ã€putæ–¹æ³•åŠ é”å›¾è§£"></a>5ã€putæ–¹æ³•åŠ é”å›¾è§£</h3><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210305142810.jpg" alt="Snipaste_2020-05-16_12-04-08"></p><ul><li><p>ä¸Šé¢çš„ <code>if/else-if</code> åˆ†åˆ«å¯¹åº” <strong>Node</strong> æ•°ç»„<strong>æœªåˆå§‹åŒ–</strong>ã€<strong>Node</strong> æ•°ç»„è¦æ·»åŠ çš„<strong>ä½ç½®å…ƒç´ ä¸ºç©º</strong>ã€<strong>Node</strong> æ•°ç»„è¦æ·»åŠ çš„ä½ç½®<strong>æ­£åœ¨æ‰©å®¹</strong>çš„æƒ…å†µã€‚</p></li><li><p>ä¸‹é¢çš„ <code>else</code> è¡¨ç¤ºè¦æ·»åŠ çš„ä½ç½®å…ƒç´ å·²ç»å­˜åœ¨å…ƒç´ äº†ï¼Œæ­¤æ—¶å¯¹è¯¥ä½ç½®ä¸Šçš„å…ƒç´ åŠ é”ã€‚</p></li><li><p><strong>ConcurrentHashMap</strong> åœ¨æ·»åŠ å…ƒç´ æ—¶ï¼Œ<strong>åªä¼šå¯¹è¦åŠ å…¥çš„æ¡¶åŠ é”</strong>ï¼Œä¸ä¼šå½±å“å…¶ä»–æ¡¶ä½çš„çº¿ç¨‹æ“ä½œï¼Œé”ä½çš„æ˜¯è¿™ä¸ªæ¡¶ä¸Šçš„å¤´èŠ‚ç‚¹</p></li><li><p>åœ¨æ·»åŠ æ—¶ï¼Œå¦‚æœå½“å‰æ¡¶ä½ä¸Šçš„å¤´èŠ‚ç‚¹çš„å“ˆå¸Œå€¼å¤§äºç­‰äº0ï¼Œé‚£ä¹ˆè¯æ˜è¿™ä¸ªæ¡¶ä¸­å­˜æ”¾çš„æ˜¯é“¾è¡¨ç»“æ„çš„å…ƒç´ </p></li></ul><blockquote><p>å¦‚æœæ˜¯é“¾è¡¨å…ƒç´ ï¼Œé‚£ä¹ˆå¾ªç¯éå†è¿™ä¸ªé“¾è¡¨ï¼Œå¦‚æœå‘ç°é“¾è¡¨å…ƒç´ çš„ key å’Œå¾…æ’å…¥èŠ‚ç‚¹çš„ key ç›¸ç­‰ï¼Œé‚£ä¹ˆç›´æ¥ç”¨æ–°å€¼è¦†ç›–æ—§å€¼ï¼Œå¦åˆ™å°±ä½¿ç”¨<strong>å°¾æ’æ³•</strong>æ’å…¥å…ƒç´ </p></blockquote><ul><li>å¦‚æœæ­¤æ—¶æ¡¶ä¸Šçš„å…ƒç´ å·²ç»æ ‘åŒ–ï¼Œé‚£ä¹ˆå°±æŒ‰ç…§çº¢é»‘æ ‘çš„æ’å…¥è§„åˆ™è¿›è¡Œæ–°å¢</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//hashè®¡ç®—çš„æ¡¶ä½ç½®å…ƒç´ ä¸ä¸ºç©ºï¼Œä¸”å½“å‰æ²¡æœ‰å¤„äºæ‰©å®¹æ“ä½œï¼Œè¿›è¡Œå…ƒç´ æ·»åŠ </span></span><br><span class="line">    V oldVal = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//å¯¹å½“å‰æ¡¶è¿›è¡ŒåŠ é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ‰§è¡Œå…ƒç´ æ·»åŠ æ“ä½œ</span></span><br><span class="line">    <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">        <span class="comment">// ä¸ºä»€ä¹ˆè¿˜è¦åšåˆ¤æ–­ï¼Œé˜²æ­¢è¿™ä¸ªæ¡¶ä¸Šçš„å…ƒç´ æ ‘åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">            <span class="comment">//æ™®é€šé“¾è¡¨èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                binCount = <span class="number">1</span>;</span><br><span class="line">                <span class="comment">//éå†é“¾è¡¨ï¼Œé€ä¸ªæ¯”è¾ƒé“¾è¡¨å…ƒç´ çš„keyå’Œå¾…æ’å…¥èŠ‚ç‚¹çš„keyæ˜¯å¦ç›¸ç­‰</span></span><br><span class="line">                <span class="comment">//å¦‚æœä¸æ˜¯ï¼Œå°±ä½¿ç”¨å°¾æ’æ³•æ’å…¥å…ƒç´ ï¼Œå¦åˆ™å°±è¦†ç›–æ—§å€¼</span></span><br><span class="line">                <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                    K ek;</span><br><span class="line">                    <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                        ((ek = e.key) == key ||</span><br><span class="line">                         (ek != <span class="keyword">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                        oldVal = e.val;</span><br><span class="line">                        <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                            e.val = value;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    Node&lt;K,V&gt; pred = e;</span><br><span class="line">                    <span class="keyword">if</span> ((e = e.next) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        pred.next = <span class="keyword">new</span> Node&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                  value, <span class="keyword">null</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//æ ‘èŠ‚ç‚¹ï¼Œå°†å…ƒç´ æ·»åŠ åˆ°çº¢é»‘æ ‘ä¸­</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                Node&lt;K,V&gt; p;</span><br><span class="line">                binCount = <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                               value)) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    oldVal = p.val;</span><br><span class="line">                    <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                        p.val = value;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//é“¾è¡¨é•¿åº¦å¤§äº/ç­‰äº8ï¼Œå°†é“¾è¡¨è½¬æˆçº¢é»‘æ ‘</span></span><br><span class="line">        <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">            treeifyBin(tab, i);</span><br><span class="line">        <span class="comment">//å¦‚æœæ˜¯é‡å¤é”®ï¼Œç›´æ¥å°†æ—§å€¼è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> oldVal;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6ã€æ·»åŠ å®Œå…ƒç´ åè¿›è¡Œé“¾è¡¨é•¿åº¦åˆ¤æ–­"><a href="#6ã€æ·»åŠ å®Œå…ƒç´ åè¿›è¡Œé“¾è¡¨é•¿åº¦åˆ¤æ–­" class="headerlink" title="6ã€æ·»åŠ å®Œå…ƒç´ åè¿›è¡Œé“¾è¡¨é•¿åº¦åˆ¤æ–­"></a>6ã€æ·»åŠ å®Œå…ƒç´ åè¿›è¡Œé“¾è¡¨é•¿åº¦åˆ¤æ–­</h3><ul><li>å’Œ <strong>HashMap</strong> ç±»ä¼¼ï¼Œåœ¨æ·»åŠ å®Œä¸€ä¸ªå…ƒç´ åéœ€è¦å¯¹<strong>æ¡¶å…ƒç´ ä¸ªæ•°</strong>åŠ<strong>æ•°ç»„é•¿åº¦</strong>è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ¡¶ä¸­<strong>é“¾è¡¨é•¿åº¦å¤§äº8</strong>ä¸”<strong>æ•°ç»„é•¿åº¦å¤§äº64</strong>ï¼Œå°±å°†è¯¥æ¡¶ä¸Šçš„é“¾è¡¨<strong>è½¬æ¢</strong>ä¸ºä¸€æ£µçº¢é»‘æ ‘ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//é“¾è¡¨é•¿åº¦å¤§äº/ç­‰äº8ï¼Œå°†é“¾è¡¨è½¬æˆçº¢é»‘æ ‘</span></span><br><span class="line">    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">        treeifyBin(tab, i);</span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯é‡å¤é”®ï¼Œç›´æ¥å°†æ—§å€¼è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (oldVal != <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> oldVal;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ ‘åŒ–æ–¹æ³• <code>treeifyBin</code> åªæœ‰å½“<strong>æ•°ç»„é•¿åº¦å¤§äºç­‰äº64</strong>çš„æ—¶å€™æ‰ä¼šé€‰æ‹©æ ‘åŒ–ï¼Œä¸”æ ‘åŒ–æ—¶çš„åŠ é”è¿‡ç¨‹ä¹Ÿæ˜¯å¯¹å•ä¸€æ¡¶åŠ é”ã€‚</li></ul><blockquote><p>å¦‚æœæ•°ç»„é•¿åº¦å°äº64ï¼Œä¼šè¿›è¡Œæ•°ç»„æ‰©å®¹ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TREEIFY_CAPACITY = <span class="number">64</span>;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">       Node&lt;K,V&gt; b; <span class="keyword">int</span> n, sc;</span><br><span class="line">       <span class="keyword">if</span> (tab != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="comment">// å¦‚æœå½“å‰é“¾è¡¨é•¿åº¦å°äº 64 ï¼Œåˆ™ä¼šè¿›è¡Œæ‰©å®¹ï¼Œè€Œä¸æ˜¯æ ‘åŒ–</span></span><br><span class="line">           <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">               tryPresize(n &lt;&lt; <span class="number">1</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="keyword">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">               <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">                       TreeNode&lt;K,V&gt; hd = <span class="keyword">null</span>, tl = <span class="keyword">null</span>;</span><br><span class="line">                       <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                           TreeNode&lt;K,V&gt; p =</span><br><span class="line">                               <span class="keyword">new</span> TreeNode&lt;K,V&gt;(e.hash, e.key, e.val,</span><br><span class="line">                                                 <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                           <span class="keyword">if</span> ((p.prev = tl) == <span class="keyword">null</span>)</span><br><span class="line">                               hd = p;</span><br><span class="line">                           <span class="keyword">else</span></span><br><span class="line">                               tl.next = p;</span><br><span class="line">                           tl = p;</span><br><span class="line">                       &#125;</span><br><span class="line">                       setTabAt(tab, index, <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hd));</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨ addCount æ–¹æ³•ç»´æŠ¤é›†åˆé•¿åº¦</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">addCount(<span class="number">1L</span>, binCount);</span><br></pre></td></tr></table></figure><h2 id="2-2ã€ConcurrentHashMap-ç©ºå€¼å’Œç©ºé”®é—®é¢˜"><a href="#2-2ã€ConcurrentHashMap-ç©ºå€¼å’Œç©ºé”®é—®é¢˜" class="headerlink" title="2.2ã€ConcurrentHashMap ç©ºå€¼å’Œç©ºé”®é—®é¢˜"></a>2.2ã€ConcurrentHashMap ç©ºå€¼å’Œç©ºé”®é—®é¢˜</h2><blockquote><p><strong>HashMap</strong>æ˜¯å…è®¸<em>ç©ºé”®ç©ºå€¼</em>çš„ï¼Œå…¶ä¸­ç©ºé”®åªå…è®¸æœ‰ä¸€ä¸ªï¼Œç©ºå€¼å…è®¸æœ‰å¤šä¸ªï¼Œä½† <strong>ConcurrentHashMap</strong> ä¸å…è®¸æœ‰ç©ºé”®ç©ºå€¼ã€‚</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210304223605.png" alt="image-20210304223605030"></p><blockquote><p><code>spread</code>æ–¹æ³•æ˜¯ <strong>ConcurrentHashMap</strong> ä¸­çš„<strong>æ‰°åŠ¨æ–¹æ³•</strong> ï¼Œç”¨äºå¢åŠ æ•£åˆ—æ€§ï¼Œä¸”ä¿è¯ <code>spread</code> æ–¹æ³•è¿”å›çš„å€¼ä¸€å®šä¸ºæ­£æ•°ã€‚</p><p>åœ¨HashMapçš„hashæ–¹æ³•è®¡ç®—ç»“æœçš„åŸºç¡€ä¸Šï¼Œè®©å¾—åˆ°çš„å€¼ä¸ <code>0x7fffffff</code> è¿›è¡Œä¸€ä¸ªä¸è¿ç®—ã€‚</p><p>å°† <code>0x7fffffff</code> æ”¾å…¥è®¡ç®—å™¨ä¸­è®¡ç®—ï¼Œå¾—åˆ°çš„äºŒè¿›åˆ¶å€¼ä¸º</p><p><code>01111111111111111111111111111111</code></p><p>ä»»ä½•æ•°ä¸ <code>01111111111111111111111111111111</code> å¯ä»¥ä¿è¯è¯¥æ•°çš„ç¬¬ä¸€ä½ä¸º0ï¼Œåœ¨äºŒè¿›åˆ¶ä¸­ï¼Œç¬¬ä¸€ä½ä¸º0çš„æ•°ä¸ºæ­£æ•°ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HASH_BITS = <span class="number">0x7fffffff</span>; <span class="comment">// usable bits of normal node hash    </span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">spread</span><span class="params">(<span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> (h ^ (h &gt;&gt;&gt; <span class="number">16</span>)) &amp; HASH_BITS;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><h2 id="2-3ã€addCount-æ–¹æ³•æºç åˆ†æ"><a href="#2-3ã€addCount-æ–¹æ³•æºç åˆ†æ" class="headerlink" title="2.3ã€addCount æ–¹æ³•æºç åˆ†æ"></a>2.3ã€addCount æ–¹æ³•æºç åˆ†æ</h2><blockquote><p>åœ¨æ·»åŠ æ•°æ®åï¼ŒConcurrentHashMap ä¼šè°ƒç”¨ addCount æ–¹æ³•æ¥ç»´æŠ¤é›†åˆçš„é•¿åº¦ï¼Œå¦‚æœå‘ç°é›†åˆä¸­çš„å…ƒç´ å¤§äºæ‰©å®¹é˜ˆå€¼ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šè¿›è¡Œæ‰©å®¹æ“ä½œã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">addCount</span><span class="params">(<span class="keyword">long</span> x, <span class="keyword">int</span> check)</span> </span>&#123;</span><br><span class="line">    CounterCell[] as; <span class="keyword">long</span> b, s;</span><br><span class="line">    <span class="keyword">if</span> ((as = counterCells) != <span class="keyword">null</span> ||</span><br><span class="line">        !U.compareAndSwapLong(<span class="keyword">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">        CounterCell a; <span class="keyword">long</span> v; <span class="keyword">int</span> m;</span><br><span class="line">        <span class="keyword">boolean</span> uncontended = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (as == <span class="keyword">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="keyword">null</span> ||</span><br><span class="line">            !(uncontended =</span><br><span class="line">              U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">            fullAddCount(x, uncontended);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (check &lt;= <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        s = sumCount();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab, nt; <span class="keyword">int</span> n, sc;</span><br><span class="line">        <span class="keyword">while</span> (s &gt;= (<span class="keyword">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">               (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                    transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                         (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="1ã€baseCount-å˜é‡"><a href="#1ã€baseCount-å˜é‡" class="headerlink" title="1ã€baseCount å˜é‡"></a>1ã€baseCount å˜é‡</h3><ul><li>ä¸ºäº†ç»Ÿè®¡ ConcurrentHashMap ä¸­çš„å…ƒç´ ä¸ªæ•° <strong>size</strong> ï¼Œ ConcurrentHashMap æä¾›äº† baseCount å’Œ counterCells ä¸¤ä¸ªè¾…åŠ©å˜é‡æ¥è®°å½•å…ƒç´ ä¸ªæ•°</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConcurrentHashMapä¸­å…ƒç´ ä¸ªæ•°,ä½†è¿”å›çš„ä¸ä¸€å®šæ˜¯å½“å‰Mapçš„çœŸå®å…ƒç´ ä¸ªæ•°ã€‚åŸºäºCASæ— é”æ›´æ–°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">long</span> baseCount;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> CounterCell[] counterCells;</span><br></pre></td></tr></table></figure><blockquote><p>å½“æœ‰å¤šä¸ªçº¿ç¨‹éœ€è¦è®°å½•å…ƒç´ ä¸ªæ•°æ—¶ï¼Œå¦‚æœå®ƒä»¬å¯¹ baseCount çš„åŸå­ä¿®æ”¹å¤±è´¥ï¼Œé‚£ä¹ˆå®ƒä»¬ä¼šæ‰¾åˆ° counterCells æ•°ç»„ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œç„¶åå¯¹å…¶ä¸­çš„ä¸€ä¸ªå…ƒç´ è¿›è¡Œ + 1 æ“ä½œï¼Œæ•…è€Œ baseCount å˜é‡çš„å€¼ä¸æ˜¯å‡†ç¡®çš„çœŸå®å…ƒç´ ä¸ªæ•°ï¼Œè€Œæ˜¯ baseCount + counterCells ä¸­æ‰€æœ‰æ•°ç»„å…ƒç´ çš„å’Œã€‚</p></blockquote><ul><li>åœ¨ addCount æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ª sumCount æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯ç”¨æ¥è®¡ç®— ConcurrentHashMap ä¸­çœŸå®å…ƒç´ ä¸ªæ•°çš„æ–¹æ³•</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">long</span> <span class="title">sumCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CounterCell[] as = counterCells; CounterCell a;</span><br><span class="line">    <span class="keyword">long</span> sum = baseCount;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// éå† counterCells æ•°ç»„</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸‹æ ‡å¯¹åº”çš„å…ƒç´ ä¸ä¸ºç©ºï¼Œé‚£ä¹ˆè¿›è¡Œå¢åŠ æ“ä½œã€‚</span></span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="keyword">null</span>)</span><br><span class="line">                sum += a.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2ã€è®¡ç®—å®Œå…ƒç´ ä¸ªæ•°åè¿›è¡Œæ‰©å®¹"><a href="#2ã€è®¡ç®—å®Œå…ƒç´ ä¸ªæ•°åè¿›è¡Œæ‰©å®¹" class="headerlink" title="2ã€è®¡ç®—å®Œå…ƒç´ ä¸ªæ•°åè¿›è¡Œæ‰©å®¹"></a>2ã€è®¡ç®—å®Œå…ƒç´ ä¸ªæ•°åè¿›è¡Œæ‰©å®¹</h3><ul><li>å¦‚æœè¦è¿›è¡Œæ‰©å®¹ï¼Œé‚£ä¹ˆéœ€è¦å°† sizeCtl å˜é‡å˜ä¸ºä¸€ä¸ªè´Ÿæ•°ï¼Œ ConcurrentHashMap é‡‡ç”¨äº†å·¦ç§»çš„æ–¹æ³•å°†å˜é‡çš„äºŒè¿›åˆ¶ç¬¦å·ä½å˜ä¸º 1</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab, nt; <span class="keyword">int</span> n, sc;</span><br><span class="line">    <span class="comment">// s æ˜¯ä¸Šä¸€æ­¥è®¡ç®—å‡ºæ¥çš„ï¼Œ ConcurrentHashMap ä¸­å®é™…çš„å…ƒç´ ä¸ªæ•°ï¼Œæˆ‘ä»¬åˆ¤æ–­ s å˜é‡ä¸æ‰©å®¹é˜ˆå€¼çš„å…³ç³»</span></span><br><span class="line">    <span class="comment">// ç”±äºåˆ°è¿™ä¸€æ­¥æ—¶ ConcurrentHashMap ä¸­çš„æ•°ç»„å·²ç»æ‰©å®¹å®Œæ¯•ï¼Œæ‰€ä»¥æ­¤æ—¶çš„ sizeCtl å˜é‡ä¸­å­˜å‚¨çš„å°±æ˜¯æ‰©å®¹é˜ˆå€¼</span></span><br><span class="line">    <span class="keyword">while</span> (s &gt;= (<span class="keyword">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">           (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">        <span class="keyword">int</span> rs = resizeStamp(n);</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡è¿›æ¥æ—¶ï¼Œç”±äº sc æ˜¯æ­¤æ—¶çš„æ‰©å®¹é˜ˆå€¼ï¼Œæ‰€ä»¥ä¸å¯èƒ½ä¸ºè´Ÿæ•°ï¼Œæ‰€ä»¥ä¼šè¿›å…¥ä¸‹é¢çš„åˆ†æ”¯</span></span><br><span class="line">        <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="keyword">null</span> ||</span><br><span class="line">                transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                transfer(tab, nt);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€æ¬¡è¿›æ¥æ—¶ï¼Œä¼šè¿›å…¥è¿™ä¸ªåˆ†æ”¯ï¼Œåœ¨è¿™ä¸ªæ“ä½œä¸­ï¼Œä¼šå°† sc æ”¹ä¸ºä¸€ä¸ªè´Ÿæ•°ï¼ˆè¿™é‡Œå°† sc è¿›è¡Œå·¦ç§»ï¼Œé…åˆä¸Šé¢çš„æ“ä½œä»¤ç¬¬ä¸€ä½ä¸º1ï¼‰</span></span><br><span class="line">        <span class="comment">// ç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›æ¥æ—¶ï¼Œå®ƒè¦è¿›è¡Œæ‰©å®¹ï¼Œæ‰€ä»¥éœ€è¦å°† sizeCtl æ”¹ä¸ºä¸€ä¸ªè´Ÿæ•°ï¼Œå‘Šè¯‰å…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰©å®¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc,</span><br><span class="line">                                     (rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">            transfer(tab, <span class="keyword">null</span>);</span><br><span class="line">        s = sumCount();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>transfer</code> æ–¹æ³•æ˜¯çœŸæ­£è¿›è¡Œæ‰©å®¹æ“ä½œçš„æ–¹æ³•</p></blockquote><h1 id="ä¸‰ã€æ‰©å®¹æ–¹æ³•-transfer"><a href="#ä¸‰ã€æ‰©å®¹æ–¹æ³•-transfer" class="headerlink" title="ä¸‰ã€æ‰©å®¹æ–¹æ³• transfer"></a>ä¸‰ã€æ‰©å®¹æ–¹æ³• <code>transfer</code></h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯å¤šcpuï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹åˆ’åˆ†ä»»åŠ¡ï¼Œæœ€å°ä»»åŠ¡é‡æ˜¯16ä¸ªæ¡¶ä½çš„è¿ç§»</span></span><br><span class="line">    <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">        stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br><span class="line">    <span class="comment">//å¦‚æœæ˜¯æ‰©å®¹çº¿ç¨‹ï¼Œæ­¤æ—¶æ–°æ•°ç»„ä¸ºnull</span></span><br><span class="line">    <span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">            <span class="comment">//ä¸¤å€æ‰©å®¹åˆ›å»ºæ–°æ•°ç»„</span></span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">            nextTab = nt;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">            sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        nextTable = nextTab;</span><br><span class="line">        <span class="comment">//è®°å½•çº¿ç¨‹å¼€å§‹è¿ç§»çš„æ¡¶ä½ï¼Œä»åå¾€å‰è¿ç§»</span></span><br><span class="line">        transferIndex = n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è®°å½•æ–°æ•°ç»„çš„æœ«å°¾</span></span><br><span class="line">    <span class="keyword">int</span> nextn = nextTab.length;</span><br><span class="line">    <span class="comment">//å·²ç»è¿ç§»çš„æ¡¶ä½ï¼Œä¼šç”¨è¿™ä¸ªèŠ‚ç‚¹å ä½ï¼ˆè¿™ä¸ªèŠ‚ç‚¹çš„hashå€¼ä¸º-1--MOVEDï¼‰</span></span><br><span class="line">    ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> ForwardingNode&lt;K,V&gt;(nextTab);</span><br><span class="line">    <span class="keyword">boolean</span> advance = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">boolean</span> finishing = <span class="keyword">false</span>; <span class="comment">// to ensure sweep before committing nextTab</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="keyword">int</span> fh;</span><br><span class="line">        <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">            <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">            <span class="comment">//iè®°å½•å½“å‰æ­£åœ¨è¿ç§»æ¡¶ä½çš„ç´¢å¼•å€¼</span></span><br><span class="line">            <span class="comment">//boundè®°å½•ä¸‹ä¸€æ¬¡ä»»åŠ¡è¿ç§»çš„å¼€å§‹æ¡¶ä½</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//--i &gt;= bound æˆç«‹è¡¨ç¤ºå½“å‰çº¿ç¨‹åˆ†é…çš„è¿ç§»ä»»åŠ¡è¿˜æ²¡æœ‰å®Œæˆ</span></span><br><span class="line">            <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//æ²¡æœ‰å…ƒç´ éœ€è¦è¿ç§» -- åç»­ä¼šå»å°†æ‰©å®¹çº¿ç¨‹æ•°å‡1ï¼Œå¹¶åˆ¤æ–­æ‰©å®¹æ˜¯å¦å®Œæˆ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                i = -<span class="number">1</span>;</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//è®¡ç®—ä¸‹ä¸€æ¬¡ä»»åŠ¡è¿ç§»çš„å¼€å§‹æ¡¶ä½ï¼Œå¹¶å°†è¿™ä¸ªå€¼èµ‹å€¼ç»™transferIndex</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">                     (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                      nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                                   nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                bound = nextBound;</span><br><span class="line">                i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                advance = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å¦‚æœæ²¡æœ‰æ›´å¤šçš„éœ€è¦è¿ç§»çš„æ¡¶ä½ï¼Œå°±è¿›å…¥è¯¥if</span></span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">            <span class="keyword">int</span> sc;</span><br><span class="line">            <span class="comment">//æ‰©å®¹ç»“æŸåï¼Œä¿å­˜æ–°æ•°ç»„ï¼Œå¹¶é‡æ–°è®¡ç®—æ‰©å®¹é˜ˆå€¼ï¼Œèµ‹å€¼ç»™sizeCtl</span></span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                nextTable = <span class="keyword">null</span>;</span><br><span class="line">                table = nextTab;</span><br><span class="line">                sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">		   <span class="comment">//æ‰©å®¹ä»»åŠ¡çº¿ç¨‹æ•°å‡1</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="keyword">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">//åˆ¤æ–­å½“å‰æ‰€æœ‰æ‰©å®¹ä»»åŠ¡çº¿ç¨‹æ˜¯å¦éƒ½æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">                <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="comment">//æ‰€æœ‰æ‰©å®¹çº¿ç¨‹éƒ½æ‰§è¡Œå®Œï¼Œæ ‡è¯†ç»“æŸ</span></span><br><span class="line">                finishing = advance = <span class="keyword">true</span>;</span><br><span class="line">                i = n; <span class="comment">// recheck before commit</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å½“å‰è¿ç§»çš„æ¡¶ä½æ²¡æœ‰å…ƒç´ ï¼Œç›´æ¥åœ¨è¯¥ä½ç½®æ·»åŠ ä¸€ä¸ªfwdèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="keyword">null</span>)</span><br><span class="line">            advance = casTabAt(tab, i, <span class="keyword">null</span>, fwd);</span><br><span class="line">        <span class="comment">//å½“å‰èŠ‚ç‚¹å·²ç»è¢«è¿ç§»</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            advance = <span class="keyword">true</span>; <span class="comment">// already processed</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//å½“å‰èŠ‚ç‚¹éœ€è¦è¿ç§»ï¼ŒåŠ é”è¿ç§»ï¼Œä¿è¯å¤šçº¿ç¨‹å®‰å…¨</span></span><br><span class="line">            <span class="comment">//æ­¤å¤„è¿ç§»é€»è¾‘å’Œjdk7çš„ConcurrentHashMapç›¸åŒï¼Œä¸å†èµ˜è¿°</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">int</span> runBit = fh &amp; n;</span><br><span class="line">                        Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="keyword">null</span>; p = p.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> b = p.hash &amp; n;</span><br><span class="line">                            <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                runBit = b;</span><br><span class="line">                                lastRun = p;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                            ln = lastRun;</span><br><span class="line">                            hn = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            hn = lastRun;</span><br><span class="line">                            ln = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> ph = p.hash; K pk = p.key; V pv = p.val;</span><br><span class="line">                            <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                ln = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hn = <span class="keyword">new</span> Node&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                        &#125;</span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; lo = <span class="keyword">null</span>, loTail = <span class="keyword">null</span>;</span><br><span class="line">                        TreeNode&lt;K,V&gt; hi = <span class="keyword">null</span>, hiTail = <span class="keyword">null</span>;</span><br><span class="line">                        <span class="keyword">int</span> lc = <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">                            <span class="keyword">int</span> h = e.hash;</span><br><span class="line">                            TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> TreeNode&lt;K,V&gt;</span><br><span class="line">                                (h, e.key, e.val, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                            <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = loTail) == <span class="keyword">null</span>)</span><br><span class="line">                                    lo = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    loTail.next = p;</span><br><span class="line">                                loTail = p;</span><br><span class="line">                                ++lc;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = hiTail) == <span class="keyword">null</span>)</span><br><span class="line">                                    hi = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hiTail.next = p;</span><br><span class="line">                                hiTail = p;</span><br><span class="line">                                ++hc;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                            (hc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(lo) : t;</span><br><span class="line">                        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                            (lc != <span class="number">0</span>) ? <span class="keyword">new</span> TreeBin&lt;K,V&gt;(hi) : t;</span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-1ã€çº¿ç¨‹å¯åŠ¨æ‰©å®¹"><a href="#3-1ã€çº¿ç¨‹å¯åŠ¨æ‰©å®¹" class="headerlink" title="3.1ã€çº¿ç¨‹å¯åŠ¨æ‰©å®¹"></a>3.1ã€çº¿ç¨‹å¯åŠ¨æ‰©å®¹</h2><blockquote><p>åœ¨ <code>addCount</code> æ–¹æ³•ä¸­ï¼Œå¦‚æœæ­¤æ—¶çš„ sizeCtl å¤§äºç­‰äº 0 ï¼Œæ­¤æ—¶å°† sizeCtl å˜ä¸ºä¸€ä¸ªå°äº 0 çš„è´Ÿæ•°ï¼Œç„¶åè°ƒç”¨ <code>transfer</code> æ–¹æ³•è¿›è¡Œæ‰©å®¹ï¼Œæ­¤æ—¶ä¼ å…¥çš„å‚æ•°ä¸ºå½“å‰ <code>ConcurrentHashMap</code> ä¸­æ—§çš„æ•°ç»„å¯¹è±¡ï¼ŒåŒæ—¶åœ¨ <code>nextTab</code> æ–°æ•°ç»„å¯¹è±¡çš„ä½ç½®ä¼ å…¥ä¸€ä¸ª <code>null</code></p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/blogImage/raw/master/img/20211017210221.png" alt="image-20211017210220644"></p><blockquote><p>åœ¨çº¿ç¨‹å¯åŠ¨æ‰©å®¹æ—¶ï¼Œç”±äºä¼ å…¥çš„ nextTab å¯¹è±¡ä¸ºç©ºï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ªå®¹é‡ä¸ºåŸæ¥æ•°ç»„ä¸¤å€çš„æ–°æ•°ç»„ï¼Œç„¶åè¿›è¡Œå…¶ä»–å·¥ä½œï¼Œæˆ‘ä»¬æŸ¥çœ‹ transfer æ–¹æ³•ä¸­çš„ç›¸å…³æºç </p></blockquote><ul><li>è®°å½•åŸæ•°ç»„çš„é•¿åº¦</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/blogImage/raw/master/img/20211017211202.png" alt="image-20211017211202250"></p><ul><li>è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœä¼ å…¥çš„ nextTab ä¸ºç©ºï¼Œé‚£ä¹ˆåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸ºåŸæ•°ç»„ä¸¤å€çš„æ–°æ•°ç»„</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨å·¦ç§»</span></span><br><span class="line">        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> Node&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">        nextTab = nt;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;      <span class="comment">// try to cope with OOME</span></span><br><span class="line">        sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    nextTable = nextTab;</span><br><span class="line">    transferIndex = n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-2ã€å¤šçº¿ç¨‹ååŠ©æ‰©å®¹"><a href="#3-2ã€å¤šçº¿ç¨‹ååŠ©æ‰©å®¹" class="headerlink" title="3.2ã€å¤šçº¿ç¨‹ååŠ©æ‰©å®¹"></a>3.2ã€å¤šçº¿ç¨‹ååŠ©æ‰©å®¹</h2><blockquote><p>ConcurrentHashMap ä¼šåˆ¤æ–­æœºå™¨çš„ CPU ä¸ªæ•°ï¼Œå¦‚æœæ˜¯å¤š CPU ï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹åˆ’åˆ†ä»»åŠ¡ï¼Œæ¯ä¸ªçº¿ç¨‹è‡³å°‘è´Ÿè´£ 16 ä¸ªæ¡¶çš„æ•°æ®è¿ç§»ã€‚</p></blockquote><ul><li>ä½¿ç”¨ä¸€ä¸ªå¸¸é‡ç”¨äºè¡¨ç¤ºå½“å‰ç³»ç»Ÿçš„ CPU æ•°é‡</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Number of CPUS, to place bounds on some sizings.</span></span><br><span class="line"><span class="comment"> * å½“å‰ç³»ç»Ÿçš„cpuæ•°é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NCPU = Runtime.getRuntime().availableProcessors();</span><br></pre></td></tr></table></figure><ul><li><strong>çº¿ç¨‹è¿ç§»æ•°æ®çš„æœ€å°æ­¥é•¿</strong>ï¼Œæ¯ä¸ªçº¿ç¨‹è‡³å°‘éœ€è¦è´Ÿè´£ 16 ä¸ªæ¡¶çš„æ•°æ®è¿ç§»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çº¿ç¨‹è¿ç§»æ•°æ®æœ€å°æ­¥é•¿ï¼Œæ§åˆ¶çº¿ç¨‹è¿ç§»ä»»åŠ¡æœ€å°åŒºé—´ä¸€ä¸ªå€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_TRANSFER_STRIDE = <span class="number">16</span>;</span><br></pre></td></tr></table></figure><ul><li>åˆ†é…ä»»åŠ¡</li></ul><blockquote><p>é¦–å…ˆåˆ¤æ–­å½“å‰ç³»ç»Ÿçš„ CPU ä¸ªæ•°ï¼Œå¦‚æœ CPU ä¸ªæ•°å¤§äº 1 ï¼Œåˆ™è¿›è¡Œä»»åŠ¡åˆ’åˆ†ï¼Œå¦åˆ™ç›´æ¥è®©è¯¥çº¿ç¨‹è´Ÿè´£å…¨éƒ¨æ•°æ®çš„è¿ç§»</p><p>å½“å¾—åˆ°çš„ä»»åŠ¡åŒºé—´é•¿åº¦å°äº <code>MIN_TRANSFER_STRIDE</code> ï¼Œé‚£ä¹ˆéœ€è¦å°†ä»»åŠ¡åŒºé—´é•¿åº¦ç½®ä¸º <code>MIN_TRANSFER_STRIDE</code></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¦‚æœæ˜¯å¤šcpuï¼Œé‚£ä¹ˆæ¯ä¸ªçº¿ç¨‹åˆ’åˆ†ä»»åŠ¡ï¼Œæœ€å°ä»»åŠ¡é‡æ˜¯16ä¸ªæ¡¶ä½çš„è¿ç§»</span></span><br><span class="line"><span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">    stride = MIN_TRANSFER_STRIDE; <span class="comment">// subdivide range</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºä¸€ä¸ª Forwarding èŠ‚ç‚¹ï¼Œå¯¹äºå·²ç»è¿ç§»å®Œæˆçš„æ¡¶ï¼Œä¼šä½¿ç”¨è¿™ä¸ªèŠ‚ç‚¹å ä½ï¼ˆè¿™ä¸ªèŠ‚ç‚¹çš„å“ˆå¸Œå€¼ä¸º MOVEDï¼‰</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/blogImage/raw/master/img/20211017212808.png" alt="image-20211017212807945"></p><ul><li>ConcurrentHashMap çš„æ•°æ®è¿ç§»å·¥ä½œæ˜¯ç”±åå¾€å‰è¿ç§»çš„</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> n = tab.length, stride;</span><br><span class="line">...</span><br><span class="line"><span class="comment">//å¦‚æœæ˜¯æ‰©å®¹çº¿ç¨‹ï¼Œæ­¤æ—¶æ–°æ•°ç»„ä¸ºnull</span></span><br><span class="line"><span class="keyword">if</span> (nextTab == <span class="keyword">null</span>) &#123;            <span class="comment">// initiating</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//è®°å½•çº¿ç¨‹å¼€å§‹è¿ç§»çš„æ¡¶ä½ï¼Œä»åå¾€å‰è¿ç§»</span></span><br><span class="line">    transferIndex = n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è®¡ç®—å½“å‰çº¿ç¨‹è´Ÿè´£çš„åŒºåŸŸ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (advance) &#123;</span><br><span class="line">    <span class="keyword">int</span> nextIndex, nextBound;</span><br><span class="line">    <span class="comment">//iè®°å½•å½“å‰æ­£åœ¨è¿ç§»æ¡¶ä½çš„ç´¢å¼•å€¼</span></span><br><span class="line">    <span class="comment">//boundè®°å½•ä¸‹ä¸€æ¬¡ä»»åŠ¡è¿ç§»çš„å¼€å§‹æ¡¶ä½</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//--i &gt;= bound æˆç«‹è¡¨ç¤ºå½“å‰çº¿ç¨‹åˆ†é…çš„è¿ç§»ä»»åŠ¡è¿˜æ²¡æœ‰å®Œæˆ</span></span><br><span class="line">    <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">        advance = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//æ²¡æœ‰å…ƒç´ éœ€è¦è¿ç§» -- åç»­ä¼šå»å°†æ‰©å®¹çº¿ç¨‹æ•°å‡1ï¼Œå¹¶åˆ¤æ–­æ‰©å®¹æ˜¯å¦å®Œæˆ</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        i = -<span class="number">1</span>;</span><br><span class="line">        advance = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è®¡ç®—ä¸‹ä¸€æ¬¡ä»»åŠ¡è¿ç§»çš„å¼€å§‹æ¡¶ä½ï¼Œå¹¶å°†è¿™ä¸ªå€¼èµ‹å€¼ç»™transferIndex</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt</span><br><span class="line">             (<span class="keyword">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">              <span class="comment">// å¦‚æœ nextIndex å¤§äº stride ï¼Œè¯æ˜ä¸‹ä¸€ä¸ªçº¿ç¨‹ä¾ç„¶å¯ä»¥åˆ†åˆ°ï¼Œä»»åŠ¡ï¼Œå¦‚æœå°äº stride ï¼Œé‚£ä¹ˆè¯æ˜å‰©ä¸‹çš„å·¥ä½œè¿™ä¸ªçº¿ç¨‹å°±å¯ä»¥å®Œæˆï¼Œæ²¡å¿…è¦y</span></span><br><span class="line">              nextBound = (nextIndex &gt; stride ?</span><br><span class="line">                           nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">        bound = nextBound;</span><br><span class="line">        i = nextIndex - <span class="number">1</span>;</span><br><span class="line">        advance = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>æ•°æ®ç»“æ„ä¸ç®—æ³•å­¦ä¹ ï¼ˆä¸ƒï¼‰-ConcurrentHashMapæºç è§£è¯»</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://sutianxin.top/posts/2912697261.html">https://sutianxin.top/posts/2912697261.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a" style="display:inline-block;width:120px"><h>ä½œè€…</h><div class="post-copyright-cc-info"><h>å¤©æ˜•</h></div></div><div class="post-copyright-c" style="display:inline-block;width:120px"><h>å‘å¸ƒäº</h><div class="post-copyright-cc-info"><h>2021-03-05</h></div></div><div class="post-copyright-u" style="display:inline-block;width:120px"><h>æ›´æ–°äº</h><div class="post-copyright-cc-info"><h>2021-10-17</h></div></div><div class="post-copyright-c" style="display:inline-block;width:120px"><h>è®¸å¯åè®®</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E2%98%95Java/">â˜•Java</a><a class="post-meta__tags" href="/tags/%F0%9F%92%BB%E5%90%8E%E7%AB%AF%E5%AD%A6%E4%B9%A0/">ğŸ’»åç«¯å­¦ä¹ </a></div><div class="post_share"><div class="social-share" data-image="https://gitee.com/sutianxin/blogImage/raw/master/20210504191133.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/1389856525.html"><img class="prev-cover" data-lazy-src="https://gitee.com/sutianxin/blogImage/raw/master/20210504191217.jpg" onerror='onerror=null,src="https://gitee.com/sutianxin/blogImage/raw/master/20210430103138.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">MySQLé«˜çº§å­¦ä¹ ï¼ˆä¸€ï¼‰-åˆè¯†ç´¢å¼•ã€å¤ä¹ è§†å›¾ã€å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ä»¥åŠè§¦å‘å™¨çš„å­¦ä¹ </div></div></a></div><div class="next-post pull-right"><a href="/posts/1275843529.html"><img class="next-cover" data-lazy-src="https://gitee.com/sutianxin/blogImage/raw/master/20210504191052.jpg" onerror='onerror=null,src="https://gitee.com/sutianxin/blogImage/raw/master/20210430103138.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">JUCå­¦ä¹ ç¬”è®°ï¼ˆäº”ï¼‰-ThreadLocalå­¦ä¹ </div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/posts/1128227004.html" title="Javaåº”ç”¨å­¦ä¹ ï¼ˆä¸ƒï¼‰-å›é¡¾Mybatiså’ŒSpring MVC"><img class="cover" data-lazy-src="https://gitee.com/sutianxin/blogImage/raw/master/20210430102830.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-03-27</div><div class="title">Javaåº”ç”¨å­¦ä¹ ï¼ˆä¸ƒï¼‰-å›é¡¾Mybatiså’ŒSpring MVC</div></div></a></div><div><a href="/posts/2938255980.html" title="Javaåº”ç”¨å­¦ä¹ ï¼ˆäºŒï¼‰-Springbootæ•´åˆswagger/swagger-Bootstrap-UIä½¿ç”¨"><img class="cover" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210208120213.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-12</div><div class="title">Javaåº”ç”¨å­¦ä¹ ï¼ˆäºŒï¼‰-Springbootæ•´åˆswagger/swagger-Bootstrap-UIä½¿ç”¨</div></div></a></div><div><a href="/posts/913123791.html" title="Spring Cloudå­¦ä¹ ï¼ˆä¸ƒï¼‰-Spring Cloud Config"><img class="cover" data-lazy-src="https://gitee.com/sutianxin/blogImage/raw/master/20210516192228.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-05-16</div><div class="title">Spring Cloudå­¦ä¹ ï¼ˆä¸ƒï¼‰-Spring Cloud Config</div></div></a></div><div><a href="/posts/2863462089.html" title="Spring Cloudå­¦ä¹ ï¼ˆäºŒï¼‰-OpenFeignå¾®æœåŠ¡è°ƒç”¨"><img class="cover" data-lazy-src="https://gitee.com/sutianxin/blogImage/raw/master/20210504192527.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-11</div><div class="title">Spring Cloudå­¦ä¹ ï¼ˆäºŒï¼‰-OpenFeignå¾®æœåŠ¡è°ƒç”¨</div></div></a></div><div><a href="/posts/995752607.html" title="Spring Cloudå­¦ä¹ ï¼ˆå››ï¼‰-EurekaæœåŠ¡æ³¨å†Œä¸­å¿ƒ"><img class="cover" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214225250.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-14</div><div class="title">Spring Cloudå­¦ä¹ ï¼ˆå››ï¼‰-EurekaæœåŠ¡æ³¨å†Œä¸­å¿ƒ</div></div></a></div><div><a href="/posts/650479038.html" title="åœ¨çº¿æ•™è‚²é¡¹ç›®æ€»ç»“ï¼ˆäºŒï¼‰-ç”¨æˆ·è®¤è¯"><img class="cover" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205204706.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-05</div><div class="title">åœ¨çº¿æ•™è‚²é¡¹ç›®æ€»ç»“ï¼ˆäºŒï¼‰-ç”¨æˆ·è®¤è¯</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81JDK8ConcurrentHashMap%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">ä¸€ã€JDK8ConcurrentHashMapåˆå§‹åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1%E3%80%81%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">1.1ã€æºç åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%97%A0%E5%8F%82%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="toc-text">1ã€æ— å‚æ„é€ å‡½æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E4%BC%A0%E5%85%A5%E5%88%9D%E5%A7%8B%E5%AE%B9%E9%87%8F%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="toc-text">2ã€ä¼ å…¥åˆå§‹å®¹é‡çš„æ„é€ å‡½æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%90%AB%E6%9C%89%E4%B8%89%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95"><span class="toc-text">3ã€å«æœ‰ä¸‰ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E4%BC%A0%E5%85%A5%E4%B8%80%E4%B8%AAMap%E7%9A%84%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="toc-text">4ã€ä¼ å…¥ä¸€ä¸ªMapçš„æ„é€ å‡½æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81ConcurrentHashMap-%E4%B8%AD%E6%95%B0%E7%BB%84%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96%E6%97%B6%E6%9C%BA"><span class="toc-text">5ã€ConcurrentHashMap ä¸­æ•°ç»„çš„åˆå§‹åŒ–æ—¶æœº</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2%E3%80%81-sizeCtl-%E5%90%AB%E4%B9%89%E8%A7%A3%E9%87%8A"><span class="toc-text">1.2ã€ sizeCtl å«ä¹‰è§£é‡Š</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81JDK8%E6%B7%BB%E5%8A%A0%E5%AE%89%E5%85%A8"><span class="toc-text">äºŒã€JDK8æ·»åŠ å®‰å…¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1%E3%80%81put%E6%96%B9%E6%B3%95%E5%92%8CputVal%E6%96%B9%E6%B3%95"><span class="toc-text">2.1ã€putæ–¹æ³•å’ŒputValæ–¹æ³•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E4%BD%BF%E7%94%A8-spread-%E6%89%B0%E5%8A%A8%E6%96%B9%E6%B3%95%E4%BD%BF%E5%BE%97%E5%88%B0%E7%9A%84%E5%93%88%E5%B8%8C%E5%80%BC%E6%9B%B4%E5%8A%A0%E5%88%86%E6%95%A3"><span class="toc-text">1ã€ä½¿ç”¨ spread æ‰°åŠ¨æ–¹æ³•ä½¿å¾—åˆ°çš„å“ˆå¸Œå€¼æ›´åŠ åˆ†æ•£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81initTable%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E7%BB%84%E6%96%B9%E6%B3%95"><span class="toc-text">2ã€initTableåˆå§‹åŒ–æ•°ç»„æ–¹æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%AE%A1%E7%AE%97%E9%94%AE%E5%80%BC%E5%AF%B9%E6%B7%BB%E5%8A%A0%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="toc-text">3ã€è®¡ç®—é”®å€¼å¯¹æ·»åŠ çš„ä½ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%8D%8F%E5%8A%A9%E6%89%A9%E5%AE%B9"><span class="toc-text">4ã€å¤šçº¿ç¨‹ååŠ©æ‰©å®¹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81put%E6%96%B9%E6%B3%95%E5%8A%A0%E9%94%81%E5%9B%BE%E8%A7%A3"><span class="toc-text">5ã€putæ–¹æ³•åŠ é”å›¾è§£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%B7%BB%E5%8A%A0%E5%AE%8C%E5%85%83%E7%B4%A0%E5%90%8E%E8%BF%9B%E8%A1%8C%E9%93%BE%E8%A1%A8%E9%95%BF%E5%BA%A6%E5%88%A4%E6%96%AD"><span class="toc-text">6ã€æ·»åŠ å®Œå…ƒç´ åè¿›è¡Œé“¾è¡¨é•¿åº¦åˆ¤æ–­</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2%E3%80%81ConcurrentHashMap-%E7%A9%BA%E5%80%BC%E5%92%8C%E7%A9%BA%E9%94%AE%E9%97%AE%E9%A2%98"><span class="toc-text">2.2ã€ConcurrentHashMap ç©ºå€¼å’Œç©ºé”®é—®é¢˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3%E3%80%81addCount-%E6%96%B9%E6%B3%95%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">2.3ã€addCount æ–¹æ³•æºç åˆ†æ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81baseCount-%E5%8F%98%E9%87%8F"><span class="toc-text">1ã€baseCount å˜é‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%AE%A1%E7%AE%97%E5%AE%8C%E5%85%83%E7%B4%A0%E4%B8%AA%E6%95%B0%E5%90%8E%E8%BF%9B%E8%A1%8C%E6%89%A9%E5%AE%B9"><span class="toc-text">2ã€è®¡ç®—å®Œå…ƒç´ ä¸ªæ•°åè¿›è¡Œæ‰©å®¹</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%89%A9%E5%AE%B9%E6%96%B9%E6%B3%95-transfer"><span class="toc-text">ä¸‰ã€æ‰©å®¹æ–¹æ³• transfer</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1%E3%80%81%E7%BA%BF%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%89%A9%E5%AE%B9"><span class="toc-text">3.1ã€çº¿ç¨‹å¯åŠ¨æ‰©å®¹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2%E3%80%81%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%8D%8F%E5%8A%A9%E6%89%A9%E5%AE%B9"><span class="toc-text">3.2ã€å¤šçº¿ç¨‹ååŠ©æ‰©å®¹</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 <i style="color:#ff6a6a;animation:announ_animation .8s linear infinite" class="fa fa-heartbeat"></i> å¤©æ˜•</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">æ¬¢è¿æ¥åˆ°æˆ‘çš„ä¸ªäººåšå®¢!<span id="runtime"></span><br></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo"></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender"></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr"></a><a class="github-badge" target="_blank" href="https://gitee.com/" style="margin-inline:5px"><img src="https://img.shields.io/badge/Picture-Gitee-0cedbe?style=flat&amp;logo=Gitee"></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris"></a></p><div id="workboard"></div><script async src="/js/runtime.js"></script></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç°¡</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">æœ¬åœ°æœç´¢</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script><script>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading())</script><script defer src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script defer src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{const t=document.getElementById("twikoo-count"),o=()=>{twikoo.init({el:"#twikoo-wrap",envId:"blogcomments-2gseqioe1aa55c8c",region:"ap-shanghai"})},e=()=>{twikoo.getCommentsCount({envId:"blogcomments-2gseqioe1aa55c8c",region:"ap-shanghai",urls:[window.location.pathname],includeReply:!1}).then(function(o){t.innerText=o[0].count}).catch(function(o){console.error(o)})};var n;n=!0,"object"==typeof twikoo?(o(),n&&t&&setTimeout(e,0)):getScript("https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js").then(()=>{o(),n&&t&&setTimeout(e,0)})})()</script></div><div class="aplayer no-destroy" data-id="6588965546" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-preload="none" data-autoplay="false" data-lrctype="0" muted></div><script defer src="/live2d-widget/autoload.js"></script><script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/flipcountdown.js"></script><script data-pjax src="/js/runtime.js"></script><script async src="//at.alicdn.com/t/font_2398185_yegv7kt2bj.js"></script><script src="https://apip.weatherdt.com/simple/static/js/weather-simple-common.js?v=2.0"></script><script src="/js/weather.js"></script><script src="/js/custom/runtime.js"></script><script src="https://cdn.jsdelivr.net/gh/weilain/cdn-photo/js/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/gh/zhheo/JS-Heo@main/hidescrollbar/hidescrollbar.js"></script><script async src="//at.alicdn.com/t/font_2398185_lld84dtfbb.js"></script><script src="https://www.luckyclover.top/rain.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/shuoshuo/"]):not([href="/bb/"]):not([href="/contact/"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:complete",function(){window.refreshFn(),document.querySelectorAll("script[data-pjax], .pjax-reload script").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()}),document.addEventListener("pjax:send",function(){if("object"==typeof preloader&&preloader.initLoading(),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")}),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script></div><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.10/hexo_githubcalendar.js"></script><script data-pjax>function GithubCalendarConfig(){var e=document.getElementById("recent-posts");e&&e.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_container"></div></div>'),GithubCalendar("https://python-github-calendar-api.vercel.app/api?sutianxin",["#ebedf0","#f1f8ff","#dbedff","#c8e1ff","#79b8ff","#2188ff","#0366d6","#005cc5","#044289","#032f62","#05264c"],"sutianxin")}document.getElementById("recent-posts")&&GithubCalendarConfig()</script><style>#github_container{min-height:280px}@media screen and (max-width:650px){#github_container{min-height:120px}}</style></body></html>