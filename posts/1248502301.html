<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Elasticsearch学习笔记 | Arno</title><meta name="keywords" content="☕Java,💻后端学习,👢Spring Boot"><meta name="author" content="天昕"><meta name="copyright" content="天昕"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Elasticsearch学习及Spring Boot 整合 ES"><meta property="og:type" content="article"><meta property="og:title" content="Elasticsearch学习笔记"><meta property="og:url" content="https://sutianxin.top/posts/1248502301.html"><meta property="og:site_name" content="Arno"><meta property="og:description" content="Elasticsearch学习及Spring Boot 整合 ES"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://gitee.com/sutianxin/photo/raw/master/20210422155614.jpg"><meta property="article:published_time" content="2021-04-22T07:52:06.000Z"><meta property="article:modified_time" content="2021-04-22T08:21:37.796Z"><meta property="article:author" content="天昕"><meta property="article:tag" content="☕Java"><meta property="article:tag" content="💻后端学习"><meta property="article:tag" content="👢Spring Boot"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://gitee.com/sutianxin/photo/raw/master/20210422155614.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://sutianxin.top/posts/1248502301"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"繁",msgToSimplifiedChinese:"簡"},noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"mediumZoom",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"top-right"},source:{jQuery:"https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js",justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js",css:"https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css"},fancybox:{js:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js",css:"https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"}},isPhotoFigcaption:!1,islazyload:!0,isanchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2021-04-22 16:21:37"}</script><noscript><style type="text/css">#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,a){0!==a&&(a=864e5*a,a={value:t,expiry:(new Date).getTime()+a},localStorage.setItem(e,JSON.stringify(a)))},get:function(e){var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!((new Date).getTime()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=o=>new Promise((t,e)=>{const a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};e=saveToLocal.get("theme");"dark"===e?activateDarkMode():"light"===e&&activateLightMode();e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"))})(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zyoushuo/Blog@latest/hexo/css/loading_style_1.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zhheo/JS-Heo@main/hidescrollbar/hidescrollbar.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zyoushuo/Blog@latest/hexo/css/loading_style_2.css"><link rel="stylesheet" href="/css/cover.css"><link rel="stylesheet" href="/css/copyright.css"><link href="https://cdn.jsdelivr.net/gh/sviptzk/StaticFile_HEXO@latest/butterfly/css/font-awesome-animation.min.css"><link rel="stylesheet" href="/css/flipcountdown.css"><link rel="stylesheet" href="/css/year.css"><link rel="stylesheet" href="/css/Lete.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PaddyLin-xum/wenjian@master/css/fontanimation.css"><link href="https://cdn.bootcdn.net/ajax/libs/botui/0.3.9/botui-theme-default.css" rel="stylesheet"><link rel="stylesheet" href="/css/font.css" media="defer" onload='this.media="all"'><link rel="stylesheet" href="/css/iconfont.css"><link rel="stylesheet" href="/css/twikoo.css"><style>#article-container.post-content h1:before,h2:before,h3:before,h4:before,h5:before,h6:before{-webkit-animation:avatar_turn_around 1s linear infinite;-moz-animation:avatar_turn_around 1s linear infinite;-o-animation:avatar_turn_around 1s linear infinite;-ms-animation:avatar_turn_around 1s linear infinite;animation:avatar_turn_around 1s linear infinite}</style><meta name="generator" content="Hexo 5.4.0"></head><body><a href="javascript:void(0);" onclick="preloader.endLoading()" title="点击跳过动画"><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="wizard-scene"><div class="wizard-objects"><div class="wizard-square"></div><div class="wizard-circle"></div><div class="wizard-triangle"></div></div><div class="wizard"><div class="wizard-body"></div><div class="wizard-right-arm"><div class="wizard-right-hand"></div></div><div class="wizard-left-arm"><div class="wizard-left-hand"></div></div><div class="wizard-head"><div class="wizard-beard"></div><div class="wizard-face"><div class="wizard-adds"></div></div><div class="wizard-hat"><div class="wizard-hat-of-the-hat"></div><div class="wizard-four-point-star --first"></div><div class="wizard-four-point-star --second"></div><div class="wizard-four-point-star --third"></div></div></div></div></div></div></a><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" data-lazy-src="/img/avatar.png" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">54</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa fa-book"></i><span> 文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw far fa-calendar-alt"></i><span> 归档</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 拓展</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/random/"><i class="fa-fw fa fa-random"></i><span> 随机文章</span></a></li><li><a class="site-page" href="/adjust/"><i class="fa-fw fa fa-adjust"></i><span> 更换背景</span></a></li><li><a class="site-page" href="/statistics/"><i class="fa-fw fa fa-cube"></i><span> 文章统计</span></a></li><li><a class="site-page" target="_blank" rel="noopener" href="https://sutianxin.gitee.io"><i class="fa-fw fa fa-balance-scale"></i><span> 国内镜像</span></a></li><li><a class="site-page" href="/box/"><i class="fa-fw fa fa-paper-plane"></i><span> 导航栏</span></a></li><li><a class="site-page" href="/bb/"><i class="fa-fw fa fa-mobile"></i><span> 哔哔</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-headphones"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cubes"></i><span> 社交</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></li><li><a class="site-page" href="/fcircle/"><i class="fa-fw fa fa-puzzle-piece"></i><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-file"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url(https://gitee.com/sutianxin/photo/raw/master/20210422155614.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Arno</a></span><span id="weather-v2-plugin-simple"></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa fa-book"></i><span> 文章</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/archives/"><i class="fa-fw far fa-calendar-alt"></i><span> 归档</span></a></li><li><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></li><li><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-comments"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 拓展</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/random/"><i class="fa-fw fa fa-random"></i><span> 随机文章</span></a></li><li><a class="site-page" href="/adjust/"><i class="fa-fw fa fa-adjust"></i><span> 更换背景</span></a></li><li><a class="site-page" href="/statistics/"><i class="fa-fw fa fa-cube"></i><span> 文章统计</span></a></li><li><a class="site-page" target="_blank" rel="noopener" href="https://sutianxin.gitee.io"><i class="fa-fw fa fa-balance-scale"></i><span> 国内镜像</span></a></li><li><a class="site-page" href="/box/"><i class="fa-fw fa fa-paper-plane"></i><span> 导航栏</span></a></li><li><a class="site-page" href="/bb/"><i class="fa-fw fa fa-mobile"></i><span> 哔哔</span></a></li><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-headphones"></i><span> 音乐</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-cubes"></i><span> 社交</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></li><li><a class="site-page" href="/fcircle/"><i class="fa-fw fa fa-puzzle-piece"></i><span> 朋友圈</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-file"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Elasticsearch学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-04-22T07:52:06.000Z" title="发表于 2021-04-22 15:52:06">2021-04-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-04-22T08:21:37.796Z" title="更新于 2021-04-22 16:21:37">2021-04-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0/">框架学习</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">15.3k</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="一、Elasticsearch-概述"><a href="#一、Elasticsearch-概述" class="headerlink" title="一、Elasticsearch  概述"></a>一、<code>Elasticsearch</code> 概述</h1><h2 id="1-1、Elasticsearch-是什么"><a href="#1-1、Elasticsearch-是什么" class="headerlink" title="1.1、Elasticsearch  是什么"></a>1.1、<code>Elasticsearch</code> 是什么</h2><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418194020.png" alt="image-20210418194013186"></p><blockquote><p>​ The Elastic Stack, 包括 Elasticsearch、Kibana、Beats 和 <code>Logstash</code>（也称为 ELK Stack）。能够安全可靠地获取任何来源、任何格式的数据，然后实时地对数据进行搜索、分析和可视化。<code>Elasticsearch</code>，简称为 ES，<strong>ES 是一个开源的高扩展的分布式全文搜索引擎</strong>，是整个 Elastic Stack 技术栈的核心。它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理PB 级别的数据。</p></blockquote><h2 id="1-2、全文搜索引擎"><a href="#1-2、全文搜索引擎" class="headerlink" title="1.2、全文搜索引擎"></a>1.2、全文搜索引擎</h2><p>​ Google，百度类的网站搜索，它们都是根据网页中的关键字生成索引，我们在搜索的时候输入关键字，它们会将该关键字即索引匹配到的所有网页返回；还有常见的项目中应用日志的搜索等等。对于这些非结构化的数据文本，关系型数据库搜索不是能很好的支持。</p><p>​ 一般传统数据库，全文检索都实现的很鸡肋，因为一般也没人用数据库存文本字段。进行全文检索需要扫描整个表，如果数据量大的话即使对 SQL 的语法优化，也收效甚微。建立了索引，但是维护起来也很麻烦，对于 insert 和 update 操作都会重新构建索引。<br>​ 基于以上原因可以分析得出，在一些生产环境中，使用常规的搜索方式，性能是非常差的：</p><ul><li>搜索的数据对象是大量的非结构化的文本数据。</li><li>文件记录量达到数十万或数百万个甚至更多。</li><li>支持大量基于交互式文本的查询。</li><li>需求非常灵活的全文搜索查询。</li><li>对高度相关的搜索结果的有特殊需求，但是没有可用的关系数据库可以满足。</li><li>对不同记录类型、非文本数据操作或安全事务处理的需求相对较少的情况。<strong>为了解决结构化数据搜索和非结构化数据搜索性能问题，我们就需要专业，健壮，强大的全文搜索引擎</strong></li></ul><p>​ 这里说到的全文搜索引擎指的是目前广泛应用的主流搜索引擎。它的工作原理是计算机索引程序通过扫描文章中的每一个词，对每一个词建立一个索引，指明该词在文章中出现的次数和位置，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程。</p><h2 id="1-3、Elasticsearch-And-Solr"><a href="#1-3、Elasticsearch-And-Solr" class="headerlink" title="1.3、Elasticsearch And Solr"></a>1.3、<code>Elasticsearch And Solr</code></h2><p>​ Lucene 是 Apache 软件基金会 Jakarta 项目组的一个子项目，提供了一个简单却强大的应用程式接口，能够做全文索引和搜寻。在Java 开发环境里 Lucene 是一个成熟的免费开源工具。就其本身而言，Lucene 是当前以及最近几年最受欢迎的免费 Java 信息检索程序库。但 Lucene 只是一个提供全文搜索功能类库的核心工具包，而真正使用它还需要一个完善的服务框架搭建起来进行应用。</p><p>​ 目前市面上流行的搜索引擎软件，主流的就两款：Elasticsearch 和 <code>Solr</code> ,这两款都是基于 <code>Lucene</code> 搭建的，可以独立部署启动的搜索引擎服务软件。由于内核相同，所以两者除了服务器安装、部署、管理、集群以外，对于数据的操作 修改、添加、保存、查询等等都十分类似。</p><p>​ 在使用过程中，一般都会将 Elasticsearch 和 <code>Solr</code> 这两个软件对比，然后进行选型。这两个搜索引擎都是流行的，先进的的开源搜索引擎。它们都是围绕核心底层搜索库 - Lucene构建的 - 但它们又是不同的。像所有东西一样，每个都有其优点和缺点：</p><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418194759.png" alt="image-20210418194759873"></p><ul><li>与 <code>Solr</code> 相比，Elasticsearch 易于安装且非常轻巧。此外，你可以在几分钟内安装并运行 Elasticsearch。但是，如果 Elasticsearch 管理不当，这种易于部署和使用可能会成为一个问题。基于 JSON 的配置很简单，但如果要为文件中的每个配置指定注释，那么它不适合您。总的来说，如果你的应用使用的是 JSON，那么 Elasticsearch 是一个更好的选择。否则，请使用 <code>Solr</code>，因为它的 schema.xml 和 solrconfig.xml 都有很好的文档记录。</li><li><code>Solr</code> 拥有更大，更成熟的用户，开发者和贡献者社区。ES 虽拥有的规模较小但活跃的用户社区以及不断增长的贡献者社区。<code>Solr</code> 贡献者和提交者来自许多不同的组织，而 Elasticsearch 提交者来自单个公司</li><li><code>Solr</code> 更成熟，但 ES 增长迅速，更稳定。</li><li><code>Solr</code> 是一个非常有据可查的产品，具有清晰的示例和 API 用例场景。 Elasticsearch 的文档组织良好，但它缺乏好的示例和清晰的配置说明。</li></ul><h2 id="1-4、ES-核心概念介绍"><a href="#1-4、ES-核心概念介绍" class="headerlink" title="1.4、ES 核心概念介绍"></a>1.4、ES 核心概念介绍</h2><h3 id="1、集群（Cluster）"><a href="#1、集群（Cluster）" class="headerlink" title="1、集群（Cluster）"></a>1、集群（Cluster）</h3><blockquote><p>一个或者多个安装了 ES 节点的服务器组织在一起，就是集群，这些节点共同持有数据，共同提供搜索服务。</p><p>一个集群有一个名字，这个名字是集群的唯一标识，该名字成为 cluster name，默认的集群名称是 <code>elasticsearch</code>，具有相同名称的节点才会组成一个集群。</p><p>可以在 <code>config/elasticsearch.yml</code> 文件中配置集群名称：</p></blockquote><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> <span class="string">javaboy-es</span></span><br></pre></td></tr></table></figure><blockquote><p>在集群中，节点的状态有三种：绿色、黄色、红色：</p></blockquote><ul><li>绿色：节点运行状态为健康状态。所有的主分片、副本分片都可以正常工作。</li><li>黄色：表示节点的运行状态为警告状态，所有的主分片目前都可以直接运行，但是至少有一个副本分片是不能正常工作的。</li><li>红色：表示集群无法正常工作。</li></ul><h3 id="2、节点（Node）"><a href="#2、节点（Node）" class="headerlink" title="2、节点（Node）"></a>2、节点（Node）</h3><p>集群中的一个服务器就是一个节点，节点中会存储数据，同时参与集群的索引以及搜索功能。一个节点想要加入一个集群，只需要配置一下集群名称即可。默认情况下，如果我们启动了多个节点，多个节点还能够互相发现彼此，那么它们会自动组成一个集群，这是 <code>es</code> 默认提供的，但是这种方式并不可靠，有可能会发生脑裂现象。所以在实际使用中，建议一定手动配置一下集群信息。</p><h3 id="3、索引（Index）"><a href="#3、索引（Index）" class="headerlink" title="3、索引（Index）"></a>3、索引（Index）</h3><blockquote><p>索引可以从两方面来理解：</p></blockquote><ul><li><strong>名词</strong></li></ul><p>具有相似特征文档的集合。</p><ul><li><strong>动词</strong></li></ul><p>索引数据以及对数据进行索引操作。</p><h3 id="4、类型（Type）"><a href="#4、类型（Type）" class="headerlink" title="4、类型（Type）"></a>4、类型（Type）</h3><blockquote><p>类型是索引上的逻辑分类或者分区。在 es6 之前，一个索引中可以有多个类型，从 es7 开始，一个索引中，只能有一个类型。在 es6.x 中，依然保持了兼容，依然支持单 index 多个 type 结构，但是已经不建议这么使用。</p></blockquote><h3 id="5、文档（Document）"><a href="#5、文档（Document）" class="headerlink" title="5、文档（Document）"></a>5、文档（Document）</h3><p>一个可以被索引的数据单元。例如一个用户的文档、一个产品的文档等等。文档都是 JSON 格式的。</p><h3 id="6、分片（Shards）"><a href="#6、分片（Shards）" class="headerlink" title="6、分片（Shards）"></a>6、分片（Shards）</h3><p>索引都是存储在节点上的，但是受限于节点的空间大小以及数据处理能力，单个节点的处理效果可能不理想，此时我们可以对索引进行分片。当我们创建一个索引的时候，就需要指定分片的数量。每个分片本身也是一个功能完善并且独立的索引。</p><p>默认情况下，一个索引会自动创建 1 个分片，并且为每一个分片创建一个副本。</p><h3 id="7、副本（Replicas）"><a href="#7、副本（Replicas）" class="headerlink" title="7、副本（Replicas）"></a>7、副本（Replicas）</h3><p>副本也就是备份，是对主分片的一个备份。</p><h3 id="8、Settings"><a href="#8、Settings" class="headerlink" title="8、Settings"></a>8、Settings</h3><p>集群中对索引的定义信息，例如索引的分片数、副本数等等。</p><h3 id="9、Mapping"><a href="#9、Mapping" class="headerlink" title="9、Mapping"></a>9、Mapping</h3><p>Mapping 保存了定义索引字段的存储类型、分词方式、是否存储等信息。</p><h3 id="10、Analyzer-和-Analysis"><a href="#10、Analyzer-和-Analysis" class="headerlink" title="10、Analyzer 和 Analysis"></a>10、Analyzer 和 Analysis</h3><blockquote><p>Analysis 只是一个概念，文本分析是将全文本转换为一系列单词的过程，也叫分词。</p><p>Analysis 是通过 analyzer （分词器） 来实现的，可以使用 ES 中自带的分词器，也可以自定义分词器。</p><p><strong>除了在数据写入时将词条进行转换，在查询时也可以使用分析器对语句进行分析。</strong></p><p>analyzer 由三部分组成，例如有 <code>&lt;p&gt;Hello a world, the world is beautiful&lt;/p&gt;;</code></p><ol><li>Character Filter：将文本中的 html 标签剔除掉。</li><li>Tokenizer：按照规则进行分词，在英文中按照空格分词。</li><li>Token Filter：去掉 stop word(停顿词，a，an，the，is，are等)，然后转换为小写。</li></ol></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210419120723.png" alt="image-20210419120712729"></p><h3 id="11、类比"><a href="#11、类比" class="headerlink" title="11、类比"></a>11、类比</h3><table><thead><tr><th>DBMS</th><th>ES</th></tr></thead><tbody><tr><td>database</td><td>index</td></tr><tr><td>table</td><td>type（7.0后固定为_doc）</td></tr><tr><td>Row</td><td>Document</td></tr><tr><td>Column</td><td>Field</td></tr><tr><td>Schema（表信息约束）</td><td>Mapping</td></tr><tr><td>SQL</td><td>DSL</td></tr></tbody></table><blockquote><p>在 ES 7.0前，一个 index 可以创建多个 type，从 7.0 开始，一个索引只能创建一个类型，也就是 <code>_doc</code></p></blockquote><h2 id="1-5、正排索引和倒排索引"><a href="#1-5、正排索引和倒排索引" class="headerlink" title="1.5、正排索引和倒排索引"></a>1.5、正排索引和倒排索引</h2><h3 id="1、正排索引"><a href="#1、正排索引" class="headerlink" title="1、正排索引"></a>1、正排索引</h3><blockquote><p>正排索引就是最普通的索引排序方式。正排索引也是采取key-value pair的方式对数据进行保存，key是doc-id，value则可以存储多种内容，如doc的分词词表、doc所在网页的属性信息等。由此可见，正排索引可以随意添加数据，但如果你要查询某个单词在哪些文档中出现，那么你就不得不将全部文档都遍历一遍，若文档库极大，则时间消耗是不可接受的。</p><p>在搜索引擎中每个文件都对应一个文件ID，文件内容被表示为一系列关键词的集合（实际上在搜索引擎索引库中，关键词也已经转换为关键词ID）。例如“文档1”经过分词，提取了20个关键词，每个关键词都会记录它在文档中的出现次数和出现位置。</p><p>正排索引一般通过 KEY 去找 VALUE</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418205500.png" alt="image-20210418205459644"></p><blockquote><p>当用户在主页上搜索关键词“华为手机”时，假设只存在正向索引（forward index），那么就需要扫描索引库中的所有文档，找出所有包含关键词“华为手机”的文档，再根据打分模型进行打分，排出名次后呈现给用户。因为互联网上收录在搜索引擎中的文档的数目是个天文数字，这样的索引结构根本无法满足实时返回排名结果的要求。</p></blockquote><h3 id="2、倒排索引"><a href="#2、倒排索引" class="headerlink" title="2、倒排索引"></a>2、倒排索引</h3><blockquote><p>倒排索引是 <code>Lucene</code> 和 <code>ElasticSearch</code> 用来做全文检索的标配。倒排索引类似将正排索引反过来，以全部文档中出现的所有words建立一个term dictionary ，然后对于term dictionary 中的每个词，它后面都会跟随一个链表，该链表就是 <strong>倒排表</strong> ，<strong>倒排表</strong> 内存储着如下信息：</p></blockquote><ul><li>该词出现的doc-id</li><li>该词在某doc中的出现次数和出现位置</li></ul><blockquote><p>倒排索引以关键词作为主键</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418205610.png" alt="image-20210418205610707"></p><h2 id="1-6、索引基本操作"><a href="#1-6、索引基本操作" class="headerlink" title="1.6、索引基本操作"></a>1.6、索引基本操作</h2><h3 id="1、创建索引（PUT-请求）"><a href="#1、创建索引（PUT-请求）" class="headerlink" title="1、创建索引（PUT 请求）"></a>1、创建索引（PUT 请求）</h3><blockquote><p>对比关系型数据库，创建索引就等同于创建数据库。</p><p>在 Postman 中，向 ES 服务器发起 PUT 请求，地址为：<a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping">http://127.0.0.1:9200/shopping</a></p></blockquote><ul><li>请求结果为：</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418210713.png" alt="image-20210418210713192"></p><ul><li>此时再次发送请求，会提示索引已存在！</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418210916.png" alt="image-20210418210916672"></p><h3 id="2、获取-shopping-索引信息（GET-请求）"><a href="#2、获取-shopping-索引信息（GET-请求）" class="headerlink" title="2、获取 shopping 索引信息（GET 请求）"></a>2、获取 shopping 索引信息（GET 请求）</h3><blockquote><p>发送 GET 请求，请求地址为：<a target="_blank" rel="noopener" href="http://127.0.0.1:9200/shopping">http://127.0.0.1:9200/shopping</a></p><p>查看索引向 ES 服务器发送的请求路径和创建索引是一致的。但是HTTP 方法不一致。</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418211312.png"></p><h3 id="3、获取当前所有索引信息（GET-请求）"><a href="#3、获取当前所有索引信息（GET-请求）" class="headerlink" title="3、获取当前所有索引信息（GET 请求）"></a>3、获取当前所有索引信息（GET 请求）</h3><blockquote><p>发送 GET 请求，请求地址为：<a target="_blank" rel="noopener" href="http://127.0.0.1:9200/_cat/indices?v">http://127.0.0.1:9200/_cat/indices?v</a></p><p>这里请求路径中的 _cat 表示查看的意思，indices 表示索引，所以整体含义就是查看当前 ES</p><p>服务器中的所有索引，就好像 MySQL 中的 show tables 的感觉，服务器响应结果如下</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418211630.png" alt="image-20210418211630448"></p><blockquote><p>各参数及含义如下表</p></blockquote><table><thead><tr><th>表头</th><th>含义</th></tr></thead><tbody><tr><td>health</td><td>当前服务器健康状态：green(集群完整) 、yellow(单点正常、集群不完整) 、red(单点不正常)</td></tr><tr><td>status</td><td>索引打开、关闭状态</td></tr><tr><td>index</td><td>索引名</td></tr><tr><td><code>uuid</code></td><td>索引统一编号</td></tr><tr><td><code>pri</code></td><td>主分片数量</td></tr><tr><td>rep</td><td>副本数量</td></tr><tr><td><code>docs.count</code></td><td>可用文档数量</td></tr><tr><td><code>docs.deleted</code></td><td>文档删除状态（逻辑删除）</td></tr><tr><td><code>store.size</code></td><td>主分片和副分片整体占空间大小</td></tr><tr><td><code>pri.store.size</code></td><td>主分片占空间大小</td></tr></tbody></table><h3 id="4、删除单个索引（DELETE-请求）"><a href="#4、删除单个索引（DELETE-请求）" class="headerlink" title="4、删除单个索引（DELETE 请求）"></a>4、删除单个索引（DELETE 请求）</h3><blockquote><p>请求方式为 DELETE，在请求地址栏中输入链接如下：<a target="_blank" rel="noopener" href="http://localhost:9200/shopping">http://localhost:9200/shopping</a></p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418212048.png" alt="image-20210418212048172"></p><blockquote><p>再次访问 shopping 索引，会提示索引不存在</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418212120.png" alt="image-20210418212120103"></p><h2 id="1-7、文档操作"><a href="#1-7、文档操作" class="headerlink" title="1.7、文档操作"></a>1.7、文档操作</h2><h3 id="1、创建文档（POST-请求）"><a href="#1、创建文档（POST-请求）" class="headerlink" title="1、创建文档（POST 请求）"></a>1、创建文档（POST 请求）</h3><blockquote><p>重建 shopping 索引，然后创建文档，添加数据，添加数据的格式为 JSON 格式。</p><p>发送 POST 请求，请求地址为：<a target="_blank" rel="noopener" href="http://localhost:9200/shopping/_doc">http://localhost:9200/shopping/_doc</a></p><p>其中请求体内容为：</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;华为手机&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;category&quot;</span>: <span class="string">&quot;huawei&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;image&quot;</span>: <span class="string">&quot;https://gitee.com/sutianxin/photo/raw/master/20210418212741.png&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;price&quot;</span>:<span class="number">3999</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果如下</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418212935.png" alt="image-20210418212935632"></p><h3 id="2、在创建文档时自定义文档-id（POST-请求）"><a href="#2、在创建文档时自定义文档-id（POST-请求）" class="headerlink" title="2、在创建文档时自定义文档 id（POST 请求）"></a>2、在创建文档时自定义文档 id（POST 请求）</h3><blockquote><p>请求路径为 POST ，在请求路径中添加自定义的id，请求路径如下</p><p><a target="_blank" rel="noopener" href="http://localhost:9200/shopping/_doc/1001">http://localhost:9200/shopping/_doc/1001</a></p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418213516.png" alt="image-20210418213516224"></p><h3 id="3、根据-id-获取文档对象（GET-请求）"><a href="#3、根据-id-获取文档对象（GET-请求）" class="headerlink" title="3、根据 id 获取文档对象（GET 请求）"></a>3、根据 id 获取文档对象（GET 请求）</h3><blockquote><p>发送 GET 请求，请求地址为 <code>http://localhost:9200/shopping/_doc/带查询id</code>，这里我们查询 id 为1001的数据</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418213804.png" alt="image-20210418213804078"></p><blockquote><p>如果查询一个不存在的数据，那么返回结果的 found 属性会为 false</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418213906.png" alt="image-20210418213906787"></p><h3 id="4、查询索引下的所有文档对象（GET-请求）"><a href="#4、查询索引下的所有文档对象（GET-请求）" class="headerlink" title="4、查询索引下的所有文档对象（GET 请求）"></a>4、查询索引下的所有文档对象（GET 请求）</h3><blockquote><p>发送 GET 请求，请求地址为：<code>http://localhost:9200/索引名称/_search</code></p></blockquote><ul><li>查询 shopping 索引下的所有文档对象</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;took&quot;</span>: <span class="number">2383</span>,</span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">&quot;relation&quot;</span>: <span class="string">&quot;eq&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span>: <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;shopping&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;d5Ir5XgBPCVDxZvTxiiG&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1.0</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;华为手机&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;category&quot;</span>: <span class="string">&quot;huawei&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;image&quot;</span>: <span class="string">&quot;https://gitee.com/sutianxin/photo/raw/master/20210418212741.png&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;price&quot;</span>: <span class="number">3999</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;shopping&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;_doc&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1001&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">1.0</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;华为手机&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;category&quot;</span>: <span class="string">&quot;huawei&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;image&quot;</span>: <span class="string">&quot;https://gitee.com/sutianxin/photo/raw/master/20210418212741.png&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;price&quot;</span>: <span class="number">3999</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5、文档的全量修改（PUT-请求）"><a href="#5、文档的全量修改（PUT-请求）" class="headerlink" title="5、文档的全量修改（PUT 请求）"></a>5、文档的全量修改（PUT 请求）</h3><blockquote><p>发送 PUT 请求，请求地址为：<code>http://localhost:9200/索引/_doc/要修改的文档id</code></p><p>然后在 Body 中传入新文档的信息，以 JSON 形式传递。</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418214711.png" alt="image-20210418214711634"></p><blockquote><p>发送请求，查看结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418214753.png" alt="image-20210418214753942"></p><blockquote><p>再次查看该数据</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418214942.png" alt="image-20210418214942303"></p><h3 id="6、文档的局部修改（POST-请求）"><a href="#6、文档的局部修改（POST-请求）" class="headerlink" title="6、文档的局部修改（POST 请求）"></a>6、文档的局部修改（POST 请求）</h3><blockquote><p>发送 POST 请求，请求地址为：<code>http://localhost:9200/索引名/_update/要修改的id</code>，并在 Body 中指定要更新的字段及对应信息.</p></blockquote><ul><li>修改 shopping 索引中 id 为 1001 的字段，将 title 修改为 <code>HUAWEI MATE P40</code></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;doc&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;title&quot;</span>:<span class="string">&quot;HUAWEI MATE P40&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>请求如下</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418215304.png" alt="image-20210418215304169"></p><blockquote><p>结果如下</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418215318.png" alt="image-20210418215318775"></p><h3 id="7、文档对象的删除（DELETE-请求）"><a href="#7、文档对象的删除（DELETE-请求）" class="headerlink" title="7、文档对象的删除（DELETE 请求）"></a>7、文档对象的删除（DELETE 请求）</h3><blockquote><p>发送 DELETE 请求，请求地址为：<code>http://localhost:9200/索引名/_doc/待删除索引id</code></p></blockquote><ul><li>删除 id 为 1001 的文档对象</li></ul><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418220243.png" alt="image-20210418220243804"></p><h1 id="二、ElasticSearch-分词器介绍"><a href="#二、ElasticSearch-分词器介绍" class="headerlink" title="二、ElasticSearch 分词器介绍"></a>二、<code>ElasticSearch</code> 分词器介绍</h1><h2 id="2-1、内置分词器"><a href="#2-1、内置分词器" class="headerlink" title="2.1、内置分词器"></a>2.1、内置分词器</h2><blockquote><p><code>ElasticSearch</code> 核心功能就是数据检索，首先通过索引将文档写入 ES ，查询分析则主要分为两个步骤：</p></blockquote><ol><li>词条化：分词器将输入文本转换为一个一个的词条流。</li><li>过滤：比如停用词过滤器会从词条中去除不相干的词条；另外还有同义词过滤器，小写过滤器等，<code>ElasticSearch</code> 中内置了多种分词器可供使用。</li></ol><blockquote><p>ES 内置分词器如下：</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420163311.png" alt="image-20210420163311390"></p><h2 id="2-2、中文分词器"><a href="#2-2、中文分词器" class="headerlink" title="2.2、中文分词器"></a>2.2、中文分词器</h2><p>在<code>Es</code> 中，使用较多的中文分词器是 <code>elasticsearch-analysis-ik</code>，这个是 <code>es</code> 的一个第三方插件，代码托管在 GitHub 上：</p><blockquote><p><a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p></blockquote><h3 id="1、安装方式"><a href="#1、安装方式" class="headerlink" title="1、安装方式"></a>1、安装方式</h3><ul><li>首先打开分词器官网：</li></ul><blockquote><p><a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p></blockquote><ul><li><p>在 <a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik/releases">https://github.com/medcl/elasticsearch-analysis-ik/releases</a> 页面找到最新的正式版，下载下来。</p></li><li><p>将下载文件解压。</p></li><li><p>在 <code>es/plugins</code> 目录下，新建 <code>ik</code>目录，并将解压后的所有文件拷贝到 ik 目录下。</p></li><li><p>重启 <code>es</code> 服务。</p></li></ul><h3 id="2、测试分词器"><a href="#2、测试分词器" class="headerlink" title="2、测试分词器"></a>2、测试分词器</h3><ul><li>创建一个 test 索引</li><li>传入文本进行分析</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST test/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;美国留给伊拉克的是一个烂摊子吗&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>结果</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span> : [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;美国&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;留给&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;伊拉克&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">7</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;的&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">7</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">8</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;CN_CHAR&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">3</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;是&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">8</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">9</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;CN_CHAR&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">4</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;一个&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">9</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">11</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">5</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;烂摊子&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">11</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">14</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">6</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span> : <span class="string">&quot;吗&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span> : <span class="number">14</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span> : <span class="number">15</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;CN_CHAR&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span> : <span class="number">7</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、自定义扩展词库"><a href="#3、自定义扩展词库" class="headerlink" title="3、自定义扩展词库"></a>3、自定义扩展词库</h3><blockquote><p>本地自定义</p><p>在 <code>plugins/ik/config</code> 目录下，新建 <code>ext.dic</code> （文件名任意），在该文件中配置自定义词库</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">芜湖起飞</span><br></pre></td></tr></table></figure><blockquote><p>在 <code>IKAnalyzer.cfg.xml</code> 中配置自定义词库</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">properties</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;http://java.sun.com/dtd/properties.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_dict&quot;</span>&gt;</span>ext.dic<span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	 <span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;ext_stopwords&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展字典 --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>重启 <code>ES</code> ，测试分词</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST test/_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;芜湖起飞肉蛋葱鸡&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>分词结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420182301.png" alt="image-20210420182300273"></p><h1 id="三、字段类型"><a href="#三、字段类型" class="headerlink" title="三、字段类型"></a>三、字段类型</h1><h2 id="3-1、核心类型"><a href="#3-1、核心类型" class="headerlink" title="3.1、核心类型"></a>3.1、核心类型</h2><h3 id="1、字符串类型"><a href="#1、字符串类型" class="headerlink" title="1、字符串类型"></a>1、字符串类型</h3><ul><li>string</li></ul><blockquote><p>这是一个已经过期的字符串类型。在 es5 之前，用这个来描述字符串，现在的话，它已经被 text 和 keyword 替代了。</p></blockquote><ul><li>text</li></ul><blockquote><p>如果一个字段是要被全文检索的，比如说<strong>博客内容、新闻内容、产品描述</strong>，那么可以使用 text。</p><p>用了 text 之后，字段内容会被分析，在生成倒排索引之前，字符串会被分词器分成一个个词项。</p><p>text 类型的字段不用于排序，很少用于聚合。这种字符串也被称为 analyzed 字段。</p><p>使用场景：</p><ol><li>存储全文搜索数据, 例如: 邮箱内容、地址、代码块、博客文章内容等。</li><li>默认结合standard analyzer(标准解析器)对文本进行分词、倒排索引。</li><li>默认结合标准分析器进行词命中、词频相关度打分。</li></ol></blockquote><ul><li>keyword</li></ul><blockquote><p>这种类型适用于结构化的字段，例如标签、email 地址、手机号码等等，这种类型的字段可以用作过滤、排序、聚合等。</p><p>这种字符串也称之为 not-analyzed 字段。</p></blockquote><h3 id="2、数字类型"><a href="#2、数字类型" class="headerlink" title="2、数字类型"></a>2、数字类型</h3><table><thead><tr><th>类型</th><th>取值范围</th></tr></thead><tbody><tr><td>long</td><td>-2^63^ 到 2^63^ - 1</td></tr><tr><td>integer</td><td>-2^31^ 到 2^31^ - 1</td></tr><tr><td>short</td><td>-2^15^ 到 2^15^ - 1</td></tr><tr><td>byte</td><td>-2^7^ 到 2^7^ - 1</td></tr><tr><td>double</td><td>64 位的双精度浮点类型</td></tr><tr><td>float</td><td>32 位的双精度浮点类型</td></tr><tr><td>half_float</td><td>16 位的双精度浮点类型</td></tr><tr><td>scaled_float</td><td>缩放类型的浮点类型</td></tr></tbody></table><blockquote><p>在满足需求的情况下，优先使用范围小的字段。字段长度越短，索引和搜索的效率越高。</p><p>浮点数，优先考虑使用 scaled_float。</p></blockquote><h3 id="3、日期类型"><a href="#3、日期类型" class="headerlink" title="3、日期类型"></a>3、日期类型</h3><blockquote><p>由于 JSON 中没有日期类型，所以 <code>es</code> 中的日期类型形式就比较多样：</p></blockquote><ul><li>2020-11-11 或者 2020-11-11 11:11:11</li><li>一个从 1970.1.1 零点到现在的一个秒数或者毫秒数。</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PUT product/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;date&quot;</span>:<span class="string">&quot;2020-11-11&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT product/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;date&quot;</span>:<span class="string">&quot;2020-11-11T11:11:11Z&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT product/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;date&quot;</span>:<span class="string">&quot;1604672099958&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>以上三个时间都能被解析</p></blockquote><h3 id="4、布尔类型"><a href="#4、布尔类型" class="headerlink" title="4、布尔类型"></a>4、布尔类型</h3><blockquote><p>JSON 中的 “true”、“false”、true、false 都可以。</p></blockquote><h3 id="5、二进制类型"><a href="#5、二进制类型" class="headerlink" title="5、二进制类型"></a>5、二进制类型</h3><blockquote><p>二进制接受的是 base64 编码的字符串，默认不存储，也不可搜索。</p></blockquote><h3 id="6、范围类型"><a href="#6、范围类型" class="headerlink" title="6、范围类型"></a>6、范围类型</h3><ul><li>integer_range</li><li>float_range</li><li>long_range</li><li>double_range</li><li>date_range</li><li>ip_range</li></ul><blockquote><p>定义的时候，指定范围类型即可：</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT product</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;date&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;price&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;float_range&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>在插入数据时指定范围，可以使用 <code>gt、gte、lt、lte</code></p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PUT product/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;date&quot;</span>: <span class="string">&quot;2020-11-11&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gt&quot;</span>:<span class="number">9</span>,</span><br><span class="line">        <span class="attr">&quot;lt&quot;</span>:<span class="number">11</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3-2、复合类型"><a href="#3-2、复合类型" class="headerlink" title="3.2、复合类型"></a>3.2、复合类型</h2><h3 id="1、数组类型"><a href="#1、数组类型" class="headerlink" title="1、数组类型"></a>1、数组类型</h3><p><code>es</code> 中没有专门的数组类型。默认情况下，任何字段都可以有一个或者多个值。</p><p><strong>需要注意的是，数组中的元素必须是同一种类型。</strong></p><p><strong>添加数组时，数组中的第一个元素决定了整个数组的类型。</strong></p><h3 id="2、对象类型"><a href="#2、对象类型" class="headerlink" title="2、对象类型"></a>2、对象类型</h3><blockquote><p>由于 JSON 本身具有层级关系，所以文档包含内部对象。内部对象中，还可以再包含内部对象。</p></blockquote><h2 id="3-3、地理类型"><a href="#3-3、地理类型" class="headerlink" title="3.3、地理类型"></a>3.3、地理类型</h2><h3 id="1、使用场景"><a href="#1、使用场景" class="headerlink" title="1、使用场景"></a>1、使用场景</h3><ul><li>查找某一个范围内的地理位置</li><li>通过地理位置或者相对中心点的距离来聚合文档</li><li>把距离整个到文档的评分中</li><li>通过距离对文档进行排序</li></ul><h3 id="2、geo-point"><a href="#2、geo-point" class="headerlink" title="2、geo_point"></a>2、geo_point</h3><blockquote><p>geo_point 就是一个坐标点，定义方式如下：</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT people</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;location&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;geo_point&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>创建文档时指定字段类型，存储的时候，有四种方式：</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PUT people/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;location&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;lat&quot;</span>: <span class="number">34.27</span>,</span><br><span class="line">    <span class="attr">&quot;lon&quot;</span>: <span class="number">108.94</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT people/_doc/2</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;location&quot;</span>:<span class="string">&quot;34.27,108.94&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT people/_doc/3</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// 使用geo_hash  </span></span><br><span class="line">  <span class="attr">&quot;location&quot;</span>:<span class="string">&quot;uzbrgzfxuzup&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT people/_doc/4</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;location&quot;</span>:[<span class="number">108.94</span>,<span class="number">34.27</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意，使用数组描述，先经度后纬度</p></blockquote><ul><li><code>lat</code>：纬度</li><li><code>lon</code>：经度</li></ul><h2 id="3-4、特殊类型"><a href="#3-4、特殊类型" class="headerlink" title="3.4、特殊类型"></a>3.4、特殊类型</h2><h3 id="1、IP"><a href="#1、IP" class="headerlink" title="1、IP"></a>1、IP</h3><blockquote><p>存储 IP 地址，类型是 <code>ip</code></p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PUT blog</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;remote&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;ip&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>添加文档</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PUT blog/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;remote&quot;</span>:<span class="string">&quot;192.168.91.1&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>搜索结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420190745.png" alt="image-20210420190744443"></p><h2 id="3-5、Mapping-的定义"><a href="#3-5、Mapping-的定义" class="headerlink" title="3.5、Mapping 的定义"></a>3.5、Mapping 的定义</h2><blockquote><p>语法格式如下</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT 索引名 </span><br><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;mappings&quot;</span> : &#123;</span><br><span class="line">        <span class="comment">// 定义你的Mapping</span></span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>定义mapping的建议方式：写入一个样本文档到临时索引中。此时 ES 会自动生成mapping信息，通过访问 mapping 信息的 API 查询 mapping 定义，修改自动生成的 mapping 成为我们需要的mapping，然后删去原有的索引即可。</code></p><p><strong>建议在 ES 自动生成的基础上修改，ES 的mapping确定后不能修改</strong></p></blockquote><ul><li>创建一个 user 索引，其中 name 为 text 类型，age 为 long 类型，birthday 为 date 类型</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">PUT /user</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;mappings&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;properties&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;text&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;long&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;birthday&quot;</span> : &#123;</span><br><span class="line">                <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;date&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="四、搜索"><a href="#四、搜索" class="headerlink" title="四、搜索"></a>四、搜索</h1><h2 id="4-1、前期准备"><a href="#4-1、前期准备" class="headerlink" title="4.1、前期准备"></a>4.1、前期准备</h2><h3 id="1、创建索引"><a href="#1、创建索引" class="headerlink" title="1、创建索引"></a>1、创建索引</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">PUT books</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;publish&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;author&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;info&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;price&quot;</span>:&#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;double&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、导入数据"><a href="#2、导入数据" class="headerlink" title="2、导入数据"></a>2、导入数据</h3><blockquote><p>执行脚本，导入数据</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">&quot;http://localhost:9200/books/_bulk?pretty&quot;</span> -H <span class="string">&quot;content-type:application/json&quot;</span> --data-binary @bookdata.json</span><br></pre></td></tr></table></figure><h3 id="3、文档保存与搜索"><a href="#3、文档保存与搜索" class="headerlink" title="3、文档保存与搜索"></a>3、文档保存与搜索</h3><blockquote><p>搜索分为两个过程：</p></blockquote><ol><li>当向索引中保存文档时，默认情况下，<code>es</code> 会保存两份内容，一份是 <code>_source</code> 中的数据，另一份则是通过分词、排序等一系列过程生成的倒排索引文件，倒排索引中保存了词项和文档之间的对应关系。</li><li>搜索时，当 <code>es</code> 接收到用户的搜索请求之后，就会去倒排索引中查询，通过的倒排索引中维护的倒排记录表找到关键词对应的文档集合，然后对文档进行评分、排序、高亮等处理，处理完成后返回文档。</li></ol><h2 id="4-2、词项-查询"><a href="#4-2、词项-查询" class="headerlink" title="4.2、词项 查询"></a>4.2、词项 查询</h2><blockquote><p>term 是表达语义的最小单位，在搜索的时候基本都要使用到 term。</p><p>term 查询的种类有：Term Query、Range Query 等。</p><p><strong>在 ES 中，Term的查询代表完全匹配， Term 查询不会对输入进行分词处理，而是将输入作为一个整体，在创建索引中使用查找准确的词项，我们也可以 Constant Score 将查询转换为一个 filter ，避免算分，利用缓存，提高查询效率。</strong></p><p>Term 不会对我们传入的参数做任何处理，而是直接将参数丢进倒排索引库中。</p></blockquote><h3 id="1、term"><a href="#1、term" class="headerlink" title="1、term"></a>1、term</h3><blockquote><p>查询书名中有 <strong>无机化学</strong> 的书籍， 用于查询的单词不会被进行任何分词处理</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;无机化学&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;_source&quot;</span>:[<span class="string">&quot;name&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420213415.png" alt="image-20210420213415175"></p><h3 id="2、terms"><a href="#2、terms" class="headerlink" title="2、terms"></a>2、terms</h3><blockquote><p>terms 查询和 term 查询机制一样，都不会将指定关键词进行分词，而是直接去分词库中匹配，找到响应文档内容。</p><p>terms 是在针对一个字段包含多个值时使用，多个值间以 OR 分隔</p></blockquote><ul><li>查询书籍名称中含有 <strong>无机化学</strong> 或者 <strong>线性代数</strong> 的书籍</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;线性代数&quot;</span>,</span><br><span class="line">        <span class="string">&quot;无机化学&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>]  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420194655.png" alt="image-20210420194654481"></p><h3 id="3、Constant-Score"><a href="#3、Constant-Score" class="headerlink" title="3、Constant Score"></a>3、Constant Score</h3><blockquote><p>内部包装了过滤查询,故而不会计算相似度分,该查询返回的相似度分与字段上指定boost参数值相同</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;constant_score&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;term&quot;</span>: &#123; <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;无机化学&quot;</span> &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>]  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420201022.png" alt="image-20210420201022240"></p><h3 id="4、range"><a href="#4、range" class="headerlink" title="4、range"></a>4、range</h3><blockquote><p>range query 中的参数主要有四个：</p></blockquote><ol><li><code>gt</code></li><li><code>lt</code></li><li><code>gte</code></li><li><code>lte</code></li></ol><ul><li>查询书籍价格在 10 - 20 元之间的书籍</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="comment">// 进行范围查询的字段，必须为数字类型</span></span><br><span class="line">      <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gte&quot;</span>: <span class="number">10</span>,</span><br><span class="line">        <span class="attr">&quot;lte&quot;</span>: <span class="number">20</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>,<span class="string">&quot;price&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果（局部）</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420215217.png" alt="image-20210420215217404"></p><h3 id="5、wildcard"><a href="#5、wildcard" class="headerlink" title="5、wildcard"></a>5、wildcard</h3><blockquote><p>wildcard query 即通配符查询。支持单字符和多字符通配符：</p></blockquote><ol><li><code>?</code> 表示一个任意字符。</li><li><code>*</code> 表示零个或者多个字符。</li></ol><ul><li>查询所有姓张的作者的书</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;wildcard&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;author&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;张*&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>,<span class="string">&quot;author&quot;</span>,<span class="string">&quot;price&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果（局部）</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420220011.png" alt="image-20210420220011558"></p><ul><li>查询作者姓张，且名字只有两个字的书籍</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;wildcard&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;author&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;张?&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>,<span class="string">&quot;author&quot;</span>,<span class="string">&quot;price&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420220422.png" alt="image-20210420220422761"></p><h3 id="6、ids"><a href="#6、ids" class="headerlink" title="6、ids"></a>6、ids</h3><blockquote><p>根据指定的 id 查询</p></blockquote><ul><li>查询id 为 1，2，3的数据</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;ids&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;values&quot;</span>: [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420221808.png" alt="image-20210420221807911"></p><h2 id="4-3、全文查询"><a href="#4-3、全文查询" class="headerlink" title="4.3、全文查询"></a>4.3、全文查询</h2><blockquote><p>全文查询的种类有：<strong>Match Query、Match Phrase Query 和 Query String Query 等</strong></p><p><code>索引和搜索时都会进行分词，在查询时，会对输入进行分词，然后每个词项会逐个到底层进行查询，将最终结果进行合并。</code></p></blockquote><h3 id="1、match-phrase"><a href="#1、match-phrase" class="headerlink" title="1、match_phrase"></a>1、match_phrase</h3><blockquote><p>match_phrase是短语搜索，它会将给定的短语（phrase）当成一个完整的查询条件。</p><p>会对输入做分词，但是需要结果中也包含所有的分词，而且顺序要求一样。</p><p>match_phrase 含有一个 slop 属性</p><p>slop 是指关键字之间的最小距离，但是注意不是关键之间间隔的字数。文档中的字段被分词器解析之后，解析出来的词项都包含一个 position 字段表示词项的位置，查询短语分词之后 的 position 之间的间隔要满足 slop 的要求。slop 默认为1</p></blockquote><ul><li>查询名字中带有 <strong>十一五化学</strong> 的文档</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;十一五化学&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;slop&quot;</span>: <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>此时无法查询到任何结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420210141.png" alt="image-20210420210141684"></p><ul><li>我们增大 slop 的值，再次进行查询</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match_phrase&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;十一五化学&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;slop&quot;</span>: <span class="number">20</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>此时查询到 5 条数据</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420210252.png" alt="image-20210420210252535"></p><h3 id="2、multi-match"><a href="#2、multi-match" class="headerlink" title="2、multi_match"></a>2、multi_match</h3><blockquote><p>多条件查询，会对传入的文本进行分词。</p></blockquote><ul><li>查询 name 属性或 info 属性中 匹配 <strong>化学无机数学</strong> 的文档</li></ul><blockquote><p>进行分词，其实就是查询 name 属性或 info 属性中含有 <strong>化学</strong> 、 <strong>无机</strong> 或 <strong>数学</strong> 的文档</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;化学无机数学&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;</span>: [<span class="string">&quot;name&quot;</span>,<span class="string">&quot;info&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">   <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>,<span class="string">&quot;info&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420202138.png" alt="image-20210420202138254"></p><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420202207.png" alt="image-20210420202207751"></p><ul><li>这种查询方式还可以指定字段权重</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;multi_match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;化学无机数学&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;</span>: [<span class="string">&quot;name&quot;</span>,<span class="string">&quot;info&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">   <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;name^4&quot;</span>,<span class="string">&quot;info&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这个表示关键字出现在 name 中的权重是出现在 info 中权重的 4 倍。</p></blockquote><h3 id="3、match"><a href="#3、match" class="headerlink" title="3、match"></a>3、match</h3><blockquote><p>match 会对查询语句进行分词，分词后，如果查询语句中的任何一个词项被匹配，则文档就会被索引到。查询条件相对来说比较宽松。</p><p>match 分词后，默认词项之间是 OR 的关系，也就是说，只需要文档中包含一个分词结果，那么就返回文档，可以通过 operator 修改分词后词项之间的关系。</p></blockquote><ul><li>词项间为 OR 的关系</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;计算机化学&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>此时查看结果，发现返回的文档中 name 属性可以只包含 <code>计算机</code> 或只包含 <code>化学</code></p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420204832.png" alt="image-20210420204832261"></p><ul><li>词项间为 AND 的关系</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;计算机化学&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;operator&quot;</span>: <span class="string">&quot;AND&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>此时命中的记录数为0</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420205057.png" alt="image-20210420205056950"></p><h2 id="4-4、simple-query-string-和-query-string"><a href="#4-4、simple-query-string-和-query-string" class="headerlink" title="4.4、simple_query_string 和 query_string"></a>4.4、simple_query_string 和 query_string</h2><h3 id="1、query-string"><a href="#1、query-string" class="headerlink" title="1、query_string"></a>1、query_string</h3><blockquote><p>和match类似，但是match需要指定字段名，query_string是在所有字段中搜索，范围更广泛。</p><p>允许我们在<strong>单个查询字符串</strong>中指定<strong>AND | OR | NOT</strong>条件，同时也和 multi_match query 一样，<strong>支持多字段搜索。</strong></p><p><code>查询 title 中包含 beautiful 和 mind 的所有电影</code></p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210419131348.png" alt="image-20210419131348485"></p><blockquote><p>检索同时包含Token【系统学、<code>es</code>】的文档</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /tehero_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query_string&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;fields&quot;</span> : [<span class="string">&quot;content.ik_smart_analyzer&quot;</span>],</span><br><span class="line">            <span class="attr">&quot;query&quot;</span> : <span class="string">&quot;系统学 AND es&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>检索包含Token【系统学、<code>es</code>】二者之一的文档</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /tehero_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query_string&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;fields&quot;</span> : [<span class="string">&quot;content.ik_smart_analyzer&quot;</span>],</span><br><span class="line">            <span class="attr">&quot;query&quot;</span> : <span class="string">&quot;系统学 OR es&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、simple-query-string"><a href="#2、simple-query-string" class="headerlink" title="2、simple_query_string"></a>2、simple_query_string</h3><blockquote><p><strong>类似于</strong>query_string ，<strong>但是会忽略错误的语法，永远不会引发异常，并且会丢弃查询的无效部分。</strong></p><p>simple_query_string支持以下特殊字符：</p><ol><li><p><code>+</code> 表示与运算，相当于query_string 的 AND</p></li><li><p><code>|</code> 表示或运算，相当于query_string 的 OR</p></li><li><p><code>-</code> 取反单个令牌,相当于query_string 的 NOT</p></li><li><p><code>&quot;&quot;</code>表示对检索词进行 match_phrase query</p></li><li><p><code>*</code> 字词末尾表示前缀查询</p></li></ol></blockquote><ul><li><code>+</code> 表示与运算，相当于query_string 的 AND</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /tehero_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;simple_query_string&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;fields&quot;</span> : [<span class="string">&quot;content.ik_smart_analyzer&quot;</span>],</span><br><span class="line">            <span class="attr">&quot;query&quot;</span> : <span class="string">&quot;系统学 + 间隔&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>|</code> 表示或运算，相当于query_string 的 OR</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /tehero_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;simple_query_string&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;fields&quot;</span> : [<span class="string">&quot;content.ik_smart_analyzer&quot;</span>],</span><br><span class="line">            <span class="attr">&quot;query&quot;</span> : <span class="string">&quot;系统学 | 间隔&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>-</code> 取反单个令牌,相当于query_string 的 NOT</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET /tehero_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;simple_query_string&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;fields&quot;</span> : [<span class="string">&quot;content.ik_smart_analyzer&quot;</span>],</span><br><span class="line">            <span class="attr">&quot;query&quot;</span> : <span class="string">&quot;系统学 -间隔&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;default_operator&quot;</span>: <span class="string">&quot;and&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><strong>注意：参数”default_operator”: “and”。该参数的默认值为or。</strong><br>上述DSL对应的 <code>sql</code> 语句为：【where Token = 系统学 and Token &lt;&gt; 间隔】</p></blockquote><ul><li><code>&quot;&quot;</code>表示对检索词进行 match_phrase query</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /tehero_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;simple_query_string&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;fields&quot;</span> : [<span class="string">&quot;content.ik_smart_analyzer&quot;</span>],</span><br><span class="line">            <span class="attr">&quot;query&quot;</span> : <span class="string">&quot;\&quot;系统学编程关注\&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>*</code> 字词末尾表示前缀查询</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /tehero_index/_doc/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;simple_query_string&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;fields&quot;</span> : [<span class="string">&quot;content.ik_smart_analyzer&quot;</span>],</span><br><span class="line">            <span class="attr">&quot;query&quot;</span> : <span class="string">&quot;系统*&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4-5、fuzzy-模糊查询"><a href="#4-5、fuzzy-模糊查询" class="headerlink" title="4.5、fuzzy 模糊查询"></a>4.5、fuzzy 模糊查询</h2><blockquote><p>在实际搜索中，有时我们可能会打错字，从而导致搜索不到，fuzzy 用于模糊查询，可以自动将拼写错误的搜索文本进行纠正，纠正后去尝试匹配索引中的数据。</p><p>fuzzy query 返回与搜索关键字相似的文档。怎么样就算相似？以 <code>LevenShtein</code> 编辑距离为准。编辑距离是指将一个字符变为另一个字符所需要更改字符的次数，更改主要包括四种：</p></blockquote><ul><li>更改字符（javb–〉java）</li><li>删除字符（javva–〉java）</li><li>插入字符（jaa–〉java）</li><li>转置字符（ajva–〉java）</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /my_index/my_type/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;fuzzy&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;属性&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;要模糊匹配的值&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;fuzziness&quot;</span>: <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>其中 fuzziness 为调整次数，只能为0、1、2，最多纠正两个错误</p></blockquote><ul><li>传入拼写错误的文本 jaba，查看模糊查询返回的结果</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;fuzzy&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;jaba&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;fuzziness&quot;</span>: <span class="number">2</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_source&quot;</span>: [<span class="string">&quot;name&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>返回的结果如下</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210420221130.png" alt="image-20210420221130345"></p><h2 id="4-6、特殊查询"><a href="#4-6、特殊查询" class="headerlink" title="4.6、特殊查询"></a>4.6、特殊查询</h2><h3 id="1、more-like-this"><a href="#1、more-like-this" class="headerlink" title="1、more_like_this"></a>1、more_like_this</h3><blockquote><p><code>more_like_this</code> query 可以实现基于内容的推荐，给定一篇文章，可以查询出和该文章相似的内容。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET 要查询的索引&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;more_like_this&quot;: &#123;</span><br><span class="line">      &quot;fields&quot;: [</span><br><span class="line">        &quot;FIELD&quot;</span><br><span class="line">      ],</span><br><span class="line">      &quot;like&quot;: &quot;text like this one&quot;,</span><br><span class="line">      &quot;min_term_freq&quot;: 1,</span><br><span class="line">      &quot;max_query_terms&quot;: 12</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>fields：要匹配的字段，可以有多个</li><li>like：要匹配的文本</li><li><code>min_term_freq</code>：词项的最低频率，默认为2，<strong>这个指词项在要匹配的文本中的频率，而不是在 ES 文档中的频率</strong></li><li><code>max_query_terms</code>：query 中包含的最大词项数目</li><li><code>min_doc_freq</code>：最小的文档频率，搜索的词，至少在多少个文档中出现，少于指定数目，该词会被忽略</li><li><code>max_doc_freq</code>：最大文档频率</li><li>analyzer：分词器，默认使用字段的分词器</li><li>stop_words：停用词列表</li></ol><h1 id="五、聚合查询"><a href="#五、聚合查询" class="headerlink" title="五、聚合查询"></a>五、聚合查询</h1><blockquote><p>语法格式：</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET indexName/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        &quot;aggs_name&quot; : &#123; # 聚合分析的名字由用户自定义</span><br><span class="line">            &quot;aggs_type&quot; : &#123; # 由 es 提供，固定值</span><br><span class="line">            	<span class="comment">// aggregation body           </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ES 中的聚合分析我们主要从两个方面来学习：</p><ul><li>指标聚合</li><li>桶聚合（类似 group by）</li></ul><h2 id="5-1、ES-指标聚合"><a href="#5-1、ES-指标聚合" class="headerlink" title="5.1、ES 指标聚合"></a>5.1、ES 指标聚合</h2><h3 id="1、Max-Aggregation"><a href="#1、Max-Aggregation" class="headerlink" title="1、Max Aggregation"></a>1、<code>Max</code> Aggregation</h3><blockquote><p>统计最大值</p></blockquote><ul><li>查询价格最高的书籍</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>, </span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;max_price_book&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;max&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;missing&quot;</span>: <span class="number">1000</span>  </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421144025.png" alt="image-20210421144021453"></p><blockquote><p>missing 参数：如果某个文档中缺少 price 字段，则设置该字段的值为 1000。</p></blockquote><h3 id="2、Min-Aggregation"><a href="#2、Min-Aggregation" class="headerlink" title="2、Min Aggregation"></a>2、<code>Min</code> Aggregation</h3><blockquote><p>统计最小值，用法和 Max Aggregation 基本一致：</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;min_price_book&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;min&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;missing&quot;</span>: <span class="number">25</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421145212.png" alt="image-20210421145212570"></p><h3 id="3、Avg-Aggregation"><a href="#3、Avg-Aggregation" class="headerlink" title="3、Avg Aggregation"></a>3、<code>Avg</code> Aggregation</h3><blockquote><p>统计平均值</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421145635.png" alt="image-20210421145635226"></p><h3 id="4、Sum-Aggregation"><a href="#4、Sum-Aggregation" class="headerlink" title="4、Sum Aggregation"></a>4、<code>Sum</code> Aggregation</h3><blockquote><p>求和</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>, </span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;sum_price&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;sum&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421145711.png" alt="image-20210421145711003"></p><h3 id="5、Cardinality-Aggregation"><a href="#5、Cardinality-Aggregation" class="headerlink" title="5、Cardinality Aggregation"></a>5、<code>Cardinality</code> Aggregation</h3><blockquote><p>cardinality aggregation 用于基数统计。类似于 SQL 中的 distinct count(0)</p></blockquote><ul><li>查询总共有多少个岗位</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 计算岗位个数</span><br><span class="line">GET employee/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;count_job&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;cardinality&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;job&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>查看结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210419204556.png" alt="image-20210419204556351"></p><h3 id="6、Stats-Aggregation"><a href="#6、Stats-Aggregation" class="headerlink" title="6、Stats Aggregation"></a>6、<code>Stats</code> Aggregation</h3><blockquote><p>基本统计，<code>count</code>、<code>max</code>、<code>min</code>、<code>avg</code>和<code>sum</code>，要求计算属性的类型为数字类型</p><p>查询员工工资的信息</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 查询员工工资基本信息</span><br><span class="line">GET employee/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;sal_info&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;stats&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;sal&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210419213452.png" alt="image-20210419213452141"></p><h3 id="7、Extends-Stats-Aggregation"><a href="#7、Extends-Stats-Aggregation" class="headerlink" title="7、Extends Stats Aggregation"></a>7、<code>Extends Stats</code> Aggregation</h3><blockquote><p>高级统计，比 stats 多出来：平方和、方差、标准差、平均值加减两个标准差的区间</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;price_info&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;extended_stats&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421151609.png" alt="image-20210421151609265"></p><h2 id="5-2、桶聚合"><a href="#5-2、桶聚合" class="headerlink" title="5.2、桶聚合"></a>5.2、桶聚合</h2><h3 id="1、Terms-Aggregation"><a href="#1、Terms-Aggregation" class="headerlink" title="1、Terms Aggregation"></a>1、Terms Aggregation</h3><blockquote><p>Terms Aggregation 用于分组聚合，例如，统计各个出版社出版的图书总数量</p></blockquote><ul><li>统计每个职位员工数量</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET employee/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;job_num&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;job&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421152330.png" alt="image-20210421152330207"></p><blockquote><p>在 terms 分桶的基础上，还可以对每个桶进行指标聚合</p></blockquote><ul><li>统计每个岗位中员工工资信息</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET employee/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>, </span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;job_num&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;job&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;job_sal_info&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;stats&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;sal&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421153352.png" alt="image-20210421153352727"></p><h3 id="2、Filter-Aggregation"><a href="#2、Filter-Aggregation" class="headerlink" title="2、Filter Aggregation"></a>2、Filter Aggregation</h3><blockquote><p>过滤器聚合。可以将符合过滤器中条件的文档分到一个桶中，然后可以求其平均值。</p></blockquote><ul><li><p>例如查询书名中包含 化学 的图书的平均价格：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>:<span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;java_book_info&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;term&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;化学&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;avg_price&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421154919.png" alt="image-20210421154919595"></p><h3 id="3、Filters-Aggregation"><a href="#3、Filters-Aggregation" class="headerlink" title="3、Filters Aggregation"></a>3、Filters Aggregation</h3><blockquote><p>多过滤器聚合。过滤条件可以有多个。</p></blockquote><ul><li>查询书名中含有 java 或者 化学 的书籍，并且平均价格</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>, </span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;java_or_huaxue_book&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;filters&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;filters&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;term&quot;</span>:&#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;java&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;term&quot;</span>:&#123;</span><br><span class="line">              <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;office&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;avg_book_sal&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421155544.png" alt="image-20210421155544449"></p><h3 id="4、range-Aggregation"><a href="#4、range-Aggregation" class="headerlink" title="4、range Aggregation"></a>4、range Aggregation</h3><blockquote><p>按照范围聚合，在某一个范围内的文档数统计。</p></blockquote><ul><li>例如统计图书价格在 0-50、50-100、100-150、150以上的图书数量：</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;book_range_count&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;0-50的书籍数量&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="number">51</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;51-100的书籍数量&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="number">51</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="number">101</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;100-150的书籍数量&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="number">101</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="number">151</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;151后的书籍数量&quot;</span>, </span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="number">151</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421160255.png" alt="image-20210421160255316"></p><h3 id="5、Range-Aggregation"><a href="#5、Range-Aggregation" class="headerlink" title="5、Range Aggregation"></a>5、Range Aggregation</h3><blockquote><p>Range Aggregation 也可以用来统计日期，但是也可以使用 Date Range Aggregation，后者的优势在于可以使用日期表达式。</p></blockquote><ul><li>统计两年前到一年后的博客数量</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>, </span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;near_blog&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;date_range&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;now-24M/M&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;now+1y/y&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421161616.png" alt="image-20210421161616858"></p><ul><li>12M/M 表示 12 个月。</li><li>1y/y 表示 1年。</li><li>d 表示天</li></ul><h3 id="6、Missing-Aggregation"><a href="#6、Missing-Aggregation" class="headerlink" title="6、Missing Aggregation"></a>6、Missing Aggregation</h3><blockquote><p>空值聚合。</p><p>统计所有没有 price 字段的文档：</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">GET books/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;NAME&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;missing&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421162631.png" alt="image-20210421162631828"></p><h3 id="7、IP-Range-Aggregation"><a href="#7、IP-Range-Aggregation" class="headerlink" title="7、IP Range Aggregation"></a>7、IP Range Aggregation</h3><blockquote><p>IP 地址范围查询。</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET blog/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;NAME&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;ip_range&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;ip&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;127.0.0.5&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;127.0.0.11&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-3、聚合过滤问题"><a href="#5-3、聚合过滤问题" class="headerlink" title="5.3、聚合过滤问题"></a>5.3、聚合过滤问题</h2><h3 id="1、查询年龄大于30岁的员工的平均工资"><a href="#1、查询年龄大于30岁的员工的平均工资" class="headerlink" title="1、查询年龄大于30岁的员工的平均工资"></a>1、查询年龄大于30岁的员工的平均工资</h3><blockquote><p>先查询出年龄大于30岁的员工，然后进行聚合</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GET employee/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>, </span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;gte&quot;</span>: <span class="number">30</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;gt_30_emp_avg_sal&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;sal&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;aggregations&quot; : &#123;</span><br><span class="line">  &quot;gt_30_emp_avg_sal&quot; : &#123;</span><br><span class="line">    &quot;value&quot; : 20000.0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、查询Java员工的平均工资"><a href="#2、查询Java员工的平均工资" class="headerlink" title="2、查询Java员工的平均工资"></a>2、查询Java员工的平均工资</h3><blockquote><p>先查询出职业为 java 或者 Java 的员工，然后根据 平均工资进行聚合。</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET employee/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>, </span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;default_field&quot;</span>: <span class="string">&quot;job&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;java OR Java&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;java_emp_sal&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;sal&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;aggregations&quot; : &#123;</span><br><span class="line">  &quot;java_emp_sal&quot; : &#123;</span><br><span class="line">    &quot;value&quot; : 40488.88888888889</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5-4、高亮显示"><a href="#5-4、高亮显示" class="headerlink" title="5.4、高亮显示"></a>5.4、高亮显示</h2><blockquote><p>日常生活中我们使用搜索工具尝试查询一些信息的时候，常常可以看到返回的结果集中和我们查询条件相符合的字段被特殊的颜色所标记，这就是结果高亮显示。通过高亮显示用户可以明显的发现查询匹配的位置，</p><p>ES使用<code>highlight</code>来实现搜索结果中一个或多个字段突出显示。</p><p><code>highlight</code> 的层级与 <code>query</code> 同级，语法如下</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET employee/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;default_field&quot;</span>: <span class="string">&quot;job&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;java OR Java&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">      <span class="comment">// 要高亮的字段名，可以有多个  </span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">&quot;job&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210419234322.png" alt="image-20210419234321989"></p><blockquote><p>我们可以自定义高亮所用的标签，使用 <code>pre_tags</code> 定义前置标签， <code>post_tags</code> 定义后置标签</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET employee/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;default_field&quot;</span>: <span class="string">&quot;job&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;java OR Java&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;pre_tags&quot;</span>: <span class="string">&quot;&lt;span&gt;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;post_tags&quot;</span>: <span class="string">&quot;&lt;/span&gt;&quot;</span>, </span><br><span class="line">    <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">&quot;job&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210419234430.png" alt="image-20210419234430358"></p><blockquote><p>可以单独定义 job 的前置后置标签</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">GET employee/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;query_string&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;default_field&quot;</span>: <span class="string">&quot;job&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;java OR Java&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;highlight&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;pre_tags&quot;</span>: <span class="string">&quot;&lt;span&gt;&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;post_tags&quot;</span>: <span class="string">&quot;&lt;/span&gt;&quot;</span>, </span><br><span class="line">    <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">&quot;job&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;pre_tags&quot;</span>: <span class="string">&quot;&lt;em&gt;&quot;</span>,</span><br><span class="line">    	<span class="attr">&quot;post_tags&quot;</span>: <span class="string">&quot;&lt;/em&gt;&quot;</span>, </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="六、Spring-Data-Elasticsearch"><a href="#六、Spring-Data-Elasticsearch" class="headerlink" title="六、Spring Data Elasticsearch"></a>六、Spring Data Elasticsearch</h1><h2 id="6-1、简介"><a href="#6-1、简介" class="headerlink" title="6.1、简介"></a>6.1、简介</h2><blockquote><p>Spring Data Elasticsearch是Spring Data项目下的一个子模块。</p><p>Spring Data的官网：<a target="_blank" rel="noopener" href="http://projects.spring.io/spring-data/">http://projects.spring.io/spring-data/</a></p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421190554.png" alt="image-20210421190546838"></p><blockquote><p>查看 Spring Data Elasticsearch的页面：<a target="_blank" rel="noopener" href="https://projects.spring.io/spring-data-elasticsearch/">https://projects.spring.io/spring-data-elasticsearch/</a></p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421191146.png" alt="image-20210421191146844"></p><p>特征：</p><ul><li>支持Spring的基于<code>@Configuration</code>的java配置方式，或者XML配置方式</li><li>提供了用于操作ES的便捷工具类**<code>ElasticsearchTemplate</code>**。包括实现文档到POJO之间的自动智能映射。</li><li>利用Spring的数据转换服务实现的功能丰富的对象映射</li><li>基于注解的元数据映射方式，而且可扩展以支持更多不同的数据格式</li><li>根据持久层接口自动生成对应实现方法，无需人工编写基本操作代码（类似 <code>mybatis</code>，根据接口自动得到实现）。当然，也支持人工定制查询</li></ul><h2 id="6-2、前期准备"><a href="#6-2、前期准备" class="headerlink" title="6.2、前期准备"></a>6.2、前期准备</h2><h3 id="1、使用-Spring-Initializer-创建一个项目"><a href="#1、使用-Spring-Initializer-创建一个项目" class="headerlink" title="1、使用 Spring Initializer 创建一个项目"></a>1、使用 <code>Spring Initializer</code> 创建一个项目</h3><blockquote><p>pom.xml 文件如下</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.hzx<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2、核心配置文件"><a href="#2、核心配置文件" class="headerlink" title="2、核心配置文件"></a>2、核心配置文件</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">spring-boot-es-demo</span></span><br><span class="line">  <span class="attr">elasticsearch:</span></span><br><span class="line">    <span class="attr">rest:</span></span><br><span class="line">      <span class="attr">uris:</span> <span class="string">http://127.0.0.1:9200</span></span><br></pre></td></tr></table></figure><h3 id="3、创建索引，导入数据"><a href="#3、创建索引，导入数据" class="headerlink" title="3、创建索引，导入数据"></a>3、创建索引，导入数据</h3><blockquote><p>这里以上面的 <code>books</code> 索引及其数据为例。</p></blockquote><h2 id="6-3、实体类及注解"><a href="#6-3、实体类及注解" class="headerlink" title="6.3、实体类及注解"></a>6.3、实体类及注解</h2><h3 id="1、实体类"><a href="#1、实体类" class="headerlink" title="1、实体类"></a>1、实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="keyword">private</span> String publish;</span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、注解"><a href="#2、注解" class="headerlink" title="2、注解"></a>2、注解</h3><blockquote><p>Spring Data 通过注解来声明字段的映射属性，有下面三个注解</p></blockquote><ul><li><code>@Document</code></li></ul><blockquote><p>作用在类上，标记这个实体类为文档对象，一般有下面四个属性</p></blockquote><ol><li><code>indexName</code>：对应 ES 中索引库的名称</li><li><code>type</code>：对应在索引库中的类型，在 ES 7后，这个属性已过时，因为 ES 7中只有一个类型，即 <code>doc</code></li><li><code>shards</code>：分片数量，默认5</li><li><code>replicas</code>：副本数量，默认1</li></ol><ul><li><code>@Id</code></li></ul><blockquote><p>作用在成员变量，标记一个字段作为id主键</p></blockquote><ul><li><code>@Field</code></li></ul><blockquote><p>作用在成员变量，标记为文档的字段，并指定字段映射属性</p></blockquote><ol><li>type：字段类型，取值是枚举：<code>FieldType</code></li><li>index：是否索引，布尔类型，默认是true</li><li>store：是否存储，布尔类型，默认是false</li><li>analyzer：分词器名称：<code>ik_max_word</code>，也可以是 <code>ik_smart</code></li></ol><h3 id="3、完整实体类"><a href="#3、完整实体类" class="headerlink" title="3、完整实体类"></a>3、完整实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Document(indexName = &quot;book&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Field(type = FieldType.Keyword,analyzer = &quot;ik_max_word&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String author;</span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text,analyzer = &quot;ik_max_word&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String info;</span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text,analyzer = &quot;ik_max_word&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text,analyzer = &quot;ik_max_word&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="meta">@Field(type = FieldType.Text,analyzer = &quot;ik_max_word&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String publish;</span><br><span class="line">    <span class="meta">@Field(type = FieldType.Double)</span></span><br><span class="line">    <span class="keyword">private</span> Double price;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="6-4、在测试类中使用-ElasticsearchRestTemplate-进行索引操作"><a href="#6-4、在测试类中使用-ElasticsearchRestTemplate-进行索引操作" class="headerlink" title="6.4、在测试类中使用 ElasticsearchRestTemplate 进行索引操作"></a>6.4、在测试类中使用 <code>ElasticsearchRestTemplate</code> 进行索引操作</h2><h3 id="1、说明"><a href="#1、说明" class="headerlink" title="1、说明"></a>1、说明</h3><blockquote><p>在新版本的 Spring Data Elasticsearch 中，<code>ElasticsearchTemplate</code> 已被弃用，我们可以使用 <code>ElasticsearchRestTemplate</code> 操作索引。</p></blockquote><h3 id="2、创建索引及映射"><a href="#2、创建索引及映射" class="headerlink" title="2、创建索引及映射"></a>2、创建索引及映射</h3><blockquote><p><code>ElasticsearchTemplate</code> 中创建索引与映射关系的方法已经过时，查看 <code>ElasticsearchTemplate</code> 源码可以找到替代方法</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421211746.png" alt="image-20210421211742915"></p><blockquote><p>进入 <code>IndexOperations</code> 接口，可以看到方法如下</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421211843.png" alt="image-20210421211843649"></p><blockquote><p>创建索引映射，使用 <code>IndexOperations</code> 接口中的 <code>createMapping</code> 方法</p></blockquote><ul><li>通过与该 <code>IndexOperations</code> 接口绑定的实体类创建</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates the index mapping for the entity this IndexOperations is bound to.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mapping object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Document <span class="title">createMapping</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><ul><li>在创建 <code>IndexOperations</code> 对象时进行实体类绑定</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IndexOperations indexOperations = elasticsearchRestTemplate.indexOps(Book.class);</span><br></pre></td></tr></table></figure><ul><li>传入一个实体类的 class 属性进行创建</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates the index mapping for the given class</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> clazz the clazz to create a mapping for</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> mapping object</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Document <span class="title">createMapping</span><span class="params">(Class&lt;?&gt; clazz)</span></span>;</span><br></pre></td></tr></table></figure><ul><li>创建索引的方法，直接使用 <code>IndexOperations</code> 的 create 方法即可。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">indexOperations.create();</span><br></pre></td></tr></table></figure><blockquote><p>测试</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    IndexOperations indexOperations = elasticsearchRestTemplate.indexOps(Book.class);</span><br><span class="line">    <span class="comment">// 创建/更新索引</span></span><br><span class="line">    System.out.println(indexOperations.createMapping());</span><br><span class="line">    System.out.println(indexOperations.create());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">MapDocument@?#? </span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;author&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;info&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;publish&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;price&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;double&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">true</span><br></pre></td></tr></table></figure><blockquote><p>此时在 <code>kibana</code> 中看到了新创建的索引</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421213320.png" alt="image-20210421213319788"></p><h3 id="3、判断索引是否存在"><a href="#3、判断索引是否存在" class="headerlink" title="3、判断索引是否存在"></a>3、判断索引是否存在</h3><blockquote><p>方法同样存在于 <code>IndexOperations</code> 接口中</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Checks if the index this IndexOperations is bound to exists</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@literal</span> true&#125; if the index exists</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">exists</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><blockquote><p>测试</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createExist</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    IndexOperations indexOperations = elasticsearchRestTemplate.indexOps(Book.class);</span><br><span class="line">    System.out.println(<span class="string">&quot;book 索引是否存在：&quot;</span> + indexOperations.exists());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421213616.png" alt="image-20210421213616776"></p><h3 id="4、删除索引"><a href="#4、删除索引" class="headerlink" title="4、删除索引"></a>4、删除索引</h3><blockquote><p>方法存在于 <code>IndexOperations</code> 接口中，删除与该 <code>IndexOperations</code> 接口绑定的实体类对应的索引。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Deletes the index this &#123;<span class="doctag">@link</span> IndexOperations&#125; is bound to</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@literal</span> true&#125; if the index was deleted</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">delete</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><blockquote><p>测试</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createExist</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IndexOperations indexOperations = elasticsearchRestTemplate.indexOps(Book.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;book 索引是否存在：&quot;</span> + indexOperations.exists());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421214056.png" alt="image-20210421214055808"></p><h2 id="6-5、创建接口己成-ElasticsearchRepository-实现文档操作"><a href="#6-5、创建接口己成-ElasticsearchRepository-实现文档操作" class="headerlink" title="6.5、创建接口己成 ElasticsearchRepository 实现文档操作"></a>6.5、创建接口己成 <code>ElasticsearchRepository</code> 实现文档操作</h2><blockquote><p>我们需要定义一个 接口，这个接口继承 <code>ElasticsearchRepository</code>，然后就可以实现对文档的基础 CRUD 操作</p><p><code>ElasticsearchRepository</code> 中有两个泛型，第一个为操作的实体类，第二个为实体类主键 ID 类型</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421215119.png" alt="image-20210421215119613"></p><h3 id="1、创建一个接口继承-ElasticsearchRepository"><a href="#1、创建一个接口继承-ElasticsearchRepository" class="headerlink" title="1、创建一个接口继承  ElasticsearchRepository"></a>1、创建一个接口继承 <code>ElasticsearchRepository</code></h3><blockquote><p>这样我们就获得了对文档进行基础 CRUD 的功能</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookRepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Book</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、测试插入文档数据"><a href="#2、测试插入文档数据" class="headerlink" title="2、测试插入文档数据"></a>2、测试插入文档数据</h3><blockquote><p>使用 <code>ElasticsearchRepository</code> 接口中的 <code>save</code> 方法</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421220556.png" alt="image-20210421220556118"></p><blockquote><p>测试</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testAddDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Book book = <span class="keyword">new</span> Book();</span><br><span class="line">    book.setId(<span class="number">1L</span>)</span><br><span class="line">        .setAuthor(<span class="string">&quot;罗贯中&quot;</span>)</span><br><span class="line">        .setInfo(<span class="string">&quot;《三国演义》是中国文学史上第一部章回小说，是历史演义小说的开山之作，也是第一部文人长篇小说，被列为中国古典四大名著和六大名著之一。明清时期甚至有“第一才子书”之称。&quot;</span>)</span><br><span class="line">        .setPrice(<span class="number">28.90</span>)</span><br><span class="line">        .setType(<span class="string">&quot;古典小说&quot;</span>)</span><br><span class="line">        .setPublish(<span class="string">&quot;广东工业大学出版社&quot;</span>)</span><br><span class="line">        .setName(<span class="string">&quot;三国演义&quot;</span>);</span><br><span class="line">    bookRepository.save(book);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421221429.png" alt="image-20210421221429428"></p><h3 id="3、测试更新文档信息"><a href="#3、测试更新文档信息" class="headerlink" title="3、测试更新文档信息"></a>3、测试更新文档信息</h3><blockquote><p>同样使用 save 方法，当一条数据在索引中已经存在时，再次调用 save 方法即为更新</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testUpdateDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Book book = <span class="keyword">new</span> Book();</span><br><span class="line">    book.setId(<span class="number">1L</span>)</span><br><span class="line">            .setAuthor(<span class="string">&quot;罗贯中&quot;</span>)</span><br><span class="line">            .setInfo(<span class="string">&quot;《三国演义》是中国文学史上第一部章回小说，是历史演义小说的开山之作，也是第一部文人长篇小说，被列为中国古典四大名著和六大名著之一。明清时期甚至有“第一才子书”之称。&quot;</span>)</span><br><span class="line">            .setPrice(<span class="number">128.90</span>)</span><br><span class="line">            .setType(<span class="string">&quot;古典小说&quot;</span>)</span><br><span class="line">            .setPublish(<span class="string">&quot;广东工业大学出版社&quot;</span>)</span><br><span class="line">            .setName(<span class="string">&quot;《三国演义》&quot;</span>);</span><br><span class="line">    bookRepository.save(book);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>查看结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421222656.png" alt="image-20210421222656611"></p><h3 id="4、删除文档"><a href="#4、删除文档" class="headerlink" title="4、删除文档"></a>4、删除文档</h3><blockquote><p>有两个方法</p></blockquote><ol><li>传入待删除的文档对象 id</li><li>传入待删除文档对象</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Deletes the entity with the given id.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> id must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException in case the given &#123;<span class="doctag">@literal</span> id&#125; is &#123;<span class="doctag">@literal</span> null&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deleteById</span><span class="params">(ID id)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Deletes a given entity.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> entity must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException in case the given entity is &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">(T entity)</span></span>;</span><br></pre></td></tr></table></figure><blockquote><p>删除 id 为一的文档对象</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testDeleteDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    bookRepository.deleteById(<span class="number">1L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果，此时索引中不存在任何数据</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421223504.png" alt="image-20210421223504056"></p><h3 id="5、批量插入"><a href="#5、批量插入" class="headerlink" title="5、批量插入"></a>5、批量插入</h3><blockquote><p>使用 <code>ElasticsearchRepository</code> 接口中的 <code>saveAll</code> 方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Saves all given entities.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> entities must not be &#123;<span class="doctag">@literal</span> null&#125; nor must it contain &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the saved entities; will never be &#123;<span class="doctag">@literal</span> null&#125;. The returned &#123;<span class="doctag">@literal</span> Iterable&#125; will have the same size</span></span><br><span class="line"><span class="comment"> *         as the &#123;<span class="doctag">@literal</span> Iterable&#125; passed as an argument.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalArgumentException in case the given &#123;<span class="doctag">@link</span> Iterable entities&#125; or one of its entities is</span></span><br><span class="line"><span class="comment"> *           &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&lt;S extends T&gt; <span class="function">Iterable&lt;S&gt; <span class="title">saveAll</span><span class="params">(Iterable&lt;S&gt; entities)</span></span>;</span><br></pre></td></tr></table></figure><blockquote><p>进行批量插入</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testBatchInsertDocument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Book book = <span class="keyword">new</span> Book();</span><br><span class="line">    book.setId(<span class="number">1L</span>)</span><br><span class="line">            .setAuthor(<span class="string">&quot;罗贯中&quot;</span>)</span><br><span class="line">            .setInfo(<span class="string">&quot;《三国演义》是中国文学史上第一部章回小说，是历史演义小说的开山之作，也是第一部文人长篇小说，被列为中国古典四大名著和六大名著之一。明清时期甚至有“第一才子书”之称。&quot;</span>)</span><br><span class="line">            .setPrice(<span class="number">28.90</span>)</span><br><span class="line">            .setType(<span class="string">&quot;古典小说&quot;</span>)</span><br><span class="line">            .setPublish(<span class="string">&quot;广东工业大学出版社&quot;</span>)</span><br><span class="line">            .setName(<span class="string">&quot;三国演义&quot;</span>);</span><br><span class="line">    Book book2 = <span class="keyword">new</span> Book();</span><br><span class="line">    book2.setId(<span class="number">2L</span>)</span><br><span class="line">            .setAuthor(<span class="string">&quot;罗贯中123&quot;</span>)</span><br><span class="line">            .setInfo(<span class="string">&quot;《三国演义》是中国文学史上第一部章回小说，是历史演义小说的开山之作，也是第一部文人长篇小说，被列为中国古典四大名著和六大名著之一。明清时期甚至有“第一才子书”之称。&quot;</span>)</span><br><span class="line">            .setPrice(<span class="number">1128.90</span>)</span><br><span class="line">            .setType(<span class="string">&quot;古典小说&quot;</span>)</span><br><span class="line">            .setPublish(<span class="string">&quot;广东工业大学出版社&quot;</span>)</span><br><span class="line">            .setName(<span class="string">&quot;《三国演义》&quot;</span>);</span><br><span class="line">    List&lt;Book&gt; list = <span class="keyword">new</span> ArrayList();</span><br><span class="line">    list.add(book);</span><br><span class="line">    list.add(book2);</span><br><span class="line">    bookRepository.saveAll(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421225136.png" alt="image-20210421225136184"></p><h2 id="6-6、数据查询"><a href="#6-6、数据查询" class="headerlink" title="6.6、数据查询"></a>6.6、数据查询</h2><h3 id="1、根据-id-查询一个文档对象"><a href="#1、根据-id-查询一个文档对象" class="headerlink" title="1、根据 id 查询一个文档对象"></a>1、根据 id 查询一个文档对象</h3><blockquote><p>使用 <code>ElasticsearchRepository</code> 的 <code>findById</code> 方法，该方法返回一个 <code>Optional</code> 对象，<code>Optional</code> 类中存在一个 value 属性，就是我们要获取的文档对象，可以通过 <code>Optional</code> 对象的 get 方法获取</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421225841.png" alt="image-20210421225841544"></p><blockquote><p>测试</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testFindById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Optional&lt;Book&gt; book = bookRepository.findById(<span class="number">1L</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;获取到的对象为：&quot;</span> + book.get());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>查看结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421230126.png" alt="image-20210421230126598"></p><h3 id="2、自定义方法"><a href="#2、自定义方法" class="headerlink" title="2、自定义方法"></a>2、自定义方法</h3><blockquote><p>Spring Data 的另一个强大功能，是根据方法名称自动实现功能。</p><p>比如：你的方法名叫做：<code>findByTitle</code>，那么它就知道你是根据title查询，然后自动帮你完成，无需写实现类。</p><p>当然，方法名称要符合一定的约定：</p></blockquote><table><thead><tr><th>Keyword</th><th>Sample</th><th>Elasticsearch Query String</th></tr></thead><tbody><tr><td><code>And</code></td><td><code>findByNameAndPrice</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;price&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;</code></td></tr><tr><td><code>Or</code></td><td><code>findByNameOrPrice</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;should&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;price&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;</code></td></tr><tr><td><code>Is</code></td><td><code>findByName</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>Not</code></td><td><code>findByNameNot</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must_not&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>Between</code></td><td><code>findByPriceBetween</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>LessThanEqual</code></td><td><code>findByPriceLessThan</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : null,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>GreaterThanEqual</code></td><td><code>findByPriceGreaterThan</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : null,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>Before</code></td><td><code>findByPriceBefore</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : null,&quot;to&quot; : ?,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>After</code></td><td><code>findByPriceAfter</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;range&quot; : &#123;&quot;price&quot; : &#123;&quot;from&quot; : ?,&quot;to&quot; : null,&quot;include_lower&quot; : true,&quot;include_upper&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>Like</code></td><td><code>findByNameLike</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;?*&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>StartingWith</code></td><td><code>findByNameStartingWith</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;?*&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>EndingWith</code></td><td><code>findByNameEndingWith</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;*?&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>Contains/Containing</code></td><td><code>findByNameContaining</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &#123;&quot;query&quot; : &quot;**?**&quot;,&quot;analyze_wildcard&quot; : true&#125;&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>In</code></td><td><code>findByNameIn(Collection&lt;String&gt;names)</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;bool&quot; : &#123;&quot;should&quot; : [ &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;, &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125; ]&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>NotIn</code></td><td><code>findByNameNotIn(Collection&lt;String&gt;names)</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must_not&quot; : &#123;&quot;bool&quot; : &#123;&quot;should&quot; : &#123;&quot;field&quot; : &#123;&quot;name&quot; : &quot;?&quot;&#125;&#125;&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>Near</code></td><td><code>findByStoreNear</code></td><td><code>Not Supported Yet !</code></td></tr><tr><td><code>True</code></td><td><code>findByAvailableTrue</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : true&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>False</code></td><td><code>findByAvailableFalse</code></td><td><code>&#123;&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : false&#125;&#125;&#125;&#125;</code></td></tr><tr><td><code>OrderBy</code></td><td><code>findByAvailableTrueOrderByNameDesc</code></td><td><code>&#123;&quot;sort&quot; : [&#123; &quot;name&quot; : &#123;&quot;order&quot; : &quot;desc&quot;&#125; &#125;],&quot;bool&quot; : &#123;&quot;must&quot; : &#123;&quot;field&quot; : &#123;&quot;available&quot; : true&#125;&#125;&#125;&#125;</code></td></tr></tbody></table><blockquote><p>修改实体类中的索引为 <code>books</code>，在我们自定义的接口中编写一个根据价格排序的方法声明</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookRepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Book</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">List&lt;Book&gt; <span class="title">findByOrderByPriceDesc</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>编写一个测试方法，获取所有书籍，根据价格排序</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testFindOrderByPriceDesc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Book&gt; books = bookRepository.findByOrderByPriceDesc();</span><br><span class="line">    books.forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果（局部）</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421232224.png" alt="image-20210421232223882"></p><ul><li>编写一个方法，返回价格在 100-200 之间的所有书籍</li></ul><blockquote><p><code>BookRepository</code></p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BookRepository</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Book</span>,<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">List&lt;Book&gt; <span class="title">findByPriceBetween</span><span class="params">(Double from,Double to)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>测试方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testFindPriceBetween</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;Book&gt; books = bookRepository.findByPriceBetween(<span class="number">100.0</span>,<span class="number">200.0</span>);</span><br><span class="line">    books.stream().map(Book::getPrice).collect(Collectors.toList()).forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>查看结果，这里只输出价格</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421233102.png" alt="image-20210421233102615"></p><h2 id="6-7、高级查询"><a href="#6-7、高级查询" class="headerlink" title="6.7、高级查询"></a>6.7、高级查询</h2><blockquote><p>虽然基本查询和自定义方法已经很强大了，但是如果是复杂查询（模糊、通配符、词条查询等）就显得力不从心了。此时，我们只能使用原生查询。</p><p>需要 <code>ElasticsearchRestTemplate</code> 对象的 search 方法和 <code>QueryBuilders</code> 对象配合使用</p></blockquote><h3 id="1、QueryBuilders"><a href="#1、QueryBuilders" class="headerlink" title="1、QueryBuilders"></a>1、<code>QueryBuilders</code></h3><blockquote><p><code>QueryBuilders</code> 提供了大量的静态方法，用于生成各种不同类型的查询对象，例如：词条、模糊、通配符等 <code>QueryBuilder</code> 对象。</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210421234733.png" alt="image-20210421234732846"></p><ol><li>构建一个 <code>NativeSearchQueryBuilder</code> 对象</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NativeSearchQueryBuilder queryBuilder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br></pre></td></tr></table></figure><ol start="2"><li>调用构造的 <code>NativeSearchQueryBuilder</code> 对象的 <code>withQuery</code> 方法，这个方法接收一个 <code>QueryBuilder</code> 对象，这个<code>QueryBuilder</code> 对象可以通过<code>QueryBuilders</code> 的静态方法获取。</li></ol><h3 id="2、使用-match-all-查询全部"><a href="#2、使用-match-all-查询全部" class="headerlink" title="2、使用 match_all 查询全部"></a>2、使用 <code>match_all</code> 查询全部</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testMatchAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    NativeSearchQueryBuilder queryBuilder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">    queryBuilder.withQuery(QueryBuilders.matchAllQuery());</span><br><span class="line">    SearchHits&lt;Book&gt; hits = elasticsearchRestTemplate.search(queryBuilder.build(), Book.class);</span><br><span class="line">    List&lt;Book&gt; books = hits.stream().map(SearchHit::getContent).collect(Collectors.toList());</span><br><span class="line">    System.out.println(books.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210422111221.png" alt="image-20210422111218219"></p><h3 id="3、使用-match-进行查询，查询书名中含有-“无机”-和-“化学”-的书名"><a href="#3、使用-match-进行查询，查询书名中含有-“无机”-和-“化学”-的书名" class="headerlink" title="3、使用 match 进行查询，查询书名中含有 “无机” 和 “化学” 的书名"></a>3、使用 match 进行查询，查询书名中含有 “无机” 和 “化学” 的书名</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testMatch</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    NativeSearchQueryBuilder queryBuilder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">    <span class="comment">//queryBuilder.withQuery(QueryBuilders.matchAllQuery());</span></span><br><span class="line">    queryBuilder.withQuery(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;无机化学&quot;</span>));</span><br><span class="line">    SearchHits&lt;Book&gt; hits = elasticsearchRestTemplate.search(queryBuilder.build(), Book.class);</span><br><span class="line">    List&lt;Book&gt; books = hits.stream().map(SearchHit::getContent).collect(Collectors.toList());</span><br><span class="line">    System.out.println(books.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210422111502.png" alt="image-20210422111502353"></p><h3 id="4、分页查询"><a href="#4、分页查询" class="headerlink" title="4、分页查询"></a>4、分页查询</h3><blockquote><p>使用 <code>NativeSearchQueryBuilder</code> 对象的 <code>withPageable</code> 方法，这个方法要传入 <code>Pageable</code> 对象</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> NativeSearchQueryBuilder <span class="title">withPageable</span><span class="params">(Pageable pageable)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.pageable = pageable;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>这个对象可以使用 <code>PageRequest</code> 对象的 of 方法构造，需要传入 page 和 size</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PageRequest <span class="title">of</span><span class="params">(<span class="keyword">int</span> page, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> of(page, size, Sort.unsorted());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>查询书名中带有 “无机” “化学” 的前十条数据</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testMatchAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    NativeSearchQueryBuilder queryBuilder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">    queryBuilder.withQuery(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;无机化学&quot;</span>))</span><br><span class="line">                .withPageable(PageRequest.of(<span class="number">0</span>,<span class="number">10</span>));</span><br><span class="line">    SearchHits&lt;Book&gt; hits = elasticsearchRestTemplate.search(queryBuilder.build(), Book.class);</span><br><span class="line">    System.out.println(hits.stream().map(SearchHit::getContent).collect(Collectors.toList()).size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210422113636.png" alt="image-20210422113635898"></p><ul><li>指定要查询的字段和不查询的字段</li></ul><blockquote><p>使用 <code>NativeSearchQueryBuilder</code> 对象的 <code>withSourceFilter</code> 方法，这个方法需要传入一个 <code>FetchSourceFilter</code> 对象，这个对象需要传入两个字符串数组，分别为要返回的属性数组和排除的属性数组</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210422114022.png" alt="image-20210422114022430"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    NativeSearchQueryBuilder queryBuilder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">    <span class="comment">//queryBuilder.withQuery(QueryBuilders.matchAllQuery());</span></span><br><span class="line">    String[] includes = &#123;<span class="string">&quot;name&quot;</span>,<span class="string">&quot;price&quot;</span>,<span class="string">&quot;author&quot;</span>&#125;;</span><br><span class="line">    String[] excludes = &#123;&#125;;</span><br><span class="line">    queryBuilder.withSourceFilter(<span class="keyword">new</span> FetchSourceFilter(includes,excludes))</span><br><span class="line">                .withQuery(QueryBuilders.matchQuery(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;无机化学&quot;</span>))</span><br><span class="line">                .withPageable(PageRequest.of(<span class="number">0</span>,<span class="number">10</span>));</span><br><span class="line">    SearchHits&lt;Book&gt; hits = elasticsearchRestTemplate.search(queryBuilder.build(), Book.class);</span><br><span class="line">    hits.stream().map(SearchHit::getContent).collect(Collectors.toList()).forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果，可以看到只返回了 <code>includes</code> 数组中的属性</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210422114457.png" alt="image-20210422114457537"></p><h3 id="5、范围匹配"><a href="#5、范围匹配" class="headerlink" title="5、范围匹配"></a>5、范围匹配</h3><blockquote><p>使用 <code>NativeSearchQueryBuilder</code> 对象的 <code>withQuery</code> 方法，需要传入一个 <code>RangeQueryBuilder</code> 对象。</p></blockquote><ol><li><p>使用 <code>gte</code>/ <code>gt</code> 方法指定下界</p></li><li><p>使用 <code>lte</code> / <code>lt</code>方法指定上界</p></li></ol><blockquote><p>上面两个方法可以配合使用</p></blockquote><ol start="3"><li>使用 <code>from</code> 方法指定下界， <code>to</code> 方法指定上界</li></ol><blockquote><p>上面两个方法只能指定选择一个使用。</p></blockquote><ul><li>查询价格在 100.0 - 200.0 的书籍</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testRangeQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    NativeSearchQueryBuilder queryBuilder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">    String[] includes = &#123;<span class="string">&quot;name&quot;</span>,<span class="string">&quot;price&quot;</span>,<span class="string">&quot;author&quot;</span>&#125;;</span><br><span class="line">    String[] excludes = &#123;&#125;;</span><br><span class="line">    queryBuilder.withQuery(QueryBuilders.rangeQuery(<span class="string">&quot;price&quot;</span>).gte(<span class="number">100.0</span>).lte(<span class="number">200.0</span>))</span><br><span class="line">                .withSourceFilter(<span class="keyword">new</span> FetchSourceFilter(includes,excludes));</span><br><span class="line">    elasticsearchRestTemplate.search(queryBuilder.build(),Book.class).stream().map(SearchHit::getContent).collect(Collectors.toList()).forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210422144148.png" alt="image-20210422144141487"></p><h3 id="6、结果排序"><a href="#6、结果排序" class="headerlink" title="6、结果排序"></a>6、结果排序</h3><blockquote><p>使用 <code>NativeSearchQueryBuilder</code> 对象的 <code>withSort</code> 方法，需要传入一个 <code>SortBuilder</code> 对象。</p><p><code>SortBuilders.fieldSort</code> 表示根据属性排序，这里根据 price 排序，order 方法中传入一个枚举对象，这里 <code>SortOrder.DESC</code> 指降序排序。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testSortQuery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    NativeSearchQueryBuilder queryBuilder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">    String[] includes = &#123;<span class="string">&quot;name&quot;</span>,<span class="string">&quot;price&quot;</span>,<span class="string">&quot;author&quot;</span>&#125;;</span><br><span class="line">    String[] excludes = &#123;&#125;;</span><br><span class="line">    queryBuilder.withSort(SortBuilders.fieldSort(<span class="string">&quot;price&quot;</span>).order(SortOrder.DESC))</span><br><span class="line">                .withPageable(PageRequest.of(<span class="number">0</span>,<span class="number">10</span>))</span><br><span class="line">                .withSourceFilter(<span class="keyword">new</span> FetchSourceFilter(includes,excludes));</span><br><span class="line">    elasticsearchRestTemplate.search(queryBuilder.build(),Book.class).stream().map(SearchHit::getContent).collect(Collectors.toList()).forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210422145554.png" alt="image-20210422145553852"></p><h2 id="6-8、聚合查询"><a href="#6-8、聚合查询" class="headerlink" title="6.8、聚合查询"></a>6.8、聚合查询</h2><h3 id="1、聚合为桶"><a href="#1、聚合为桶" class="headerlink" title="1、聚合为桶"></a>1、聚合为桶</h3><blockquote><p>桶就是分组，比如这里我们按照出版社 <code>price</code> 进行分组：</p></blockquote><ol><li>terms 方法中传入聚合的名称，field 指定要进行桶分组的属性</li><li>使用 <code>withSourceFilter</code> 过滤所有普通结果，当 <code>includes</code> 为空数组时，不返回任何结果</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testAgg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String[] includes = &#123;&#125;;</span><br><span class="line">    NativeSearchQueryBuilder queryBuilder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">    queryBuilder.addAggregation(AggregationBuilders.terms(<span class="string">&quot;price_info&quot;</span>).field(<span class="string">&quot;price&quot;</span>));</span><br><span class="line">    queryBuilder.withSourceFilter(<span class="keyword">new</span> FetchSourceFilter(includes,<span class="keyword">null</span>));</span><br><span class="line">    SearchHits&lt;Book&gt; search = elasticsearchRestTemplate.search(queryBuilder.build(), Book.class);</span><br><span class="line">    Terms terms = (Terms) search.getAggregations().asMap().get(<span class="string">&quot;price_info&quot;</span>);</span><br><span class="line">    List&lt;? extends Terms.Bucket&gt; buckets = terms.getBuckets();</span><br><span class="line">    buckets.forEach(bucket -&gt; &#123;</span><br><span class="line">        System.out.println(bucket.getKeyAsString());</span><br><span class="line">        System.out.println(bucket.getDocCount());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>结果</p></blockquote><p><img src="/img/loading.gif" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210422152439.png" alt="image-20210422152439646"></p><h3 id="2、嵌套聚合"><a href="#2、嵌套聚合" class="headerlink" title="2、嵌套聚合"></a>2、嵌套聚合</h3><blockquote><p>使用 <code>subAggregation</code> 添加子聚合</p><p>然后在遍历中解析子聚合</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">testAgg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String[] includes = &#123;&#125;;</span><br><span class="line">    NativeSearchQueryBuilder queryBuilder = <span class="keyword">new</span> NativeSearchQueryBuilder();</span><br><span class="line">    queryBuilder.addAggregation(AggregationBuilders.terms(<span class="string">&quot;price_info&quot;</span>).field(<span class="string">&quot;price&quot;</span>)</span><br><span class="line">                .subAggregation(AggregationBuilders.avg(<span class="string">&quot;price_avg&quot;</span>)).field(<span class="string">&quot;price&quot;</span>));</span><br><span class="line">    queryBuilder.withSourceFilter(<span class="keyword">new</span> FetchSourceFilter(includes,<span class="keyword">null</span>));</span><br><span class="line">    SearchHits&lt;Book&gt; search = elasticsearchRestTemplate.search(queryBuilder.build(), Book.class);</span><br><span class="line">    Terms terms = (Terms) search.getAggregations().asMap().get(<span class="string">&quot;price_info&quot;</span>);</span><br><span class="line">    List&lt;? extends Terms.Bucket&gt; buckets = terms.getBuckets();</span><br><span class="line">    buckets.forEach(bucket -&gt; &#123;</span><br><span class="line">        System.out.println(bucket.getKeyAsString());</span><br><span class="line">        System.out.println(bucket.getDocCount());</span><br><span class="line">        <span class="comment">// 解析子聚合</span></span><br><span class="line">        Map&lt;String, Aggregation&gt; aggregationMap = bucket.getAggregations().asMap();</span><br><span class="line">        InternalAvg priceAvg = (InternalAvg)aggregationMap.get(<span class="string">&quot;price_avg&quot;</span>);</span><br><span class="line">        System.out.println(priceAvg.getValue());</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__title"><span class="post-copyright-info"><h>Elasticsearch学习笔记</h></span></div><div class="post-copyright__type"><span class="post-copyright-info"><a href="https://sutianxin.top/posts/1248502301.html">https://sutianxin.top/posts/1248502301.html</a></span></div><div class="post-copyright-m"><div class="post-copyright-m-info"><div class="post-copyright-a" style="display:inline-block;width:120px"><h>作者</h><div class="post-copyright-cc-info"><h>天昕</h></div></div><div class="post-copyright-c" style="display:inline-block;width:120px"><h>发布于</h><div class="post-copyright-cc-info"><h>2021-04-22</h></div></div><div class="post-copyright-u" style="display:inline-block;width:120px"><h>更新于</h><div class="post-copyright-cc-info"><h>2021-04-22</h></div></div><div class="post-copyright-c" style="display:inline-block;width:120px"><h>许可协议</h><div class="post-copyright-cc-info"><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a rel="noopener" target="_blank" title="CC BY 4.0" href="https://creativecommons.org/licenses/by/4.0/deed.zh">CC BY 4.0</a></div></div></div></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E2%98%95Java/">☕Java</a><a class="post-meta__tags" href="/tags/%F0%9F%92%BB%E5%90%8E%E7%AB%AF%E5%AD%A6%E4%B9%A0/">💻后端学习</a><a class="post-meta__tags" href="/tags/%F0%9F%91%A2Spring-Boot/">👢Spring Boot</a></div><div class="post_share"><div class="social-share" data-image="https://gitee.com/sutianxin/photo/raw/master/20210422155614.jpg" data-sites="wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/2238630669.html"><img class="prev-cover" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210423233706.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Java基础学习（三）-集合学习</div></div></a></div><div class="next-post pull-right"><a href="/posts/1245529498.html"><img class="next-cover" data-lazy-src="https://gitee.com/sutianxin/photo/raw/master/20210418172927.jpg" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Docker学习笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/2938255980.html" title="Java应用学习（二）-Springboot整合swagger/swagger-Bootstrap-UI使用"><img class="cover" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210208120213.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-12</div><div class="title">Java应用学习（二）-Springboot整合swagger/swagger-Bootstrap-UI使用</div></div></a></div><div><a href="/posts/2863462089.html" title="Spring Cloud学习（二）-OpenFeign微服务调用"><img class="cover" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210211212103.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-11</div><div class="title">Spring Cloud学习（二）-OpenFeign微服务调用</div></div></a></div><div><a href="/posts/995752607.html" title="Spring Cloud学习（四）-Eureka服务注册中心"><img class="cover" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210214225250.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-14</div><div class="title">Spring Cloud学习（四）-Eureka服务注册中心</div></div></a></div><div><a href="/posts/650479038.html" title="在线教育项目总结（二）-用户认证"><img class="cover" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210205204706.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-05</div><div class="title">在线教育项目总结（二）-用户认证</div></div></a></div><div><a href="/posts/4109687940.html" title="在线教育项目总结（四）-使用递归查询嵌套列表和删除嵌套列表"><img class="cover" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210210223743.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-10</div><div class="title">在线教育项目总结（四）-使用递归查询嵌套列表和删除嵌套列表</div></div></a></div><div><a href="/posts/3410178450.html" title="数据结构与算法学习（五）-雪花算法生成唯一ID"><img class="cover" data-lazy-src="https://gitee.com/sutianxin/my-hexo-blog-photo/raw/master/20210217153355.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-02-17</div><div class="title">数据结构与算法学习（五）-雪花算法生成唯一ID</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81Elasticsearch-%E6%A6%82%E8%BF%B0"><span class="toc-text">一、Elasticsearch 概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1%E3%80%81Elasticsearch-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">1.1、Elasticsearch 是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2%E3%80%81%E5%85%A8%E6%96%87%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E"><span class="toc-text">1.2、全文搜索引擎</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3%E3%80%81Elasticsearch-And-Solr"><span class="toc-text">1.3、Elasticsearch And Solr</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4%E3%80%81ES-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.4、ES 核心概念介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E9%9B%86%E7%BE%A4%EF%BC%88Cluster%EF%BC%89"><span class="toc-text">1、集群（Cluster）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%8A%82%E7%82%B9%EF%BC%88Node%EF%BC%89"><span class="toc-text">2、节点（Node）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E7%B4%A2%E5%BC%95%EF%BC%88Index%EF%BC%89"><span class="toc-text">3、索引（Index）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E7%B1%BB%E5%9E%8B%EF%BC%88Type%EF%BC%89"><span class="toc-text">4、类型（Type）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%96%87%E6%A1%A3%EF%BC%88Document%EF%BC%89"><span class="toc-text">5、文档（Document）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E5%88%86%E7%89%87%EF%BC%88Shards%EF%BC%89"><span class="toc-text">6、分片（Shards）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E5%89%AF%E6%9C%AC%EF%BC%88Replicas%EF%BC%89"><span class="toc-text">7、副本（Replicas）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81Settings"><span class="toc-text">8、Settings</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81Mapping"><span class="toc-text">9、Mapping</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81Analyzer-%E5%92%8C-Analysis"><span class="toc-text">10、Analyzer 和 Analysis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11%E3%80%81%E7%B1%BB%E6%AF%94"><span class="toc-text">11、类比</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-5%E3%80%81%E6%AD%A3%E6%8E%92%E7%B4%A2%E5%BC%95%E5%92%8C%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-text">1.5、正排索引和倒排索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%AD%A3%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-text">1、正排索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%80%92%E6%8E%92%E7%B4%A2%E5%BC%95"><span class="toc-text">2、倒排索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-6%E3%80%81%E7%B4%A2%E5%BC%95%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-text">1.6、索引基本操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%EF%BC%88PUT-%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="toc-text">1、创建索引（PUT 请求）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%8E%B7%E5%8F%96-shopping-%E7%B4%A2%E5%BC%95%E4%BF%A1%E6%81%AF%EF%BC%88GET-%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="toc-text">2、获取 shopping 索引信息（GET 请求）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E6%89%80%E6%9C%89%E7%B4%A2%E5%BC%95%E4%BF%A1%E6%81%AF%EF%BC%88GET-%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="toc-text">3、获取当前所有索引信息（GET 请求）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%88%A0%E9%99%A4%E5%8D%95%E4%B8%AA%E7%B4%A2%E5%BC%95%EF%BC%88DELETE-%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="toc-text">4、删除单个索引（DELETE 请求）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-7%E3%80%81%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="toc-text">1.7、文档操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3%EF%BC%88POST-%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="toc-text">1、创建文档（POST 请求）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%9C%A8%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3%E6%97%B6%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%87%E6%A1%A3-id%EF%BC%88POST-%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="toc-text">2、在创建文档时自定义文档 id（POST 请求）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%A0%B9%E6%8D%AE-id-%E8%8E%B7%E5%8F%96%E6%96%87%E6%A1%A3%E5%AF%B9%E8%B1%A1%EF%BC%88GET-%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="toc-text">3、根据 id 获取文档对象（GET 请求）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%9F%A5%E8%AF%A2%E7%B4%A2%E5%BC%95%E4%B8%8B%E7%9A%84%E6%89%80%E6%9C%89%E6%96%87%E6%A1%A3%E5%AF%B9%E8%B1%A1%EF%BC%88GET-%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="toc-text">4、查询索引下的所有文档对象（GET 请求）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%96%87%E6%A1%A3%E7%9A%84%E5%85%A8%E9%87%8F%E4%BF%AE%E6%94%B9%EF%BC%88PUT-%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="toc-text">5、文档的全量修改（PUT 请求）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%96%87%E6%A1%A3%E7%9A%84%E5%B1%80%E9%83%A8%E4%BF%AE%E6%94%B9%EF%BC%88POST-%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="toc-text">6、文档的局部修改（POST 请求）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E6%96%87%E6%A1%A3%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%A0%E9%99%A4%EF%BC%88DELETE-%E8%AF%B7%E6%B1%82%EF%BC%89"><span class="toc-text">7、文档对象的删除（DELETE 请求）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81ElasticSearch-%E5%88%86%E8%AF%8D%E5%99%A8%E4%BB%8B%E7%BB%8D"><span class="toc-text">二、ElasticSearch 分词器介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1%E3%80%81%E5%86%85%E7%BD%AE%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text">2.1、内置分词器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2%E3%80%81%E4%B8%AD%E6%96%87%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text">2.2、中文分词器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%AE%89%E8%A3%85%E6%96%B9%E5%BC%8F"><span class="toc-text">1、安装方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%B5%8B%E8%AF%95%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-text">2、测试分词器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E6%89%A9%E5%B1%95%E8%AF%8D%E5%BA%93"><span class="toc-text">3、自定义扩展词库</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E5%AD%97%E6%AE%B5%E7%B1%BB%E5%9E%8B"><span class="toc-text">三、字段类型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1%E3%80%81%E6%A0%B8%E5%BF%83%E7%B1%BB%E5%9E%8B"><span class="toc-text">3.1、核心类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B"><span class="toc-text">1、字符串类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%95%B0%E5%AD%97%E7%B1%BB%E5%9E%8B"><span class="toc-text">2、数字类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%97%A5%E6%9C%9F%E7%B1%BB%E5%9E%8B"><span class="toc-text">3、日期类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%B8%83%E5%B0%94%E7%B1%BB%E5%9E%8B"><span class="toc-text">4、布尔类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E4%BA%8C%E8%BF%9B%E5%88%B6%E7%B1%BB%E5%9E%8B"><span class="toc-text">5、二进制类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E8%8C%83%E5%9B%B4%E7%B1%BB%E5%9E%8B"><span class="toc-text">6、范围类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2%E3%80%81%E5%A4%8D%E5%90%88%E7%B1%BB%E5%9E%8B"><span class="toc-text">3.2、复合类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B"><span class="toc-text">1、数组类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B"><span class="toc-text">2、对象类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3%E3%80%81%E5%9C%B0%E7%90%86%E7%B1%BB%E5%9E%8B"><span class="toc-text">3.3、地理类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-text">1、使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81geo-point"><span class="toc-text">2、geo_point</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4%E3%80%81%E7%89%B9%E6%AE%8A%E7%B1%BB%E5%9E%8B"><span class="toc-text">3.4、特殊类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81IP"><span class="toc-text">1、IP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5%E3%80%81Mapping-%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-text">3.5、Mapping 的定义</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%90%9C%E7%B4%A2"><span class="toc-text">四、搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1%E3%80%81%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="toc-text">4.1、前期准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-text">1、创建索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-text">2、导入数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%96%87%E6%A1%A3%E4%BF%9D%E5%AD%98%E4%B8%8E%E6%90%9C%E7%B4%A2"><span class="toc-text">3、文档保存与搜索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2%E3%80%81%E8%AF%8D%E9%A1%B9-%E6%9F%A5%E8%AF%A2"><span class="toc-text">4.2、词项 查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81term"><span class="toc-text">1、term</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81terms"><span class="toc-text">2、terms</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81Constant-Score"><span class="toc-text">3、Constant Score</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81range"><span class="toc-text">4、range</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81wildcard"><span class="toc-text">5、wildcard</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81ids"><span class="toc-text">6、ids</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3%E3%80%81%E5%85%A8%E6%96%87%E6%9F%A5%E8%AF%A2"><span class="toc-text">4.3、全文查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81match-phrase"><span class="toc-text">1、match_phrase</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81multi-match"><span class="toc-text">2、multi_match</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81match"><span class="toc-text">3、match</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4%E3%80%81simple-query-string-%E5%92%8C-query-string"><span class="toc-text">4.4、simple_query_string 和 query_string</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81query-string"><span class="toc-text">1、query_string</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81simple-query-string"><span class="toc-text">2、simple_query_string</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5%E3%80%81fuzzy-%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2"><span class="toc-text">4.5、fuzzy 模糊查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6%E3%80%81%E7%89%B9%E6%AE%8A%E6%9F%A5%E8%AF%A2"><span class="toc-text">4.6、特殊查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81more-like-this"><span class="toc-text">1、more_like_this</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-text">五、聚合查询</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1%E3%80%81ES-%E6%8C%87%E6%A0%87%E8%81%9A%E5%90%88"><span class="toc-text">5.1、ES 指标聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Max-Aggregation"><span class="toc-text">1、Max Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81Min-Aggregation"><span class="toc-text">2、Min Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81Avg-Aggregation"><span class="toc-text">3、Avg Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81Sum-Aggregation"><span class="toc-text">4、Sum Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81Cardinality-Aggregation"><span class="toc-text">5、Cardinality Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81Stats-Aggregation"><span class="toc-text">6、Stats Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81Extends-Stats-Aggregation"><span class="toc-text">7、Extends Stats Aggregation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2%E3%80%81%E6%A1%B6%E8%81%9A%E5%90%88"><span class="toc-text">5.2、桶聚合</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Terms-Aggregation"><span class="toc-text">1、Terms Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81Filter-Aggregation"><span class="toc-text">2、Filter Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81Filters-Aggregation"><span class="toc-text">3、Filters Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81range-Aggregation"><span class="toc-text">4、range Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81Range-Aggregation"><span class="toc-text">5、Range Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81Missing-Aggregation"><span class="toc-text">6、Missing Aggregation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81IP-Range-Aggregation"><span class="toc-text">7、IP Range Aggregation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3%E3%80%81%E8%81%9A%E5%90%88%E8%BF%87%E6%BB%A4%E9%97%AE%E9%A2%98"><span class="toc-text">5.3、聚合过滤问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%9F%A5%E8%AF%A2%E5%B9%B4%E9%BE%84%E5%A4%A7%E4%BA%8E30%E5%B2%81%E7%9A%84%E5%91%98%E5%B7%A5%E7%9A%84%E5%B9%B3%E5%9D%87%E5%B7%A5%E8%B5%84"><span class="toc-text">1、查询年龄大于30岁的员工的平均工资</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%9F%A5%E8%AF%A2Java%E5%91%98%E5%B7%A5%E7%9A%84%E5%B9%B3%E5%9D%87%E5%B7%A5%E8%B5%84"><span class="toc-text">2、查询Java员工的平均工资</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4%E3%80%81%E9%AB%98%E4%BA%AE%E6%98%BE%E7%A4%BA"><span class="toc-text">5.4、高亮显示</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81Spring-Data-Elasticsearch"><span class="toc-text">六、Spring Data Elasticsearch</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1%E3%80%81%E7%AE%80%E4%BB%8B"><span class="toc-text">6.1、简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2%E3%80%81%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87"><span class="toc-text">6.2、前期准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E4%BD%BF%E7%94%A8-Spring-Initializer-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E9%A1%B9%E7%9B%AE"><span class="toc-text">1、使用 Spring Initializer 创建一个项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">2、核心配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%EF%BC%8C%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-text">3、创建索引，导入数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3%E3%80%81%E5%AE%9E%E4%BD%93%E7%B1%BB%E5%8F%8A%E6%B3%A8%E8%A7%A3"><span class="toc-text">6.3、实体类及注解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-text">1、实体类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%B3%A8%E8%A7%A3"><span class="toc-text">2、注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%AE%8C%E6%95%B4%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="toc-text">3、完整实体类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4%E3%80%81%E5%9C%A8%E6%B5%8B%E8%AF%95%E7%B1%BB%E4%B8%AD%E4%BD%BF%E7%94%A8-ElasticsearchRestTemplate-%E8%BF%9B%E8%A1%8C%E7%B4%A2%E5%BC%95%E6%93%8D%E4%BD%9C"><span class="toc-text">6.4、在测试类中使用 ElasticsearchRestTemplate 进行索引操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E8%AF%B4%E6%98%8E"><span class="toc-text">1、说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95%E5%8F%8A%E6%98%A0%E5%B0%84"><span class="toc-text">2、创建索引及映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E5%88%A4%E6%96%AD%E7%B4%A2%E5%BC%95%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-text">3、判断索引是否存在</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="toc-text">4、删除索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-5%E3%80%81%E5%88%9B%E5%BB%BA%E6%8E%A5%E5%8F%A3%E5%B7%B1%E6%88%90-ElasticsearchRepository-%E5%AE%9E%E7%8E%B0%E6%96%87%E6%A1%A3%E6%93%8D%E4%BD%9C"><span class="toc-text">6.5、创建接口己成 ElasticsearchRepository 实现文档操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%8E%A5%E5%8F%A3%E7%BB%A7%E6%89%BF-ElasticsearchRepository"><span class="toc-text">1、创建一个接口继承 ElasticsearchRepository</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%B5%8B%E8%AF%95%E6%8F%92%E5%85%A5%E6%96%87%E6%A1%A3%E6%95%B0%E6%8D%AE"><span class="toc-text">2、测试插入文档数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%B5%8B%E8%AF%95%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3%E4%BF%A1%E6%81%AF"><span class="toc-text">3、测试更新文档信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-text">4、删除文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E6%89%B9%E9%87%8F%E6%8F%92%E5%85%A5"><span class="toc-text">5、批量插入</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-6%E3%80%81%E6%95%B0%E6%8D%AE%E6%9F%A5%E8%AF%A2"><span class="toc-text">6.6、数据查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A0%B9%E6%8D%AE-id-%E6%9F%A5%E8%AF%A2%E4%B8%80%E4%B8%AA%E6%96%87%E6%A1%A3%E5%AF%B9%E8%B1%A1"><span class="toc-text">1、根据 id 查询一个文档对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%87%AA%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95"><span class="toc-text">2、自定义方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-7%E3%80%81%E9%AB%98%E7%BA%A7%E6%9F%A5%E8%AF%A2"><span class="toc-text">6.7、高级查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81QueryBuilders"><span class="toc-text">1、QueryBuilders</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E4%BD%BF%E7%94%A8-match-all-%E6%9F%A5%E8%AF%A2%E5%85%A8%E9%83%A8"><span class="toc-text">2、使用 match_all 查询全部</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E4%BD%BF%E7%94%A8-match-%E8%BF%9B%E8%A1%8C%E6%9F%A5%E8%AF%A2%EF%BC%8C%E6%9F%A5%E8%AF%A2%E4%B9%A6%E5%90%8D%E4%B8%AD%E5%90%AB%E6%9C%89-%E2%80%9C%E6%97%A0%E6%9C%BA%E2%80%9D-%E5%92%8C-%E2%80%9C%E5%8C%96%E5%AD%A6%E2%80%9D-%E7%9A%84%E4%B9%A6%E5%90%8D"><span class="toc-text">3、使用 match 进行查询，查询书名中含有 “无机” 和 “化学” 的书名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-text">4、分页查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81%E8%8C%83%E5%9B%B4%E5%8C%B9%E9%85%8D"><span class="toc-text">5、范围匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E7%BB%93%E6%9E%9C%E6%8E%92%E5%BA%8F"><span class="toc-text">6、结果排序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-8%E3%80%81%E8%81%9A%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="toc-text">6.8、聚合查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E8%81%9A%E5%90%88%E4%B8%BA%E6%A1%B6"><span class="toc-text">1、聚合为桶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%B5%8C%E5%A5%97%E8%81%9A%E5%90%88"><span class="toc-text">2、嵌套聚合</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2021 <i style="color:#ff6a6a;animation:announ_animation .8s linear infinite" class="fa fa-heartbeat"></i> 天昕</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">欢迎来到我的个人博客!<span id="runtime"></span><br></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px"><img src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&amp;logo=hexo"></a><a class="github-badge" target="_blank" href="https://butterfly.js.org/" style="margin-inline:5px"><img src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&amp;logo=bitdefender"></a><a class="github-badge" target="_blank" href="https://www.jsdelivr.com/" style="margin-inline:5px"><img src="https://img.shields.io/badge/CDN-jsDelivr-orange?style=flat&amp;logo=jsDelivr"></a><a class="github-badge" target="_blank" href="https://gitee.com/" style="margin-inline:5px"><img src="https://img.shields.io/badge/Picture-Gitee-0cedbe?style=flat&amp;logo=Gitee"></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&amp;logo=Claris"></a></p><div id="workboard"></div><script async src="/js/runtime.js"></script></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">簡</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div></div><hr><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script><script>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading())</script><script defer src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script defer src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script defer src="/js/search/local-search.js"></script><div class="js-pjax"><script>(()=>{const t=document.getElementById("twikoo-count"),o=()=>{twikoo.init({el:"#twikoo-wrap",envId:"blogcomments-2gseqioe1aa55c8c",region:"ap-shanghai"})},e=()=>{twikoo.getCommentsCount({envId:"blogcomments-2gseqioe1aa55c8c",region:"ap-shanghai",urls:[window.location.pathname],includeReply:!1}).then(function(o){t.innerText=o[0].count}).catch(function(o){console.error(o)})};var n;n=!0,"object"==typeof twikoo?(o(),n&&t&&setTimeout(e,0)):getScript("https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js").then(()=>{o(),n&&t&&setTimeout(e,0)})})()</script></div><div class="aplayer no-destroy" data-id="6588965546" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><script defer src="/live2d-widget/autoload.js"></script><script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/flipcountdown.js"></script><script data-pjax src="/js/runtime.js"></script><script async src="//at.alicdn.com/t/font_2398185_1cbsmfleajn.js"></script><script data-pjax src="/js/Lete.js"></script><script src="https://apip.weatherdt.com/simple/static/js/weather-simple-common.js?v=2.0"></script><script src="/js/weather.js"></script><script src="/js/custom/runtime.js"></script><script src="https://cdn.jsdelivr.net/gh/weilain/cdn-photo/js/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/gh/zhheo/JS-Heo@main/hidescrollbar/hidescrollbar.js"></script><script>let backimg=["url(https://gitee.com/sutianxin/photo/raw/master/20210415220031.png)","url(https://gitee.com/sutianxin/photo/raw/master/20210411191518.jpg)","url(https://gitee.com/sutianxin/photo/raw/master/20210411191521.jpg)","url(https://gitee.com/sutianxin/photo/raw/master/20210411191536.jpg)","url(https://gitee.com/sutianxin/photo/raw/master/20210411191533.jpg)","url(https://gitee.com/sutianxin/photo/raw/master/20210411191530.jpg)","url(https://gitee.com/sutianxin/photo/raw/master/20210411191527.jpg)","url(https://gitee.com/sutianxin/photo/raw/master/20210411191524.jpg)"],index=Math.ceil(Math.random()*(backimg.length-1))-1;document.getElementById("web_bg").style.backgroundImage=backimg[index]</script><script async src="//at.alicdn.com/t/font_2398185_lld84dtfbb.js"></script><script src="https://www.luckyclover.top/rain.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/gh/metowolf/MetingJS@1.2/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors=["title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"];var pjax=new Pjax({elements:'a:not([target="_blank"]):not([href="/shuoshuo/"]):not([href="/bb/"]):not([href="/contact/"])',selectors:pjaxSelectors,cacheBust:!1,analytics:!1,scrollRestoration:!1});document.addEventListener("pjax:complete",function(){window.refreshFn(),document.querySelectorAll("script[data-pjax], .pjax-reload script").forEach(e=>{const t=document.createElement("script"),o=e.text||e.textContent||e.innerHTML||"";Array.from(e.attributes).forEach(e=>t.setAttribute(e.name,e.value)),t.appendChild(document.createTextNode(o)),e.parentNode.replaceChild(t,e)}),GLOBAL_CONFIG.islazyload&&window.lazyLoadInstance.update(),"function"==typeof chatBtnFn&&chatBtnFn(),"function"==typeof panguInit&&panguInit(),"function"==typeof gtag&&gtag("config","",{page_path:window.location.pathname}),"function"==typeof loadMeting&&document.getElementsByClassName("aplayer").length&&loadMeting(),"object"==typeof Prism&&Prism.highlightAll(),"object"==typeof preloader&&preloader.endLoading()}),document.addEventListener("pjax:send",function(){if("object"==typeof preloader&&preloader.initLoading(),window.aplayers)for(let e=0;e<window.aplayers.length;e++)window.aplayers[e].options.fixed||window.aplayers[e].destroy();"object"==typeof typed&&typed.destroy();const e=document.body.classList;e.contains("read-mode")&&e.remove("read-mode")}),document.addEventListener("pjax:error",e=>{404===e.request.status&&pjax.loadUrl("/404.html")})</script></div><script data-pjax src="https://cdn.jsdelivr.net/gh/Zfour/hexo-github-calendar@1.10/hexo_githubcalendar.js"></script><script data-pjax>function GithubCalendarConfig(){var e=document.getElementById("recent-posts");e&&e.insertAdjacentHTML("afterbegin",'<div class="recent-post-item" style="width:100%;height:auto;padding:10px;"><div id="github_container"></div></div>'),GithubCalendar("https://python-github-calendar-api.vercel.app/api?sutianxin",["#ebedf0","#f1f8ff","#dbedff","#c8e1ff","#79b8ff","#2188ff","#0366d6","#005cc5","#044289","#032f62","#05264c"],"sutianxin")}document.getElementById("recent-posts")&&GithubCalendarConfig()</script><style>#github_container{min-height:280px}@media screen and (max-width:650px){#github_container{min-height:120px}}</style></body></html>